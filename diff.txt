Index: admin/app/backend.base.php
===================================================================
--- admin/app/backend.base.php	(revision 3919)
+++ admin/app/backend.base.php	(working copy)
@@ -121,7 +121,7 @@
      *    @param    none
      *    @return    void
      */
-    function jslang()
+    function jslang($trival)
     {
         $lang = Lang::fetch(lang_file('admin/jslang'));
         parent::jslang($lang);
@@ -163,7 +163,7 @@
         $this->_view->res_base      = site_url() . '/templates';
         $this->_view->lib_base      = dirname(site_url()) . '/includes/libraries/javascript';
     }
-
+
     /**
      *   获取商城当前模板名称
      */
@@ -191,7 +191,7 @@

         return $style_name;
     }
-
+
     function _init_visitor()
     {
         $this->visitor =& env('visitor', new AdminVisitor());
@@ -203,7 +203,7 @@
         $cache_server =& cache_server();
         $cache_server->clear();
     }
-
+
     function display($tpl)
     {
         $this->assign('real_backend_url', site_url());
Index: admin/app/fakebackend.base.php
===================================================================
--- admin/app/fakebackend.base.php	(revision 3919)
+++ admin/app/fakebackend.base.php	(working copy)
@@ -120,7 +120,7 @@
      *    @param    none
      *    @return    void
      */
-    function jslang()
+    function jslang($trival)
     {
         $lang = Lang::fetch(lang_file('admin/jslang'));
         parent::jslang($lang);
@@ -162,7 +162,7 @@
         $this->_view->res_base      = site_url() . '/templates';
         $this->_view->lib_base      = dirname(site_url()) . '/includes/libraries/javascript';
     }
-
+
     /**
      *   获取商城当前模板名称
      */
@@ -190,7 +190,7 @@

         return $style_name;
     }
-
+
     function _init_visitor()
     {
         $this->visitor =& env('visitor', new AdminVisitor());
@@ -202,7 +202,7 @@
         $cache_server =& cache_server();
         $cache_server->clear();
     }
-
+
     function display($tpl)
     {
         $this->assign('real_backend_url', site_url());
Index: app/buyer_order.app.php
===================================================================
--- app/buyer_order.app.php	(revision 3919)
+++ app/buyer_order.app.php	(working copy)
@@ -119,15 +119,15 @@
             $order_detail['data']['goods_list'][$key]['sku'] = $spec_info[$goods['spec_id']]['sku'];
             if(!$order_detail['data']['goods_list'][$key]['sku'])
             {
-               $order_detail['data']['goods_list'][$key]['sku'] = getHuoHao($goods['goods_name']);
-               if(!$order_detail['data']['goods_list'][$key]['sku'])
-               {
-                       $goods_AttrModel = &m('goodsattr');
-                       $attrs = $goods_AttrModel->get(array(
-                                       'conditions' => "goods_id = ".$goods['goods_id']." AND attr_id = 13021751",
-                       ));
-                       $order_detail['data']['goods_list'][$key]['sku'] = $attrs['attr_value'];
-               }
+                $order_detail['data']['goods_list'][$key]['sku'] = getHuoHao($goods['goods_name']);
+                if(!$order_detail['data']['goods_list'][$key]['sku'])
+                {
+                    $goods_AttrModel = &m('goodsattr');
+                    $attrs = $goods_AttrModel->get(array(
+                            'conditions' => "goods_id = ".$goods['goods_id']." AND attr_id = 13021751",
+                    ));
+                    $order_detail['data']['goods_list'][$key]['sku'] = $attrs['attr_value'];
+                }
             }
             $goods_seller_bm = $model_goodsattr->getOne("SELECT attr_value FROM {$model_goodsattr->table} WHERE goods_id={$goods['goods_id']} AND attr_id=1");
             $order_detail['data']['goods_list'][$key]['goods_seller_bm'] = $goods_seller_bm;
@@ -159,24 +159,24 @@
             }

         }
-
+
         //
         $model_orderrefund = & m('orderrefund');
         $refunds=$model_orderrefund->get(array(
-                       'conditions'=>'order_id='.$order_info['order_id'].' AND receiver_id='.$order_info['bh_id'].' AND closed=0 AND type=1',
+                'conditions'=>'order_id='.$order_info['order_id'].' AND receiver_id='.$order_info['bh_id'].' AND closed=0 AND type=1',
         ));
         if($refunds)
         {
-               $model_behalf = & m('behalf');
-               $refunds_behalf = $model_behalf->get($refunds['receiver_id']);
-               $refunds['receiver_name'] = $refunds_behalf['bh_name'];
+            $model_behalf = & m('behalf');
+            $refunds_behalf = $model_behalf->get($refunds['receiver_id']);
+            $refunds['receiver_name'] = $refunds_behalf['bh_name'];
         }
         $apply_fees=$model_orderrefund->get(array(
-                       'conditions'=>'order_id='.$order_info['order_id'].' AND receiver_id='.$order_info['buyer_id'].' AND closed=0 AND type=2',
+                'conditions'=>'order_id='.$order_info['order_id'].' AND receiver_id='.$order_info['buyer_id'].' AND closed=0 AND type=2',
         ));
-
-
-
+
+
+
         $this->import_resource(array(
                 'script' => array(
                         array(
@@ -359,9 +359,9 @@
             'money'=>$new_buy_money,
         );
         if($new_money_dj > 0 ){
-            $my_money_mod->edit('user_id='.$sell_user_id,$new_money_array);
+            $my_money_mod->edit('user_id='.$sell_user_id,$new_money_array);
         }
-
+
 //        $my_money_mod->edit('user_id='.$this->visitor->get('user_id'),$new_buy_money_array);
         //更新商付通log为 定单已完成
         $my_moneylog_mod->edit('order_id='.$order_id,array('caozuo'=>40));
@@ -607,10 +607,10 @@
         $model_orderrefund=& m('orderrefund');//behalf
         $model_orderstorerefund = & m('orderstorerefund');//store
         $model_orderextm = & m('orderextm');
-
+
         $model_ordervendor =& m('ordervendor');

-        !$_GET['type'] && $_GET['type'] = 'all_orders';
+        @!$_GET['type'] && $_GET['type'] = 'all_orders';
         $con = array(
             array(      //按订单状态搜索
                 'field' => 'status',
@@ -637,179 +637,179 @@
                 'field' => 'order_sn',
             ),
         );
-
+
         //商品名称查询
-        if($_GET['goods_name'])
+        if(@$_GET['goods_name'])
         {
-               //找出代发所有订单
-               $query_goods_name = trim($_GET['goods_name']);
-               $query_goods_name_orders = $model_order->find(array(
-                               'conditions'=>"buyer_id=".$this->visitor->get('user_id'),
-                               'fields'=>'order_id',
-               ));
-               if(!empty($query_goods_name_orders))
-               {
-                       $query_goods_name_order_ids = array();
-                       foreach ($query_goods_name_orders as $value)
-                       {
-                               $query_goods_name_order_ids[] = $value['order_id'];
-                       }
-                       //找出 有传入关键字的订单
-                       $query_order_goods = $model_ordergoods->find(array(
-                                       'conditions'=>db_create_in($query_goods_name_order_ids,'order_id')." AND goods_name like '%".$query_goods_name."%'",
-                                       'fields'=>'order_id',
-                       ));
-                       $query_goods_name_order_result = array();
-                       foreach ($query_order_goods as $value)
-                       {
-                               if(!in_array($value['order_id'], $query_goods_name_order_result))
-                                       $query_goods_name_order_result[] = $value['order_id'];
-                       }
-                       $this->assign("query_goods_name",$query_goods_name);
-                       if($query_goods_name_order_result)
-                       {
-                               $query_goods_condition = " AND ".db_create_in($query_goods_name_order_result,'order_alias.order_id');
-                       }
-                       else
-                       {
-                               return;
-                       }
-                       //dump($query_goods_name_order_result);
-               }
+            //找出代发所有订单
+            $query_goods_name = trim($_GET['goods_name']);
+            $query_goods_name_orders = $model_order->find(array(
+                    'conditions'=>"buyer_id=".$this->visitor->get('user_id'),
+                    'fields'=>'order_id',
+            ));
+            if(!empty($query_goods_name_orders))
+            {
+                $query_goods_name_order_ids = array();
+                foreach ($query_goods_name_orders as $value)
+                {
+                    $query_goods_name_order_ids[] = $value['order_id'];
+                }
+                //找出 有传入关键字的订单
+                $query_order_goods = $model_ordergoods->find(array(
+                        'conditions'=>db_create_in($query_goods_name_order_ids,'order_id')." AND goods_name like '%".$query_goods_name."%'",
+                        'fields'=>'order_id',
+                ));
+                $query_goods_name_order_result = array();
+                foreach ($query_order_goods as $value)
+                {
+                    if(!in_array($value['order_id'], $query_goods_name_order_result))
+                        $query_goods_name_order_result[] = $value['order_id'];
+                }
+                $this->assign("query_goods_name",$query_goods_name);
+                if($query_goods_name_order_result)
+                {
+                    $query_goods_condition = " AND ".db_create_in($query_goods_name_order_result,'order_alias.order_id');
+                }
+                else
+                {
+                    return;
+                }
+                //dump($query_goods_name_order_result);
+            }
         }
         //商家编码查询
-        if($_GET['goods_seller_bm'])
+        if(@$_GET['goods_seller_bm'])
         {
-               //找出代发所有订单
-               $query_goods_seller_bm = trim($_GET['goods_seller_bm']);
-               $query_goods_seller_bm_orders = $model_order->find(array(
-                               'conditions'=>"buyer_id=".$this->visitor->get('user_id'),
-                               'fields'=>'order_id',
-               ));
-               if(!empty($query_goods_seller_bm_orders))
-               {
-                       $query_goods_seller_bm_orders_ids = array();
-                       foreach ($query_goods_seller_bm_orders as $value)
-                       {
-                               $query_goods_seller_bm_orders_ids[] = $value['order_id'];
-                       }
-                       //找出 有传入关键字的订单
-                       ////商家编码
-                       /* $goods_AttrModel = & m('goodsattr');
-                        $attrs = $goods_AttrModel->find(array(
-                                       'conditions' => "attr_value like '%".$query_goods_seller_bm."%' AND attr_id = 1",
-                                       'fields'=>'goods_id',
-                        )); */
-                       $attrs = $model_goods->get_Mem_list(array(
-                                       'order'=>'views desc',
-                                       'fields'=>'g.goods_id,',
-                                       'limit'=>20,
-                                       'conditions_tt'=>array($query_goods_seller_bm)
-                       ),null,false,true,$total_found);
-
-                       $query_goods_seller_bm_goods_ids = array();
-                       foreach ($attrs as $value)
-                       {
-                               if(!in_array($value['goods_id'], $query_goods_seller_bm_goods_ids))
-                                       $query_goods_seller_bm_goods_ids[] = $value['goods_id'];
-                       }
-                       //dump($attrs);
-
-                       $query_goods_seller_bm_order_goods = $model_ordergoods->find(array(
-                                       'conditions'=>db_create_in($query_goods_seller_bm_goods_ids,'goods_id'),
-                                       'fields'=>'order_id',
-                       ));
-                       $query_goods_seller_bm_order_result = array();
-                       foreach ($query_goods_seller_bm_order_goods as $value)
-                       {
-                               if(!in_array($value['order_id'], $query_goods_seller_bm_order_result))
-                                       $query_goods_seller_bm_order_result[] = $value['order_id'];
-                       }
-                       $this->assign("query_goods_seller_bm",$query_goods_seller_bm);
-                       if($query_goods_seller_bm_order_result)
-                       {
-                               $query_goods_seller_bm_condition = " AND ".db_create_in($query_goods_seller_bm_order_result,'order_alias.order_id');
-                       }
-                       else
-                       {
-                               return;
-                       }
-                       //dump($query_goods_name_order_result);
-               }
+            //找出代发所有订单
+            $query_goods_seller_bm = trim($_GET['goods_seller_bm']);
+            $query_goods_seller_bm_orders = $model_order->find(array(
+                    'conditions'=>"buyer_id=".$this->visitor->get('user_id'),
+                    'fields'=>'order_id',
+            ));
+            if(!empty($query_goods_seller_bm_orders))
+            {
+                $query_goods_seller_bm_orders_ids = array();
+                foreach ($query_goods_seller_bm_orders as $value)
+                {
+                    $query_goods_seller_bm_orders_ids[] = $value['order_id'];
+                }
+                //找出 有传入关键字的订单
+                ////商家编码
+                /* $goods_AttrModel = & m('goodsattr');
+                 $attrs = $goods_AttrModel->find(array(
+                        'conditions' => "attr_value like '%".$query_goods_seller_bm."%' AND attr_id = 1",
+                        'fields'=>'goods_id',
+                 )); */
+                $attrs = $model_goods->get_Mem_list(array(
+                        'order'=>'views desc',
+                        'fields'=>'g.goods_id,',
+                        'limit'=>20,
+                        'conditions_tt'=>array($query_goods_seller_bm)
+                ),null,false,true,$total_found);
+
+                $query_goods_seller_bm_goods_ids = array();
+                foreach ($attrs as $value)
+                {
+                    if(!in_array($value['goods_id'], $query_goods_seller_bm_goods_ids))
+                        $query_goods_seller_bm_goods_ids[] = $value['goods_id'];
+                }
+                //dump($attrs);
+
+                $query_goods_seller_bm_order_goods = $model_ordergoods->find(array(
+                        'conditions'=>db_create_in($query_goods_seller_bm_goods_ids,'goods_id'),
+                        'fields'=>'order_id',
+                ));
+                $query_goods_seller_bm_order_result = array();
+                foreach ($query_goods_seller_bm_order_goods as $value)
+                {
+                    if(!in_array($value['order_id'], $query_goods_seller_bm_order_result))
+                        $query_goods_seller_bm_order_result[] = $value['order_id'];
+                }
+                $this->assign("query_goods_seller_bm",$query_goods_seller_bm);
+                if($query_goods_seller_bm_order_result)
+                {
+                    $query_goods_seller_bm_condition = " AND ".db_create_in($query_goods_seller_bm_order_result,'order_alias.order_id');
+                }
+                else
+                {
+                    return;
+                }
+                //dump($query_goods_name_order_result);
+            }
         }
-
+
         //待退款
         if(isset($_GET['type']) && 'refund'==trim($_GET['type']))
         {
-               $orderrefund_result = $model_orderrefund->find(array(
-                               'conditions'=>'sender_id='.$this->visitor->get('user_id').' AND status=0 AND closed=0 AND type=1',
-                               'fields'=>'order_id',
-               ));
-               if($orderrefund_result)
-               {
-                       $orderrefund_ids = array();
-                       foreach ($orderrefund_result as $value)
-                       {
-                               if(!in_array($value['order_id'], $orderrefund_ids))
-                                       $orderrefund_ids[] = $value['order_id'];
-                       }
-                       $query_refunds_condition =" AND ".db_create_in($orderrefund_ids,'order_alias.order_id')." AND ".db_create_in(array(ORDER_ACCEPTED,ORDER_SHIPPED,ORDER_FINISHED),'order_alias.status');
-               }
-               else{
-                       return;
-               }
+            $orderrefund_result = $model_orderrefund->find(array(
+                    'conditions'=>'sender_id='.$this->visitor->get('user_id').' AND status=0 AND closed=0 AND type=1',
+                    'fields'=>'order_id',
+            ));
+            if($orderrefund_result)
+            {
+                $orderrefund_ids = array();
+                foreach ($orderrefund_result as $value)
+                {
+                    if(!in_array($value['order_id'], $orderrefund_ids))
+                        $orderrefund_ids[] = $value['order_id'];
+                }
+                $query_refunds_condition =" AND ".db_create_in($orderrefund_ids,'order_alias.order_id')." AND ".db_create_in(array(ORDER_ACCEPTED,ORDER_SHIPPED,ORDER_FINISHED),'order_alias.status');
+            }
+            else{
+                return;
+            }
         }
         //待补差
         if(isset($_GET['type']) && 'applyfee'==trim($_GET['type']))
         {
-               $orderrefund_result = $model_orderrefund->find(array(
-                               'conditions'=>'receiver_id='.$this->visitor->get('user_id').' AND status=0 AND closed=0 AND type=2',
-                               'fields'=>'order_id',
-               ));
-               if($orderrefund_result)
-               {
-                       $orderrefund_ids = array();
-                       foreach ($orderrefund_result as $value)
-                       {
-                               if(!in_array($value['order_id'], $orderrefund_ids))
-                                       $orderrefund_ids[] = $value['order_id'];
-                       }
-                       $query_refunds_condition =" AND ".db_create_in($orderrefund_ids,'order_alias.order_id')." AND ".db_create_in(array(ORDER_ACCEPTED,ORDER_SHIPPED,ORDER_FINISHED),'order_alias.status');
-               }
-               else{
-                       return;
-               }
+            $orderrefund_result = $model_orderrefund->find(array(
+                    'conditions'=>'receiver_id='.$this->visitor->get('user_id').' AND status=0 AND closed=0 AND type=2',
+                    'fields'=>'order_id',
+            ));
+            if($orderrefund_result)
+            {
+                $orderrefund_ids = array();
+                foreach ($orderrefund_result as $value)
+                {
+                    if(!in_array($value['order_id'], $orderrefund_ids))
+                        $orderrefund_ids[] = $value['order_id'];
+                }
+                $query_refunds_condition =" AND ".db_create_in($orderrefund_ids,'order_alias.order_id')." AND ".db_create_in(array(ORDER_ACCEPTED,ORDER_SHIPPED,ORDER_FINISHED),'order_alias.status');
+            }
+            else{
+                return;
+            }
         }
         //收件人
         if(isset($_GET['consignee']) && !empty($_GET['consignee']))
         {
-               $consignee = trim($_GET['consignee']);
-               $consignee_result = $model_orderextm->find(array(
-                       'conditions'=>"consignee like '%".$consignee."%'",
-                       'fields'=>'order_id',
-               ));
-               $this->assign('cosignee_query',$consignee);
-               if(!empty($consignee_result))
-               {
-                       $consignee_arr = array();
-                       foreach ($consignee_result as $value)
-                       {
-                               $consignee_arr[] = $value['order_id'];
-                       }
-                       $query_consignee_condition = " AND ".db_create_in($consignee_arr,'order_alias.order_id');
-               }
-               else
-               {
-                       return;
-               }
-
+            $consignee = trim($_GET['consignee']);
+            $consignee_result = $model_orderextm->find(array(
+                'conditions'=>"consignee like '%".$consignee."%'",
+                'fields'=>'order_id',
+            ));
+            $this->assign('cosignee_query',$consignee);
+            if(!empty($consignee_result))
+            {
+                $consignee_arr = array();
+                foreach ($consignee_result as $value)
+                {
+                    $consignee_arr[] = $value['order_id'];
+                }
+                $query_consignee_condition = " AND ".db_create_in($consignee_arr,'order_alias.order_id');
+            }
+            else
+            {
+                return;
+            }
+
         }
-
-
+
+
         $conditions = $this->_get_query_conditions($con);
         /* 查找订单 */
         $orders = $model_order->findAll(array(
-            'conditions'    => "buyer_id=" . $this->visitor->get('user_id') .$query_goods_condition.$query_goods_seller_bm_condition.$query_refunds_condition.$query_consignee_condition. "{$conditions}",
+            'conditions'    => "buyer_id=" . $this->visitor->get('user_id') .@$query_goods_condition.@$query_goods_seller_bm_condition.@$query_refunds_condition.@$query_consignee_condition. "{$conditions}",
             'fields'        => 'this.*',
             'count'         => true,
             'limit'         => $page['limit'],
@@ -872,7 +872,7 @@
                 {
                     $orders[$key1]['order_goods'] = $order_goods;
                     $order['order_goods'] = $order_goods;
-
+
                     foreach ($order['order_goods'] as $key2 => $goods)
                     {
                         empty($goods['goods_image']) && $orders[$key1]['order_goods'][$key2]['goods_image'] = Conf::get('default_goods_image');
@@ -915,7 +915,7 @@
                         }
                     }
                 }
-
+
             }
             $orders[$key1]['delivery_bm'] = $model_order->get_delivery_bm_bybehalf($order['order_id']);
             if(in_array($order['status'],array(ORDER_ACCEPTED,ORDER_SHIPPED,ORDER_FINISHED)))
@@ -933,7 +933,7 @@
                         'conditions'=>'order_id='.$order['order_id'].' AND receiver_id='.$order['buyer_id'].' AND closed=0 AND type=2',
                     ));
                 }
-                else
+                else
                 {
                     $orders[$key1]['storerefund'] = $model_orderstorerefund->get(array(
                         'conditions'=>"order_id='{$order['order_id']}' AND applicant_id=".$this->visitor->get('user_id')
@@ -942,7 +942,7 @@
                     ));
                 }
             }
-
+
             //获取运费
             $orderextm = $model_orderextm->get($order['order_id']);
             $orders[$key1]['shipping_fee'] = $orderextm['shipping_fee'];
@@ -953,62 +953,62 @@
         /*
         foreach ($orders as $key1 => $order)
         {
-               if(!empty($order['order_goods']))
-               {
-                   foreach ($order['order_goods'] as $key2 => $goods)
-                   {
-                       empty($goods['goods_image']) && $orders[$key1]['order_goods'][$key2]['goods_image'] = Conf::get('default_goods_image');
-                        //获取货号
-                        $result = $model_gs->get(array(
-                               'fields' => 'sku',
-                               'conditions' => 'spec_id = '.$goods['spec_id'],
-                       ));
-                       $orders[$key1]['order_goods'][$key2]['sku'] = $result['sku'];
-                       if(!$orders[$key1]['order_goods'][$key2]['sku'])
-                       {
-                               $orders[$key1]['order_goods'][$key2]['sku'] = getHuoHao($goods['goods_name']);
-                               if(!$orders[$key1]['order_goods'][$key2]['sku'])
-                               {
-                                       $goods_AttrModel = &m('goodsattr');
-                                       $attrs = $goods_AttrModel->get(array(
-                                                       'conditions' => "goods_id = ".$goods['goods_id']." AND attr_id = 13021751",
-                                       ));
-                                       $orders[$key1]['order_goods'][$key2]['sku'] = $attrs['attr_value'];
-                               }
-                       }
-                       //档口地址
-                       $result = $model_goods->get(array(
-                               'conditions' => 'goods_id = '.$goods['goods_id'],
-                               'fields' =>'mk_name,dangkou_address,tel,im_qq,im_ww,store_name,s.store_id',
-                               'join'=>'belongs_to_store',
-                       ));
-                       $orders[$key1]['order_goods'][$key2]['dk_address'] = $result['mk_name']."-".$result['dangkou_address'];
-                       $orders[$key1]['order_goods'][$key2]['tel']=$result['tel'];
-                       $orders[$key1]['order_goods'][$key2]['im_qq']=$result['im_qq'];
-                       $orders[$key1]['order_goods'][$key2]['im_ww']=$result['im_ww'];
-                       $orders[$key1]['order_goods'][$key2]['store_id']=$result['store_id'];
-                       $orders[$key1]['order_goods'][$key2]['store_name']=$result['store_name'];
-                       ////商家编码
-                       $orders[$key1]['order_goods'][$key2]['goods_seller_bm'] = $goods['attr_value'];
-                       if(empty($orders[$key1]['order_goods'][$key2]['goods_seller_bm']))
-                       {
-                               $result = $model_goodsattr->getOne("SELECT attr_value FROM {$model_goodsattr->table} WHERE goods_id={$goods['goods_id']} AND attr_id=1");
-                               $orders[$key1]['order_goods'][$key2]['goods_seller_bm'] = $result;
-                       }
-                   }
-                        }
+            if(!empty($order['order_goods']))
+            {
+                foreach ($order['order_goods'] as $key2 => $goods)
+                {
+                    empty($goods['goods_image']) && $orders[$key1]['order_goods'][$key2]['goods_image'] = Conf::get('default_goods_image');
+                     //获取货号
+                     $result = $model_gs->get(array(
+                            'fields' => 'sku',
+                            'conditions' => 'spec_id = '.$goods['spec_id'],
+                    ));
+                    $orders[$key1]['order_goods'][$key2]['sku'] = $result['sku'];
+                    if(!$orders[$key1]['order_goods'][$key2]['sku'])
+                    {
+                        $orders[$key1]['order_goods'][$key2]['sku'] = getHuoHao($goods['goods_name']);
+                        if(!$orders[$key1]['order_goods'][$key2]['sku'])
+                        {
+                            $goods_AttrModel = &m('goodsattr');
+                            $attrs = $goods_AttrModel->get(array(
+                                    'conditions' => "goods_id = ".$goods['goods_id']." AND attr_id = 13021751",
+                            ));
+                            $orders[$key1]['order_goods'][$key2]['sku'] = $attrs['attr_value'];
+                        }
+                    }
+                    //档口地址
+                    $result = $model_goods->get(array(
+                            'conditions' => 'goods_id = '.$goods['goods_id'],
+                            'fields' =>'mk_name,dangkou_address,tel,im_qq,im_ww,store_name,s.store_id',
+                            'join'=>'belongs_to_store',
+                    ));
+                    $orders[$key1]['order_goods'][$key2]['dk_address'] = $result['mk_name']."-".$result['dangkou_address'];
+                    $orders[$key1]['order_goods'][$key2]['tel']=$result['tel'];
+                    $orders[$key1]['order_goods'][$key2]['im_qq']=$result['im_qq'];
+                    $orders[$key1]['order_goods'][$key2]['im_ww']=$result['im_ww'];
+                    $orders[$key1]['order_goods'][$key2]['store_id']=$result['store_id'];
+                    $orders[$key1]['order_goods'][$key2]['store_name']=$result['store_name'];
+                    ////商家编码
+                    $orders[$key1]['order_goods'][$key2]['goods_seller_bm'] = $goods['attr_value'];
+                    if(empty($orders[$key1]['order_goods'][$key2]['goods_seller_bm']))
+                    {
+                        $result = $model_goodsattr->getOne("SELECT attr_value FROM {$model_goodsattr->table} WHERE goods_id={$goods['goods_id']} AND attr_id=1");
+                        $orders[$key1]['order_goods'][$key2]['goods_seller_bm'] = $result;
+                    }
+                }
+             }
             $orders[$key1]['delivery_bm'] = $model_order->get_delivery_bm_bybehalf($order['order_id']);
             if(!empty($order['bh_id']))
             {
-               $model_behalf = & m('behalf');
-               $behalf = $model_behalf->get($order['bh_id']);
-               $orders[$key1]['behalf'] = $behalf;
+                $model_behalf = & m('behalf');
+                $behalf = $model_behalf->get($order['bh_id']);
+                $orders[$key1]['behalf'] = $behalf;
             }
             $orders[$key1]['refund']=$model_orderrefund->get(array(
-                       'conditions'=>'order_id='.$order['order_id'].' AND receiver_id='.$order['bh_id'].' AND closed=0 AND type=1',
+                    'conditions'=>'order_id='.$order['order_id'].' AND receiver_id='.$order['bh_id'].' AND closed=0 AND type=1',
             ));
             $orders[$key1]['apply_fee']=$model_orderrefund->get(array(
-                       'conditions'=>'order_id='.$order['order_id'].' AND receiver_id='.$order['buyer_id'].' AND closed=0 AND type=2',
+                    'conditions'=>'order_id='.$order['order_id'].' AND receiver_id='.$order['buyer_id'].' AND closed=0 AND type=2',
             ));
             //获取运费
             $orderextm = $model_orderextm->get($order['order_id']);
@@ -1018,7 +1018,7 @@
             $orders[$key1]['taobao_order_sn'] = $ordervendor['order_sn'];
         }
         */
-		//dump($orders);
+        //dump($orders);
         $page['item_count'] = $model_order->getCount();
         $this->assign('types', array('all'     => Lang::get('all_orders'),
                                      'pending' => Lang::get('pending_orders'),
@@ -1043,49 +1043,49 @@
         );
         return $menus;
     } */
-
+
     /*三级菜单*/
     function _get_member_submenu()
     {
-       $array = array(
-                       array(
-                                       'name' => 'all_orders',
-                                       'url' => 'index.php?app=buyer_order&amp;type=all_orders',
-                       ),
-                       array(
-                                       'name' => 'pending',
-                                       'url' => 'index.php?app=buyer_order&amp;type=pending',
-                       ),
-                       array(
-                                       'name' => 'submitted',
-                                       'url' => 'index.php?app=buyer_order&amp;type=submitted',
-                       ),
-                       array(
-                                       'name' => 'accepted',
-                                       'url' => 'index.php?app=buyer_order&amp;type=accepted',
-                       ),
-                       array(
-                                       'name' => 'shipped',
-                                       'url' => 'index.php?app=buyer_order&amp;type=shipped',
-                       ),
-                       array(
-                                       'name' => 'finished',
-                                       'url' => 'index.php?app=buyer_order&amp;type=finished',
-                       ),
-                       array(
-                                       'name' => 'canceled',
-                                       'url' => 'index.php?app=buyer_order&amp;type=canceled',
-                       ),
-                       array(
-                                       'name' => 'refund',
-                                       'url' => 'index.php?app=buyer_order&amp;type=refund',
-                       ),
-                       array(
-                                       'name' => 'applyfee',
-                                       'url' => 'index.php?app=buyer_order&amp;type=applyfee',
-                       ),
-       );
-       return $array;
+        $array = array(
+                array(
+                        'name' => 'all_orders',
+                        'url' => 'index.php?app=buyer_order&amp;type=all_orders',
+                ),
+                array(
+                        'name' => 'pending',
+                        'url' => 'index.php?app=buyer_order&amp;type=pending',
+                ),
+                array(
+                        'name' => 'submitted',
+                        'url' => 'index.php?app=buyer_order&amp;type=submitted',
+                ),
+                array(
+                        'name' => 'accepted',
+                        'url' => 'index.php?app=buyer_order&amp;type=accepted',
+                ),
+                array(
+                        'name' => 'shipped',
+                        'url' => 'index.php?app=buyer_order&amp;type=shipped',
+                ),
+                array(
+                        'name' => 'finished',
+                        'url' => 'index.php?app=buyer_order&amp;type=finished',
+                ),
+                array(
+                        'name' => 'canceled',
+                        'url' => 'index.php?app=buyer_order&amp;type=canceled',
+                ),
+                array(
+                        'name' => 'refund',
+                        'url' => 'index.php?app=buyer_order&amp;type=refund',
+                ),
+                array(
+                        'name' => 'applyfee',
+                        'url' => 'index.php?app=buyer_order&amp;type=applyfee',
+                ),
+        );
+        return $array;
     }
     /**
      * 申请退款，改进版
@@ -1096,15 +1096,15 @@
     function refund_apply()
     {
         $order_id = isset($_GET['order_id']) ? intval($_GET['order_id']) : 0;
-
+
         $model_order = & m('order');
         $model_ordergoods = & m('ordergoods');
         $model_orderstorerefund = & m('orderstorerefund');
-
+
         $refund_info = $model_orderstorerefund->find(array(
             'conditions'=>"order_id = {$order_id} and refund_closed=0"
         ));
-
+
         if(!empty($refund_info))
         {
             foreach ($refund_info as $refund)
@@ -1126,16 +1126,16 @@
                 }
             }
         }
-
+
         $order_info     = $model_order->get(array(
            'conditions'=>"order_alias.order_id={$order_id} AND buyer_id=" . $this->visitor->get('user_id') . " AND status " . db_create_in(array(ORDER_ACCEPTED, ORDER_SHIPPED,ORDER_FINISHED)),
            //'join'=>'has_orderextm'
         ));
-
+
         if(!$order_info['bh_id'] && $order_info['extension'] == 'normal')
-        {
+        {
             $order_goods = $model_ordergoods->find(array(
-               'conditions'=>"order_id = '{$order_id}'"
+               'conditions'=>"order_id = '{$order_id}'"
             ));
             if($order_goods)
             {
@@ -1146,7 +1146,7 @@
             }
             $this->assign('order_goods',$order_goods);
         }
-
+
         $this->assign('order_info',$order_info);
         $this->display('refund.apply.wind.html');
     }
@@ -1173,17 +1173,17 @@
             $order_id = $_REQUEST['order_id'];
             $goods_ids_arr = $_POST['ginfo'];
         }
-
+
         $model_order = & m('order');
         $model_ordergoods = & m('ordergoods');
-
+
         $order_info     = $model_order->get(array(
         'conditions'=>"order_alias.order_id={$order_id} AND buyer_id=" . $this->visitor->get('user_id') . " AND status " . db_create_in(array(ORDER_ACCEPTED, ORDER_SHIPPED,ORDER_FINISHED)),
         'join'=>'has_orderextm'
         ));
-
+
         $goods_amount = 0;
-
+
         if(!$order_info['bh_id'] && $order_info['extension'] == 'normal')
         {
             $order_goods = $model_ordergoods->find(array(
@@ -1192,7 +1192,7 @@
             if($order_goods)
             {
                 foreach ($order_goods as $key=>$goods)
-                {
+                {
                     $order_goods[$key]['subtotal'] = $goods['price'] * $goods['quantity'];
                     $goods_amount += $goods['price'] * $goods['quantity'];
                 }
@@ -1200,19 +1200,19 @@
             $this->assign('goods_ids',$goods_ids_arr ? implode(',', $goods_ids_arr):array());
             $this->assign('order_goods',$order_goods);
         }
-
+
         $this->import_resource(array(
-            'script' => array(
+            'script' => array(
                 array(
                     'path' => 'jquery.plugins/jquery.validate.js',
                     'attr' => '',
                 )
             )
         ));
-
+
         $this->assign('refund_goods_amount',$goods_amount);
-        $this->assign('order_info',$order_info);
-
+        $this->assign('order_info',$order_info);
+
         $this->display('refund.fill_sheet.html');
     }
     /**
@@ -1221,35 +1221,35 @@
     function save_refund_sheet()
     {
         $data = array(
-          'is_receive_goods'=>$_POST['is_receive_goods'],//是否收到货物
-          'is_reback_goods'=>$_POST['is_reback_goods'],//是否需要退货
+          'is_receive_goods'=>$_POST['is_receive_goods'],//是否收到货物
+          'is_reback_goods'=>$_POST['is_reback_goods'],//是否需要退货
           'order_id'=>$_POST['order_id'],
           'refund_category'=>$_POST['refund_category'],
           'refund_delivery_amount'=>floatval($_POST['refund_delivery_amount']),
           'refund_goods_amount'=>floatval($_POST['refund_goods_amount']),
           'refund_intro'=>html_filter($_POST['refund_intro']),
-          'goods_info'=>trim($_POST['goods_info']),
+          'goods_info'=>trim($_POST['goods_info']),
           'applicant_id'=>$this->visitor->get('user_id'),//申请人
           'refund_status'=>REFUND_APPLYING,
           'apply_time'=>gmtime()
         );
-
+
         $model_order =& m('order');
         $model_orderstorerefund = & m('orderstorerefund');
-
-        $fp = zwd51_handle_concurrence_with_file_open('apply_store_refund');
-
+
+        $fp = zwd51_handle_concurrence_with_file_open('apply_store_refund');
+
         if(!$fp)
-        {
+        {
             $this->show_warning('cannot write','ret_order_list','index.php?app=buyer_order');
             return;
         }
         flock($fp, LOCK_EX);
-
+
         $refund_info = $model_orderstorerefund->find(array(
             'conditions'=>"order_id = {$data['order_id']} and refund_closed=0"
         ));
-
+
         if(!empty($refund_info))
         {
             foreach ($refund_info as $refund)
@@ -1265,29 +1265,29 @@
                     zwd51_handle_concurrence_with_file_close($fp);
                     $this->show_warning('refund_success_handle','ret_order_list','index.php?app=buyer_order');
                     return ;
-                }
+                }
             }
         }
-
+
         $order_info = $model_order->get($data['order_id']);
-
+
         if(empty($order_info) || $order_info['bh_id'] || !$order_info['seller_id'] || $data['refund_goods_amount'] > $order_info['goods_amount'] || $data['refund_goods_amount'] + $data['refund_delivery_amount'] > $order_info['order_amount'] || $data['refund_delivery_amount'] > $order_info['order_amount'] - $order_info['goods_amount'])
-        {
+        {
             zwd51_handle_concurrence_with_file_close($fp);
             $this->show_warning('hack attempt','ret_order_list','index.php?app=buyer_order');
             return ;
         }
-
+
         $data['store_id'] = $order_info['seller_id'];
-
+
         $model_orderstorerefund->add($data);
-
+
         zwd51_handle_concurrence_with_file_close($fp);
         if($model_orderstorerefund->has_error())
         {
             $this->show_warning($model_orderstorerefund->get_error());
         }
-
+
         $this->show_message('refund_apply_success','ret_order_list','index.php?app=buyer_order');
     }
     /**
@@ -1297,24 +1297,24 @@
     {
         $user_id = $this->visitor->get('user_id');
         $order_id = $_GET['order_id'] ? $_GET['order_id'] : 0;
-
+
         $model_orderstorerefund = & m('orderstorerefund');
         $refund_info = $model_orderstorerefund->get(array(
             'conditions'=>"order_id = $order_id and applicant_id = $user_id",
             'order'=>'id DESC'
         ));
-
-
+
+
         $model_order = & m('order');
         $model_ordergoods = & m('ordergoods');
-
+
         $order_info     = $model_order->get(array(
         'conditions'=>"order_alias.order_id={$order_id} AND buyer_id=" . $this->visitor->get('user_id') . " AND status " . db_create_in(array(ORDER_ACCEPTED, ORDER_SHIPPED,ORDER_FINISHED)),
         'join'=>'has_orderextm'
             ));
-
+
         $goods_amount = 0;
-
+
         if(!$order_info['bh_id'] && $order_info['extension'] == 'normal')
         {
             $order_goods = $model_ordergoods->find(array(
@@ -1331,9 +1331,9 @@
             //$this->assign('goods_ids',implode(',', $goods_ids_arr));
             $this->assign('order_goods',$order_goods);
         }
-
+
         $refund_info['total_refund_amount'] = floatval($refund_info['refund_goods_amount']) + floatval($refund_info['refund_delivery_amount']);
-
+
         $this->import_resource(array(
             'script' => array(
                 array(
@@ -1355,25 +1355,25 @@
             ),
             'style' =>  'jquery.ui/themes/ui-lightness/jquery.ui.css',
         ));
-
+
         $this->assign('refund_goods_amount',price_format($goods_amount));
         $this->assign('order_info',$order_info);
         $this->assign('refund_info',$refund_info);
-
-        $this->display('refund.view.html');
+
+        $this->display('refund.view.html');
     }
-
+
     /**
-     * 档口退款提交发货信息
+     * 档口退款提交发货信息
      */
     function submit_invoice()
     {
         $refund_id = $_GET['id']?trim($_GET['id']):0;
-
+
         $model_orderstorerefund = & m('orderstorerefund');
-
+
         $refund_info = $model_orderstorerefund->get($refund_id);
-
+
         if(empty($refund_info) || !in_array($refund_info['refund_status'], array(REFUND_PENDING)) || $refund_info['refund_closed'] == 1)
         {
             echo 'hack attempt<br>';
@@ -1381,15 +1381,15 @@
         }
         $mod_deli = & m('delivery');
         $deliveries = $mod_deli->find(array('conditions'=>'dl_desc IS NOT NULL','order'=>'sort_order ASC'));
-
+
         if(!IS_POST)
         {
-
+
             $this->assign('deliveries',$deliveries);
             $this->assign('refund_info',$refund_info);
             $this->display('refund.submit_invoice.html');
         }
-        else
+        else
         {
             $data = array(
               'th_deli_id'=>$_POST['th_deli_id'],
@@ -1399,503 +1399,503 @@
               'ship_time'=>gmtime(),
               'refund_status'=>REFUND_SHIPPED
             );
-
+
             $model_orderstorerefund->edit($refund_id,$data);
-
+
             $this->pop_warning('ok','','index.php?app=buyer_order&act=refund_view&order_id='.$refund_info['order_id']);
         }
-
+
     }
-
-
+
+
     /**
      * 申请退货退款 ，最开始用于代发
      */
     function apply_refund()
     {
-       //$this->pop_warning('no_such_order');
-
-       $order_id = isset($_GET['order_id']) ? intval($_GET['order_id']) : 0;
-       if (!$order_id)
-       {
-               echo Lang::get('no_such_order');
-               return;
-       }
-       $model_order    =&  m('order');
-       $model_orderrefund = & m('orderrefund');
-       $model_ordergoods =& m('ordergoods');
-       $model_behalf =& m('behalf');
-       $model_delivery =& m('delivery');
-
-       $lock_file = ROOT_PATH."/data/apply_refund.lock";
-       if(!file_exists($lock_file))
-       {
-               file_put_contents($lock_file, 1);
-       }
-
-       //对文件加锁
-       $fp = fopen($lock_file, 'a+');
-       if(!$fp)
-       {
-               echo 'fail to open file,server is busy!';
-               return;
-       }
-       flock($fp, LOCK_EX);
-
-       /* 只有已付款和已经发货、已完成的订单可以申请退货退款 */
-       $order_info     = $model_order->findAll(array(
-                       'conditions'=>"order_id={$order_id} AND buyer_id=" . $this->visitor->get('user_id') . " AND status " . db_create_in(array(ORDER_ACCEPTED, ORDER_SHIPPED,ORDER_FINISHED)),
-                       'include'       =>  array(
-                                       //'has_ordergoods',       //取出商品
-                                       'has_goodswarehouse'
-                       ),
-       ));
-       if (!empty($order_info))
-       {
-               $order_info = current($order_info);
-               if($order_info['bh_id'] == '10919')
-               {
-                       echo Lang::get('behalf1_refused');
-                       return;
-               }
-               $refund_result=$model_orderrefund->find(array(
-                               'conditions'=>'order_id='.$order_info['order_id'].' AND receiver_id='.$order_info['bh_id'].'',
-               ));
-       }
-
-       $q_deliverys = $model_delivery->find(array('conditions'=>'dl_desc IS NOT NULL','order'=>'sort_order ASC'));
-       foreach ($q_deliverys as $key=>$value)
-       {
-               if(empty($value['dl_desc']))
-               {
-                       unset($q_deliverys[$key]);
-               }
-       }
-
-       /*文件解锁*/
-       flock($fp, LOCK_UN);
-       fclose($fp);
-
-       //status 0:申请，1：已同意，2：已拒绝  closed 0:未关闭 1：已关闭
-       if(!empty($refund_result))
-       {
-               if(count($refund_result) > 1)
-               {
-                       echo Lang::get('feifashenqing_gt2');
-                       return;
-               }
-               $exist_refund = current($refund_result);
-               if($exist_refund['status'] != 2 && $exist_refund['closed'] != 1)
-               {
-                       echo Lang::get('feifashenqing');
-                       return ;
-               }
-       }
-       //dump($order_info);
-       if (empty($order_info))
-       {
-               echo Lang::get('no_such_order');
-               return;
-       }
-       //计算是否应该收取退货代发费
-       $levy_reback_goods_fee = false;
-       if($order_info['gwh'])
-       {
-           $query_gwh_ids = array();
-           foreach ($order_info['gwh'] as $order_gwh)
-           {
-               $query_gwh_ids[] = $order_gwh['id'];
-           }
-          $levy_reback_goods_fee = after_goods_taker_inventory($order_info['pay_time'],$query_gwh_ids);
-       }
-
-       if (!IS_POST)
-       {
-               header('Content-Type:text/html;charset=' . CHARSET);
-               $this->assign('order', $order_info);
-               $this->assign('deliverys',$q_deliverys);
-               $this->assign('levy_reback_goods_fee',$levy_reback_goods_fee);//是否征收退货代发费
-               $this->display('buyer_order.apply_refund.html');
-       }
-       else
-       {
-               //dump($_POST);
-
-
-               $refund_amount = isset($_POST['refund_amount'])?floatval(trim($_POST['refund_amount'])):0;
-               $invoice_no = isset($_POST['invoice_no']) && $_POST['invoice_no'] ?trim($_POST['invoice_no']):'';
-
-               if($refund_amount <= 0)
-               {
-                       echo "hack attacked";
-                       return;
-               }
-
-               if($invoice_no)
-               {
-                   if(exist_invoiceno($invoice_no))
-                   {
-                       $this->pop_warning('invoice_no_exist');
-                       return;
-                   }
-
-                       $rec_ids = $_POST['goods_ids'];
-
-                       //判断退货申请金额
-                       if($order_info['status'] == ORDER_ACCEPTED && $levy_reback_goods_fee)
-                       {
-
-                           if($refund_amount > ($order_info['order_amount'] - 2*count($rec_ids)))
-                           {
-                               $this->pop_warning(sprintf(Lang::get('apply_back_fee_too_big'),$order_info['order_amount'] - 2*count($rec_ids)));
-                               return;
-                           }
-                       }
-                       elseif(in_array($order_info['status'], array(ORDER_SHIPPED,ORDER_FINISHED)) && $levy_reback_goods_fee)
-                       {
-                           if($refund_amount > ($order_info['goods_amount'] - 2*count($rec_ids)))
-                           {
-                               $this->pop_warning(sprintf(Lang::get('apply_back_fee_too_big'),$order_info['goods_amount'] - 2*count($rec_ids)));
-                               return;
-                           }
-                       }
-
-                       $refund_intro = $goods_ids = '';
-                       $refund_total = 0;
-                       $rec_goods = &m('goodswarehouse')->find(array(
-                           'conditions'=>'order_id='.$order_id." AND ".db_create_in($rec_ids,'id'),
-                       ));
-                       if($rec_goods)
-                       {
-                           foreach ($rec_goods as $goods)
-                           {
-                               $goods_ids .= $goods['id'].',';
-                               $refund_intro .= $goods['goods_name'].' '.$goods['goods_specification'].'  &yen;'.$goods['goods_price'].';';
-                               $refund_total += floatval($goods['goods_price']);
-                           }
-                           /* if($refund_total > $refund_amount)
-                           {
-                               $this->pop_warning('cuowu_jinebudui');
-                               return;
-                           } */
-                       }
-                       /*
-                       $rec_goods = $model_ordergoods->find(array(
-                           'conditions'=>'order_id='.$order_id." AND ".db_create_in($rec_ids,'rec_id'),
-                       ));
-                       if($rec_goods)
-                       {
-                           foreach ($rec_goods as $goods)
-                           {
-                               $goods_ids .= $goods['rec_id'].',';
-                               $refund_intro .= $goods['goods_name'].' '.$goods['specification'].'  &yen;'.$goods['price'].' '.$goods['quantity'].';';
-                               $refund_total += $goods['price'] * $goods['quantity'];
-                           }
-                           if($refund_total > $refund_amount)
-                           {
-                               $this->pop_warning('cuowu_jinebudui');
-                               return;
-                           }
-                       }*/
-                       $goods_ids && $goods_ids = rtrim($goods_ids,',');
-                       $refund_intro && $refund_intro = rtrim($refund_intro,';');
-                       //$refund_intro = implode(';', $_POST['goods_ids']);
-                       //快递参数有冒号隔开
-                       if(isset($_POST['delivery_name']) && $_POST['delivery_name'])
-                       {
-                               $delivery_name = explode(':', $_POST['delivery_name']);
-                       }
-                       else
-                       {
-                               echo "hack attacked";
-                               return;
-                       }
-               }
-               else
-               {
-                       $refund_intro = html_filter($_POST['refund_intro']);
-               }
-               if($order_info['status'] != ORDER_ACCEPTED && $refund_amount > $order_info['goods_amount'])
-               {
-                       echo "hack attacked";
-                       return;
-               }
-               if($refund_amount > $order_info['order_amount'])
-               {
-                       echo "hack attacked";
-                       return;
-               }
-               if(!isset($_POST['refund_reason']) || empty($_POST['refund_reason']))
-               {
-                       echo "hack attacked";
-                       return;
-               }
-               if(empty($order_info['bh_id']))
-               {
-                       echo 'hack attacked';
-                       return;
-               }
-               $data=array(
-                       'order_id'=>$order_info['order_id'],
-                       'order_sn'=>$order_info['order_sn'],
-                       'sender_id'=>$this->visitor->get('user_id'),
-                       'sender_name'=>$this->visitor->get('user_name'),
-                       'receiver_id'=>$order_info['bh_id'],
-                       'refund_reason'=>html_filter($_POST['refund_reason']),
-                       'refund_intro'=>$refund_intro,
-                   'goods_ids'=>$goods_ids,
-                   'goods_ids_flag'=>$goods_ids?1:0,
-                       'apply_amount'=>$refund_amount,
-                       'invoice_no'=>$invoice_no,
-                       'dl_id'=>intval($delivery_name[0]),
-                       'dl_name'=>trim($delivery_name[1]),
-                       'dl_code'=>trim($delivery_name[2]),
-                       'refund_amount'=>0,
-                       'create_time'=>gmtime(),
-                       'pay_time'=>0,
-                       'status'=>0,
-                       'closed'=>0,
-                       'type'=>1,//1:代表申请退款退货 2：代表代发申请补邮
-               );
-
-               /* //开始数据库事务
-               $db_transaction_begin = db()->query("START TRANSACTION");
-               if($db_transaction_begin === false)
-               {
-                       $this->pop_warning('fail_caozuo');
-                       return;
-               }
-               $db_transaction_success = true;//默认事务执行成功，不用回滚
-               $db_transaction_reason = '';//回滚的原因 */
-
-
-               $model_orderrefund=& m('orderrefund');
-               $affect_id = $model_orderrefund->add($data);
-               if(empty($affect_id) || $model_orderrefund->has_error())
-               {
-                       $this->pop_warning($model_orderrefund->get_error());
-                       return;
-                       //$db_transaction_success = false;
-                       //$db_transaction_reason = 'write_db_failed';
-               }
-
-               /*如果订单是已完成的，则要冻结申请资金*/
-               if($order_info['status'] == ORDER_FINISHED)
-               {
-                       include_once(ROOT_PATH.'/app/fakemoney.app.php');
-                       $fakemoneyapp = new FakeMoneyApp();
-                       $affect_result = $fakemoneyapp->manuFro($order_info['bh_id'],$refund_amount);
-                       if($affect_result === false)
-                       {
-                               //$db_transaction_success = false;
-                               //$db_transaction_reason = 'frozen_failed';
-                       }
-               }
-
-               /* if($db_transaction_success === false)
-               {
-                       db()->query("ROLLBACK");//回滚
-               }
-               else
-               {
-                       db()->query("COMMIT");//提交
-               }
-
-               //db()->query("END");
-               if($db_transaction_success === false)
-               {
-                       $this->pop_warning($db_transaction_reason);
-                       return;
-               } */
-
-
-           //$refund_message = Lang::get('refund_message').$order_info['order_sn'];
-           /* 连接用户系统 */
-           /*  $ms =& ms();
-           $msg_id = $ms->pm->send($this->visitor->get('user_id'), array($order_info['bh_id']), '', $refund_message); */
-
-               /* 发送给卖家订单取消通知 */
-               //$model_member =& m('member');
-               //$seller_info   = $model_member->get($order_info['bh_id']);
-               /*短信通知*/
-               //$this->sendSaleSms($seller_info['phone_mob'], $refund_message);
-               /* $mail = get_mail('toseller_apply_refund_notify', array('order' => $order_info, 'reason' => $_POST['refund_reason']));
-               $this->_mailto($seller_info['email'], addslashes($mail['subject']), $refund_message);  */
-
-               $new_data = array(
-                               'status'    => Lang::get('apply_refund'),
-                               'actions'   => array(), //取消订单后就不能做任何操作了
-               );
-
-               $this->pop_warning('ok');
-       }
-
+        //$this->pop_warning('no_such_order');
+
+        $order_id = isset($_GET['order_id']) ? intval($_GET['order_id']) : 0;
+        if (!$order_id)
+        {
+            echo Lang::get('no_such_order');
+            return;
+        }
+        $model_order    =&  m('order');
+        $model_orderrefund = & m('orderrefund');
+        $model_ordergoods =& m('ordergoods');
+        $model_behalf =& m('behalf');
+        $model_delivery =& m('delivery');
+
+        $lock_file = ROOT_PATH."/data/apply_refund.lock";
+        if(!file_exists($lock_file))
+        {
+            file_put_contents($lock_file, 1);
+        }
+
+        //对文件加锁
+        $fp = fopen($lock_file, 'a+');
+        if(!$fp)
+        {
+            echo 'fail to open file,server is busy!';
+            return;
+        }
+        flock($fp, LOCK_EX);
+
+        /* 只有已付款和已经发货、已完成的订单可以申请退货退款 */
+        $order_info     = $model_order->findAll(array(
+                'conditions'=>"order_id={$order_id} AND buyer_id=" . $this->visitor->get('user_id') . " AND status " . db_create_in(array(ORDER_ACCEPTED, ORDER_SHIPPED,ORDER_FINISHED)),
+                'include'       =>  array(
+                        //'has_ordergoods',       //取出商品
+                        'has_goodswarehouse'
+                ),
+        ));
+        if (!empty($order_info))
+        {
+            $order_info = current($order_info);
+            if($order_info['bh_id'] == '10919')
+            {
+                echo Lang::get('behalf1_refused');
+                return;
+            }
+            $refund_result=$model_orderrefund->find(array(
+                    'conditions'=>'order_id='.$order_info['order_id'].' AND receiver_id='.$order_info['bh_id'].'',
+            ));
+        }
+
+        $q_deliverys = $model_delivery->find(array('conditions'=>'dl_desc IS NOT NULL','order'=>'sort_order ASC'));
+        foreach ($q_deliverys as $key=>$value)
+        {
+            if(empty($value['dl_desc']))
+            {
+                unset($q_deliverys[$key]);
+            }
+        }
+
+        /*文件解锁*/
+        flock($fp, LOCK_UN);
+        fclose($fp);
+
+        //status 0:申请，1：已同意，2：已拒绝  closed 0:未关闭 1：已关闭
+        if(!empty($refund_result))
+        {
+            if(count($refund_result) > 1)
+            {
+                echo Lang::get('feifashenqing_gt2');
+                return;
+            }
+            $exist_refund = current($refund_result);
+            if($exist_refund['status'] != 2 && $exist_refund['closed'] != 1)
+            {
+                echo Lang::get('feifashenqing');
+                return ;
+            }
+        }
+        //dump($order_info);
+        if (empty($order_info))
+        {
+            echo Lang::get('no_such_order');
+            return;
+        }
+        //计算是否应该收取退货代发费
+        $levy_reback_goods_fee = false;
+        if($order_info['gwh'])
+        {
+            $query_gwh_ids = array();
+            foreach ($order_info['gwh'] as $order_gwh)
+            {
+                $query_gwh_ids[] = $order_gwh['id'];
+            }
+           $levy_reback_goods_fee = after_goods_taker_inventory($order_info['pay_time'],$query_gwh_ids);
+        }
+
+        if (!IS_POST)
+        {
+            header('Content-Type:text/html;charset=' . CHARSET);
+            $this->assign('order', $order_info);
+            $this->assign('deliverys',$q_deliverys);
+            $this->assign('levy_reback_goods_fee',$levy_reback_goods_fee);//是否征收退货代发费
+            $this->display('buyer_order.apply_refund.html');
+        }
+        else
+        {
+            //dump($_POST);
+
+
+            $refund_amount = isset($_POST['refund_amount'])?floatval(trim($_POST['refund_amount'])):0;
+            $invoice_no = isset($_POST['invoice_no']) && $_POST['invoice_no'] ?trim($_POST['invoice_no']):'';
+
+            if($refund_amount <= 0)
+            {
+                echo "hack attacked";
+                return;
+            }
+
+            if($invoice_no)
+            {
+                if(exist_invoiceno($invoice_no))
+                {
+                    $this->pop_warning('invoice_no_exist');
+                    return;
+                }
+
+                $rec_ids = $_POST['goods_ids'];
+
+                //判断退货申请金额
+                if($order_info['status'] == ORDER_ACCEPTED && $levy_reback_goods_fee)
+                {
+
+                    if($refund_amount > ($order_info['order_amount'] - 2*count($rec_ids)))
+                    {
+                        $this->pop_warning(sprintf(Lang::get('apply_back_fee_too_big'),$order_info['order_amount'] - 2*count($rec_ids)));
+                        return;
+                    }
+                }
+                elseif(in_array($order_info['status'], array(ORDER_SHIPPED,ORDER_FINISHED)) && $levy_reback_goods_fee)
+                {
+                    if($refund_amount > ($order_info['goods_amount'] - 2*count($rec_ids)))
+                    {
+                        $this->pop_warning(sprintf(Lang::get('apply_back_fee_too_big'),$order_info['goods_amount'] - 2*count($rec_ids)));
+                        return;
+                    }
+                }
+
+                $refund_intro = $goods_ids = '';
+                $refund_total = 0;
+                $rec_goods = &m('goodswarehouse')->find(array(
+                    'conditions'=>'order_id='.$order_id." AND ".db_create_in($rec_ids,'id'),
+                ));
+                if($rec_goods)
+                {
+                    foreach ($rec_goods as $goods)
+                    {
+                        $goods_ids .= $goods['id'].',';
+                        $refund_intro .= $goods['goods_name'].' '.$goods['goods_specification'].'  &yen;'.$goods['goods_price'].';';
+                        $refund_total += floatval($goods['goods_price']);
+                    }
+                    /* if($refund_total > $refund_amount)
+                    {
+                        $this->pop_warning('cuowu_jinebudui');
+                        return;
+                    } */
+                }
+                /*
+                $rec_goods = $model_ordergoods->find(array(
+                    'conditions'=>'order_id='.$order_id." AND ".db_create_in($rec_ids,'rec_id'),
+                ));
+                if($rec_goods)
+                {
+                    foreach ($rec_goods as $goods)
+                    {
+                        $goods_ids .= $goods['rec_id'].',';
+                        $refund_intro .= $goods['goods_name'].' '.$goods['specification'].'  &yen;'.$goods['price'].' '.$goods['quantity'].';';
+                        $refund_total += $goods['price'] * $goods['quantity'];
+                    }
+                    if($refund_total > $refund_amount)
+                    {
+                        $this->pop_warning('cuowu_jinebudui');
+                        return;
+                    }
+                }*/
+                $goods_ids && $goods_ids = rtrim($goods_ids,',');
+                $refund_intro && $refund_intro = rtrim($refund_intro,';');
+                //$refund_intro = implode(';', $_POST['goods_ids']);
+                //快递参数有冒号隔开
+                if(isset($_POST['delivery_name']) && $_POST['delivery_name'])
+                {
+                    $delivery_name = explode(':', $_POST['delivery_name']);
+                }
+                else
+                {
+                    echo "hack attacked";
+                    return;
+                }
+            }
+            else
+            {
+                $refund_intro = html_filter($_POST['refund_intro']);
+            }
+            if($order_info['status'] != ORDER_ACCEPTED && $refund_amount > $order_info['goods_amount'])
+            {
+                echo "hack attacked";
+                return;
+            }
+            if($refund_amount > $order_info['order_amount'])
+            {
+                echo "hack attacked";
+                return;
+            }
+            if(!isset($_POST['refund_reason']) || empty($_POST['refund_reason']))
+            {
+                echo "hack attacked";
+                return;
+            }
+            if(empty($order_info['bh_id']))
+            {
+                echo 'hack attacked';
+                return;
+            }
+            $data=array(
+                'order_id'=>$order_info['order_id'],
+                'order_sn'=>$order_info['order_sn'],
+                'sender_id'=>$this->visitor->get('user_id'),
+                'sender_name'=>$this->visitor->get('user_name'),
+                'receiver_id'=>$order_info['bh_id'],
+                'refund_reason'=>html_filter($_POST['refund_reason']),
+                'refund_intro'=>$refund_intro,
+                'goods_ids'=>$goods_ids,
+                'goods_ids_flag'=>$goods_ids?1:0,
+                'apply_amount'=>$refund_amount,
+                'invoice_no'=>$invoice_no,
+                'dl_id'=>intval($delivery_name[0]),
+                'dl_name'=>trim($delivery_name[1]),
+                'dl_code'=>trim($delivery_name[2]),
+                'refund_amount'=>0,
+                'create_time'=>gmtime(),
+                'pay_time'=>0,
+                'status'=>0,
+                'closed'=>0,
+                'type'=>1,//1:代表申请退款退货 2：代表代发申请补邮
+            );
+
+            /* //开始数据库事务
+            $db_transaction_begin = db()->query("START TRANSACTION");
+            if($db_transaction_begin === false)
+            {
+                $this->pop_warning('fail_caozuo');
+                return;
+            }
+            $db_transaction_success = true;//默认事务执行成功，不用回滚
+            $db_transaction_reason = '';//回滚的原因 */
+
+
+            $model_orderrefund=& m('orderrefund');
+            $affect_id = $model_orderrefund->add($data);
+            if(empty($affect_id) || $model_orderrefund->has_error())
+            {
+                $this->pop_warning($model_orderrefund->get_error());
+                return;
+                //$db_transaction_success = false;
+                //$db_transaction_reason = 'write_db_failed';
+            }
+
+            /*如果订单是已完成的，则要冻结申请资金*/
+            if($order_info['status'] == ORDER_FINISHED)
+            {
+                include_once(ROOT_PATH.'/app/fakemoney.app.php');
+                $fakemoneyapp = new FakeMoneyApp();
+                $affect_result = $fakemoneyapp->manuFro($order_info['bh_id'],$refund_amount);
+                if($affect_result === false)
+                {
+                    //$db_transaction_success = false;
+                    //$db_transaction_reason = 'frozen_failed';
+                }
+            }
+
+            /* if($db_transaction_success === false)
+            {
+                db()->query("ROLLBACK");//回滚
+            }
+            else
+            {
+                db()->query("COMMIT");//提交
+            }
+
+            //db()->query("END");
+            if($db_transaction_success === false)
+            {
+                $this->pop_warning($db_transaction_reason);
+                return;
+            } */
+
+
+            //$refund_message = Lang::get('refund_message').$order_info['order_sn'];
+            /* 连接用户系统 */
+            /*  $ms =& ms();
+            $msg_id = $ms->pm->send($this->visitor->get('user_id'), array($order_info['bh_id']), '', $refund_message); */
+
+            /* 发送给卖家订单取消通知 */
+            //$model_member =& m('member');
+            //$seller_info   = $model_member->get($order_info['bh_id']);
+            /*短信通知*/
+            //$this->sendSaleSms($seller_info['phone_mob'], $refund_message);
+            /* $mail = get_mail('toseller_apply_refund_notify', array('order' => $order_info, 'reason' => $_POST['refund_reason']));
+            $this->_mailto($seller_info['email'], addslashes($mail['subject']), $refund_message);  */
+
+            $new_data = array(
+                    'status'    => Lang::get('apply_refund'),
+                    'actions'   => array(), //取消订单后就不能做任何操作了
+            );
+
+            $this->pop_warning('ok');
+        }
+
     }
-
+
     /**
      * 处理补收差价
      */
     function applied_fee()
     {
-       $order_id = isset($_GET['order_id']) ? intval($_GET['order_id']) : 0;
-       if (!$order_id)
-       {
-               echo Lang::get('no_such_order');
-               return;
-       }
-       $model_order    =&  m('order');
-       $model_orderrefund = & m('orderrefund');
-       /* 只有已付款,已发货、已完成的订单可以补收差价*/
-       $order_info     = $model_order->get("order_id={$order_id}  AND buyer_id=" . $this->visitor->get('user_id')." AND status " . db_create_in(array(ORDER_ACCEPTED,ORDER_SHIPPED,ORDER_FINISHED)));
-       if (empty($order_info))
-       {
-               echo Lang::get('no_such_order');
-               return;
-       }
-       $refund_result=$model_orderrefund->find(array(
-                       'conditions'=>'order_id='.$order_info['order_id'].' AND sender_id='.$order_info['bh_id'].' AND receiver_id='.$order_info['buyer_id'].' AND status=0 AND closed=0',
-       ));
-       if(count($refund_result) != 1)
-       {
-               echo Lang::get('feifashenqi');
-               return ;
-       }
-       if (!IS_POST)
-       {
-               header('Content-Type:text/html;charset=' . CHARSET);
-               $this->assign('order', $order_info);
-               $this->assign('refund',current($refund_result));
-               $this->display('buyer_order.applied_fee.html');
-       }
-       else
-       {
-
-               $refund_agree = isset($_POST['agree'])?intval(trim($_POST['agree'])):0;
-               $zf_pass = isset($_POST['zf_pass'])?trim($_POST['zf_pass']):'';
-               if($refund_agree == 0)
-               {
-                       return;
-               }
-               if(empty($zf_pass) && $refund_agree==1)
-               {
-                       return;
-               }
-               $refund_result = current($refund_result);
-               //开始转账
-               if($refund_agree == 1)
-               {
-                       include_once(ROOT_PATH.'/app/my_money.app.php');
-                       $my_moneyapp = new My_moneyApp();
-                       $my_money_result=$my_moneyapp->to_user_withdraw($refund_result['sender_name'],$refund_result['apply_amount'], $order_id,$order_info['order_sn'],$zf_pass);
-                       if($my_money_result !== true)
-                       {
-                               //$this->pop_warning(Lang::get('refund_failed'));
-                               $this->pop_warning($my_money_result);
-                               return;
-                       }
-                       $data=array(
-                                       'order_id'=>$order_info['order_id'],
-                                       'order_sn'=>$order_info['order_sn'],
-                                       'refund_amount'=>$refund_result['apply_amount'],
-                                       'pay_time'=>gmtime(),
-                                       'status'=>$refund_agree,
-                                       'closed'=>0
-                       );
-                       $refund_message = Lang::get('refund_message1').$order_info['order_sn'].','.$refund_result['apply_amount'];
-               }
-
-               if($refund_agree == 2)
-               {
-                       $data=array(
-                                       'order_id'=>$order_info['order_id'],
-                                       'order_sn'=>$order_info['order_sn'],
-                                       'status'=>$refund_agree,
-                                       'closed'=>0
-                       );
-                       $refund_message = Lang::get('refund_message_disagree').$order_info['order_sn'].','.$refund_result['apply_amount'];
-               }
-               $model_orderrefund->edit($refund_result['id'],$data);
-               if($model_orderrefund->has_error())
-               {
-                       $this->pop_warning($model_orderrefund->get_error());
-                       return;
-               }
-
-               /* 连接用户系统 */
-               /* $ms =& ms();
-               $msg_id = $ms->pm->send($this->visitor->get('user_id'), array($order_info['bh_id']), '', $refund_message); */
-
-               /* $new_data = array(
-                'status'    => Lang::get('apply_refund'),
-                               'actions'   => array(), //取消订单后就不能做任何操作了
-               ); */
-               /* 记录订单操作日志 */
-               $order_log =& m('orderlog');
-               $order_log->add(array(
-                               'order_id'  => $order_info['order_id'],
-                               'operator'  => addslashes($this->visitor->get('user_name')),
-                               'order_status' => order_status($order_info['status']),
-                               'changed_status' => order_status($order_info['status']),
-                               'remark'    => $refund_message,
-                               'log_time'  => gmtime(),
-               ));
-
-               /* 发送给卖家订单转账通知 */
-               $model_member =& m('member');
-               $seller_info   = $model_member->get($order_info['bh_id']);
-               /*短信通知*/
-               $this->sendSaleSms($seller_info['phone_mob'], $refund_message);
-               //$mail = get_mail('toseller_apply_fee_notify', array('order' => $order_info, 'reason' =>$refund_message ));
-               //$this->_mailto($seller_info['email'], addslashes($mail['subject']), $refund_message);
-
-               $this->pop_warning('ok');
-       }
+        $order_id = isset($_GET['order_id']) ? intval($_GET['order_id']) : 0;
+        if (!$order_id)
+        {
+            echo Lang::get('no_such_order');
+            return;
+        }
+        $model_order    =&  m('order');
+        $model_orderrefund = & m('orderrefund');
+        /* 只有已付款,已发货、已完成的订单可以补收差价*/
+        $order_info     = $model_order->get("order_id={$order_id}  AND buyer_id=" . $this->visitor->get('user_id')." AND status " . db_create_in(array(ORDER_ACCEPTED,ORDER_SHIPPED,ORDER_FINISHED)));
+        if (empty($order_info))
+        {
+            echo Lang::get('no_such_order');
+            return;
+        }
+        $refund_result=$model_orderrefund->find(array(
+                'conditions'=>'order_id='.$order_info['order_id'].' AND sender_id='.$order_info['bh_id'].' AND receiver_id='.$order_info['buyer_id'].' AND status=0 AND closed=0',
+        ));
+        if(count($refund_result) != 1)
+        {
+            echo Lang::get('feifashenqi');
+            return ;
+        }
+        if (!IS_POST)
+        {
+            header('Content-Type:text/html;charset=' . CHARSET);
+            $this->assign('order', $order_info);
+            $this->assign('refund',current($refund_result));
+            $this->display('buyer_order.applied_fee.html');
+        }
+        else
+        {
+
+            $refund_agree = isset($_POST['agree'])?intval(trim($_POST['agree'])):0;
+            $zf_pass = isset($_POST['zf_pass'])?trim($_POST['zf_pass']):'';
+            if($refund_agree == 0)
+            {
+                return;
+            }
+            if(empty($zf_pass) && $refund_agree==1)
+            {
+                return;
+            }
+            $refund_result = current($refund_result);
+            //开始转账
+            if($refund_agree == 1)
+            {
+                include_once(ROOT_PATH.'/app/my_money.app.php');
+                $my_moneyapp = new My_moneyApp();
+                $my_money_result=$my_moneyapp->to_user_withdraw($refund_result['sender_name'],$refund_result['apply_amount'], $order_id,$order_info['order_sn'],$zf_pass);
+                if($my_money_result !== true)
+                {
+                    //$this->pop_warning(Lang::get('refund_failed'));
+                    $this->pop_warning($my_money_result);
+                    return;
+                }
+                $data=array(
+                        'order_id'=>$order_info['order_id'],
+                        'order_sn'=>$order_info['order_sn'],
+                        'refund_amount'=>$refund_result['apply_amount'],
+                        'pay_time'=>gmtime(),
+                        'status'=>$refund_agree,
+                        'closed'=>0
+                );
+                $refund_message = Lang::get('refund_message1').$order_info['order_sn'].','.$refund_result['apply_amount'];
+            }
+
+            if($refund_agree == 2)
+            {
+                $data=array(
+                        'order_id'=>$order_info['order_id'],
+                        'order_sn'=>$order_info['order_sn'],
+                        'status'=>$refund_agree,
+                        'closed'=>0
+                );
+                $refund_message = Lang::get('refund_message_disagree').$order_info['order_sn'].','.$refund_result['apply_amount'];
+            }
+            $model_orderrefund->edit($refund_result['id'],$data);
+            if($model_orderrefund->has_error())
+            {
+                $this->pop_warning($model_orderrefund->get_error());
+                return;
+            }
+
+            /* 连接用户系统 */
+            /* $ms =& ms();
+            $msg_id = $ms->pm->send($this->visitor->get('user_id'), array($order_info['bh_id']), '', $refund_message); */
+
+            /* $new_data = array(
+             'status'    => Lang::get('apply_refund'),
+                    'actions'   => array(), //取消订单后就不能做任何操作了
+            ); */
+            /* 记录订单操作日志 */
+            $order_log =& m('orderlog');
+            $order_log->add(array(
+                    'order_id'  => $order_info['order_id'],
+                    'operator'  => addslashes($this->visitor->get('user_name')),
+                    'order_status' => order_status($order_info['status']),
+                    'changed_status' => order_status($order_info['status']),
+                    'remark'    => $refund_message,
+                    'log_time'  => gmtime(),
+            ));
+
+            /* 发送给卖家订单转账通知 */
+            $model_member =& m('member');
+            $seller_info   = $model_member->get($order_info['bh_id']);
+            /*短信通知*/
+            $this->sendSaleSms($seller_info['phone_mob'], $refund_message);
+            //$mail = get_mail('toseller_apply_fee_notify', array('order' => $order_info, 'reason' =>$refund_message ));
+            //$this->_mailto($seller_info['email'], addslashes($mail['subject']), $refund_message);
+
+            $this->pop_warning('ok');
+        }
     }
-
+
     function unicodeToUtf8($str,$order="little")
     {
-       $utf8string ="";
-       $n=strlen($str);
-       for ($i=0;$i<$n ;$i++ )
-       {
-               if ($order=="little")
-               {
-                       $val = str_pad(dechex(ord($str[$i+1])), 2, 0, STR_PAD_LEFT) .
-                       str_pad(dechex(ord($str[$i])),      2, 0, STR_PAD_LEFT);
-               }
-               else
-               {
-                       $val = str_pad(dechex(ord($str[$i])),      2, 0, STR_PAD_LEFT) .
-                       str_pad(dechex(ord($str[$i+1])), 2, 0, STR_PAD_LEFT);
-               }
-               $val = intval($val,16); // 由于上次的.连接，导致$val变为字符串，这里得转回来。
-               $i++; // 两个字节表示一个unicode字符。
-               $c = "";
-               if($val < 0x7F)
-               { // 0000-007F
-                       $c .= chr($val);
-               }
-               elseif($val < 0x800)
-               { // 0080-07F0
-                       $c .= chr(0xC0 | ($val / 64));
-                       $c .= chr(0x80 | ($val % 64));
-               }
-               else
-               { // 0800-FFFF
-                       $c .= chr(0xE0 | (($val / 64) / 64));
-                       $c .= chr(0x80 | (($val / 64) % 64));
-                       $c .= chr(0x80 | ($val % 64));
-               }
-               $utf8string .= $c;
-       }
-       /* 去除bom标记 才能使内置的iconv函数正确转换 */
-       if (ord(substr($utf8string,0,1)) == 0xEF && ord(substr($utf8string,1,2)) == 0xBB && ord(substr($utf8string,2,1)) == 0xBF)
-       {
-               $utf8string = substr($utf8string,3);
-       }
-       return $utf8string;
+        $utf8string ="";
+        $n=strlen($str);
+        for ($i=0;$i<$n ;$i++ )
+        {
+            if ($order=="little")
+            {
+                $val = str_pad(dechex(ord($str[$i+1])), 2, 0, STR_PAD_LEFT) .
+                str_pad(dechex(ord($str[$i])),      2, 0, STR_PAD_LEFT);
+            }
+            else
+            {
+                $val = str_pad(dechex(ord($str[$i])),      2, 0, STR_PAD_LEFT) .
+                str_pad(dechex(ord($str[$i+1])), 2, 0, STR_PAD_LEFT);
+            }
+            $val = intval($val,16); // 由于上次的.连接，导致$val变为字符串，这里得转回来。
+            $i++; // 两个字节表示一个unicode字符。
+            $c = "";
+            if($val < 0x7F)
+            { // 0000-007F
+                $c .= chr($val);
+            }
+            elseif($val < 0x800)
+            { // 0080-07F0
+                $c .= chr(0xC0 | ($val / 64));
+                $c .= chr(0x80 | ($val % 64));
+            }
+            else
+            { // 0800-FFFF
+                $c .= chr(0xE0 | (($val / 64) / 64));
+                $c .= chr(0x80 | (($val / 64) % 64));
+                $c .= chr(0x80 | ($val % 64));
+            }
+            $utf8string .= $c;
+        }
+        /* 去除bom标记 才能使内置的iconv函数正确转换 */
+        if (ord(substr($utf8string,0,1)) == 0xEF && ord(substr($utf8string,1,2)) == 0xBB && ord(substr($utf8string,2,1)) == 0xBF)
+        {
+            $utf8string = substr($utf8string,3);
+        }
+        return $utf8string;
     }
-
+
     /**
      * 导入订单,某些非淘宝卖家用户有大量订单导入
      * @author tanaiquan
@@ -1904,671 +1904,671 @@
     function im_order()
     {
         return;//by tanaiquan 2015-09-14 20:00
-       if (!IS_POST)
-       {
-               $this->_config_seo('title', Lang::get('member_center') . ' - ' . Lang::get('my_im_order'));
-               $this->_curlocal(LANG::get('member_center'), 'index.php?app=member',
-                               LANG::get('im_buyer'), 'index.php?app=buyer_order&act=im_order',
-                               LANG::get('my_im_order'));
-               $this->_curitem('buyer_order');
-               $this->_curmenu('my_im_order');
-               $this->display('import.my_order.html');
-       }
-       else
-       {
-               //检查是否最大上传数
-               $this->_check_upload_goods_amount();
-               //设置地区信息
-               setlocale(LC_ALL, 'zh_CN');
-
-               $file = $_FILES['csv'];
-               if ($file['error'] != UPLOAD_ERR_OK)
-               {
-                       $this->show_warning('select_file');
-                       return;
-               }
-               import('uploader.lib'); // 导入上传类
-               $uploader = new Uploader();
-               $uploader->allowed_type('csv'); // 限制文件类型
-               $uploader->allowed_size(SIZE_CSV_TAOBAO); // 限制单个文件大小2M
-               $uploader->addFile($file);
-               if (!$uploader->file_info())
-               {
-                       $this->show_warning($uploader->get_error());
-                       return;
-               }
-               /* 初始化统计 */
-               $num_image = 0; // 需要导入的图片数量
-               $num_record = 0; // 成功导入的记录条数
-
-               //$csv_string = $this->unicodeToUtf8(file_get_contents($file['tmp_name']));
-               //$csv_string = addslashes($csv_string); // 必须在转码后进行引号转义
-               //dump(mb_detect_encoding($csv_string,array('ascii','gbk','gb2312','utf-8')));
-               //$records = $this->_parse_order_csv($csv_string);
-               //dump($records);
-
-               $records = $this->_parse_csv($file['tmp_name']);
-               //dump($records);
-               //$handle=fopen($file['tmp_name'], 'r');
-               //$records = $this->input_csv($handle);
-               if ($this->has_error())
-               {
-                       $this->show_warning($this->get_error());
-                       return;
-               }
-               if(count($records) < 1)
-               {
-                       $this->show_warning('csv_empty'); // 欲导入的字段列数跟实际CSV文件中列数不符
-                       return false;
-               }
-               //fclose($handle);
-               //records 全部是utf-8
-               //验证订单商品的有效性
-               $this->_check_import_orders_goods($records);
-               //组合成订单
-               $im_orders = $this->_generate_import_orders($records );
-               /* $mmmmmm = $this->_order_fields();
-               dump(mb_detect_encoding($mmmmmm['order_sn'],array('ascii','gbk','gb2312','utf-8'))); */
-			//dump($im_orders);
-               //加入数据库
-               $orderVendorMod = &m('ordervendor');
-               $goodsVendorMod = &m('goodsvendor');
-               foreach ($im_orders as $order)
-               {
-                       $order_id = $orderVendorMod->add($order['order']);
-                       if($orderVendorMod->has_error())
-                       {
-                               $this->show_warning($orderVendorMod->get_error());
-                               return;
-                       }
-                       foreach ($order['order_goods'] as $goods)
-                       {
-                               $goods['order_id'] = $order_id;
-                               $goodsVendorMod->add($goods);
-                               if($goodsVendorMod->has_error())
-                               {
-                                       $this->show_warning($goodsVendorMod->get_error());
-                                       return;
-                               }
-                       }
-               }
-               //
-               $ms = & ms();
-               $ms->user->_local_edit($this->visitor->get('user_id'),array('upload_goods'=>count($records),'upload_goods_time'=>gmtime()));
-
-               $this->show_message('csv_import_success',
+        if (!IS_POST)
+        {
+            $this->_config_seo('title', Lang::get('member_center') . ' - ' . Lang::get('my_im_order'));
+            $this->_curlocal(LANG::get('member_center'), 'index.php?app=member',
+                    LANG::get('im_buyer'), 'index.php?app=buyer_order&act=im_order',
+                    LANG::get('my_im_order'));
+            $this->_curitem('buyer_order');
+            $this->_curmenu('my_im_order');
+            $this->display('import.my_order.html');
+        }
+        else
+        {
+            //检查是否最大上传数
+            $this->_check_upload_goods_amount();
+            //设置地区信息
+            setlocale(LC_ALL, 'zh_CN');
+
+            $file = $_FILES['csv'];
+            if ($file['error'] != UPLOAD_ERR_OK)
+            {
+                $this->show_warning('select_file');
+                return;
+            }
+            import('uploader.lib'); // 导入上传类
+            $uploader = new Uploader();
+            $uploader->allowed_type('csv'); // 限制文件类型
+            $uploader->allowed_size(SIZE_CSV_TAOBAO); // 限制单个文件大小2M
+            $uploader->addFile($file);
+            if (!$uploader->file_info())
+            {
+                $this->show_warning($uploader->get_error());
+                return;
+            }
+            /* 初始化统计 */
+            $num_image = 0; // 需要导入的图片数量
+            $num_record = 0; // 成功导入的记录条数
+
+            //$csv_string = $this->unicodeToUtf8(file_get_contents($file['tmp_name']));
+            //$csv_string = addslashes($csv_string); // 必须在转码后进行引号转义
+            //dump(mb_detect_encoding($csv_string,array('ascii','gbk','gb2312','utf-8')));
+            //$records = $this->_parse_order_csv($csv_string);
+            //dump($records);
+
+            $records = $this->_parse_csv($file['tmp_name']);
+            //dump($records);
+            //$handle=fopen($file['tmp_name'], 'r');
+            //$records = $this->input_csv($handle);
+            if ($this->has_error())
+            {
+                $this->show_warning($this->get_error());
+                return;
+            }
+            if(count($records) < 1)
+            {
+                $this->show_warning('csv_empty'); // 欲导入的字段列数跟实际CSV文件中列数不符
+                return false;
+            }
+            //fclose($handle);
+            //records 全部是utf-8
+            //验证订单商品的有效性
+            $this->_check_import_orders_goods($records);
+            //组合成订单
+            $im_orders = $this->_generate_import_orders($records );
+            /* $mmmmmm = $this->_order_fields();
+            dump(mb_detect_encoding($mmmmmm['order_sn'],array('ascii','gbk','gb2312','utf-8'))); */
+            //dump($im_orders);
+            //加入数据库
+            $orderVendorMod = &m('ordervendor');
+            $goodsVendorMod = &m('goodsvendor');
+            foreach ($im_orders as $order)
+            {
+                $order_id = $orderVendorMod->add($order['order']);
+                if($orderVendorMod->has_error())
+                {
+                    $this->show_warning($orderVendorMod->get_error());
+                    return;
+                }
+                foreach ($order['order_goods'] as $goods)
+                {
+                    $goods['order_id'] = $order_id;
+                    $goodsVendorMod->add($goods);
+                    if($goodsVendorMod->has_error())
+                    {
+                        $this->show_warning($goodsVendorMod->get_error());
+                        return;
+                    }
+                }
+            }
+            //
+            $ms = & ms();
+            $ms->user->_local_edit($this->visitor->get('user_id'),array('upload_goods'=>count($records),'upload_goods_time'=>gmtime()));
+
+            $this->show_message('csv_import_success',
                 'back_list', 'index.php?app=taobao_order&vendor=1');
-       }
+        }
     }
-
-	/**
-        * @param today_date
-        * @param upload_goods_date
-        */
-         function _check_upload_goods_amount() {
-		$ms =& ms();    //连接用户系统
-		$msUploadGoods = $ms->user->_local_get(array(
-				'conditions'=>'user_id='.$this->visitor->get('user_id'),
-				'fields'=>'upload_goods,upload_goods_time',
-		));
-		$upload_goods_time = empty($msUploadGoods)?0:intval($msUploadGoods['upload_goods_time']);
-		$isSameDate = false;
-		if($upload_goods_time > 0 )
-		{
-			$today_date = getdate(gmtime());
-			$upload_goods_date = getdate($upload_goods_time);
-			$isSameDate = $this->isSameDays($today_date, $upload_goods_date);
-		}
-		//先写死一人一日上传最大商品数200
-		if($isSameDate && $msUploadGoods['upload_goods'] >= 200)
-		{
-			$this->show_warning('upload_goods_limit');
-			return;
-		}
-	}

-
+    /**
+     * @param today_date
+     * @param upload_goods_date
+     */
+      function _check_upload_goods_amount() {
+        $ms =& ms();    //连接用户系统
+        $msUploadGoods = $ms->user->_local_get(array(
+                'conditions'=>'user_id='.$this->visitor->get('user_id'),
+                'fields'=>'upload_goods,upload_goods_time',
+        ));
+        $upload_goods_time = empty($msUploadGoods)?0:intval($msUploadGoods['upload_goods_time']);
+        $isSameDate = false;
+        if($upload_goods_time > 0 )
+        {
+            $today_date = getdate(gmtime());
+            $upload_goods_date = getdate($upload_goods_time);
+            $isSameDate = $this->isSameDays($today_date, $upload_goods_date);
+        }
+        //先写死一人一日上传最大商品数200
+        if($isSameDate && $msUploadGoods['upload_goods'] >= 200)
+        {
+            $this->show_warning('upload_goods_limit');
+            return;
+        }
+    }
+
+
     //判断两天是否是同一天
     function isSameDays($last_date,$this_date){
-       if(($last_date['year']===$this_date['year'])&&($this_date['yday']===$last_date['yday'])){
-               return true;
-       }else{
-               return false;
-       }
+        if(($last_date['year']===$this_date['year'])&&($this_date['yday']===$last_date['yday'])){
+            return true;
+        }else{
+            return false;
+        }
     }
-	/**
-        * @param records
-        */
-         function _generate_import_orders($records)
-         {
-               $ret_im_orders = array();
-		$im_orders = array();
-		$im_orders_keys = array();
-		/* for($i=1;$i<count($records);$i++)
-		{
-			if(!in_array($records[$i][0], $im_orders_keys))
-			{
-				$im_orders_keys[] = $records[$i][0];
-				$im_orders[$records[$i][0]][]=$records[$i];
-			}
-			else
-			{
-				$im_orders[$records[$i][0]][]=$records[$i];
-			}
-		} */
-		foreach ($records as $ik=>$iv)
-		{
-			if(!in_array($iv['order_sn'], $im_orders_keys))
-			{
-				$im_orders_keys[] = $iv['order_sn'];
-				$im_orders[$iv['order_sn']][]=$iv;
-			}
-			else
-			{
-				$im_orders[$iv['order_sn']][]=$iv;
-			}
-		}
-		foreach ($im_orders as $key=>$value)
-		{
-			$data = array();
-			$order_goods = array();
-			$data['order_sn']=$this->_gen_import_order_sn();
-			$data['seller_id']=$this->visitor->get('user_id');
-			$data['seller_name']=$this->visitor->get('user_name');
-			$data['buyer_name']=trim($value[0]['member']);
-			$data['receiver_name']=trim($value[0]['consignee_name']);
-			$data['receiver_mobile']=trim($value[0]['consignee_phone']);
-			$data['receiver_address']=trim($value[0]['consignee_address']);
-			$data['status'] = VENDOR_ORDER_UNHANDLED;
-			$data['vendor'] = 1; //代表excel导入
-			$data['add_time'] = gmtime();
-			$goods_amount = 0;
-			foreach ($value as $kk=>$vv)
-			{
-				$goods_amount += floatval($vv['price']) * intval($vv['goods_amount']);
-			}
-			$data['price'] = $goods_amount; //订单商品价格
-			$data['post_fee'] = floatval(trim($value[0]['post_fee'])); //邮费可以不用填写
-			$data['receiver_state'] = trim($value[0]['consignee_prov']);
-			$data['receiver_city'] = trim($value[0]['consignee_city']);
-			$data['receiver_district'] = trim($value[0]['consignee_dist']);
-			$data['receiver_zip'] = trim($value[0]['consignee_zipcode']);
-			$data['total_fee'] = $data['price'] + $data['post_fee'];
-			$ret_im_orders[$key]['order'] = $data;
-			foreach ($value as $kkk=>$vvv)
-			{
-				$im_goods = array();
-				$im_goods['goods_name'] = $vvv['goods_name'];
-				$im_goods['outer_iid'] = $vvv['market'].$vvv['dangkou'].'_P'.$vvv['price'].'_'.$vvv['sku'];
-				$im_goods['spec_name_1'] = Lang::get('color');
-				$im_goods['spec_value_1'] = trim($vvv['color']);
-				$im_goods['spec_name_2'] = Lang::get('size');
-				$im_goods['spec_value_2'] = trim($vvv['size']);
-				$im_goods['price'] = floatval(trim($vvv['price']));
-				$im_goods['num'] = intval(trim($vvv['goods_amount']));
-				$order_goods[] = $im_goods;
-			}
-			$ret_im_orders[$key]['order_goods']=$order_goods;
-		}
-		return $ret_im_orders;
-	}
-	/**
-        *    生成订单号
-        *
-        *    @author    Garbin
-        *    @return    string
-        */
-	function _gen_import_order_sn()
-	{
-		/* 选择一个随机的方案 */
-		mt_srand((double) microtime() * 1000000);
-		$timestamp = gmtime();
-		$y = date('y', $timestamp);
-		$z = date('z', $timestamp);
-		$h = date('H',$timestamp);
-		$i = date('i',$timestamp);
-		$s = date('s',$timestamp);
-		$order_sn = $y . str_pad($z, 3, '0', STR_PAD_LEFT) .$h.$i.$s. str_pad(mt_rand(1, 99999), 5, '0', STR_PAD_LEFT);
+    /**
+     * @param records
+     */
+      function _generate_import_orders($records)
+      {
+        $ret_im_orders = array();
+        $im_orders = array();
+        $im_orders_keys = array();
+        /* for($i=1;$i<count($records);$i++)
+        {
+            if(!in_array($records[$i][0], $im_orders_keys))
+            {
+                $im_orders_keys[] = $records[$i][0];
+                $im_orders[$records[$i][0]][]=$records[$i];
+            }
+            else
+            {
+                $im_orders[$records[$i][0]][]=$records[$i];
+            }
+        } */
+        foreach ($records as $ik=>$iv)
+        {
+            if(!in_array($iv['order_sn'], $im_orders_keys))
+            {
+                $im_orders_keys[] = $iv['order_sn'];
+                $im_orders[$iv['order_sn']][]=$iv;
+            }
+            else
+            {
+                $im_orders[$iv['order_sn']][]=$iv;
+            }
+        }
+        foreach ($im_orders as $key=>$value)
+        {
+            $data = array();
+            $order_goods = array();
+            $data['order_sn']=$this->_gen_import_order_sn();
+            $data['seller_id']=$this->visitor->get('user_id');
+            $data['seller_name']=$this->visitor->get('user_name');
+            $data['buyer_name']=trim($value[0]['member']);
+            $data['receiver_name']=trim($value[0]['consignee_name']);
+            $data['receiver_mobile']=trim($value[0]['consignee_phone']);
+            $data['receiver_address']=trim($value[0]['consignee_address']);
+            $data['status'] = VENDOR_ORDER_UNHANDLED;
+            $data['vendor'] = 1; //代表excel导入
+            $data['add_time'] = gmtime();
+            $goods_amount = 0;
+            foreach ($value as $kk=>$vv)
+            {
+                $goods_amount += floatval($vv['price']) * intval($vv['goods_amount']);
+            }
+            $data['price'] = $goods_amount; //订单商品价格
+            $data['post_fee'] = floatval(trim($value[0]['post_fee'])); //邮费可以不用填写
+            $data['receiver_state'] = trim($value[0]['consignee_prov']);
+            $data['receiver_city'] = trim($value[0]['consignee_city']);
+            $data['receiver_district'] = trim($value[0]['consignee_dist']);
+            $data['receiver_zip'] = trim($value[0]['consignee_zipcode']);
+            $data['total_fee'] = $data['price'] + $data['post_fee'];
+            $ret_im_orders[$key]['order'] = $data;
+            foreach ($value as $kkk=>$vvv)
+            {
+                $im_goods = array();
+                $im_goods['goods_name'] = $vvv['goods_name'];
+                $im_goods['outer_iid'] = $vvv['market'].$vvv['dangkou'].'_P'.$vvv['price'].'_'.$vvv['sku'];
+                $im_goods['spec_name_1'] = Lang::get('color');
+                $im_goods['spec_value_1'] = trim($vvv['color']);
+                $im_goods['spec_name_2'] = Lang::get('size');
+                $im_goods['spec_value_2'] = trim($vvv['size']);
+                $im_goods['price'] = floatval(trim($vvv['price']));
+                $im_goods['num'] = intval(trim($vvv['goods_amount']));
+                $order_goods[] = $im_goods;
+            }
+            $ret_im_orders[$key]['order_goods']=$order_goods;
+        }
+        return $ret_im_orders;
+    }
+    /**
+     *    生成订单号
+     *
+     *    @author    Garbin
+     *    @return    string
+     */
+    function _gen_import_order_sn()
+    {
+        /* 选择一个随机的方案 */
+        mt_srand((double) microtime() * 1000000);
+        $timestamp = gmtime();
+        $y = date('y', $timestamp);
+        $z = date('z', $timestamp);
+        $h = date('H',$timestamp);
+        $i = date('i',$timestamp);
+        $s = date('s',$timestamp);
+        $order_sn = $y . str_pad($z, 3, '0', STR_PAD_LEFT) .$h.$i.$s. str_pad(mt_rand(1, 99999), 5, '0', STR_PAD_LEFT);

-		$model_ordervender =& m('ordervendor');
-		$orders = $model_ordervender->find('order_sn=' . $order_sn);
-		if (empty($orders))
-		{
-			/* 否则就使用这个订单号 */
-			return $order_sn;
-		}
-
-		/* 如果有重复的，则重新生成 */
-		return $this->_gen_import_order_sn();
-	}
+        $model_ordervender =& m('ordervendor');
+        $orders = $model_ordervender->find('order_sn=' . $order_sn);
+        if (empty($orders))
+        {
+            /* 否则就使用这个订单号 */
+            return $order_sn;
+        }

-	/**
-        * @param records
-        */
-        function _check_import_orders_goods($records)
-        {
-               $import_fields = $this->_order_fields();
-               //$import_fields = array_values($import_fields);
-               $import_order_flag = array();
-
-               foreach ($records as $key=>$line)
-               {
-                       foreach ($line as $kk=>$vv)
-                       {
-                               if($kk == 'order_sn' && !in_array($vv, $import_order_flag))
-                               {
-                                       $import_order_flag[] = $vv;
-                                       if(in_array($kk, array('delivery','post_fee','member','consignee_name','consignee_phone','consignee_prov','consignee_city','consignee_dist','consignee_address',
+        /* 如果有重复的，则重新生成 */
+        return $this->_gen_import_order_sn();
+    }
+
+    /**
+     * @param records
+     */
+     function _check_import_orders_goods($records)
+     {
+        $import_fields = $this->_order_fields();
+        //$import_fields = array_values($import_fields);
+        $import_order_flag = array();
+
+        foreach ($records as $key=>$line)
+        {
+            foreach ($line as $kk=>$vv)
+            {
+                if($kk == 'order_sn' && !in_array($vv, $import_order_flag))
+                {
+                    $import_order_flag[] = $vv;
+                    if(in_array($kk, array('delivery','post_fee','member','consignee_name','consignee_phone','consignee_prov','consignee_city','consignee_dist','consignee_address',
             'consignee_zipcode' )) && empty($vv))
-                                       {
-                                               $this->show_warning(sprintf(Lang::get('csv_line_wrong'),$key,$vv));
-                                               return;
-                                       }
-                               }
-                               if(in_array($kk, array('order_sn','market','floor','dangkou','sku','color','size','price','goods_amount')) && empty($vv))
-                               {
-                                       $this->show_warning(sprintf(Lang::get('csv_line_wrong'),$key,$vv));
-                                       return;
-                               }
-                       }
-               }
-
-
-		//数据合法性检查
-
-	}
+                    {
+                        $this->show_warning(sprintf(Lang::get('csv_line_wrong'),$key,$vv));
+                        return;
+                    }
+                }
+                if(in_array($kk, array('order_sn','market','floor','dangkou','sku','color','size','price','goods_amount')) && empty($vv))
+                {
+                    $this->show_warning(sprintf(Lang::get('csv_line_wrong'),$key,$vv));
+                    return;
+                }
+            }
+        }

-
+
+        //数据合法性检查
+
+    }
+
+
     /* 解析上传订单CSV数据 */
     function _parse_order_csv($csv_string)
     {
-       /* 定义CSV文件中几个标识性的字符的ascii码值 */
-       define('ORD_SPACE', 32); // 空格
-       define('ORD_QUOTE', 34); // 双引号
-       define('ORD_TAB',    9); // 制表符
-       define('ORD_N',     10); // 换行\n
-       define('ORD_R',     13); // 换行\r
-       define('ORD_D', 44);//逗号 add by tanaiquan
-
-       /* 字段信息 */
-       $import_fields = $this->_order_fields(); // 需要导入的字段在CSV中显示的名称
-       $fields_cols = array(); // 每个字段所在CSV中的列序号，从0开始算
-       $csv_col_num = 0; // csv文件总列数
-
-       $pos = 0; // 当前的字符偏移量
-       $status = 0; // 0标题未开始 1标题已开始
-       $title_pos = 0; // 标题开始位置
-       $records = array(); // 记录集
-       $field = 0; // 字段号
-       $start_pos = 0; // 字段开始位置
-       $field_status = 0; // 0未开始 1双引号字段开始 2无双引号字段开始
-       $line =0; // 数据行号
-       while($pos < strlen($csv_string))
-       {
-               $t = ord($csv_string[$pos]); // 每个UTF-8字符第一个字节单元的ascii码
-               $next = ord($csv_string[$pos + 1]);
-               $next2 = ord($csv_string[$pos + 2]);
-               $next3 = ord($csv_string[$pos + 3]);
-               //dump($t);
-               if ($status == 0 && !in_array($t, array(ORD_SPACE, ORD_TAB, ORD_N, ORD_R)))
-               {
-                       $status = 1;
-                       $title_pos = $pos;
-               }
-
-               if ($status == 1)
-               {
-                       if ($field_status == 0 && $t== ORD_N)
-                       {
-                               static $flag = null;
-                               if ($flag === null)
-                               {
-                                       $title_str = substr($csv_string, $title_pos, $pos - $title_pos);
-                                       $title_arr = explode("\t", trim($title_str));
-                                       $fields_cols = $this->_order_fields_cols($title_arr, $import_fields);
-                                       if (count($fields_cols) != count($import_fields))
-                                       {
-                                               $csv_string = substr($csv_string,$pos - $title_pos);
-                                               continue;
-                                               $this->_error('csv_fields_error'); // 欲导入的字段列数跟实际CSV文件中列数不符
-                                               return false;
-                                       }
-                                       $csv_col_num = count($title_arr); // csv总列数
-                                       $flag = 1;
-                               }
-
-                               if ($next == ORD_QUOTE)
-                               {
-                                       $field_status = 1; // 引号数据单元开始
-                                       $start_pos = $pos = $pos + 2; // 数据单元开始位置(相对\n偏移+2)
-                               }
-                               else
-                               {
-                                       $field_status = 2; // 无引号数据单元开始
-                                       $start_pos = $pos = $pos + 1; // 数据单元开始位置(相对\n偏移+1)
-                               }
-                               continue;
-                       }
-
-                       if($field_status == 1 && $t == ORD_QUOTE && in_array($next, array(ORD_N, ORD_R, ORD_TAB))) // 引号+换行 或 引号+\t
-                       {
-                               $records[$line][$field] = addslashes(substr($csv_string, $start_pos, $pos - $start_pos));
-                               $field++;
-                               if ($field == $csv_col_num)
-                               {
-                                       $line++;
-                                       $field = 0;
-                                       $field_status = 0;
-                                       continue;
-                               }
-                               if (($next == ORD_N && $next2 == ORD_QUOTE) || ($next == ORD_TAB && $next2 == ORD_QUOTE) || ($next == ORD_R && $next2 == ORD_QUOTE))
-                               {
-                                       $field_status = 1;
-                                       $start_pos = $pos = $pos + 3;
-                                       continue;
-                               }
-                               if (($next == ORD_N && $next2 != ORD_QUOTE) || ($next == ORD_TAB && $next2 != ORD_QUOTE) || ($next == ORD_R && $next2 != ORD_QUOTE))
-                               {
-                                       $field_status = 2;
-                                       $start_pos = $pos = $pos + 2;
-                                       continue;
-                               }
-                               if ($next == ORD_R && $next2 == ORD_N && $next3 == ORD_QUOTE)
-                               {
-                                       $field_status = 1;
-                                       $start_pos = $pos = $pos + 4;
-                                       continue;
-                               }
-                               if ($next == ORD_R && $next2 == ORD_N && $next3 != ORD_QUOTE)
-                               {
-                                       $field_status = 2;
-                                       $start_pos = $pos = $pos + 3;
-                                       continue;
-                               }
-                       }
-
-                       if($field_status == 2 && in_array($t, array(ORD_N, ORD_R, ORD_TAB))) // 换行 或 \t
-                       {
-                               $records[$line][$field] = addslashes(substr($csv_string, $start_pos, $pos - $start_pos));
-                               $field++;
-                               if ($field == $csv_col_num)
-                               {
-                                       $line++;
-                                       $field = 0;
-                                       $field_status = 0;
-                                       continue;
-                               }
-                               if (($t == ORD_N && $next == ORD_QUOTE) || ($t == ORD_TAB && $next == ORD_QUOTE) || ($t == ORD_R && $next == ORD_QUOTE))
-                               {
-                                       $field_status = 1;
-                                       $start_pos = $pos = $pos + 2;
-                                       continue;
-                               }
-                               if (($t == ORD_N && $next != ORD_QUOTE) || ($t == ORD_TAB && $next != ORD_QUOTE) || ($t == ORD_R && $next != ORD_QUOTE))
-                               {
-                                       $field_status = 2;
-                                       $start_pos = $pos = $pos + 1;
-                                       continue;
-                               }
-                               if ($t == ORD_R && $next == ORD_N && $next2 == ORD_QUOTE)
-                               {
-                                       $field_status = 1;
-                                       $start_pos = $pos = $pos + 3;
-                                       continue;
-                               }
-                               if ($t == ORD_R && $next == ORD_N && $next2 != ORD_QUOTE)
-                               {
-                                       $field_status = 2;
-                                       $start_pos = $pos = $pos + 2;
-                                       continue;
-                               }
-                       }
-               }
-
-               if($t > 0 && $t <= 127) {
-                       $pos++;
-               } elseif(192 <= $t && $t <= 223) {
-                       $pos += 2;
-               } elseif(224 <= $t && $t <= 239) {
-                       $pos += 3;
-               } elseif(240 <= $t && $t <= 247) {
-                       $pos += 4;
-               } elseif(248 <= $t && $t <= 251) {
-                       $pos += 5;
-               } elseif($t == 252 || $t == 253) {
-                       $pos += 6;
-               } else {
-                       $pos++;
-               }
-       }
-       $return = array();
-       foreach ($records as $key => $record)
-       {
-               foreach ($record as $k => $col)
-               {
-                       $col = trim($col); // 去掉数据两端的空格
-                       /* 对字段数据进行分别处理 */
-                       switch ($k)
-                       {
-                               case $fields_cols['description'] :  $return[$key]['description'] = str_replace(array("\\\"\\\"", "\"\""), array("\\\"", "\""), $col); break;
-                               case $fields_cols['goods_image'] :  $result = $this->_parse_taobao_image($col); $return[$key]['goods_image'] = $result['data']; $return[$key]['image_count'] = $result['count'];break;
-                               case $fields_cols['if_show'] :      $return[$key]['if_show'] = $col == 1 ? 0 : 1; break;
-                               case $fields_cols['goods_name'] :   $return[$key]['goods_name'] = $col; break;
-                               case $fields_cols['stock'] :        $return[$key]['stock'] = $col; break;
-                               case $fields_cols['price']:         $return[$key]['price'] = $col; break;
-                               case $fields_cols['recommended'] :  $return[$key]['recommended'] = $col; break;
-                               case $fields_cols['sale_attr'] :    $return[$key]['sale_attr'] = $col; break;
-                               case $fields_cols['sale_attr_alias'] :    $return[$key]['sale_attr_alias'] = $col; break;
-                               case $fields_cols['cid'] :          $return[$key]['cid'] = $col; break;
-                       }
-               }
-       }
-       return $return;
+        /* 定义CSV文件中几个标识性的字符的ascii码值 */
+        define('ORD_SPACE', 32); // 空格
+        define('ORD_QUOTE', 34); // 双引号
+        define('ORD_TAB',    9); // 制表符
+        define('ORD_N',     10); // 换行\n
+        define('ORD_R',     13); // 换行\r
+        define('ORD_D', 44);//逗号 add by tanaiquan
+
+        /* 字段信息 */
+        $import_fields = $this->_order_fields(); // 需要导入的字段在CSV中显示的名称
+        $fields_cols = array(); // 每个字段所在CSV中的列序号，从0开始算
+        $csv_col_num = 0; // csv文件总列数
+
+        $pos = 0; // 当前的字符偏移量
+        $status = 0; // 0标题未开始 1标题已开始
+        $title_pos = 0; // 标题开始位置
+        $records = array(); // 记录集
+        $field = 0; // 字段号
+        $start_pos = 0; // 字段开始位置
+        $field_status = 0; // 0未开始 1双引号字段开始 2无双引号字段开始
+        $line =0; // 数据行号
+        while($pos < strlen($csv_string))
+        {
+            $t = ord($csv_string[$pos]); // 每个UTF-8字符第一个字节单元的ascii码
+            $next = ord($csv_string[$pos + 1]);
+            $next2 = ord($csv_string[$pos + 2]);
+            $next3 = ord($csv_string[$pos + 3]);
+            //dump($t);
+            if ($status == 0 && !in_array($t, array(ORD_SPACE, ORD_TAB, ORD_N, ORD_R)))
+            {
+                $status = 1;
+                $title_pos = $pos;
+            }
+
+            if ($status == 1)
+            {
+                if ($field_status == 0 && $t== ORD_N)
+                {
+                    static $flag = null;
+                    if ($flag === null)
+                    {
+                        $title_str = substr($csv_string, $title_pos, $pos - $title_pos);
+                        $title_arr = explode("\t", trim($title_str));
+                        $fields_cols = $this->_order_fields_cols($title_arr, $import_fields);
+                        if (count($fields_cols) != count($import_fields))
+                        {
+                            $csv_string = substr($csv_string,$pos - $title_pos);
+                            continue;
+                            $this->_error('csv_fields_error'); // 欲导入的字段列数跟实际CSV文件中列数不符
+                            return false;
+                        }
+                        $csv_col_num = count($title_arr); // csv总列数
+                        $flag = 1;
+                    }
+
+                    if ($next == ORD_QUOTE)
+                    {
+                        $field_status = 1; // 引号数据单元开始
+                        $start_pos = $pos = $pos + 2; // 数据单元开始位置(相对\n偏移+2)
+                    }
+                    else
+                    {
+                        $field_status = 2; // 无引号数据单元开始
+                        $start_pos = $pos = $pos + 1; // 数据单元开始位置(相对\n偏移+1)
+                    }
+                    continue;
+                }
+
+                if($field_status == 1 && $t == ORD_QUOTE && in_array($next, array(ORD_N, ORD_R, ORD_TAB))) // 引号+换行 或 引号+\t
+                {
+                    $records[$line][$field] = addslashes(substr($csv_string, $start_pos, $pos - $start_pos));
+                    $field++;
+                    if ($field == $csv_col_num)
+                    {
+                        $line++;
+                        $field = 0;
+                        $field_status = 0;
+                        continue;
+                    }
+                    if (($next == ORD_N && $next2 == ORD_QUOTE) || ($next == ORD_TAB && $next2 == ORD_QUOTE) || ($next == ORD_R && $next2 == ORD_QUOTE))
+                    {
+                        $field_status = 1;
+                        $start_pos = $pos = $pos + 3;
+                        continue;
+                    }
+                    if (($next == ORD_N && $next2 != ORD_QUOTE) || ($next == ORD_TAB && $next2 != ORD_QUOTE) || ($next == ORD_R && $next2 != ORD_QUOTE))
+                    {
+                        $field_status = 2;
+                        $start_pos = $pos = $pos + 2;
+                        continue;
+                    }
+                    if ($next == ORD_R && $next2 == ORD_N && $next3 == ORD_QUOTE)
+                    {
+                        $field_status = 1;
+                        $start_pos = $pos = $pos + 4;
+                        continue;
+                    }
+                    if ($next == ORD_R && $next2 == ORD_N && $next3 != ORD_QUOTE)
+                    {
+                        $field_status = 2;
+                        $start_pos = $pos = $pos + 3;
+                        continue;
+                    }
+                }
+
+                if($field_status == 2 && in_array($t, array(ORD_N, ORD_R, ORD_TAB))) // 换行 或 \t
+                {
+                    $records[$line][$field] = addslashes(substr($csv_string, $start_pos, $pos - $start_pos));
+                    $field++;
+                    if ($field == $csv_col_num)
+                    {
+                        $line++;
+                        $field = 0;
+                        $field_status = 0;
+                        continue;
+                    }
+                    if (($t == ORD_N && $next == ORD_QUOTE) || ($t == ORD_TAB && $next == ORD_QUOTE) || ($t == ORD_R && $next == ORD_QUOTE))
+                    {
+                        $field_status = 1;
+                        $start_pos = $pos = $pos + 2;
+                        continue;
+                    }
+                    if (($t == ORD_N && $next != ORD_QUOTE) || ($t == ORD_TAB && $next != ORD_QUOTE) || ($t == ORD_R && $next != ORD_QUOTE))
+                    {
+                        $field_status = 2;
+                        $start_pos = $pos = $pos + 1;
+                        continue;
+                    }
+                    if ($t == ORD_R && $next == ORD_N && $next2 == ORD_QUOTE)
+                    {
+                        $field_status = 1;
+                        $start_pos = $pos = $pos + 3;
+                        continue;
+                    }
+                    if ($t == ORD_R && $next == ORD_N && $next2 != ORD_QUOTE)
+                    {
+                        $field_status = 2;
+                        $start_pos = $pos = $pos + 2;
+                        continue;
+                    }
+                }
+            }
+
+            if($t > 0 && $t <= 127) {
+                $pos++;
+            } elseif(192 <= $t && $t <= 223) {
+                $pos += 2;
+            } elseif(224 <= $t && $t <= 239) {
+                $pos += 3;
+            } elseif(240 <= $t && $t <= 247) {
+                $pos += 4;
+            } elseif(248 <= $t && $t <= 251) {
+                $pos += 5;
+            } elseif($t == 252 || $t == 253) {
+                $pos += 6;
+            } else {
+                $pos++;
+            }
+        }
+        $return = array();
+        foreach ($records as $key => $record)
+        {
+            foreach ($record as $k => $col)
+            {
+                $col = trim($col); // 去掉数据两端的空格
+                /* 对字段数据进行分别处理 */
+                switch ($k)
+                {
+                    case $fields_cols['description'] :  $return[$key]['description'] = str_replace(array("\\\"\\\"", "\"\""), array("\\\"", "\""), $col); break;
+                    case $fields_cols['goods_image'] :  $result = $this->_parse_taobao_image($col); $return[$key]['goods_image'] = $result['data']; $return[$key]['image_count'] = $result['count'];break;
+                    case $fields_cols['if_show'] :      $return[$key]['if_show'] = $col == 1 ? 0 : 1; break;
+                    case $fields_cols['goods_name'] :   $return[$key]['goods_name'] = $col; break;
+                    case $fields_cols['stock'] :        $return[$key]['stock'] = $col; break;
+                    case $fields_cols['price']:         $return[$key]['price'] = $col; break;
+                    case $fields_cols['recommended'] :  $return[$key]['recommended'] = $col; break;
+                    case $fields_cols['sale_attr'] :    $return[$key]['sale_attr'] = $col; break;
+                    case $fields_cols['sale_attr_alias'] :    $return[$key]['sale_attr_alias'] = $col; break;
+                    case $fields_cols['cid'] :          $return[$key]['cid'] = $col; break;
+                }
+            }
+        }
+        return $return;
     }
-
+
     /* 需要导入的字段在CSV中显示的名称 */
     function _order_fields()
     {
-       return array(
-                       'order_sn'		=>'订单编号',
-                       'goods_name'    =>'商品名称',
-                       'market'        =>'所在市场',
-                       'floor'			=>'所属楼层',
-                       'dangkou'		=>'档口地址',
-                       'sku'			=>'货号',
-                       'color'			=>'颜色',
-                       'size'			=>'尺码',
-                       'price'			=>'单价',
-                       'goods_amount'	=>'购买数量',
-                       'delivery'		=>'快递公司',
-                       'post_fee'		=>'快递费用',
-                       'member'		=>'会员名称',
-                       'consignee_name'=>'收件人姓名',
-                       'consignee_phone'=>'收件人电话',
-                       'consignee_prov' =>'收件人省',
-                       'consignee_city' =>'收件人市',
-                       'consignee_dist' =>'收件人区',
-                       'consignee_address'=>'收件人详细地址',
-                       'consignee_zipcode'=>'收件人邮编'
-       );
+        return array(
+                'order_sn'		=>'订单编号',
+                'goods_name'    =>'商品名称',
+                'market'        =>'所在市场',
+                'floor'			=>'所属楼层',
+                'dangkou'		=>'档口地址',
+                'sku'			=>'货号',
+                'color'			=>'颜色',
+                'size'			=>'尺码',
+                'price'			=>'单价',
+                'goods_amount'	=>'购买数量',
+                'delivery'		=>'快递公司',
+                'post_fee'		=>'快递费用',
+                'member'		=>'会员名称',
+                'consignee_name'=>'收件人姓名',
+                'consignee_phone'=>'收件人电话',
+                'consignee_prov' =>'收件人省',
+                'consignee_city' =>'收件人市',
+                'consignee_dist' =>'收件人区',
+                'consignee_address'=>'收件人详细地址',
+                'consignee_zipcode'=>'收件人邮编'
+        );
     }
-
+
     /* 每个字段所在CSV中的列序号，从0开始算 */
     function _order_fields_cols($title_arr, $import_fields)
     {
-       $fields_cols = array();
-       foreach ($import_fields as $k => $field)
-       {
-               $pos = array_search($field, $title_arr);
-               if ($pos !== false)
-               {
-                       $fields_cols[$k] = $pos;
-               }
-       }
-       return $fields_cols;
+        $fields_cols = array();
+        foreach ($import_fields as $k => $field)
+        {
+            $pos = array_search($field, $title_arr);
+            if ($pos !== false)
+            {
+                $fields_cols[$k] = $pos;
+            }
+        }
+        return $fields_cols;
     }
-
+
     function input_csv($handle)
     {
-       $out = array();
-       $n = 0;
-       while($data=fgetcsv($handle,10000))
-       {
-               $num = count($data);
-               for($i=0;$i<$num;$i++)
-               {
-                       $out[$n][$i] = $data[$i];
-               }
-               $n++;
-       }
-       //unicodeToUtf-8
-       foreach ($out as $k=>$v)
-       {
-               foreach ($v as $kk=>$vv)
-               {
-                       $encoding = mb_detect_encoding($vvv,array('ascii','gbk','gb2312','utf-8'));
-                       $out[$k][$kk]=ecm_iconv_deep($encoding, 'UTF-8', trim($vv));
-               }
-       }
-       //dump($out);
-       /* if (CHARSET =='big5')
-       {
-               $out = ecm_iconv_deep('utf-8', 'gbk', $out);//dump($chs);
-               $out = ecm_iconv_deep('gbk', 'big5', $out);
-       }
-       else
-       {
-               $out = ecm_iconv_deep('utf-8', CHARSET, $out);
-       } */
-       //assert
-       $import_fields = $this->_order_fields(); // 需要导入的字段在CSV中显示的名称
-       foreach ($import_fields as $kkk=>$vvv)
-       {
-               $encoding = mb_detect_encoding($vvv,array('ascii','gbk','gb2312','utf-8'));
-                       $import_fields[$kkk]=ecm_iconv_deep($encoding, 'utf-8', $vvv);
-       }
-       //$import_fields = ecm_iconv_deep('gbk', CHARSET, $import_fields);
+        $out = array();
+        $n = 0;
+        while($data=fgetcsv($handle,10000))
+        {
+            $num = count($data);
+            for($i=0;$i<$num;$i++)
+            {
+                $out[$n][$i] = $data[$i];
+            }
+            $n++;
+        }
+        //unicodeToUtf-8
+        foreach ($out as $k=>$v)
+        {
+            foreach ($v as $kk=>$vv)
+            {
+                $encoding = mb_detect_encoding($vvv,array('ascii','gbk','gb2312','utf-8'));
+                $out[$k][$kk]=ecm_iconv_deep($encoding, 'UTF-8', trim($vv));
+            }
+        }
+        //dump($out);
+        /* if (CHARSET =='big5')
+        {
+            $out = ecm_iconv_deep('utf-8', 'gbk', $out);//dump($chs);
+            $out = ecm_iconv_deep('gbk', 'big5', $out);
+        }
+        else
+        {
+            $out = ecm_iconv_deep('utf-8', CHARSET, $out);
+        } */
+        //assert
+        $import_fields = $this->_order_fields(); // 需要导入的字段在CSV中显示的名称
+        foreach ($import_fields as $kkk=>$vvv)
+        {
+            $encoding = mb_detect_encoding($vvv,array('ascii','gbk','gb2312','utf-8'));
+            $import_fields[$kkk]=ecm_iconv_deep($encoding, 'utf-8', $vvv);
+        }
+        //$import_fields = ecm_iconv_deep('gbk', CHARSET, $import_fields);
         //dump($import_fields);
-       //$fields_cols = $this->_order_fields_cols($out[0], $import_fields);
-       //dump($fields_cols);
-       if (count($out[0]) != count($import_fields))
-       {
-               $this->_error('csv_fields_error'); // 欲导入的字段列数跟实际CSV文件中列数不符
-               return false;
-       }
-       if(count($out) > 201)
-       {
-               $this->show_warning('upload_goods_amount_more');
-               return;
-       }
-       return $out;
+        //$fields_cols = $this->_order_fields_cols($out[0], $import_fields);
+        //dump($fields_cols);
+        if (count($out[0]) != count($import_fields))
+        {
+            $this->_error('csv_fields_error'); // 欲导入的字段列数跟实际CSV文件中列数不符
+            return false;
+        }
+        if(count($out) > 201)
+        {
+            $this->show_warning('upload_goods_amount_more');
+            return;
+        }
+        return $out;
     }
-
+
     function _parse_csv($data)
     {
-       /* 将文件按行读入数组，逐行进行解析 */
-       $line_number = 0;
-       $arr = array();
-       $goods_list = array();
-       $field_list = array_keys($this->_order_fields()); // 字段列表
-       //$data = file($_FILES['file']['tmp_name']);
-       $data = file($data);
-               foreach ($data AS $line)
-               {
-                       // 跳过第一行
-                       if ($line_number == 0)
-                       {
-                               $line_number++;
-                               continue;
-                       }
-
-                       // 转换编码
-
-                       $line = ecm_iconv_deep('gbk', 'UTF-8', $line);
-
-
-                       // 初始化
-                       $arr    = array();
-                       $buff   = '';
-                       $quote  = 0;
-                       $len    = strlen($line);
-                       for ($i = 0; $i < $len; $i++)
-                       {
-                               $char = $line[$i];
-
-                               if ('\\' == $char)
-                               {
-                                       $i++;
-                                       $char = $line[$i];
-
-                                       switch ($char)
-                                       {
-                                               case '"':
-                                                       $buff .= '"';
-                                                       break;
-                                               case '\'':
-                                                       $buff .= '\'';
-                                                       break;
-                                               case ',';
-                                                       $buff .= ',';
-                                                       break;
-                                               default:
-                                                       $buff .= '\\' . $char;
-                                                       break;
-                                       }
-                               }
-                               elseif ('"' == $char)
-                               {
-                                       if (0 == $quote)
-                                       {
-                                               $quote++;
-                                       }
-                                       else
-                                       {
-                                               $quote = 0;
-                                       }
-                               }
-                               elseif (',' == $char)
-                               {
-                                       if (0 == $quote)
-                                       {
-                                               if (!isset($field_list[count($arr)]))
-                                               {
-                                                       continue;
-                                               }
-                                               $field_name = $field_list[count($arr)];
-                                               $arr[$field_name] = trim($buff);
-                                               $buff = '';
-                                               $quote = 0;
-                                       }
-                                       else
-                                       {
-                                               $buff .= $char;
-                                       }
-                               }
-                               else
-                               {
-                                       $buff .= $char;
-                               }
-
-                               if ($i == $len - 1)
-                               {
-                                       if (!isset($field_list[count($arr)]))
-                                       {
-                                               continue;
-                                       }
-                                       $field_name = $field_list[count($arr)];
-                                       $arr[$field_name] = trim($buff);
-                               }
-                       }
-                       $goods_list[] = $arr;
-               }
-       return $goods_list;
+        /* 将文件按行读入数组，逐行进行解析 */
+        $line_number = 0;
+        $arr = array();
+        $goods_list = array();
+        $field_list = array_keys($this->_order_fields()); // 字段列表
+        //$data = file($_FILES['file']['tmp_name']);
+        $data = file($data);
+            foreach ($data AS $line)
+            {
+                // 跳过第一行
+                if ($line_number == 0)
+                {
+                    $line_number++;
+                    continue;
+                }
+
+                // 转换编码
+
+                $line = ecm_iconv_deep('gbk', 'UTF-8', $line);
+
+
+                // 初始化
+                $arr    = array();
+                $buff   = '';
+                $quote  = 0;
+                $len    = strlen($line);
+                for ($i = 0; $i < $len; $i++)
+                {
+                    $char = $line[$i];
+
+                    if ('\\' == $char)
+                    {
+                        $i++;
+                        $char = $line[$i];
+
+                        switch ($char)
+                        {
+                            case '"':
+                                $buff .= '"';
+                                break;
+                            case '\'':
+                                $buff .= '\'';
+                                break;
+                            case ',';
+                                $buff .= ',';
+                                break;
+                            default:
+                                $buff .= '\\' . $char;
+                                break;
+                        }
+                    }
+                    elseif ('"' == $char)
+                    {
+                        if (0 == $quote)
+                        {
+                            $quote++;
+                        }
+                        else
+                        {
+                            $quote = 0;
+                        }
+                    }
+                    elseif (',' == $char)
+                    {
+                        if (0 == $quote)
+                        {
+                            if (!isset($field_list[count($arr)]))
+                            {
+                                continue;
+                            }
+                            $field_name = $field_list[count($arr)];
+                            $arr[$field_name] = trim($buff);
+                            $buff = '';
+                            $quote = 0;
+                        }
+                        else
+                        {
+                            $buff .= $char;
+                        }
+                    }
+                    else
+                    {
+                        $buff .= $char;
+                    }
+
+                    if ($i == $len - 1)
+                    {
+                        if (!isset($field_list[count($arr)]))
+                        {
+                            continue;
+                        }
+                        $field_name = $field_list[count($arr)];
+                        $arr[$field_name] = trim($buff);
+                    }
+                }
+                $goods_list[] = $arr;
+            }
+        return $goods_list;
     }
-
-
-

+
+
+
 }

 ?>
Index: app/default.app.php
===================================================================
--- app/default.app.php	(revision 3919)
+++ app/default.app.php	(working copy)
@@ -2142,7 +2142,7 @@
             }
         }
     }
-
+
     /**
      * 展示广告，iframe
      */
Index: app/frontend.base.php
===================================================================
--- app/frontend.base.php	(revision 3919)
+++ app/frontend.base.php	(working copy)
@@ -311,7 +311,7 @@
      *    @param    none
      *    @return    void
      */
-    function jslang()
+    function jslang($trival)
     {
         $lang = Lang::fetch(lang_file('jslang'));
         parent::jslang($lang);
@@ -402,7 +402,7 @@
                 $len = count($args);
                 for ($i = 0; $i < $len; $i += 2)
                 {
-                    $curlocal[] = array(
+                    @$curlocal[] = array(
                         'text'  =>  $args[$i],
                         'url'   =>  $args[$i+1],
                     );
@@ -649,7 +649,7 @@
         $_member_submenu = $this->_get_member_submenu();
         foreach ($_member_submenu as $key => $value)
         {
-            $_member_submenu[$key]['text'] = $value['text'] ? $value['text'] : Lang::get($value['name']);
+            @$_member_submenu[$key]['text'] = $value['text'] ? $value['text'] : Lang::get($value['name']);
         }
         $this->assign('_member_submenu', $_member_submenu);
         $this->assign('_curmenu', $item);
Index: app/member.app.php
===================================================================
--- app/member.app.php	(revision 3919)
+++ app/member.app.php	(working copy)
@@ -732,7 +732,7 @@
     function authBack($nick, $fixed_prefix, $auth_info = null) {
         if ($nick) {
             $username = $fixed_prefix.$nick;
+            $fixed_password = FIXED_PASSWORD;
             $this->loginWithStoreIfPossible($nick, $auth_info);
             $this->loginWithTaobaoIfPossible($nick, $username, $fixed_password, $auth_info);
             $this->registerWithTaobaoIfPossible($nick, $username, $fixed_password, $auth_info);
Index: eccore/controller/app.base.php
===================================================================
--- eccore/controller/app.base.php	(revision 3919)
+++ eccore/controller/app.base.php	(working copy)
@@ -265,19 +265,19 @@
         }
         return $str;
     }
-
+
     /**
      *    首页静态化 获取视图
-     *
+     *
      *    @author    by tiq
      *    @param     string $n
      *    @return    string
      */
     function outhtml($n)
     {
-       $this->_init_view();
-       return $this->_view->outhtml($n);
-    }
+        $this->_init_view();
+        return $this->_view->outhtml($n);
+    }
 }

 ?>
\ No newline at end of file
Index: eccore/controller/message.base.php
===================================================================
--- eccore/controller/message.base.php	(revision 3919)
+++ eccore/controller/message.base.php	(working copy)
@@ -141,12 +141,12 @@

             put_log($errno, $errstr, $errfile, $errline); // 写入错误日志

-            $msg->display();
+            $msg->display(null);
             exit;
         }
         else
         {
-            $msg->display();
+            $msg->display(null);
         }
     }
     else if ($errno == E_NOTICE && (defined('DEBUG_MODE') && DEBUG_MODE > 0) )
@@ -294,7 +294,7 @@
      * @author  wj
      * @return  void
      */
-    function display()
+    function display($tpl)
     {
         $this->message = str_replace(ROOT_PATH, '', $this->message);

Index: eccore/ecmall.php
===================================================================
--- eccore/ecmall.php	(revision 3919)
+++ eccore/ecmall.php	(working copy)
@@ -48,7 +48,7 @@
 class ECMall
 {
     /* 启动 */
-    function startup($config = array())
+    static function startup($config = array())
     {
         /* 加载初始化文件 */
         require(ROOT_PATH . '/eccore/controller/app.base.php');     //基础控制器类
@@ -68,7 +68,7 @@
             $_POST  = addslashes_deep($_POST);
             $_COOKIE= addslashes_deep($_COOKIE);
         }
-		if(isset($_GET['id']) && !empty($_GET['id']))
+        if(isset($_GET['id']) && !empty($_GET['id']))
         {
             $_GET['id']=str_replace(' ','',$_GET['id']);
         }
@@ -79,12 +79,12 @@
         if(isset($_GET['sort']) && !empty($_GET['sort']))
         {
             $_GET['sort']=str_replace(' ','',$_GET['sort']);
-			$_GET['sort']=strtolower(str_replace('DESC', ' DESC',str_replace('ASC', ' ASC',trim($_GET['sort']))));
+            $_GET['sort']=strtolower(str_replace('DESC', ' DESC',str_replace('ASC', ' ASC',trim($_GET['sort']))));
         }
         if(isset($_POST['sort']) && !empty($_POST['sort']))
         {
             $_POST['sort']=str_replace(' ','',$_POST['sort']);
-			$_POST['sort']=strtolower(str_replace('DESC', ' DESC',str_replace('ASC', ' ASC',trim($_POST['sort']))));
+            $_POST['sort']=strtolower(str_replace('DESC', ' DESC',str_replace('ASC', ' ASC',trim($_POST['sort']))));
         }

         /* 请求转发 */
@@ -190,7 +190,7 @@
      *    @param     none
      *    @return    mixed
      */
-    function &get($key = '')
+    static function &get($key = '')
     {
         if (Lang::_valid_key($key) == false)
         {
@@ -209,7 +209,7 @@
      * @param string $key
      * @return bool
      */
-    function _valid_key($key)
+    static function _valid_key($key)
     {
         if (strpos($key, ' ') !== false)
         {
@@ -363,7 +363,8 @@
         if (!is_file($model_file))
         {
             /* 不存在该文件，则无法获取模型 */
-            return false;
+            $result = false;
+            return $result;
         }
         include_once($model_file);
         $model_name = ucfirst($model_name) . 'Model';
@@ -568,9 +569,9 @@

 function Psmb_init()
 {
-	import('init.lib');
-
-	return new Psmb_init();
+    import('init.lib');
+
+    return new Psmb_init();
 }

 /**
@@ -957,90 +958,90 @@
     return $db;
 }
 function &bbsdb() {
-	include_once(ROOT_PATH . '/eccore/model/mysql.php');
-	static $db = null;
-	if ($db === null)
-	{
-		$cfg = parse_url("mysql://wangpi51:51374b78b104@rdsqr7ne2m2ifjm.mysql.rds.aliyuncs.com:3306/wangpi51");
+    include_once(ROOT_PATH . '/eccore/model/mysql.php');
+    static $db = null;
+    if ($db === null)
+    {
+        $cfg = parse_url("mysql://wangpi51:51374b78b104@rdsqr7ne2m2ifjm.mysql.rds.aliyuncs.com:3306/wangpi51");

-		if ($cfg['scheme'] == 'mysql')
-		{
-			if (empty($cfg['pass']))
-			{
-				$cfg['pass'] = '';
-			}
-			else
-			{
-				$cfg['pass'] = urldecode($cfg['pass']);
-			}
-			$cfg ['user'] = urldecode($cfg['user']);
+        if ($cfg['scheme'] == 'mysql')
+        {
+            if (empty($cfg['pass']))
+            {
+                $cfg['pass'] = '';
+            }
+            else
+            {
+                $cfg['pass'] = urldecode($cfg['pass']);
+            }
+            $cfg ['user'] = urldecode($cfg['user']);

-			if (empty($cfg['path']))
-			{
-				trigger_error('Invalid database name.', E_USER_ERROR);
-			}
-			else
-			{
-				$cfg['path'] = str_replace('/', '', $cfg['path']);
-			}
+            if (empty($cfg['path']))
+            {
+                trigger_error('Invalid database name.', E_USER_ERROR);
+            }
+            else
+            {
+                $cfg['path'] = str_replace('/', '', $cfg['path']);
+            }

-			$charset = (CHARSET == 'utf-8') ? 'utf8' : CHARSET;
-			$db = new cls_mysql();
-			$db->cache_dir = ROOT_PATH. '/temp/query_caches/';
-			$db->connect($cfg['host']. ':' .$cfg['port'], $cfg['user'],
-					$cfg['pass'], $cfg['path'], $charset);
-		}
-		else
-		{
-			trigger_error('Unkown database type.', E_USER_ERROR);
-		}
-	}
+            $charset = (CHARSET == 'utf-8') ? 'utf8' : CHARSET;
+            $db = new cls_mysql();
+            $db->cache_dir = ROOT_PATH. '/temp/query_caches/';
+            $db->connect($cfg['host']. ':' .$cfg['port'], $cfg['user'],
+                    $cfg['pass'], $cfg['path'], $charset);
+        }
+        else
+        {
+            trigger_error('Unkown database type.', E_USER_ERROR);
+        }
+    }

-	return $db;
+    return $db;
 }

 function &sp_db()
 {
-	include_once(ROOT_PATH . '/eccore/model/mysql.php');
-	static $sp_db = null;
-	if ($sp_db === null)
-	{
-		$cfg = parse_url(DB_CONFIG);
+    include_once(ROOT_PATH . '/eccore/model/mysql.php');
+    static $sp_db = null;
+    if ($sp_db === null)
+    {
+        $cfg = parse_url(DB_CONFIG);

-		if ($cfg['scheme'] == 'mysql')
-		{
-			if (empty($cfg['pass']))
-			{
-				$cfg['pass'] = '';
-			}
-			else
-			{
-				$cfg['pass'] = urldecode($cfg['pass']);
-			}
-			$cfg ['user'] = urldecode($cfg['user']);
+        if ($cfg['scheme'] == 'mysql')
+        {
+            if (empty($cfg['pass']))
+            {
+                $cfg['pass'] = '';
+            }
+            else
+            {
+                $cfg['pass'] = urldecode($cfg['pass']);
+            }
+            $cfg ['user'] = urldecode($cfg['user']);

-			if (empty($cfg['path']))
-			{
-				trigger_error('Invalid database name.', E_USER_ERROR);
-			}
-			else
-			{
-				$cfg['path'] = str_replace('/', '', $cfg['path']);
-			}
+            if (empty($cfg['path']))
+            {
+                trigger_error('Invalid database name.', E_USER_ERROR);
+            }
+            else
+            {
+                $cfg['path'] = str_replace('/', '', $cfg['path']);
+            }

-			$charset = (CHARSET == 'utf-8') ? 'utf8' : CHARSET;
-			$sp_db = new cls_mysql();
-			$sp_db->cache_dir = ROOT_PATH. '/temp/query_caches/';
-			$sp_db->sp_connect($cfg['host']. ':' .$cfg['port'], $cfg['user'],
-					$cfg['pass'], $cfg['path']);
-		}
-		else
-		{
-			trigger_error('Unkown database type.', E_USER_ERROR);
-		}
-	}
+            $charset = (CHARSET == 'utf-8') ? 'utf8' : CHARSET;
+            $sp_db = new cls_mysql();
+            $sp_db->cache_dir = ROOT_PATH. '/temp/query_caches/';
+            $sp_db->sp_connect($cfg['host']. ':' .$cfg['port'], $cfg['user'],
+                    $cfg['pass'], $cfg['path']);
+        }
+        else
+        {
+            trigger_error('Unkown database type.', E_USER_ERROR);
+        }
+    }

-	return $sp_db;
+    return $sp_db;
 }

 /**
Index: eccore/model/model.base.php
===================================================================
--- eccore/model/model.base.php	(revision 3919)
+++ eccore/model/model.base.php	(working copy)
@@ -224,9 +224,9 @@

         /* 构造查询条件 */
         $conditions = $alias . '.' . $relation_info['foreign_key'] . ' ' . db_create_in($ids);   //主键值限定
-        $conditions .= $relation_info['ext_limit'] ?
+        $conditions .= @$relation_info['ext_limit'] ?
                 ' AND ' . $this->_getExtLimit($relation_info['ext_limit'], $alias) : '';
-        $conditions .= is_string($find_param['conditions']) ? ' AND ' . $find_param['conditions'] : '';
+        $conditions .= is_string(@$find_param['conditions']) ? ' AND ' . $find_param['conditions'] : '';
         $find_param['conditions'] = $conditions;


@@ -279,16 +279,16 @@
                 $id = $insert_id;
             }
         }
-        else
+        else
         { //由于主键不是自增，返回为true or false
-               if($ret_value)
-               {
-                       return true;
-               }
-               else
-               {
-                       return false;
-               }
+            if($ret_value)
+            {
+                return true;
+            }
+            else
+            {
+                return false;
+            }
         }

         return $id;
@@ -1002,7 +1002,8 @@
         if (!$src_fields_list) {
             $fields = '';
         }
-        $fields = preg_replace('/([a-zA-Z0-9_]+)\.([a-zA-Z0-9_*]+)/e', "\$this->_getFieldTable('\\1') . '.\\2'", $fields);
+        $fields = preg_replace_callback('/([a-zA-Z0-9_]+)\.([a-zA-Z0-9_*]+)/',
+                                        function ($m) {return $this->_getFieldTable($m[1]).'.'.$m[2];}, $fields);

         return $fields;
     }
@@ -1257,7 +1258,7 @@

                 /* 联合限制 */
                 $ext_limit = '';
-                $relation_info['ext_limit'] && $ext_limit = ' AND ' . $this->_getExtLimit($relation_info['ext_limit'], $model->alias); //须加上当前被关联表的别名，因为有可能存在多个JOIN，并且可能存在同名字段。
+                @$relation_info['ext_limit'] && $ext_limit = ' AND ' . $this->_getExtLimit($relation_info['ext_limit'], $model->alias); //须加上当前被关联表的别名，因为有可能存在多个JOIN，并且可能存在同名字段。

                 /* 获取参考键，默认是本表主键(直接拥有)，否则为间接拥有 */
                 $refer_key = isset($relation_info['refer_key']) ? $relation_info['refer_key'] : $this->prikey;
@@ -1287,7 +1288,7 @@
                 /* 连接中间表，本表主键=中间表外键 */
                 $malias = isset($relation_info['alias']) ? $relation_info['alias'] : $relation_info['middle_table'];
                 $ext_limit = '';
-                $relation_info['ext_limit'] && $ext_limit = ' AND ' . $this->_getExtLimit($relation_info['ext_limit'], $malias);
+                @$relation_info['ext_limit'] && $ext_limit = ' AND ' . $this->_getExtLimit($relation_info['ext_limit'], $malias);
                 return " LEFT JOIN {$this->_prefix}{$relation_info['middle_table']} {$malias} ON {$this->alias}.{$this->prikey} = {$malias}.{$relation_info['foreign_key']}{$ext_limit}";
                 break;
         }
Index: eccore/model/mysql.php
===================================================================
--- eccore/model/mysql.php	(revision 3919)
+++ eccore/model/mysql.php	(working copy)
@@ -92,7 +92,7 @@
         {
             if (PHP_VERSION >= '4.2')
             {
-                $this->_link_id = @mysql_connect($dbhost, $dbuser, $dbpw, true);
+                $this->_link_id = @mysqli_connect($dbhost, $dbuser, $dbpw);
             }
             else
             {
@@ -113,18 +113,18 @@
         }

         $this->_dbhash  = md5(ROOT_PATH . $dbhost . $dbuser . $dbpw . $dbname);
-        $this->version  = mysql_get_server_info($this->_link_id);
+        $this->version  = mysqli_get_server_info($this->_link_id);

         /* 如果mysql 版本是 4.1+ 以上，需要对字符集进行初始化 */
         if ($this->version > '4.1')
         {
             if ($charset != 'latin1')
             {
-                mysql_query("SET character_set_connection=$charset, character_set_results=$charset, character_set_client=binary", $this->_link_id);
+                mysqli_query($this->_link_id, "SET character_set_connection=$charset, character_set_results=$charset, character_set_client=binary");
             }
             if ($this->version > '5.0.1')
             {
-                mysql_query("SET sql_mode=''", $this->_link_id);
+                mysqli_query($this->_link_id, "SET sql_mode=''");
             }
         }

@@ -141,8 +141,8 @@
         {
             if ($dbhost != '.')
             {
-                $result = mysql_query("SHOW VARIABLES LIKE 'basedir'", $this->_link_id);
-                $row    = mysql_fetch_assoc($result);
+                $result = mysqli_query($this->_link_id, "SHOW VARIABLES LIKE 'basedir'");
+                $row    = mysqli_fetch_assoc($result);
                 if (!empty($row['Value']{1}) && $row['Value']{1} == ':' && !empty($row['Value']{2}) && $row['Value']{2} == "\\")
                 {
                     $this->_platform = 'WINDOWS';
@@ -161,8 +161,8 @@
                 ($dbhost != '.' && strtolower($dbhost) != 'localhost:3306' && $dbhost != '127.0.0.1:3306') ||
                 (PHP_VERSION >= '5.1' && date_default_timezone_get() == 'UTC'))
             {
-                $result = mysql_query("SELECT UNIX_TIMESTAMP() AS timeline, UNIX_TIMESTAMP('" . date('Y-m-d H:i:s', $this->starttime) . "') AS timezone", $this->_link_id);
-                $row    = mysql_fetch_assoc($result);
+                $result = mysqli_query($this->_link_id, "SELECT UNIX_TIMESTAMP() AS timeline, UNIX_TIMESTAMP('" . date('Y-m-d H:i:s', $this->starttime) . "') AS timezone");
+                $row    = mysqli_fetch_assoc($result);

                 if ($dbhost != '.' && strtolower($dbhost) != 'localhost:3306' && $dbhost != '127.0.0.1:3306')
                 {
@@ -187,7 +187,7 @@
         /* 选择数据库 */
         if ($dbname)
         {
-            if (mysql_select_db($dbname, $this->_link_id) === false )
+            if (mysqli_select_db($this->_link_id, $dbname) === false )
             {
                 if (!$quiet)
                 {
@@ -209,7 +209,7 @@

     function select_database($dbname)
     {
-        return mysql_select_db($dbname, $this->_link_id);
+        return mysqli_select_db($this->_link_id, $dbname);
     }

     function set_mysql_charset($charset)
@@ -223,14 +223,14 @@
             }
             if ($charset != 'latin1')
             {
-                mysql_query("SET character_set_connection=$charset, character_set_results=$charset, character_set_client=binary", $this->_link_id);
+                mysqli_query($this->_link_id, "SET character_set_connection=$charset, character_set_results=$charset, character_set_client=binary");
             }
         }
     }

-    function fetch_array($query, $result_type = MYSQL_ASSOC)
+    function fetch_array($query, $result_type = MYSQLI_ASSOC)
     {
-        return mysql_fetch_array($query, $result_type);
+        return mysqli_fetch_array($query, $result_type);
     }

     function query($sql, $type = '', $times=0)
@@ -255,10 +255,10 @@

         $sql = $this->prefix($sql); // 处理表名前缀

-        if (!($query = mysql_query($sql, $this->_link_id)))
+        if (!($query = mysqli_query($this->_link_id, $sql)))
         {
-            $errno = mysql_errno();
-            $error = mysql_error();
+            $errno = mysqli_errno($this->_link_id);
+            $error = mysqli_error($this->_link_id);

             if (($errno == 126 || $errno == 145 || $errno == 1062 || $errno == 1194 || $errno == 1034 || $errno == 1035)
                 && $times == 0 && (preg_match('/\'\.?\\\\?([\w_]+)\\\\?([\w_]+)\'/', $error, $match) !== false))
@@ -267,7 +267,7 @@
                 /* 如果错误类型为可修复，则尝试修复这个表 */
                 if (isset($match[2]))
                 {
-                    mysql_query("REPAIR TABLE $match[2]");
+                    mysqli_query($this->_link_id, "REPAIR TABLE $match[2]");
                     $query = $this->query($sql, $type, 1);
                 }
             }
@@ -280,7 +280,7 @@
                 if ($type != 'SILENT')
                 {
                     $trace  = debug_backtrace();
-                    $msg    = 'MySQL Error[' .mysql_errno($this->_link_id). ']: ' . mysql_error($this->_link_id). "\nMySQL Query:" .$sql;
+                    $msg    = 'MySQL Error[' .mysqli_errno($this->_link_id). ']: ' . mysqli_error($this->_link_id). "\nMySQL Query:" .$sql;
                     $msg    .= "\nWrong File:  " .$trace[0]['file']. "[" .$trace[0]['line']. "]";

                     trigger_error($msg, E_USER_ERROR);
@@ -339,17 +339,17 @@

     function affected_rows()
     {
-        return mysql_affected_rows($this->_link_id);
+        return mysqli_affected_rows($this->_link_id);
     }

     function error()
     {
-        return mysql_error($this->_link_id);
+        return mysqli_error($this->_link_id);
     }

     function errno()
     {
-        return mysql_errno($this->_link_id);
+        return mysqli_errno($this->_link_id);
     }

     function result($query, $row)
@@ -379,7 +379,7 @@

     function fetchRow($query)
     {
-        return mysql_fetch_assoc($query);
+        return mysqli_fetch_assoc($query);
     }

     function fetch_fields($query)
@@ -430,8 +430,8 @@
         else
         {
             static $last_errno = null;
-            $error = mysql_error();
-            $error_no = mysql_errno();
+            $error = mysqli_error($this->_link_id);
+            $error_no = mysqli_errno($this->_link_id);
             if ($last_errno == $error_no)
             {
                 exit;
@@ -476,7 +476,7 @@
         $res = $this->query($sql);
         if ($res !== false)
         {
-            $row = mysql_fetch_row($res);
+            $row = mysqli_fetch_row($res);

             if ($row !== false)
             {
@@ -527,7 +527,7 @@
         if ($res !== false)
         {
             $arr = array();
-            while ($row = mysql_fetch_assoc($res))
+            while ($row = mysqli_fetch_assoc($res))
             {
                 $arr[] = $row;
             }
@@ -607,7 +607,7 @@
         $res = $this->query($sql);
         if ($res !== false)
         {
-            return mysql_fetch_assoc($res);
+            return mysqli_fetch_assoc($res);
         }
         else
         {
@@ -649,7 +649,7 @@
         if ($res !== false)
         {
             $arr = array();
-            while ($row = mysql_fetch_row($res))
+            while ($row = mysqli_fetch_row($res))
             {
                 $arr[] = $row[0];
             }
@@ -943,9 +943,9 @@
             {
                 $sql = "SHOW TABLE STATUS LIKE '" . trim($table) . "'";
             }
-            $result = mysql_query($sql, $this->_link_id);
+            $result = mysqli_query($this->_link_id, $sql);

-            $row = mysql_fetch_assoc($result);
+            $row = mysqli_fetch_assoc($result);
             if ($row['Update_time'] > $lastupdatetime)
             {
                 $lastupdatetime = $row['Update_time'];
@@ -1002,27 +1002,27 @@

         array_unique($this->mysql_disable_cache_tables);
     }
-
+
     function sp_connect($dbhost, $dbuser, $dbpw, $dbname = '')
     {
-       //$this->close();
-       $this->_link_id = @mysql_connect($dbhost, $dbuser, $dbpw, true,131072);//add 131072 by tanaiquan in order to call procedure 201507030146
-       /* 选择数据库 */
-       if ($dbname)
-       {
-               if (mysql_select_db($dbname, $this->_link_id) === false )
-               {
-                       return false;
-               }
-               else
-               {
-                       return true;
-               }
-       }
-       else
-       {
-               return true;
-       }
+        //$this->close();
+        $this->_link_id = @mysql_connect($dbhost, $dbuser, $dbpw, true,131072);//add 131072 by tanaiquan in order to call procedure 201507030146
+        /* 选择数据库 */
+        if ($dbname)
+        {
+            if (mysqli_select_db($this->_link_id, $dbname) === false )
+            {
+                return false;
+            }
+            else
+            {
+                return true;
+            }
+        }
+        else
+        {
+            return true;
+        }
     }
 }

Index: eccore/view/template.php
===================================================================
--- eccore/view/template.php	(revision 3919)
+++ eccore/view/template.php	(working copy)
@@ -353,7 +353,8 @@
             $source = $this->smarty_prefilter_preCompile($source);
         }

-        return preg_replace("/{([^\}\{\n]*)}/e", "\$this->select('\\1');", $source);
+        return preg_replace_callback("/{([^\}\{\n]*)}/",
+                            function ($m) {return $this->select($m[1]);}, $source);
     }

     /**
@@ -577,7 +578,8 @@
                         $t['_template'] = str_replace("\r", '', $this->fetch_str(base64_decode($_template)));
                     }

-                    $out = "<?php \n" . '$k = ' . preg_replace("/(\'\\$[^,]+)/e" , "stripslashes(trim('\\1','\''));", var_export($t, true)) . ";\n";
+                    $out = "<?php \n" . '$k = ' . preg_replace_callback("/(\'\\$[^,]+)/" ,
+                                                                        function($m) {return stripslashes(trim($m[1],'\''));}, var_export($t, true)) . ";\n";
                     $out .= 'echo $this->_echash . $k[\'name\'] . \'|\' . serialize($k) . $this->_echash;' . "\n?>";

                     return $out;
@@ -606,12 +608,12 @@
                     $t = $this->get_para(substr($tag, 13), 0);
                     return '<?php echo $this->html_options(' . $this->make_array($t) . '); ?>';
                     break;
-				/*改变列表页排序样式 by tyioocom*/
-				case 'html_lis':
-                                   $t = $this->get_para(substr($tag, 9), 0);
+                /*改变列表页排序样式 by tyioocom*/
+                case 'html_lis':
+                    $t = $this->get_para(substr($tag, 9), 0);
                     return '<?php echo $this->html_lis(' . $this->make_array($t) . '); ?>';
                     break;
-				/*end*/
+                /*end*/
                 case 'widgets':
                     $t = $this->get_para(substr($tag, 8), 0);

@@ -682,69 +684,69 @@

                     return '<?php echo url(\'' . implode('&', $arr) . '\'); ?>';
                     break;
-
+
                case 'imqq':
-                               //add by tanaiquan 2015-06-09  qq online
-                       $str = str_replace('index.php?', '', substr($tag, 5));
-                       $str = str_replace('&amp;', '&', $str);
-                       $tmp = explode('&', $str);
-                       $arr = array();
-
-                       foreach ($tmp AS $key=>$val)
-                       {
-                               $a = explode('=', $val);
-                               if ((substr($a[1], 0, 1) == '$'))
-                               {
-                                       $arr[$a[0]] =  $this->get_val(substr($a[1], 1));
-                               }
-                               else
-                               {
-                                       $arr[$a[0]] = $a[1];
-                               }
-                       }
-                       $uin = $arr['uin'];
-                       $site = $arr['site'];
-
-                       $ahref1 = '<a href="http://wpa.qq.com/msgrd?v=3&uin='.'<?php echo urlencode('.$uin.'); ?>'.
-                               '&site='.'<?php echo '.$site.'; ?>'.'&menu=yes" target="_blank" style="display:inline-block;width:16px;overflow:hidden;vertical-align:middle;">
-                               <img src="http://wpa.qq.com/pa?p=1:'.'<?php echo urlencode('.$uin.'); ?>'.':9" alt="QQ">
-                               </a>';
-
-                       $ahref2 ='<a href="http://crm2.qq.com/page/portalpage/wpa.php?uin=800063451&aty=1&a='.'<?php echo urlencode('.$uin.'); ?>'.
-                                               '&curl=&ty=1" style="display:inline-block;width:16px;overflow:hidden;vertical-align:middle;"><img src="http://wpa.qq.com/pa?p=1:800063451:9" alt="QQ"></a>';
-
-                       return "<?php if(strlen($uin) > 4){ ?>". $ahref1."<?php } if(strlen($uin) == 4) {?>".$ahref2 ."<?php } ?>";
-
-                       break;
-
+                        //add by tanaiquan 2015-06-09  qq online
+                        $str = str_replace('index.php?', '', substr($tag, 5));
+                        $str = str_replace('&amp;', '&', $str);
+                        $tmp = explode('&', $str);
+                        $arr = array();
+
+                        foreach ($tmp AS $key=>$val)
+                        {
+                            $a = explode('=', $val);
+                            if ((substr($a[1], 0, 1) == '$'))
+                            {
+                                $arr[$a[0]] =  $this->get_val(substr($a[1], 1));
+                            }
+                            else
+                            {
+                                $arr[$a[0]] = $a[1];
+                            }
+                        }
+                        $uin = $arr['uin'];
+                        $site = $arr['site'];
+
+                        $ahref1 = '<a href="http://wpa.qq.com/msgrd?v=3&uin='.'<?php echo urlencode('.$uin.'); ?>'.
+                            '&site='.'<?php echo '.$site.'; ?>'.'&menu=yes" target="_blank" style="display:inline-block;width:16px;overflow:hidden;vertical-align:middle;">
+                            <img src="http://wpa.qq.com/pa?p=1:'.'<?php echo urlencode('.$uin.'); ?>'.':9" alt="QQ">
+                            </a>';
+
+                        $ahref2 ='<a href="http://crm2.qq.com/page/portalpage/wpa.php?uin=800063451&aty=1&a='.'<?php echo urlencode('.$uin.'); ?>'.
+                                    '&curl=&ty=1" style="display:inline-block;width:16px;overflow:hidden;vertical-align:middle;"><img src="http://wpa.qq.com/pa?p=1:800063451:9" alt="QQ"></a>';
+
+                        return "<?php if(strlen($uin) > 4){ ?>". $ahref1."<?php } if(strlen($uin) == 4) {?>".$ahref2 ."<?php } ?>";
+
+                        break;
+
                    case 'imww':
-                               //add by tanaiquan 2015-06-09  qq online
-                               $str = str_replace('index.php?', '', substr($tag, 5));
-                               $str = str_replace('&amp;', '&', $str);
-                               $tmp = explode('&', $str);
-                               $arr = array();
-
-                               foreach ($tmp AS $key=>$val)
-                               {
-                                       $a = explode('=', $val);
-                                       if ((substr($a[1], 0, 1) == '$'))
-                                       {
-                                               $arr[$a[0]] =  $this->get_val(substr($a[1], 1));
-                                       }
-                                       else
-                                       {
-                                               $arr[$a[0]] = $a[1];
-                                       }
-                               }
-                               $touid = $arr['touid'];
-                               $charset = $arr['charset'];
-                               $str = '<a target="_blank" style="vertical-align:middle;display:inline-block;width:16px;" href="http://www.taobao.com/webww/ww.php?ver=3&touid='.'<?php echo '.$touid.'; ?>'.
-                               '&siteid=cntaobao&status=2&charset='.'<?php echo urlencode('.$charset.'); ?>'.'">
+                            //add by tanaiquan 2015-06-09  qq online
+                            $str = str_replace('index.php?', '', substr($tag, 5));
+                            $str = str_replace('&amp;', '&', $str);
+                            $tmp = explode('&', $str);
+                            $arr = array();
+
+                            foreach ($tmp AS $key=>$val)
+                            {
+                                $a = explode('=', $val);
+                                if ((substr($a[1], 0, 1) == '$'))
+                                {
+                                    $arr[$a[0]] =  $this->get_val(substr($a[1], 1));
+                                }
+                                else
+                                {
+                                    $arr[$a[0]] = $a[1];
+                                }
+                            }
+                            $touid = $arr['touid'];
+                            $charset = $arr['charset'];
+                            $str = '<a target="_blank" style="vertical-align:middle;display:inline-block;width:16px;" href="http://www.taobao.com/webww/ww.php?ver=3&touid='.'<?php echo '.$touid.'; ?>'.
+                            '&siteid=cntaobao&status=2&charset='.'<?php echo urlencode('.$charset.'); ?>'.'">
                      <img border="0" src="http://amos.im.alisoft.com/online.aw?v=2&uid='.'<?php echo '.$touid.'; ?>'.
                      '&site=cntaobao&s=2&charset='.'<?php echo urlencode('.$charset.'); ?>'.'" alt="Wang Wang" />
                      </a>';
-                               return $str;
-                               break;
+                            return $str;
+                            break;

                 case 'ecjoin':
                     $t = $this->get_para(substr($tag, 6), 0);
@@ -791,7 +793,8 @@
     {
         if (strrpos($val, '[') !== false)
         {
-            $val = preg_replace("/\[([^\[\]]*)\]/eis", "'.'.str_replace('$','\$','\\1')", $val);
+            $val = preg_replace_callback("/\[([^\[\]]*)\]/is",
+                                         function($m) {return '.'.str_replace('$','\$',$m[1]);}, $val);
         }

         if (strrpos($val, '|') !== false)
@@ -868,18 +871,18 @@
                     case 'truncate':
                         $p = 'sub_str(' . $p . ",$s[1])";
                         break;
-                    case 'mb_substr':
-                       mb_internal_encoding("UTF-8");
-                       $p = 'strpos('.$p.',\''.$s[2].'\') !== false && '.'strpos('.$p.',\''.$s[2].'\') == 0'.' ?mb_substr('.$p.','.$s[1].'):'.$p;
-
-                       break;
-                    case 'mb_substr2':
-                       if(strlen($p) > 6)
-                           $p = 'sub_str(' . $p . ",6,false)";
-                           //$p = 'strlen('.$p.')';
-                       else
-                           $p = $p;
-                       break;
+                    case 'mb_substr':
+                        mb_internal_encoding("UTF-8");
+                        $p = 'strpos('.$p.',\''.$s[2].'\') !== false && '.'strpos('.$p.',\''.$s[2].'\') == 0'.' ?mb_substr('.$p.','.$s[1].'):'.$p;
+
+                        break;
+                    case 'mb_substr2':
+                        if(strlen($p) > 6)
+                            $p = 'sub_str(' . $p . ",6,false)";
+                            //$p = 'strlen('.$p.')';
+                        else
+                            $p = $p;
+                        break;
                     case 'strip_tags':
                         $p = 'strip_tags(' . $p . ')';
                         break;
@@ -889,13 +892,13 @@
                         break;
                     case 'double':
                         $p = '2*'.$p;
-                        break;
+                        break;
                    case 'ltrim51t':
-                            $p = 'strpos('.$p.',\'51t_\') !== false && '.'strpos('.$p.',\'51t_\') == 0'.' ?ltrim('.$p.',\'51t_\'):'.$p;
+                         $p = 'strpos('.$p.',\'51t_\') !== false && '.'strpos('.$p.',\'51t_\') == 0'.' ?ltrim('.$p.',\'51t_\'):'.$p;
                         break;
                   case 'addstar':
-                           mb_internal_encoding("UTF-8");
-                           $p="mb_substr(".$p.",0,1)".".'**'."."mb_substr(".$p.",-1,1)";
+                        mb_internal_encoding("UTF-8");
+                        $p="mb_substr(".$p.",0,1)".".'**'."."mb_substr(".$p.",-1,1)";
                         break;
                     case 'date':
                         if (empty($s[1]))
@@ -1475,7 +1478,7 @@
             '/(href=["|\'])\.\.\/(.*?)(["|\'])/i',  // 替换相对链接
             '/((?:background|src)\s*=\s*["|\'])(?:\.\/|\.\.\/)?(images\/.*?["|\'])/is', // 在images前加上 $tmp_dir
             '/((?:background|background-image):\s*?url\()(?:\.\/|\.\.\/)?(images\/)/is', // 在images前加上 $tmp_dir
-            '/{nocache}(.+?){\/nocache}/ise', //无缓存模块
+            '/{nocache}(.+?){\/nocache}/is', //无缓存模块
             );
         $replace = array(
             '\1',
@@ -1643,8 +1646,8 @@

         return $out;
     }
-	/*改变列表页排序的样式，不用 select  by tyioocom*/
-	function html_lis($arr)
+    /*改变列表页排序的样式，不用 select  by tyioocom*/
+    function html_lis($arr)
     {
         $selected = $arr['selected'];

@@ -1673,13 +1676,13 @@
                 $key = htmlspecialchars($key);
                 $val = strip_tags($val);
                 //$out .= $key == $selected ? "<option value=\"$key\" selected>$val</option>" : "<option value=\"$key\">$val</option>";
-				$out .= $key == $selected ? "<li ectype=\"order_by\" class=\"curr\"><a title=\"$key\">$val</a><span></span></li>" : "<li ectype=\"order_by\"><a title=\"$key\">$val</a><span></span></li>";
+                $out .= $key == $selected ? "<li ectype=\"order_by\" class=\"curr\"><a title=\"$key\">$val</a><span></span></li>" : "<li ectype=\"order_by\"><a title=\"$key\">$val</a><span></span></li>";
             }
         }

         return $out;
     }
-	/*end*/
+    /*end*/
     function display_widgets($arr)
     {
         /* 请求控制器 */
@@ -2082,7 +2085,7 @@

         return 'sprintf(\'' . $lang . '\', ' . implode(',' , $arr) . ')';
     }
-
+
     /**
      * 首页静态化
      * 获取页面解释后的内容
@@ -2094,7 +2097,7 @@
      */
     function outhtml($filename, $cache_id = '')
     {
-       return $this->fetch($filename, $cache_id);
+        return $this->fetch($filename, $cache_id);
     }
 }

Index: includes/ecapp.base.php
===================================================================
--- includes/ecapp.base.php	(revision 3919)
+++ includes/ecapp.base.php	(working copy)
@@ -137,7 +137,7 @@
     }

     function _init_visitor() {
-
+
     }

     /**
@@ -521,7 +521,7 @@

         $this->assign('currentCitysite', $this->_get_current_citysite());
         $this->assign('currentCitysiteName', $this->_get_current_citysitename());
-
+
         $this->assign('citysiteList', $this->_get_citysites_except_current_citysite());
         $this->assign('oem', OEM);

@@ -1357,12 +1357,12 @@
         if ($detail['store_id'] && $detail['state'] != STORE_APPLYING) { // 排除申请中的店铺
             $detail['manage_store'] = $detail['has_store'] = $detail['store_id'];
         }
-
-        if($this->info['pass_behalf'])
+
+        if(@$this->info['pass_behalf'])
         {
-               $model_behalf =& m('behalf');
-               $behalf_detail = $model_behalf->get("{$this->info['has_behalf']}");
-               $detail['behalf'] = $behalf_detail;
+            $model_behalf =& m('behalf');
+            $behalf_detail = $model_behalf->get("{$this->info['has_behalf']}");
+            $detail['behalf'] = $behalf_detail;
         }

         return $detail;
Index: includes/global.lib.php
===================================================================
--- includes/global.lib.php	(revision 3919)
+++ includes/global.lib.php	(working copy)
@@ -724,94 +724,94 @@
  */
 function generateQRfromQRCode($txt,$fileflag)
 {
-	$PNG_TEMP_DIR = ROOT_PATH.DIRECTORY_SEPARATOR.'data'.DIRECTORY_SEPARATOR.'qrcode'.DIRECTORY_SEPARATOR;
-	$PNG_WEB_DIR = 'data/qrcode/';
-	import('qrlib');
-	if(!file_exists($PNG_TEMP_DIR))
-		mkdir($PNG_TEMP_DIR);
-	$errorCorrectionLevel = 'H';//L,M,Q,H
-	$matrixPointSize = 5;//1-10
-	$data='weixin://contacts/profile/'.trim($txt);
-	if(empty($data))
-		return false;
-		//die('qrdata cannot be empty!');
-	$filename = $PNG_TEMP_DIR.'zwd51_'.$fileflag.'.png';
-	QRcode::png($data,$filename,$errorCorrectionLevel,$matrixPointSize,2);
-	return true;
+    $PNG_TEMP_DIR = ROOT_PATH.DIRECTORY_SEPARATOR.'data'.DIRECTORY_SEPARATOR.'qrcode'.DIRECTORY_SEPARATOR;
+    $PNG_WEB_DIR = 'data/qrcode/';
+    import('qrlib');
+    if(!file_exists($PNG_TEMP_DIR))
+        mkdir($PNG_TEMP_DIR);
+    $errorCorrectionLevel = 'H';//L,M,Q,H
+    $matrixPointSize = 5;//1-10
+    $data='weixin://contacts/profile/'.trim($txt);
+    if(empty($data))
+        return false;
+        //die('qrdata cannot be empty!');
+    $filename = $PNG_TEMP_DIR.'zwd51_'.$fileflag.'.png';
+    QRcode::png($data,$filename,$errorCorrectionLevel,$matrixPointSize,2);
+    return true;
 }

 /**
  *   文件大小换算 tiq
  */
 function filesize_caculate($filesize)
-{
-	if($filesize >= 1073741824)
-	{
-		$filesize = round($filesize / 1073741824 * 100) / 100 . ' GB';
-	}
-	elseif($filesize >= 1048576)
-	{
-		$filesize = round($filesize / 1048576 * 100) / 100 . ' MB';
-	}
-	elseif($filesize >= 1024)
-	{
-		$filesize = round($filesize / 1024 * 100) / 100 . ' KB';
-	}
-	else
-	{
-		$filesize = $filesize . ' Bytes';
-	}
-	return $filesize;
+{
+    if($filesize >= 1073741824)
+    {
+        $filesize = round($filesize / 1073741824 * 100) / 100 . ' GB';
+    }
+    elseif($filesize >= 1048576)
+    {
+        $filesize = round($filesize / 1048576 * 100) / 100 . ' MB';
+    }
+    elseif($filesize >= 1024)
+    {
+        $filesize = round($filesize / 1024 * 100) / 100 . ' KB';
+    }
+    else
+    {
+        $filesize = $filesize . ' Bytes';
+    }
+    return $filesize;
 }
 /*根据现有价格计算出淘宝价*/
-function make_price($price, $seePrice, $title = null)
+function make_price($price, $seePrice, $title = null)
 {
-	$finalPrice = $rawPrice = floatval ( $price );
-	if (strpos ( $seePrice, '减半' ) !== false)
-	{
-		$finalPrice = $rawPrice * 2;
-	}
-	else if (strpos ( $seePrice, 'P' ) !== false || $seePrice == '减P' || $seePrice == '减p')
-	{
-		$regexP = '/[Pp](\d+)/';
-		$regexF = '/[Ff](\d+)/';
-		if (preg_match ( $regexP, $title, $matches ) == 1)
-		{
-			$finalPrice = floatval ( $matches [1] );
-		}
-		else if (preg_match ( $regexF, $title, $matches ) == 1)
-		{
-			$finalPrice = floatval ( $matches [1] );
-		}
-	}
-	else if (strpos ( $seePrice, '减' ) === 0)
-	{
-		$finalPrice = $rawPrice + floatval ( mb_substr ( $seePrice, 1, mb_strlen ( $seePrice, 'utf-8' ) - 1, 'utf-8' ) );
-	}
-	else if (strpos ( $seePrice, '实价' ) !== false)
-	{
-		$finalPrice = $rawPrice;
-	}
-	else if (strpos ( $seePrice, '*' ) === 0)
-	{
-		$finalPrice = $rawPrice / floatval ( mb_substr ( $seePrice, 1, mb_strlen ( $seePrice, 'utf-8' ) - 1, 'utf-8' ) );
-	}
-	else if (strpos ( $seePrice, '打' ) === 0)
-	{
-		$finalPrice = $rawPrice / (floatval ( mb_substr ( $seePrice, 1, mb_strlen ( $seePrice, 'utf-8' ) - 1, 'utf-8' ) ) / 10);
-	}
-	else if (strpos ( $seePrice, '折' ) === mb_strlen ( $seePrice, 'utf-8' ) - 1)
-	{
-		$finalPrice = $rawPrice / (floatval ( mb_substr ( $seePrice, 0, mb_strlen ( $seePrice, 'utf-8' ) - 1, 'utf-8' ) ) / 10);
-	}
-	if (is_numeric ( $finalPrice ))
-	{
-		return $finalPrice;
-	}
-	else
-	{
-		return $price;
-	}
+    $finalPrice = $rawPrice = floatval ( $price );
+    if (strpos ( $seePrice, '减半' ) !== false)
+    {
+        $finalPrice = $rawPrice * 2;
+    }
+    else if (strpos ( $seePrice, 'P' ) !== false || $seePrice == '减P' || $seePrice == '减p')
+    {
+        $regexP = '/[Pp](\d+)/';
+        $regexF = '/[Ff](\d+)/';
+        if (preg_match ( $regexP, $title, $matches ) == 1)
+        {
+            $finalPrice = floatval ( $matches [1] );
+        }
+        else if (preg_match ( $regexF, $title, $matches ) == 1)
+        {
+            $finalPrice = floatval ( $matches [1] );
+        }
+    }
+    else if (strpos ( $seePrice, '减' ) === 0)
+    {
+        $finalPrice = $rawPrice + floatval ( mb_substr ( $seePrice, 1, mb_strlen ( $seePrice, 'utf-8' ) - 1, 'utf-8' ) );
+    }
+    else if (strpos ( $seePrice, '实价' ) !== false)
+    {
+        $finalPrice = $rawPrice;
+    }
+    else if (strpos ( $seePrice, '*' ) === 0)
+    {
+        $finalPrice = $rawPrice / floatval ( mb_substr ( $seePrice, 1, mb_strlen ( $seePrice, 'utf-8' ) - 1, 'utf-8' ) );
+    }
+    else if (strpos ( $seePrice, '打' ) === 0)
+    {
+        $finalPrice = $rawPrice / (floatval ( mb_substr ( $seePrice, 1, mb_strlen ( $seePrice, 'utf-8' ) - 1, 'utf-8' ) ) / 10);
+    }
+    else if (strpos ( $seePrice, '折' ) === mb_strlen ( $seePrice, 'utf-8' ) - 1)
+    {
+        $finalPrice = $rawPrice / (floatval ( mb_substr ( $seePrice, 0, mb_strlen ( $seePrice, 'utf-8' ) - 1, 'utf-8' ) ) / 10);
+    }
+    if (is_numeric ( $finalPrice ))
+    {
+        return $finalPrice;
+    }
+    else
+    {
+        return $price;
+    }
 }

 /**
@@ -821,30 +821,30 @@
  * @return unknown
  */
 function getHuoHao($title, $propsName = null) {
-	$kuanHaoRegex='/[A-Z]?\d+/';
-	preg_match_all($kuanHaoRegex,$title,$kuanHao);
-	$pKhnum=count($kuanHao[0]);
-	if($pKhnum>0) {
-		for($i=0;$i < $pKhnum;$i++) {
-			if(strlen($kuanHao[0][$i])==3 || (strlen($kuanHao[0][$i])==4 && substr($kuanHao[0][$i], 0,3)!= "201")) {
-				$huoHao = $kuanHao[0][$i];
-				break;
-			}
-		}
-	}
-	if (!$huoHao && $propsName != null) {
-		if (strpos(''.$propsName, '13021751') !== false) {
-			$parts = explode(';', ''.$propsName);
-			$count = count($parts);
-			for ($i = 0; $i < $count; $i++) {
-				if (strpos($parts[$i], '13021751') !== false) {
-					$values = explode(':', $parts[$i]);
-					$huoHao = $values[3];
-				}
-			}
-		}
-	}
-	return $huoHao;
+    $kuanHaoRegex='/[A-Z]?\d+/';
+    preg_match_all($kuanHaoRegex,$title,$kuanHao);
+    $pKhnum=count($kuanHao[0]);
+    if($pKhnum>0) {
+        for($i=0;$i < $pKhnum;$i++) {
+            if(strlen($kuanHao[0][$i])==3 || (strlen($kuanHao[0][$i])==4 && substr($kuanHao[0][$i], 0,3)!= "201")) {
+                $huoHao = $kuanHao[0][$i];
+                break;
+            }
+        }
+    }
+    if (!$huoHao && $propsName != null) {
+        if (strpos(''.$propsName, '13021751') !== false) {
+            $parts = explode(';', ''.$propsName);
+            $count = count($parts);
+            for ($i = 0; $i < $count; $i++) {
+                if (strpos($parts[$i], '13021751') !== false) {
+                    $values = explode(':', $parts[$i]);
+                    $huoHao = $values[3];
+                }
+            }
+        }
+    }
+    return $huoHao;
 }

 /**
@@ -853,7 +853,7 @@
  */
 function generate_storeBM($store_id)
 {
-	sp_db()->query("call build_outer_iid(".intval($store_id).",".(intval($store_id) + 1).")");
+    sp_db()->query("call build_outer_iid(".intval($store_id).",".(intval($store_id) + 1).")");
 }
 /**
  *  获取拼音信息
@@ -866,59 +866,59 @@
  */
 function GetPinyin($str, $ishead=0, $isclose=1)
 {
-	global $pinyins;
-	$restr = '';
-	$str = trim($str);
-	$slen = strlen($str);
-	if($slen < 2)
-	{
-		return $str;
-	}
-	if(count($pinyins) == 0)
-	{
-		$fp = fopen(ROOT_PATH.'/includes/codetable/pinyin.dat', 'r');
-		while(!feof($fp))
-		{
-			$line = trim(fgets($fp));
-			$pinyins[$line[0].$line[1]] = substr($line, 3, strlen($line)-3);
-		}
-		fclose($fp);
-	}
-	for($i=0; $i<$slen; $i++)
-	{
-	if(ord($str[$i])>0x80)
-	{
-	$c = $str[$i].$str[$i+1];
-		$i++;
-		if(isset($pinyins[$c]))
-		{
-		if($ishead==0)
-		{
-		$restr .= $pinyins[$c];
-		}
-			else
-			{
-			$restr .= $pinyins[$c][0];
-			}
-			}else
-			{
-			$restr .= "_";
-			}
-			}else if( preg_match("/[a-z0-9]/i", $str[$i]) )
-				{
-					$restr .= $str[$i];
-			}
-			else
-					{
-					$restr .= "_";
-		}
-	}
-	if($isclose==0)
-		{
-			unset($pinyins);
-	}
-	return $restr;
-	}
+    global $pinyins;
+    $restr = '';
+    $str = trim($str);
+    $slen = strlen($str);
+    if($slen < 2)
+    {
+        return $str;
+    }
+    if(count($pinyins) == 0)
+    {
+        $fp = fopen(ROOT_PATH.'/includes/codetable/pinyin.dat', 'r');
+        while(!feof($fp))
+        {
+            $line = trim(fgets($fp));
+            $pinyins[$line[0].$line[1]] = substr($line, 3, strlen($line)-3);
+        }
+        fclose($fp);
+    }
+    for($i=0; $i<$slen; $i++)
+    {
+    if(ord($str[$i])>0x80)
+    {
+    $c = $str[$i].$str[$i+1];
+        $i++;
+        if(isset($pinyins[$c]))
+        {
+        if($ishead==0)
+        {
+        $restr .= $pinyins[$c];
+        }
+            else
+            {
+            $restr .= $pinyins[$c][0];
+            }
+            }else
+            {
+            $restr .= "_";
+            }
+            }else if( preg_match("/[a-z0-9]/i", $str[$i]) )
+                {
+                    $restr .= $str[$i];
+            }
+            else
+                    {
+                    $restr .= "_";
+        }
+    }
+    if($isclose==0)
+        {
+            unset($pinyins);
+    }
+    return $restr;
+    }
     function getSphinxAddress(){
         $cache_server = & cache_server();
         $current = $cache_server->get('currentSphinx');
@@ -928,6 +928,6 @@
             return "127.0.0.1";
         }
     }
-
+
     include_once ROOT_PATH.'/includes/customize/common.lib.php';
 ?>
Index: includes/libraries/cache.lib.php
===================================================================
--- includes/libraries/cache.lib.php	(revision 3919)
+++ includes/libraries/cache.lib.php	(working copy)
@@ -85,7 +85,8 @@
         $cache_file = $this->_get_cache_path($key);
         if (!is_file($cache_file))
         {
-            return false;
+            $result = false;
+            return $result;
         }
         $data = include($cache_file);

@@ -204,7 +205,8 @@
      */
     function &get($key)
     {
-        return $this->_memcache->get($key);
+        $value = $this->_memcache->get($key);
+        return $value;
     }

     /**
Index: includes/libraries/init.lib.php
===================================================================
--- includes/libraries/init.lib.php	(revision 3919)
+++ includes/libraries/init.lib.php	(working copy)
@@ -81,7 +81,7 @@
         }
         return $delivery;
     }
-    public function create_table( )
+    public static function create_table( )
     {
         $result = db( )->getAll( "SHOW COLUMNS FROM ".DB_PREFIX."store" );
         $fields = array( );
@@ -152,303 +152,303 @@
         $sql = "CREATE TABLE IF NOT EXISTS `".DB_PREFIX."delivery_template` (\r\n  \t\t\t`template_id` int(11) NOT NULL AUTO_INCREMENT,\r\n  \t\t\t`name` varchar(50) NOT NULL,\r\n  \t\t\t`store_id` int(10) NOT NULL,\r\n  \t\t\t`template_types` text NOT NULL,\r\n  \t\t\t`template_dests` text NOT NULL,\r\n  \t\t\t`template_start_standards` text NOT NULL,\r\n  \t\t\t`template_start_fees` text NOT NULL,\r\n  \t\t\t`template_add_standards` text NOT NULL,\r\n  \t\t\t`template_add_fees` text NOT NULL,\r\n  \t\t\t`created` int(10) NOT NULL,\r\n  \t\t\tPRIMARY KEY (`template_id`)\r\n\t\t) ENGINE = MYISAM DEFAULT CHARSET=".str_replace( "-", "", CHARSET ).";";
         db( )->query( $sql );
     }
-    public function addColumInDelivery_template()
+    public static function addColumInDelivery_template()
     {
-       $result = db()->getAll("SHOW COLUMNS FROM ".DB_PREFIX."delivery_template");
-       $fields = array();
-       foreach ($result as $v)
-       {
-               $fields[] = $v['Field'];
-       }
-       if(!in_array("price_type", $fields))
-       {
-               $sql = "ALTER TABLE `".DB_PREFIX."delivery_template` ADD `price_type` TINYINT(1) NOT NULL DEFAULT '1' AFTER `name`";
-               db()->query($sql);
-       }
-       $result = db()->getAll("SHOW COLUMNS FROM ".DB_PREFIX."goods");
-       $fields = array();
-       foreach ($result as $v)
-       {
-               $fields[] = $v['Field'];
-       }
-       if(!in_array("delivery_weight", $fields))
-       {
-               $sql = "ALTER TABLE `".DB_PREFIX."goods` ADD `delivery_weight` decimal(10,2) NOT NULL DEFAULT '0.00'";
-               db()->query($sql);
-       }
+        $result = db()->getAll("SHOW COLUMNS FROM ".DB_PREFIX."delivery_template");
+        $fields = array();
+        foreach ($result as $v)
+        {
+            $fields[] = $v['Field'];
+        }
+        if(!in_array("price_type", $fields))
+        {
+            $sql = "ALTER TABLE `".DB_PREFIX."delivery_template` ADD `price_type` TINYINT(1) NOT NULL DEFAULT '1' AFTER `name`";
+            db()->query($sql);
+        }
+        $result = db()->getAll("SHOW COLUMNS FROM ".DB_PREFIX."goods");
+        $fields = array();
+        foreach ($result as $v)
+        {
+            $fields[] = $v['Field'];
+        }
+        if(!in_array("delivery_weight", $fields))
+        {
+            $sql = "ALTER TABLE `".DB_PREFIX."goods` ADD `delivery_weight` decimal(10,2) NOT NULL DEFAULT '0.00'";
+            db()->query($sql);
+        }
     }
     public function addColumnOrder()
     {
-       $result = db()->getAll("SHOW COLUMNS FROM ".DB_PREFIX."order");
-       $fields = array();
-       foreach ($result as $v)
-       {
-               $fields[] = $v['Field'];
-       }
-       if(!in_array("bh_id", $fields))
-       {
-               $sql = "ALTER TABLE `".DB_PREFIX."order` ADD `bh_id` INT(10) NOT NULL DEFAULT '0' AFTER `pay_alter`";
-               db()->query($sql);
-               $result = db()->getAll("select order_id,bh_id from `".DB_PREFIX."order_behalfs`");
-               foreach ($result as $va)
-               {
-                       db()->query("UPDATE `".DB_PREFIX."order` SET bh_id=".$va['bh_id']." WHERE order_id=".$va['order_id'].";");
-               }
-       }
-       if(!in_array("logistics", $fields))
-       {
-               $sql = "ALTER TABLE `".DB_PREFIX."order` ADD `logistics` varchar(255) AFTER `invoice_no`";
-               db()->query($sql);
-       }
-       if(!in_array("seller_message_flag", $fields))
-       {
-               $sql = "ALTER TABLE `".DB_PREFIX."order` ADD `seller_message_flag` tinyint(2) AFTER `postscript`";
-               db()->query($sql);
-       }
-       if(!in_array("seller_message", $fields))
-       {
-               $sql = "ALTER TABLE `".DB_PREFIX."order` ADD `seller_message` varchar(255) AFTER `postscript`";
-               db()->query($sql);
-       }
-       /*navigation*/
-       $result = db()->getAll("SHOW COLUMNS FROM ".DB_PREFIX."navigation");
-       $fields = array();
-       foreach ($result as $v)
-       {
-               $fields[] = $v['Field'];
-       }
-       if(!in_array("margin", $fields))
-       {
-               $sql = "ALTER TABLE `".DB_PREFIX."navigation` ADD `margin` varchar(30) AFTER `hot`";
-               db()->query($sql);
-       }
-       if(!in_array("fontcolor", $fields))
-       {
-               $sql = "ALTER TABLE `".DB_PREFIX."navigation` ADD `fontcolor` varchar(6) AFTER `hot`";
-               db()->query($sql);
-       }
-       /*ecm_store*/
-       $result = db()->getAll("SHOW COLUMNS FROM ".DB_PREFIX."store");
-       $fields = array();
-       foreach ($result as $v)
-       {
-               $fields[] = $v['Field'];
-       }
-       if(!in_array("im_wx", $fields))
-       {
-               $sql = "ALTER TABLE `".DB_PREFIX."store` ADD `im_wx` varchar(60) AFTER `im_ww`";
-               db()->query($sql);
-       }
-       /*ecm_behalf*/
-       $result = db()->getAll("SHOW COLUMNS FROM ".DB_PREFIX."behalf");
-       $fields = array();
-       foreach ($result as $v)
-       {
-               $fields[] = $v['Field'];
-       }
-       if(!in_array("owner_name", $fields))
-       {
-               $sql = "ALTER TABLE `".DB_PREFIX."behalf` ADD `owner_name` varchar(30) AFTER `bh_name`";
-               db()->query($sql);
-       }
-       //$sql = "CREATE TABLE IF NOT EXISTS `".DB_PREFIX."order_refund` (\r\n  \t\t\t`id` INT( 10 ) UNSIGNED NOT NULL AUTO_INCREMENT,\r\n  \t\t\t`order_id` INT( 10 ) UNSIGNED NOT NULL ,\r\n  \t\t\t`order_sn` VARCHAR( 20 ) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL ,\r\n  \t\t\t`sender_id` INT( 10 ) UNSIGNED NOT NULL ,\r\n  \t\t\t`sender_name` VARCHAR( 100 ) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL ,\r\n  \t\t\t`receiver_id` INT( 10 ) UNSIGNED NOT NULL ,\r\n  \t\t\t`receiver_name` VARCHAR( 100 ) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL ,\r\n  \t\t\t`refund_reason` VARCHAR( 100 ) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL ,\r\n  \t\t\t`refund_amount` DECIMAL( 10, 2 ) NOT NULL ,\r\n  \t\t\t`refund_intro` VARCHAR( 255 ) CHARACTER SET utf8 COLLATE utf8_general_ci ,\r\n  \t\t\t`create_time` INT( 10 ) UNSIGNED NOT NULL ,\r\n  \t\t\t`pay_time` INT UNSIGNED NOT NULL ,\r\n  \t\t\t`apply_amount` DECIMAL( 10, 2 ) NOT NULL ,\r\n  \t\t\t`status` TINYINT( 3 ) UNSIGNED NOT NULL DEFAULT '0',\r\n  \t\t\t`closed` TINYINT( 3 ) UNSIGNED NOT NULL DEFAULT '0',\r\n  \t\t\t`type` TINYINT( 3 ) UNSIGNED NOT NULL DEFAULT '0',\r\n  \t\t\t PRIMARY KEY ( `id` ) ,\r\n  \t\t\tINDEX ( `order_id` , `order_sn` , `sender_id` , `receiver_id`,`status` )\r\n  \t\t\t) ENGINE = MYISAM DEFAULT CHARSET=".str_replace( "-", "", CHARSET ).";";
-       //db( )->query( $sql );
-       /*ecm_article*/
-       $result = db()->getAll("SHOW COLUMNS FROM ".DB_PREFIX."article");
-       $fields = array();
-       foreach ($result as $v)
-       {
-               $fields[] = $v['Field'];
-       }
-       if(!in_array("add_red", $fields))
-       {
-               $sql = "ALTER TABLE `".DB_PREFIX."article` ADD `add_red` TINYINT(3) UNSIGNED NOT NULL DEFAULT '0'";
-               db()->query($sql);
-       }
+        $result = db()->getAll("SHOW COLUMNS FROM ".DB_PREFIX."order");
+        $fields = array();
+        foreach ($result as $v)
+        {
+            $fields[] = $v['Field'];
+        }
+        if(!in_array("bh_id", $fields))
+        {
+            $sql = "ALTER TABLE `".DB_PREFIX."order` ADD `bh_id` INT(10) NOT NULL DEFAULT '0' AFTER `pay_alter`";
+            db()->query($sql);
+            $result = db()->getAll("select order_id,bh_id from `".DB_PREFIX."order_behalfs`");
+            foreach ($result as $va)
+            {
+                db()->query("UPDATE `".DB_PREFIX."order` SET bh_id=".$va['bh_id']." WHERE order_id=".$va['order_id'].";");
+            }
+        }
+        if(!in_array("logistics", $fields))
+        {
+            $sql = "ALTER TABLE `".DB_PREFIX."order` ADD `logistics` varchar(255) AFTER `invoice_no`";
+            db()->query($sql);
+        }
+        if(!in_array("seller_message_flag", $fields))
+        {
+            $sql = "ALTER TABLE `".DB_PREFIX."order` ADD `seller_message_flag` tinyint(2) AFTER `postscript`";
+            db()->query($sql);
+        }
+        if(!in_array("seller_message", $fields))
+        {
+            $sql = "ALTER TABLE `".DB_PREFIX."order` ADD `seller_message` varchar(255) AFTER `postscript`";
+            db()->query($sql);
+        }
+        /*navigation*/
+        $result = db()->getAll("SHOW COLUMNS FROM ".DB_PREFIX."navigation");
+        $fields = array();
+        foreach ($result as $v)
+        {
+            $fields[] = $v['Field'];
+        }
+        if(!in_array("margin", $fields))
+        {
+            $sql = "ALTER TABLE `".DB_PREFIX."navigation` ADD `margin` varchar(30) AFTER `hot`";
+            db()->query($sql);
+        }
+        if(!in_array("fontcolor", $fields))
+        {
+            $sql = "ALTER TABLE `".DB_PREFIX."navigation` ADD `fontcolor` varchar(6) AFTER `hot`";
+            db()->query($sql);
+        }
+        /*ecm_store*/
+        $result = db()->getAll("SHOW COLUMNS FROM ".DB_PREFIX."store");
+        $fields = array();
+        foreach ($result as $v)
+        {
+            $fields[] = $v['Field'];
+        }
+        if(!in_array("im_wx", $fields))
+        {
+            $sql = "ALTER TABLE `".DB_PREFIX."store` ADD `im_wx` varchar(60) AFTER `im_ww`";
+            db()->query($sql);
+        }
+        /*ecm_behalf*/
+        $result = db()->getAll("SHOW COLUMNS FROM ".DB_PREFIX."behalf");
+        $fields = array();
+        foreach ($result as $v)
+        {
+            $fields[] = $v['Field'];
+        }
+        if(!in_array("owner_name", $fields))
+        {
+            $sql = "ALTER TABLE `".DB_PREFIX."behalf` ADD `owner_name` varchar(30) AFTER `bh_name`";
+            db()->query($sql);
+        }
+        //$sql = "CREATE TABLE IF NOT EXISTS `".DB_PREFIX."order_refund` (\r\n  \t\t\t`id` INT( 10 ) UNSIGNED NOT NULL AUTO_INCREMENT,\r\n  \t\t\t`order_id` INT( 10 ) UNSIGNED NOT NULL ,\r\n  \t\t\t`order_sn` VARCHAR( 20 ) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL ,\r\n  \t\t\t`sender_id` INT( 10 ) UNSIGNED NOT NULL ,\r\n  \t\t\t`sender_name` VARCHAR( 100 ) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL ,\r\n  \t\t\t`receiver_id` INT( 10 ) UNSIGNED NOT NULL ,\r\n  \t\t\t`receiver_name` VARCHAR( 100 ) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL ,\r\n  \t\t\t`refund_reason` VARCHAR( 100 ) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL ,\r\n  \t\t\t`refund_amount` DECIMAL( 10, 2 ) NOT NULL ,\r\n  \t\t\t`refund_intro` VARCHAR( 255 ) CHARACTER SET utf8 COLLATE utf8_general_ci ,\r\n  \t\t\t`create_time` INT( 10 ) UNSIGNED NOT NULL ,\r\n  \t\t\t`pay_time` INT UNSIGNED NOT NULL ,\r\n  \t\t\t`apply_amount` DECIMAL( 10, 2 ) NOT NULL ,\r\n  \t\t\t`status` TINYINT( 3 ) UNSIGNED NOT NULL DEFAULT '0',\r\n  \t\t\t`closed` TINYINT( 3 ) UNSIGNED NOT NULL DEFAULT '0',\r\n  \t\t\t`type` TINYINT( 3 ) UNSIGNED NOT NULL DEFAULT '0',\r\n  \t\t\t PRIMARY KEY ( `id` ) ,\r\n  \t\t\tINDEX ( `order_id` , `order_sn` , `sender_id` , `receiver_id`,`status` )\r\n  \t\t\t) ENGINE = MYISAM DEFAULT CHARSET=".str_replace( "-", "", CHARSET ).";";
+        //db( )->query( $sql );
+        /*ecm_article*/
+        $result = db()->getAll("SHOW COLUMNS FROM ".DB_PREFIX."article");
+        $fields = array();
+        foreach ($result as $v)
+        {
+            $fields[] = $v['Field'];
+        }
+        if(!in_array("add_red", $fields))
+        {
+            $sql = "ALTER TABLE `".DB_PREFIX."article` ADD `add_red` TINYINT(3) UNSIGNED NOT NULL DEFAULT '0'";
+            db()->query($sql);
+        }
     }
-    public function addColumnOrder1()
+    public static function addColumnOrder1()
     {
-       $result = db()->getAll("SHOW COLUMNS FROM ".DB_PREFIX."order_refund");
-       $fields = array();
-       foreach ($result as $v)
-       {
-               $fields[] = $v['Field'];
-       }
-       if(!in_array("invoice_no", $fields))
-       {
-               $sql = "ALTER TABLE `".DB_PREFIX."order_refund` ADD `invoice_no` varchar(255) CHARACTER SET utf8 COLLATE utf8_general_ci";
-               db()->query($sql);
-       }
-       if(!in_array("dl_id", $fields))
-       {
-               $sql = "ALTER TABLE `".DB_PREFIX."order_refund` ADD `dl_id` int(10) UNSIGNED NOT NULL DEFAULT '0'";
-               db()->query($sql);
-       }
-       if(!in_array("dl_code", $fields))
-       {
-               $sql = "ALTER TABLE `".DB_PREFIX."order_refund` ADD `dl_code` varchar(255) CHARACTER SET utf8 COLLATE utf8_general_ci";
-               db()->query($sql);
-       }
-       if(!in_array("dl_name", $fields))
-       {
-               $sql = "ALTER TABLE `".DB_PREFIX."order_refund` ADD `dl_name` varchar(100) CHARACTER SET utf8 COLLATE utf8_general_ci";
-               db()->query($sql);
-       }
-       //order_goods
-       $result = db()->getAll("SHOW COLUMNS FROM ".DB_PREFIX."order_goods");
-       $fields = array();
-       foreach ($result as $v)
-       {
-               $fields[] = $v['Field'];
-       }
-       if(!in_array("attr_value", $fields))
-       {
-               $sql = "ALTER TABLE `".DB_PREFIX."order_goods` ADD `attr_value` varchar(255) CHARACTER SET utf8 COLLATE utf8_general_ci";
-               db()->query($sql);
-       }
-       if(!in_array("store_id", $fields))
-       {
-               $sql = "ALTER TABLE `".DB_PREFIX."order_goods` ADD `store_id` int(10) UNSIGNED NOT NULL DEFAULT '0'";
-               db()->query($sql);
-       }
-       if(!in_array("oos_value", $fields))
-       {
-               $sql = "ALTER TABLE `".DB_PREFIX."order_goods` ADD `oos_value` tinyint(1) UNSIGNED NOT NULL DEFAULT '1'";
-               db()->query($sql);
-       }
-       if(!in_array("oos_reason", $fields))
-       {
-               $sql = "ALTER TABLE `".DB_PREFIX."order_goods` ADD `oos_reason` varchar(255) CHARACTER SET utf8 COLLATE utf8_general_ci";
-               db()->query($sql);
-       }
-       //20150923
-       if(!in_array("behalf_to51_discount", $fields))
-       {
-           $sql = "ALTER TABLE `".DB_PREFIX."order_goods` ADD `behalf_to51_discount` decimal(10,2) NOT NULL DEFAULT '0.00'";
-           db()->query($sql);
-       }
-       if(!in_array("zwd51_tobehalf_discount", $fields))
-       {
-           $sql = "ALTER TABLE `".DB_PREFIX."order_goods` ADD `zwd51_tobehalf_discount` decimal(10,2) NOT NULL DEFAULT '0.00'";
-           db()->query($sql);
-       }
-       //members
-       $result = db()->getAll("SHOW COLUMNS FROM ".DB_PREFIX."member");
-       $fields = array();
-       foreach ($result as $v)
-       {
-               $fields[] = $v['Field'];
-       }
-       if(!in_array("upload_goods", $fields))
-       {
-               $sql = "ALTER TABLE `".DB_PREFIX."member` ADD `upload_goods` int(10) UNSIGNED NOT NULL DEFAULT '0'";
-               db()->query($sql);
-       }
-       if(!in_array("upload_goods_time", $fields))
-       {
-               $sql = "ALTER TABLE `".DB_PREFIX."member` ADD `upload_goods_time` int(10) UNSIGNED NOT NULL DEFAULT '0'";
-               db()->query($sql);
-       }
-       //behalf_delivery
-       $result = db()->getAll("SHOW COLUMNS FROM ".DB_PREFIX."behalf_delivery");
-       $fields = array();
-       foreach ($result as $v)
-       {
-               $fields[] = $v['Field'];
-       }
-       if(in_array("dl_fee", $fields))
-       {
-               $sql = "ALTER TABLE `".DB_PREFIX."behalf_delivery` CHANGE `dl_fee` `first_amount` tinyint(3) UNSIGNED NOT NULL DEFAULT '1'";
-               db()->query($sql);
-       }
-       if(!in_array("first_price", $fields))
-       {
-               $sql = "ALTER TABLE `".DB_PREFIX."behalf_delivery` ADD `first_price` decimal(10,2)  NOT NULL DEFAULT '0'";
-               db()->query($sql);
-       }
-       if(!in_array("step_price", $fields))
-       {
-               $sql = "ALTER TABLE `".DB_PREFIX."behalf_delivery` ADD `step_price` decimal(10,2)  NOT NULL DEFAULT '0'";
-               db()->query($sql);
-       }
-       if(!in_array("step_amount", $fields))
-       {
-               $sql = "ALTER TABLE `".DB_PREFIX."behalf_delivery` ADD `step_amount` tinyint(3) UNSIGNED NOT NULL DEFAULT '1'";
-               db()->query($sql);
-       }
-       //behalf_delivery
-       $result = db()->getAll("SHOW COLUMNS FROM ".DB_PREFIX."goods_statistics");
-       $fields = array();
-       foreach ($result as $v)
-       {
-               $fields[] = $v['Field'];
-       }
-       if(!in_array("oos", $fields))
-       {
-               $sql = "ALTER TABLE `".DB_PREFIX."goods_statistics` ADD `oos` int(10) UNSIGNED NOT NULL DEFAULT '0'";
-               db()->query($sql);
-       }
-       //behalf
-       $result = db()->getAll("SHOW COLUMNS FROM ".DB_PREFIX."behalf");
-       $fields = array();
-       foreach ($result as $v)
-       {
-               $fields[] = $v['Field'];
-       }
-       if(!in_array("bh_notice", $fields))
-       {
-               $sql = "ALTER TABLE `".DB_PREFIX."behalf` ADD `bh_notice` varchar(255) CHARACTER SET utf8 COLLATE utf8_general_ci";
-               db()->query($sql);
-       }
-
-       //order_modeb
-       $sql = "CREATE TABLE IF NOT EXISTS `".DB_PREFIX."order_modeb` (\r\n  \t\t\t`order_id` int(10) NOT NULL,\r\n  \t\t\t`md_content` text ,\r\n  \t\t\tPRIMARY KEY (`order_id`)\r\n\t\t) ENGINE = MYISAM DEFAULT CHARSET=".str_replace( "-", "", CHARSET ).";";
-       db( )->query( $sql );
-
-       //order_modeb
-       $result = db()->getAll("SHOW COLUMNS FROM ".DB_PREFIX."order_modeb");
-       $fields = array();
-       foreach ($result as $v)
-       {
-           $fields[] = $v['Field'];
-       }
-       if(!in_array("name", $fields))
-       {
-           $sql = "ALTER TABLE `".DB_PREFIX."order_modeb` ADD `name` varchar(10) CHARACTER SET utf8 COLLATE utf8_general_ci";
-           db()->query($sql);
-       }
-       //20150923
-       $sql = "CREATE TABLE IF NOT EXISTS `".DB_PREFIX."store_discount` (\r\n  \t\t\t`id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT,\r\n  \t\t\t`store_id` int(10) UNSIGNED NOT NULL default '0' ,\r\n  \t\t\t`type` varchar(10) CHARACTER SET utf8 COLLATE utf8_general_ci,\r\n  \t\t\t`first_price` decimal(10,2) NOT NULL DEFAULT '0.00',\r\n  \t\t\t`end_price` decimal(10,2) NOT NULL DEFAULT '0.00',\r\n  \t\t\t`discount` decimal(10,2) NOT NULL DEFAULT '0.00',\r\n  \t\t\t`sort_order` tinyint(3) unsigned NOT NULL DEFAULT '255',\r\n  \t\t\tPRIMARY KEY (`id`)\r\n\t\t) ENGINE = MYISAM DEFAULT CHARSET=".str_replace( "-", "", CHARSET ).";";
-       db()->query( $sql );
-       //order
-       $result = db()->getAll("SHOW COLUMNS FROM ".DB_PREFIX."order");
-       $fields = array();
-       foreach ($result as $v)
-       {
-           $fields[] = $v['Field'];
-       }
-       if(!in_array("behalf_discount", $fields))
-       {
-           $sql = "ALTER TABLE `".DB_PREFIX."order` ADD `behalf_discount` decimal(10,2) NOT NULL DEFAULT '0.00'";
-           db()->query($sql);
-       }
-       //order_refund
-       $result = db()->getAll("SHOW COLUMNS FROM ".DB_PREFIX."order_refund");
-       $fields = array();
-       foreach ($result as $v)
-       {
-           $fields[] = $v['Field'];
-       }
-       //退货时标注
-       if(!in_array("goods_ids", $fields))
-       {
-           $sql = "ALTER TABLE `".DB_PREFIX."order_refund` ADD `goods_ids` varchar(255) CHARACTER SET utf8 COLLATE utf8_general_ci";
-           db()->query($sql);
-       }
-
+        $result = db()->getAll("SHOW COLUMNS FROM ".DB_PREFIX."order_refund");
+        $fields = array();
+        foreach ($result as $v)
+        {
+            $fields[] = $v['Field'];
+        }
+        if(!in_array("invoice_no", $fields))
+        {
+            $sql = "ALTER TABLE `".DB_PREFIX."order_refund` ADD `invoice_no` varchar(255) CHARACTER SET utf8 COLLATE utf8_general_ci";
+            db()->query($sql);
+        }
+        if(!in_array("dl_id", $fields))
+        {
+            $sql = "ALTER TABLE `".DB_PREFIX."order_refund` ADD `dl_id` int(10) UNSIGNED NOT NULL DEFAULT '0'";
+            db()->query($sql);
+        }
+        if(!in_array("dl_code", $fields))
+        {
+            $sql = "ALTER TABLE `".DB_PREFIX."order_refund` ADD `dl_code` varchar(255) CHARACTER SET utf8 COLLATE utf8_general_ci";
+            db()->query($sql);
+        }
+        if(!in_array("dl_name", $fields))
+        {
+            $sql = "ALTER TABLE `".DB_PREFIX."order_refund` ADD `dl_name` varchar(100) CHARACTER SET utf8 COLLATE utf8_general_ci";
+            db()->query($sql);
+        }
+        //order_goods
+        $result = db()->getAll("SHOW COLUMNS FROM ".DB_PREFIX."order_goods");
+        $fields = array();
+        foreach ($result as $v)
+        {
+            $fields[] = $v['Field'];
+        }
+        if(!in_array("attr_value", $fields))
+        {
+            $sql = "ALTER TABLE `".DB_PREFIX."order_goods` ADD `attr_value` varchar(255) CHARACTER SET utf8 COLLATE utf8_general_ci";
+            db()->query($sql);
+        }
+        if(!in_array("store_id", $fields))
+        {
+            $sql = "ALTER TABLE `".DB_PREFIX."order_goods` ADD `store_id` int(10) UNSIGNED NOT NULL DEFAULT '0'";
+            db()->query($sql);
+        }
+        if(!in_array("oos_value", $fields))
+        {
+            $sql = "ALTER TABLE `".DB_PREFIX."order_goods` ADD `oos_value` tinyint(1) UNSIGNED NOT NULL DEFAULT '1'";
+            db()->query($sql);
+        }
+        if(!in_array("oos_reason", $fields))
+        {
+            $sql = "ALTER TABLE `".DB_PREFIX."order_goods` ADD `oos_reason` varchar(255) CHARACTER SET utf8 COLLATE utf8_general_ci";
+            db()->query($sql);
+        }
+        //20150923
+        if(!in_array("behalf_to51_discount", $fields))
+        {
+            $sql = "ALTER TABLE `".DB_PREFIX."order_goods` ADD `behalf_to51_discount` decimal(10,2) NOT NULL DEFAULT '0.00'";
+            db()->query($sql);
+        }
+        if(!in_array("zwd51_tobehalf_discount", $fields))
+        {
+            $sql = "ALTER TABLE `".DB_PREFIX."order_goods` ADD `zwd51_tobehalf_discount` decimal(10,2) NOT NULL DEFAULT '0.00'";
+            db()->query($sql);
+        }
+        //members
+        $result = db()->getAll("SHOW COLUMNS FROM ".DB_PREFIX."member");
+        $fields = array();
+        foreach ($result as $v)
+        {
+            $fields[] = $v['Field'];
+        }
+        if(!in_array("upload_goods", $fields))
+        {
+            $sql = "ALTER TABLE `".DB_PREFIX."member` ADD `upload_goods` int(10) UNSIGNED NOT NULL DEFAULT '0'";
+            db()->query($sql);
+        }
+        if(!in_array("upload_goods_time", $fields))
+        {
+            $sql = "ALTER TABLE `".DB_PREFIX."member` ADD `upload_goods_time` int(10) UNSIGNED NOT NULL DEFAULT '0'";
+            db()->query($sql);
+        }
+        //behalf_delivery
+        $result = db()->getAll("SHOW COLUMNS FROM ".DB_PREFIX."behalf_delivery");
+        $fields = array();
+        foreach ($result as $v)
+        {
+            $fields[] = $v['Field'];
+        }
+        if(in_array("dl_fee", $fields))
+        {
+            $sql = "ALTER TABLE `".DB_PREFIX."behalf_delivery` CHANGE `dl_fee` `first_amount` tinyint(3) UNSIGNED NOT NULL DEFAULT '1'";
+            db()->query($sql);
+        }
+        if(!in_array("first_price", $fields))
+        {
+            $sql = "ALTER TABLE `".DB_PREFIX."behalf_delivery` ADD `first_price` decimal(10,2)  NOT NULL DEFAULT '0'";
+            db()->query($sql);
+        }
+        if(!in_array("step_price", $fields))
+        {
+            $sql = "ALTER TABLE `".DB_PREFIX."behalf_delivery` ADD `step_price` decimal(10,2)  NOT NULL DEFAULT '0'";
+            db()->query($sql);
+        }
+        if(!in_array("step_amount", $fields))
+        {
+            $sql = "ALTER TABLE `".DB_PREFIX."behalf_delivery` ADD `step_amount` tinyint(3) UNSIGNED NOT NULL DEFAULT '1'";
+            db()->query($sql);
+        }
+        //behalf_delivery
+        $result = db()->getAll("SHOW COLUMNS FROM ".DB_PREFIX."goods_statistics");
+        $fields = array();
+        foreach ($result as $v)
+        {
+            $fields[] = $v['Field'];
+        }
+        if(!in_array("oos", $fields))
+        {
+            $sql = "ALTER TABLE `".DB_PREFIX."goods_statistics` ADD `oos` int(10) UNSIGNED NOT NULL DEFAULT '0'";
+            db()->query($sql);
+        }
+        //behalf
+        $result = db()->getAll("SHOW COLUMNS FROM ".DB_PREFIX."behalf");
+        $fields = array();
+        foreach ($result as $v)
+        {
+            $fields[] = $v['Field'];
+        }
+        if(!in_array("bh_notice", $fields))
+        {
+            $sql = "ALTER TABLE `".DB_PREFIX."behalf` ADD `bh_notice` varchar(255) CHARACTER SET utf8 COLLATE utf8_general_ci";
+            db()->query($sql);
+        }
+
+        //order_modeb
+        $sql = "CREATE TABLE IF NOT EXISTS `".DB_PREFIX."order_modeb` (\r\n  \t\t\t`order_id` int(10) NOT NULL,\r\n  \t\t\t`md_content` text ,\r\n  \t\t\tPRIMARY KEY (`order_id`)\r\n\t\t) ENGINE = MYISAM DEFAULT CHARSET=".str_replace( "-", "", CHARSET ).";";
+        db( )->query( $sql );
+
+        //order_modeb
+        $result = db()->getAll("SHOW COLUMNS FROM ".DB_PREFIX."order_modeb");
+        $fields = array();
+        foreach ($result as $v)
+        {
+            $fields[] = $v['Field'];
+        }
+        if(!in_array("name", $fields))
+        {
+            $sql = "ALTER TABLE `".DB_PREFIX."order_modeb` ADD `name` varchar(10) CHARACTER SET utf8 COLLATE utf8_general_ci";
+            db()->query($sql);
+        }
+        //20150923
+        $sql = "CREATE TABLE IF NOT EXISTS `".DB_PREFIX."store_discount` (\r\n  \t\t\t`id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT,\r\n  \t\t\t`store_id` int(10) UNSIGNED NOT NULL default '0' ,\r\n  \t\t\t`type` varchar(10) CHARACTER SET utf8 COLLATE utf8_general_ci,\r\n  \t\t\t`first_price` decimal(10,2) NOT NULL DEFAULT '0.00',\r\n  \t\t\t`end_price` decimal(10,2) NOT NULL DEFAULT '0.00',\r\n  \t\t\t`discount` decimal(10,2) NOT NULL DEFAULT '0.00',\r\n  \t\t\t`sort_order` tinyint(3) unsigned NOT NULL DEFAULT '255',\r\n  \t\t\tPRIMARY KEY (`id`)\r\n\t\t) ENGINE = MYISAM DEFAULT CHARSET=".str_replace( "-", "", CHARSET ).";";
+        db()->query( $sql );
+        //order
+        $result = db()->getAll("SHOW COLUMNS FROM ".DB_PREFIX."order");
+        $fields = array();
+        foreach ($result as $v)
+        {
+            $fields[] = $v['Field'];
+        }
+        if(!in_array("behalf_discount", $fields))
+        {
+            $sql = "ALTER TABLE `".DB_PREFIX."order` ADD `behalf_discount` decimal(10,2) NOT NULL DEFAULT '0.00'";
+            db()->query($sql);
+        }
+        //order_refund
+        $result = db()->getAll("SHOW COLUMNS FROM ".DB_PREFIX."order_refund");
+        $fields = array();
+        foreach ($result as $v)
+        {
+            $fields[] = $v['Field'];
+        }
+        //退货时标注
+        if(!in_array("goods_ids", $fields))
+        {
+            $sql = "ALTER TABLE `".DB_PREFIX."order_refund` ADD `goods_ids` varchar(255) CHARACTER SET utf8 COLLATE utf8_general_ci";
+            db()->query($sql);
+        }
+
     }
-
-    public function addDBTable20151106()
+
+    public static function addDBTable20151106()
     {
         //behalf
         $result = db()->getAll("SHOW COLUMNS FROM ".DB_PREFIX."behalf");
@@ -463,8 +463,8 @@
             db()->query($sql);
         }
     }
-
-    public function addDBTable20160214()
+
+    public static function addDBTable20160214()
     {
         //代发区
         $sql ="CREATE TABLE IF NOT EXISTS `".DB_PREFIX."store_behalfarea` (\r\n  \t\t\t
@@ -491,7 +491,7 @@
         $sql ="CREATE TABLE IF NOT EXISTS `".DB_PREFIX."store_realityzone` (\r\n  \t\t\t
           `store_id` int(10) unsigned NOT NULL ,\r\n  \t\t\t
           `state` tinyint(3) unsigned NOT NULL DEFAULT '0',\r\n  \t\t\t
-          `category` varchar(10) DEFAULT NULL ,\r\n  \t\t\t
+          `category` varchar(10) DEFAULT NULL ,\r\n  \t\t\t
           PRIMARY KEY (`store_id`)\r\n  \t\t\t
         ) ENGINE=MyISAM  DEFAULT CHARSET=".str_replace( "-", "", CHARSET ). " ;";
         db()->query($sql);
@@ -519,7 +519,7 @@
             $sql = "ALTER TABLE `".DB_PREFIX."store_brandarea` ADD `category` varchar(10)";
             db()->query($sql);
         }
-
+
         //档口退货退款表
         $sql = "CREATE TABLE IF NOT EXISTS `".DB_PREFIX."order_store_refund` (
                   `id` int(10) unsigned NOT NULL AUTO_INCREMENT,
@@ -557,13 +557,13 @@
                 KEY `store_id` (`store_id`)
                 ) ENGINE=InnoDB DEFAULT CHARSET=".str_replace( "-", "", CHARSET ). ";";
         db()->query($sql);
-
+
     }
-
+
     public function addDBTable20151023()
     {
-       //创建库存订单表
-       $sql = "CREATE TABLE IF NOT EXISTS `".DB_PREFIX."stock_order` (\r\n  \t\t\t
+        //创建库存订单表
+        $sql = "CREATE TABLE IF NOT EXISTS `".DB_PREFIX."stock_order` (\r\n  \t\t\t
           `order_id` int(10) unsigned NOT NULL AUTO_INCREMENT,\r\n  \t\t\t
           `order_sn` varchar(20) NOT NULL DEFAULT '',\r\n  \t\t\t
           `type` varchar(10) NOT NULL DEFAULT 'material',\r\n  \t\t\t
@@ -599,10 +599,10 @@
           KEY `buyer_name` (`buyer_name`),\r\n  \t\t\t
           KEY `add_time` (`add_time`)\r\n  \t\t\t
         ) ENGINE=MyISAM  DEFAULT CHARSET=".str_replace( "-", "", CHARSET )."  AUTO_INCREMENT=1;" ;
-           db()->query($sql);
-
-
-       $sql = "CREATE TABLE IF NOT EXISTS `".DB_PREFIX."stock_order_goods` (\r\n  \t\t\t
+            db()->query($sql);
+
+
+        $sql = "CREATE TABLE IF NOT EXISTS `".DB_PREFIX."stock_order_goods` (\r\n  \t\t\t
           `rec_id` int(10) unsigned NOT NULL AUTO_INCREMENT,\r\n  \t\t\t
           `order_id` int(10) unsigned NOT NULL DEFAULT '0',\r\n  \t\t\t
           `goods_id` int(10) unsigned NOT NULL DEFAULT '0',\r\n  \t\t\t
@@ -623,10 +623,10 @@
           PRIMARY KEY (`rec_id`),\r\n  \t\t\t
           KEY `order_id` (`order_id`,`goods_id`)\r\n  \t\t\t
         ) ENGINE=MyISAM  DEFAULT CHARSET=".str_replace( "-", "", CHARSET ). " AUTO_INCREMENT=1 ;";
-           db()->query($sql);
-
-
-       $sql ="CREATE TABLE IF NOT EXISTS `".DB_PREFIX."stock_order_log` (\r\n  \t\t\t
+            db()->query($sql);
+
+
+        $sql ="CREATE TABLE IF NOT EXISTS `".DB_PREFIX."stock_order_log` (\r\n  \t\t\t
           `log_id` int(10) unsigned NOT NULL AUTO_INCREMENT,\r\n  \t\t\t
           `order_id` int(10) unsigned NOT NULL DEFAULT '0',\r\n  \t\t\t
           `operator` varchar(60) NOT NULL DEFAULT '',\r\n  \t\t\t
@@ -637,9 +637,9 @@
           PRIMARY KEY (`log_id`),\r\n  \t\t\t
           KEY `order_id` (`order_id`)\r\n  \t\t\t
         ) ENGINE=MyISAM  DEFAULT CHARSET=".str_replace( "-", "", CHARSET ). " AUTO_INCREMENT=1 ;";
-           db()->query($sql);
-
-
+            db()->query($sql);
+
+
     }
 }
 class Init_FrontendApp
@@ -675,10 +675,10 @@
                 //添加第三级
                 if(!empty($result))
                 {
-                       foreach ($result as $cate_val)
-                       {
-                               $result = array_merge($result,$gcategory_mod->get_list( $cate_val['cate_id'], TRUE ));
-                       }
+                    foreach ($result as $cate_val)
+                    {
+                        $result = array_merge($result,$gcategory_mod->get_list( $cate_val['cate_id'], TRUE ));
+                    }
                 }
                 $gcategories = array_merge( $gcategories, $result );
             }
@@ -686,44 +686,44 @@
         //cate_mname赋给cate_name
         if($gcategories)
         {
-               foreach ($gcategories as $key=>$value)
-               {
-                       if($value['cate_mname'])
-                       {
-                               $gcategories[$key]['cate_name'] = $value['cate_mname'];
-                       }
-               }
+            foreach ($gcategories as $key=>$value)
+            {
+                if($value['cate_mname'])
+                {
+                    $gcategories[$key]['cate_name'] = $value['cate_mname'];
+                }
+            }
         }
-
+
         import( "tree.lib" );
         $tree = new Tree( );
         $tree->setTree( $gcategories, "cate_id", "parent_id", "cate_name" );
         $gcategory_list = $tree->getArrayList( 0 );
-
+
         if($amount['f_amount'])
         {
-               $gcategory_list = array_slice( $gcategory_list, 0, $amount['f_amount'] );
+            $gcategory_list = array_slice( $gcategory_list, 0, $amount['f_amount'] );
         }
-
+
         if($amount['amount'])
         {
-               foreach ($gcategory_list as $key=>$value)
-               {
-                       $gcategory_list[$key]['children'] = array_slice($value['children'],0,$amount['amount']);
-               }
+            foreach ($gcategory_list as $key=>$value)
+            {
+                $gcategory_list[$key]['children'] = array_slice($value['children'],0,$amount['amount']);
+            }
         }
-
+
         if($amount['t_amount'])
         {
-               foreach ($gcategory_list as $key=>$value)
-               {
-                       foreach ($value['children'] as $key1=>$value1)
-                       {
-                               $gcategory_list[$key]['children'][$key1]['children'] = array_slice($value1['children'], 0,$amount['t_amount']);
-                       }
-               }
+            foreach ($gcategory_list as $key=>$value)
+            {
+                foreach ($value['children'] as $key1=>$value1)
+                {
+                    $gcategory_list[$key]['children'][$key1]['children'] = array_slice($value1['children'], 0,$amount['t_amount']);
+                }
+            }
         }
-
+
        /*  $i = 0;
         foreach ( $gcategory_list as $k => $v )
         {
@@ -847,21 +847,21 @@
 }
 if(!file_exists(WEIGHT_LOCK_FILE))
 {
-	Psmb_init::addColumInDelivery_template();
-	file_put_contents(WEIGHT_LOCK_FILE, 1);
+    Psmb_init::addColumInDelivery_template();
+    file_put_contents(WEIGHT_LOCK_FILE, 1);
 }
 /* if(!file_exists(BEHALF_ORDER) || trim(file_get_contents(BEHALF_ORDER)) != 'logistics_navgation_wx_bowner_order_refund_arc')
 {
-	Psmb_init::addColumnOrder();
-	file_put_contents(BEHALF_ORDER, 'logistics_navgation_wx_bowner_order_refund_arc');
+    Psmb_init::addColumnOrder();
+    file_put_contents(BEHALF_ORDER, 'logistics_navgation_wx_bowner_order_refund_arc');
 } */
 if(!file_exists(BEHALF_ORDER) || trim(file_get_contents(BEHALF_ORDER)) != 'refund_member_delivery20160621')
 {
-	Psmb_init::addColumnOrder1();
-	//Psmb_init::addDBTable20151023();
-	Psmb_init::addDBTable20151106();
-	Psmb_init::addDBTable20160214();
-	file_put_contents(BEHALF_ORDER, 'refund_member_delivery20160621');
+    Psmb_init::addColumnOrder1();
+    //Psmb_init::addDBTable20151023();
+    Psmb_init::addDBTable20151106();
+    Psmb_init::addDBTable20160214();
+    file_put_contents(BEHALF_ORDER, 'refund_member_delivery20160621');
 }

 ?>
\ No newline at end of file
Index: includes/passport.base.php
===================================================================
--- includes/passport.base.php	(revision 3919)
+++ includes/passport.base.php	(working copy)
@@ -200,10 +200,10 @@
     }
     function _local_drop($user_id)
     {
-       //add by tanaiquan 2015-07-12
-        $this->_error('ban to delete');
-        return 0;
-       //
+        //add by tanaiquan 2015-07-12
+         $this->_error('ban to delete');
+         return 0;
+        //
         $model_member =& m('member');
         $drop_nums = $model_member->drop($user_id);
         if ($model_member->has_error())
@@ -286,7 +286,7 @@
      *    @param     string $limit
      *    @return    array:消息列表
      */
-    function get_list($user_id, $limit = '0, 10', $folder = 'inbox')
+    function get_list($user_id, $limit, $folder = 'inbox')
     {
         #TODO
     }
@@ -405,7 +405,7 @@
      *    @param     array $feed    事件
      *    @return    false:失败   true:成功
      */
-    function add($feed)
+    function add($event, $feed)
     {
         #TODO
     }
Index: themes/mall/ymall/top.html
===================================================================
--- themes/mall/ymall/top.html	(revision 3919)
+++ themes/mall/ymall/top.html	(working copy)
@@ -19,7 +19,7 @@
 <script type="text/javascript" src="{lib file=ecmall.js}" charset="utf-8"></script>
 <script type="text/javascript" src="{lib file=cart.js}" charset="utf-8"></script>
 <script type="text/javascript" src="{lib file=jquery.plugins/jquery.lazyload.js}" charset="utf-8"></script>
-<script type="text/javascript" src="{res file=js/main.js}" charset="utf-8"></script>
+<script type="text/javascript" src="{res file=js/main.js}" charset="utf-8"></script>
 <!--{if $index }-->
 <script type="text/javascript" src="{lib file=jquery.plugins/jquery.SuperSlide.js}" charset="utf-8"></script>
 <!--{/if}-->
@@ -34,7 +34,7 @@
 var REAL_SITE_URL = "{$real_site_url}";
 var PRICE_FORMAT = '{$price_format}';
 $(function(){
-	$('img.lazyload').lazyload();
+        $('img.lazyload').lazyload();
 });
 //]]>
 </script>
@@ -47,62 +47,62 @@
    <div class="shoptop w clearfix">
      <div class="left">
          <div class="city-nav">
-                  <dl>
-                   <dt>{$currentCitysite}</dt>
-                   <dd class="hidden">
-                      <!--{foreach from=$citysiteList item=city name=city_fee}-->
-                         {$city}
-                      <!--{/foreach}-->
-                   </dd>
-                  </dl>
-             </div>
+                   <dl>
+                    <dt>{$currentCitysite}</dt>
+                    <dd class="hidden">
+                       <!--{foreach from=$citysiteList item=city name=city_fee}-->
+                          {$city}
+                       <!--{/foreach}-->
+                    </dd>
+                   </dl>
+              </div>
          <div class="float-left">
-                        <a class="home-set ml5" href="javascript:SetHome(this,window.location)">{$lang.set_home}</a>
-                        <a class="site-coll ml10" href="javascript:AddFavorite(document.title,'http://www.51zwd.com')">{$lang.collect_oursite}</a>
-             </div>
-
-
-             <div id="login_info_wrapper" class="login_info f66 clearfix">
-                                <!--{if !$visitor.user_id}-->
-                                        <span class="login-span  v_line float-left">
-                                    <a href="{url app=member&act=login&ret_url=$ret_url}" class="login-flag" target="_blank">{$lang.login}</a>
-                                    <ul class="hidden">
-                                     <div class="login-div-wrapper">
-                                     <li class="login-51"><a href="{url app=member&act=login&ret_url=$ret_url}" target="_blank">{$lang.login_51}</a></li>
-                                     <li class="login-taobao"><a href="{url app=member&act=loginWithTaobao&ret_url=$ret_url}" target="_blank">{$lang.login_taobao}</a></li>
-                                     <li class="login-ali"><a href="{url app=member&act=loginWithAlibaba&ret_url=$ret_url}" target="_blank">{$lang.login_ali}</a></li>
-                                     </div>
-                                    </ul>
-                                   </span>
-
-                                        <a href="{url app=member&act=register&ret_url=$ret_url}" class="ml5 pr5 v_line float-left" target="_blank">{$lang.register}</a>
-                                        <!--{else}-->
-                                        <a href="{url app=member}" class="ml5"><span>{$visitor.user_name|escape}</span></a>
-                                        <a href="{url app=message&act=newpm}">{$lang.user_center}<!--{if $new_message}-->(<span>{$new_message}</span>)<!--{/if}--></a>
-                                        <a href="{url app=member&act=logout}" class="pr5 v_line">{$lang.logout}</a>
-				<!--{/if}-->
-                  </div>
-                  <div class="float-left">
-                        <a href="{$smarty.const.QQGRP_HREF}" target="_blank">
-                        <!--{if $smarty.const.QQGRP_SHOW }-->
-                          <img border="0" src="http://pub.idqqimg.com/wpa/images/group.png" alt="{$lang.free_kefuqun}" title="{$lang.free_kefuqun}">
-                        <!--{else}-->
-                          {$lang.kefuqun}{$smarty.const.QQGRP_NO}
-                        <!--{/if}-->
-                        </a>
-             </div>
-          </div>
+                         <a class="home-set ml5" href="javascript:SetHome(this,window.location)">{$lang.set_home}</a>
+                         <a class="site-coll ml10" href="javascript:AddFavorite(document.title,'http://www.51zwd.com')">{$lang.collect_oursite}</a>
+              </div>
+
+
+              <div id="login_info_wrapper" class="login_info f66 clearfix">
+                                 <!--{if !$visitor.user_id}-->
+                                         <span class="login-span  v_line float-left">
+                                     <a href="{url app=member&act=login&ret_url=$ret_url}" class="login-flag" target="_blank">{$lang.login}</a>
+                                     <ul class="hidden">
+                                      <div class="login-div-wrapper">
+                                      <li class="login-51"><a href="{url app=member&act=login&ret_url=$ret_url}" target="_blank">{$lang.login_51}</a></li>
+                                      <li class="login-taobao"><a href="{url app=member&act=loginWithTaobao&ret_url=$ret_url}" target="_blank">{$lang.login_taobao}</a></li>
+                                      <li class="login-ali"><a href="{url app=member&act=loginWithAlibaba&ret_url=$ret_url}" target="_blank">{$lang.login_ali}</a></li>
+                                      </div>
+                                     </ul>
+                                    </span>
+
+                                         <a href="{url app=member&act=register&ret_url=$ret_url}" class="ml5 pr5 v_line float-left" target="_blank">{$lang.register}</a>
+                                         <!--{else}-->
+                                         <a href="{url app=member}" class="ml5"><span>{$visitor.user_name|escape}</span></a>
+                                         <a href="{url app=message&act=newpm}">{$lang.user_center}<!--{if $new_message}-->(<span>{$new_message}</span>)<!--{/if}--></a>
+                                         <a href="{url app=member&act=logout}" class="pr5 v_line">{$lang.logout}</a>
+                                <!--{/if}-->
+                   </div>
+                   <div class="float-left">
+                         <a href="{$smarty.const.QQGRP_HREF}" target="_blank">
+                         <!--{if $smarty.const.QQGRP_SHOW }-->
+                           <img border="0" src="http://pub.idqqimg.com/wpa/images/group.png" alt="{$lang.free_kefuqun}" title="{$lang.free_kefuqun}">
+                         <!--{else}-->
+                           {$lang.kefuqun}{$smarty.const.QQGRP_NO}
+                         <!--{/if}-->
+                         </a>
+              </div>
+           </div>
       <ul class="quick-menu">
         {if !$index}<li class="home"><a href="{$site_url}">{$lang.back_home}</a></li>{/if}
          <li class="service v_line">
             <a href="{url app=apply}">{$lang.apply_register}</a>
          </li>

-                <li class="service v_line">
+                 <li class="service v_line">
             <a href="{url app=default&amp;act=submit_newgoods}">{$lang.newstyle_submit}</a>
          </li>

-		<li class="item v_line">
+                <li class="item v_line">
             <div class="menu favorite">
                <a class="menu-hd" href="javascript:;">{$lang.our_collect}<b></b></a>
                <div class="menu-bd">
@@ -117,10 +117,10 @@
            </div>
          </li>

-                <li class="service v_line">
+                 <li class="service v_line">
             <a href="{url app=my_favorite}">{$lang.data_bag}</a>
          </li>
-
+
          <li class="item v_line">
             <div class="menu focusus">
                <a class="menu-hd" href="javascript:;">{$lang.eyes_onme}<b></b></a>
@@ -129,7 +129,7 @@
                      <div>
                        <p><a href="http://weibo.com/wangpi">{$lang.51sinaweibo}</a></p>
                        <p><a href="http://t.qq.com/woyaozuowangdian">{$lang.51tecentweibo}</a></p>
-                                          <p><a href="data/system/ma01.jpg">{$lang.51officeweixin}</a></p>
+                                           <p><a href="data/system/ma01.jpg">{$lang.51officeweixin}</a></p>
                     </div>
                  </div>
                </div>
@@ -147,4 +147,4 @@
         </li>
      </ul>
    </div>
-</div>
\ No newline at end of file
+</div>
Index: uc_client/client.php
===================================================================
--- uc_client/client.php	(revision 3919)
+++ uc_client/client.php	(working copy)
@@ -1,14 +1,14 @@
 <?php

 /*
-	[UCenter] (C)2001-2099 Comsenz Inc.
-	This is NOT a freeware, use is subject to license terms
+    [UCenter] (C)2001-2099 Comsenz Inc.
+    This is NOT a freeware, use is subject to license terms

-	$Id: client.php 1079 2011-04-02 07:29:36Z zhengqingpeng $
+    $Id: client.php 1079 2011-04-02 07:29:36Z zhengqingpeng $
 */

 if(!defined('UC_API')) {
-	exit('Access denied');
+    exit('Access denied');
 }

 error_reporting(0);
@@ -23,559 +23,559 @@
 $GLOBALS['uc_controls'] = array();

 function uc_addslashes($string, $force = 0, $strip = FALSE) {
-	!defined('MAGIC_QUOTES_GPC') && define('MAGIC_QUOTES_GPC', get_magic_quotes_gpc());
-	if(!MAGIC_QUOTES_GPC || $force) {
-		if(is_array($string)) {
-			foreach($string as $key => $val) {
-				$string[$key] = uc_addslashes($val, $force, $strip);
-			}
-		} else {
-			$string = addslashes($strip ? stripslashes($string) : $string);
-		}
-	}
-	return $string;
+    !defined('MAGIC_QUOTES_GPC') && define('MAGIC_QUOTES_GPC', get_magic_quotes_gpc());
+    if(!MAGIC_QUOTES_GPC || $force) {
+        if(is_array($string)) {
+            foreach($string as $key => $val) {
+                $string[$key] = uc_addslashes($val, $force, $strip);
+            }
+        } else {
+            $string = addslashes($strip ? stripslashes($string) : $string);
+        }
+    }
+    return $string;
 }

 if(!function_exists('daddslashes')) {
-	function daddslashes($string, $force = 0) {
-		return uc_addslashes($string, $force);
-	}
+    function daddslashes($string, $force = 0) {
+        return uc_addslashes($string, $force);
+    }
 }

 function uc_stripslashes($string) {
-	!defined('MAGIC_QUOTES_GPC') && define('MAGIC_QUOTES_GPC', get_magic_quotes_gpc());
-	if(MAGIC_QUOTES_GPC) {
-		return stripslashes($string);
-	} else {
-		return $string;
-	}
+    !defined('MAGIC_QUOTES_GPC') && define('MAGIC_QUOTES_GPC', get_magic_quotes_gpc());
+    if(MAGIC_QUOTES_GPC) {
+        return stripslashes($string);
+    } else {
+        return $string;
+    }
 }

 function uc_api_post($module, $action, $arg = array()) {
-	$s = $sep = '';
-	foreach($arg as $k => $v) {
-		$k = urlencode($k);
-		if(is_array($v)) {
-			$s2 = $sep2 = '';
-			foreach($v as $k2 => $v2) {
-				$k2 = urlencode($k2);
-				$s2 .= "$sep2{$k}[$k2]=".urlencode(uc_stripslashes($v2));
-				$sep2 = '&';
-			}
-			$s .= $sep.$s2;
-		} else {
-			$s .= "$sep$k=".urlencode(uc_stripslashes($v));
-		}
-		$sep = '&';
-	}
-	$postdata = uc_api_requestdata($module, $action, $s);
-	return uc_fopen2(UC_API.'/index.php', 500000, $postdata, '', TRUE, UC_IP, 20);
+    $s = $sep = '';
+    foreach($arg as $k => $v) {
+        $k = urlencode($k);
+        if(is_array($v)) {
+            $s2 = $sep2 = '';
+            foreach($v as $k2 => $v2) {
+                $k2 = urlencode($k2);
+                $s2 .= "$sep2{$k}[$k2]=".urlencode(uc_stripslashes($v2));
+                $sep2 = '&';
+            }
+            $s .= $sep.$s2;
+        } else {
+            $s .= "$sep$k=".urlencode(uc_stripslashes($v));
+        }
+        $sep = '&';
+    }
+    $postdata = uc_api_requestdata($module, $action, $s);
+    return uc_fopen2(UC_API.'/index.php', 500000, $postdata, '', TRUE, UC_IP, 20);
 }

 function uc_api_requestdata($module, $action, $arg='', $extra='') {
-	$input = uc_api_input($arg);
-	$post = "m=$module&a=$action&inajax=2&release=".UC_CLIENT_RELEASE."&input=$input&appid=".UC_APPID.$extra;
-	return $post;
+    $input = uc_api_input($arg);
+    $post = "m=$module&a=$action&inajax=2&release=".UC_CLIENT_RELEASE."&input=$input&appid=".UC_APPID.$extra;
+    return $post;
 }

 function uc_api_url($module, $action, $arg='', $extra='') {
-	$url = UC_API.'/index.php?'.uc_api_requestdata($module, $action, $arg, $extra);
-	return $url;
+    $url = UC_API.'/index.php?'.uc_api_requestdata($module, $action, $arg, $extra);
+    return $url;
 }

 function uc_api_input($data) {
-	$s = urlencode(uc_authcode($data.'&agent='.md5($_SERVER['HTTP_USER_AGENT'])."&time=".time(), 'ENCODE', UC_KEY));
-	return $s;
+    $s = urlencode(uc_authcode($data.'&agent='.md5($_SERVER['HTTP_USER_AGENT'])."&time=".time(), 'ENCODE', UC_KEY));
+    return $s;
 }

 function uc_api_mysql($model, $action, $args=array()) {
-	global $uc_controls;
-	if(empty($uc_controls[$model])) {
-		include_once UC_ROOT.'./lib/db.class.php';
-		include_once UC_ROOT.'./model/base.php';
-		include_once UC_ROOT."./control/$model.php";
-		eval("\$uc_controls['$model'] = new {$model}control();");
-	}
-	if($action{0} != '_') {
-		$args = uc_addslashes($args, 1, TRUE);
-		$action = 'on'.$action;
-		$uc_controls[$model]->input = $args;
-		return $uc_controls[$model]->$action($args);
-	} else {
-		return '';
-	}
+    global $uc_controls;
+    if(empty($uc_controls[$model])) {
+        include_once UC_ROOT.'./lib/db.class.php';
+        include_once UC_ROOT.'./model/base.php';
+        include_once UC_ROOT."./control/$model.php";
+        eval("\$uc_controls['$model'] = new {$model}control();");
+    }
+    if($action{0} != '_') {
+        $args = uc_addslashes($args, 1, TRUE);
+        $action = 'on'.$action;
+        $uc_controls[$model]->input = $args;
+        return $uc_controls[$model]->$action($args);
+    } else {
+        return '';
+    }
 }

 function uc_serialize($arr, $htmlon = 0) {
-	include_once UC_ROOT.'./lib/xml.class.php';
-	return xml_serialize($arr, $htmlon);
+    include_once UC_ROOT.'./lib/xml.class.php';
+    return xml_serialize($arr, $htmlon);
 }

 function uc_unserialize($s) {
-	include_once UC_ROOT.'./lib/xml.class.php';
-	return xml_unserialize($s);
+    include_once UC_ROOT.'./lib/xml.class.php';
+    return xml_unserialize($s);
 }

 function uc_authcode($string, $operation = 'DECODE', $key = '', $expiry = 0) {

-	$ckey_length = 4;
+    $ckey_length = 4;

-	$key = md5($key ? $key : UC_KEY);
-	$keya = md5(substr($key, 0, 16));
-	$keyb = md5(substr($key, 16, 16));
-	$keyc = $ckey_length ? ($operation == 'DECODE' ? substr($string, 0, $ckey_length): substr(md5(microtime()), -$ckey_length)) : '';
+    $key = md5($key ? $key : UC_KEY);
+    $keya = md5(substr($key, 0, 16));
+    $keyb = md5(substr($key, 16, 16));
+    $keyc = $ckey_length ? ($operation == 'DECODE' ? substr($string, 0, $ckey_length): substr(md5(microtime()), -$ckey_length)) : '';

-	$cryptkey = $keya.md5($keya.$keyc);
-	$key_length = strlen($cryptkey);
+    $cryptkey = $keya.md5($keya.$keyc);
+    $key_length = strlen($cryptkey);

-	$string = $operation == 'DECODE' ? base64_decode(substr($string, $ckey_length)) : sprintf('%010d', $expiry ? $expiry + time() : 0).substr(md5($string.$keyb), 0, 16).$string;
-	$string_length = strlen($string);
+    $string = $operation == 'DECODE' ? base64_decode(substr($string, $ckey_length)) : sprintf('%010d', $expiry ? $expiry + time() : 0).substr(md5($string.$keyb), 0, 16).$string;
+    $string_length = strlen($string);

-	$result = '';
-	$box = range(0, 255);
+    $result = '';
+    $box = range(0, 255);

-	$rndkey = array();
-	for($i = 0; $i <= 255; $i++) {
-		$rndkey[$i] = ord($cryptkey[$i % $key_length]);
-	}
+    $rndkey = array();
+    for($i = 0; $i <= 255; $i++) {
+        $rndkey[$i] = ord($cryptkey[$i % $key_length]);
+    }

-	for($j = $i = 0; $i < 256; $i++) {
-		$j = ($j + $box[$i] + $rndkey[$i]) % 256;
-		$tmp = $box[$i];
-		$box[$i] = $box[$j];
-		$box[$j] = $tmp;
-	}
+    for($j = $i = 0; $i < 256; $i++) {
+        $j = ($j + $box[$i] + $rndkey[$i]) % 256;
+        $tmp = $box[$i];
+        $box[$i] = $box[$j];
+        $box[$j] = $tmp;
+    }

-	for($a = $j = $i = 0; $i < $string_length; $i++) {
-		$a = ($a + 1) % 256;
-		$j = ($j + $box[$a]) % 256;
-		$tmp = $box[$a];
-		$box[$a] = $box[$j];
-		$box[$j] = $tmp;
-		$result .= chr(ord($string[$i]) ^ ($box[($box[$a] + $box[$j]) % 256]));
-	}
+    for($a = $j = $i = 0; $i < $string_length; $i++) {
+        $a = ($a + 1) % 256;
+        $j = ($j + $box[$a]) % 256;
+        $tmp = $box[$a];
+        $box[$a] = $box[$j];
+        $box[$j] = $tmp;
+        $result .= chr(ord($string[$i]) ^ ($box[($box[$a] + $box[$j]) % 256]));
+    }

-	if($operation == 'DECODE') {
-		if((substr($result, 0, 10) == 0 || substr($result, 0, 10) - time() > 0) && substr($result, 10, 16) == substr(md5(substr($result, 26).$keyb), 0, 16)) {
-			return substr($result, 26);
-		} else {
-			return '';
-		}
-	} else {
-		return $keyc.str_replace('=', '', base64_encode($result));
-	}
+    if($operation == 'DECODE') {
+        if((substr($result, 0, 10) == 0 || substr($result, 0, 10) - time() > 0) && substr($result, 10, 16) == substr(md5(substr($result, 26).$keyb), 0, 16)) {
+            return substr($result, 26);
+        } else {
+            return '';
+        }
+    } else {
+        return $keyc.str_replace('=', '', base64_encode($result));
+    }
 }

 function uc_fopen2($url, $limit = 0, $post = '', $cookie = '', $bysocket = FALSE, $ip = '', $timeout = 15, $block = TRUE) {
-	$__times__ = isset($_GET['__times__']) ? intval($_GET['__times__']) + 1 : 1;
-	if($__times__ > 2) {
-		return '';
-	}
-	$url .= (strpos($url, '?') === FALSE ? '?' : '&')."__times__=$__times__";
-	return uc_fopen($url, $limit, $post, $cookie, $bysocket, $ip, $timeout, $block);
+    $__times__ = isset($_GET['__times__']) ? intval($_GET['__times__']) + 1 : 1;
+    if($__times__ > 2) {
+        return '';
+    }
+    $url .= (strpos($url, '?') === FALSE ? '?' : '&')."__times__=$__times__";
+    return uc_fopen($url, $limit, $post, $cookie, $bysocket, $ip, $timeout, $block);
 }

 function uc_fopen($url, $limit = 0, $post = '', $cookie = '', $bysocket = FALSE, $ip = '', $timeout = 15, $block = TRUE) {
-	$return = '';
-	$matches = parse_url($url);
-	!isset($matches['host']) && $matches['host'] = '';
-	!isset($matches['path']) && $matches['path'] = '';
-	!isset($matches['query']) && $matches['query'] = '';
-	!isset($matches['port']) && $matches['port'] = '';
-	$host = $matches['host'];
-	$path = $matches['path'] ? $matches['path'].($matches['query'] ? '?'.$matches['query'] : '') : '/';
-	$port = !empty($matches['port']) ? $matches['port'] : 80;
-	if($post) {
-		$out = "POST $path HTTP/1.0\r\n";
-		$out .= "Accept: */*\r\n";
-		//$out .= "Referer: $boardurl\r\n";
-		$out .= "Accept-Language: zh-cn\r\n";
-		$out .= "Content-Type: application/x-www-form-urlencoded\r\n";
-		$out .= "User-Agent: $_SERVER[HTTP_USER_AGENT]\r\n";
-		$out .= "Host: $host\r\n";
-		$out .= 'Content-Length: '.strlen($post)."\r\n";
-		$out .= "Connection: Close\r\n";
-		$out .= "Cache-Control: no-cache\r\n";
-		$out .= "Cookie: $cookie\r\n\r\n";
-		$out .= $post;
-	} else {
-		$out = "GET $path HTTP/1.0\r\n";
-		$out .= "Accept: */*\r\n";
-		//$out .= "Referer: $boardurl\r\n";
-		$out .= "Accept-Language: zh-cn\r\n";
-		$out .= "User-Agent: $_SERVER[HTTP_USER_AGENT]\r\n";
-		$out .= "Host: $host\r\n";
-		$out .= "Connection: Close\r\n";
-		$out .= "Cookie: $cookie\r\n\r\n";
-	}
+    $return = '';
+    $matches = parse_url($url);
+    !isset($matches['host']) && $matches['host'] = '';
+    !isset($matches['path']) && $matches['path'] = '';
+    !isset($matches['query']) && $matches['query'] = '';
+    !isset($matches['port']) && $matches['port'] = '';
+    $host = $matches['host'];
+    $path = $matches['path'] ? $matches['path'].($matches['query'] ? '?'.$matches['query'] : '') : '/';
+    $port = !empty($matches['port']) ? $matches['port'] : 80;
+    if($post) {
+        $out = "POST $path HTTP/1.0\r\n";
+        $out .= "Accept: */*\r\n";
+        //$out .= "Referer: $boardurl\r\n";
+        $out .= "Accept-Language: zh-cn\r\n";
+        $out .= "Content-Type: application/x-www-form-urlencoded\r\n";
+        $out .= "User-Agent: $_SERVER[HTTP_USER_AGENT]\r\n";
+        $out .= "Host: $host\r\n";
+        $out .= 'Content-Length: '.strlen($post)."\r\n";
+        $out .= "Connection: Close\r\n";
+        $out .= "Cache-Control: no-cache\r\n";
+        $out .= "Cookie: $cookie\r\n\r\n";
+        $out .= $post;
+    } else {
+        $out = "GET $path HTTP/1.0\r\n";
+        $out .= "Accept: */*\r\n";
+        //$out .= "Referer: $boardurl\r\n";
+        $out .= "Accept-Language: zh-cn\r\n";
+        $out .= "User-Agent: $_SERVER[HTTP_USER_AGENT]\r\n";
+        $out .= "Host: $host\r\n";
+        $out .= "Connection: Close\r\n";
+        $out .= "Cookie: $cookie\r\n\r\n";
+    }

-	if(function_exists('fsockopen')) {
-		$fp = @fsockopen(($ip ? $ip : $host), $port, $errno, $errstr, $timeout);
-	} elseif (function_exists('pfsockopen')) {
-		$fp = @pfsockopen(($ip ? $ip : $host), $port, $errno, $errstr, $timeout);
-	} else {
-		$fp = false;
-	}
+    if(function_exists('fsockopen')) {
+        $fp = @fsockopen(($ip ? $ip : $host), $port, $errno, $errstr, $timeout);
+    } elseif (function_exists('pfsockopen')) {
+        $fp = @pfsockopen(($ip ? $ip : $host), $port, $errno, $errstr, $timeout);
+    } else {
+        $fp = false;
+    }

-	if(!$fp) {
-		return '';
-	} else {
-		stream_set_blocking($fp, $block);
-		stream_set_timeout($fp, $timeout);
-		@fwrite($fp, $out);
-		$status = stream_get_meta_data($fp);
-		if(!$status['timed_out']) {
-			while (!feof($fp)) {
-				if(($header = @fgets($fp)) && ($header == "\r\n" ||  $header == "\n")) {
-					break;
-				}
-			}
+    if(!$fp) {
+        return '';
+    } else {
+        stream_set_blocking($fp, $block);
+        stream_set_timeout($fp, $timeout);
+        @fwrite($fp, $out);
+        $status = stream_get_meta_data($fp);
+        if(!$status['timed_out']) {
+            while (!feof($fp)) {
+                if(($header = @fgets($fp)) && ($header == "\r\n" ||  $header == "\n")) {
+                    break;
+                }
+            }

-			$stop = false;
-			while(!feof($fp) && !$stop) {
-				$data = fread($fp, ($limit == 0 || $limit > 8192 ? 8192 : $limit));
-				$return .= $data;
-				if($limit) {
-					$limit -= strlen($data);
-					$stop = $limit <= 0;
-				}
-			}
-		}
-		@fclose($fp);
-		return $return;
-	}
+            $stop = false;
+            while(!feof($fp) && !$stop) {
+                $data = fread($fp, ($limit == 0 || $limit > 8192 ? 8192 : $limit));
+                $return .= $data;
+                if($limit) {
+                    $limit -= strlen($data);
+                    $stop = $limit <= 0;
+                }
+            }
+        }
+        @fclose($fp);
+        return $return;
+    }
 }

 function uc_app_ls() {
-	$return = call_user_func(UC_API_FUNC, 'app', 'ls', array());
-	return UC_CONNECT == 'mysql' ? $return : uc_unserialize($return);
+    $return = call_user_func(UC_API_FUNC, 'app', 'ls', array());
+    return UC_CONNECT == 'mysql' ? $return : uc_unserialize($return);
 }

 function uc_feed_add($icon, $uid, $username, $title_template='', $title_data='', $body_template='', $body_data='', $body_general='', $target_ids='', $images = array()) {
-	return call_user_func(UC_API_FUNC, 'feed', 'add',
-		array(  'icon'=>$icon,
-			'appid'=>UC_APPID,
-			'uid'=>$uid,
-			'username'=>$username,
-			'title_template'=>$title_template,
-			'title_data'=>$title_data,
-			'body_template'=>$body_template,
-			'body_data'=>$body_data,
-			'body_general'=>$body_general,
-			'target_ids'=>$target_ids,
-			'image_1'=>$images[0]['url'],
-			'image_1_link'=>$images[0]['link'],
-			'image_2'=>$images[1]['url'],
-			'image_2_link'=>$images[1]['link'],
-			'image_3'=>$images[2]['url'],
-			'image_3_link'=>$images[2]['link'],
-			'image_4'=>$images[3]['url'],
-			'image_4_link'=>$images[3]['link']
-		)
-	);
+    return call_user_func(UC_API_FUNC, 'feed', 'add',
+        array(  'icon'=>$icon,
+            'appid'=>UC_APPID,
+            'uid'=>$uid,
+            'username'=>$username,
+            'title_template'=>$title_template,
+            'title_data'=>$title_data,
+            'body_template'=>$body_template,
+            'body_data'=>$body_data,
+            'body_general'=>$body_general,
+            'target_ids'=>$target_ids,
+            'image_1'=>$images[0]['url'],
+            'image_1_link'=>$images[0]['link'],
+            'image_2'=>$images[1]['url'],
+            'image_2_link'=>$images[1]['link'],
+            'image_3'=>$images[2]['url'],
+            'image_3_link'=>$images[2]['link'],
+            'image_4'=>$images[3]['url'],
+            'image_4_link'=>$images[3]['link']
+        )
+    );
 }

 function uc_feed_get($limit = 100, $delete = TRUE) {
-	$return = call_user_func(UC_API_FUNC, 'feed', 'get', array('limit'=>$limit, 'delete'=>$delete));
-	return UC_CONNECT == 'mysql' ? $return : uc_unserialize($return);
+    $return = call_user_func(UC_API_FUNC, 'feed', 'get', array('limit'=>$limit, 'delete'=>$delete));
+    return UC_CONNECT == 'mysql' ? $return : uc_unserialize($return);
 }

 function uc_friend_add($uid, $friendid, $comment='') {
-	return call_user_func(UC_API_FUNC, 'friend', 'add', array('uid'=>$uid, 'friendid'=>$friendid, 'comment'=>$comment));
+    return call_user_func(UC_API_FUNC, 'friend', 'add', array('uid'=>$uid, 'friendid'=>$friendid, 'comment'=>$comment));
 }

 function uc_friend_delete($uid, $friendids) {
-	return call_user_func(UC_API_FUNC, 'friend', 'delete', array('uid'=>$uid, 'friendids'=>$friendids));
+    return call_user_func(UC_API_FUNC, 'friend', 'delete', array('uid'=>$uid, 'friendids'=>$friendids));
 }

 function uc_friend_totalnum($uid, $direction = 0) {
-	return call_user_func(UC_API_FUNC, 'friend', 'totalnum', array('uid'=>$uid, 'direction'=>$direction));
+    return call_user_func(UC_API_FUNC, 'friend', 'totalnum', array('uid'=>$uid, 'direction'=>$direction));
 }

 function uc_friend_ls($uid, $page = 1, $pagesize = 10, $totalnum = 10, $direction = 0) {
-	$return = call_user_func(UC_API_FUNC, 'friend', 'ls', array('uid'=>$uid, 'page'=>$page, 'pagesize'=>$pagesize, 'totalnum'=>$totalnum, 'direction'=>$direction));
-	return UC_CONNECT == 'mysql' ? $return : uc_unserialize($return);
+    $return = call_user_func(UC_API_FUNC, 'friend', 'ls', array('uid'=>$uid, 'page'=>$page, 'pagesize'=>$pagesize, 'totalnum'=>$totalnum, 'direction'=>$direction));
+    return UC_CONNECT == 'mysql' ? $return : uc_unserialize($return);
 }

 function uc_user_register($username, $password, $email, $questionid = '', $answer = '', $regip = '') {
-	return call_user_func(UC_API_FUNC, 'user', 'register', array('username'=>$username, 'password'=>$password, 'email'=>$email, 'questionid'=>$questionid, 'answer'=>$answer, 'regip' => $regip));
+    return call_user_func(UC_API_FUNC, 'user', 'register', array('username'=>$username, 'password'=>$password, 'email'=>$email, 'questionid'=>$questionid, 'answer'=>$answer, 'regip' => $regip));
 }

 function uc_user_login($username, $password, $isuid = 0, $checkques = 0, $questionid = '', $answer = '') {
-	$isuid = intval($isuid);
-	$return = call_user_func(UC_API_FUNC, 'user', 'login', array('username'=>$username, 'password'=>$password, 'isuid'=>$isuid, 'checkques'=>$checkques, 'questionid'=>$questionid, 'answer'=>$answer));
-	return UC_CONNECT == 'mysql' ? $return : uc_unserialize($return);
+    $isuid = intval($isuid);
+    $return = call_user_func(UC_API_FUNC, 'user', 'login', array('username'=>$username, 'password'=>$password, 'isuid'=>$isuid, 'checkques'=>$checkques, 'questionid'=>$questionid, 'answer'=>$answer));
+    return UC_CONNECT == 'mysql' ? $return : uc_unserialize($return);
 }

 function uc_user_synlogin($uid) {
-	$uid = intval($uid);
-	if(@include UC_ROOT.'./data/cache/apps.php') {
-		if(count($_CACHE['apps']) > 1) {
-			$return = uc_api_post('user', 'synlogin', array('uid'=>$uid));
-		} else {
-			$return = '';
-		}
-	}
-	return $return;
+    $uid = intval($uid);
+    if(@include UC_ROOT.'./data/cache/apps.php') {
+        if(count($_CACHE['apps']) > 1) {
+            $return = uc_api_post('user', 'synlogin', array('uid'=>$uid));
+        } else {
+            $return = '';
+        }
+    }
+    return $return;
 }

 function uc_user_synlogout() {
-	if(@include UC_ROOT.'./data/cache/apps.php') {
-		if(count($_CACHE['apps']) > 1) {
-			$return = uc_api_post('user', 'synlogout', array());
-		} else {
-			$return = '';
-		}
-	}
-	return $return;
+    if(@include UC_ROOT.'./data/cache/apps.php') {
+        if(count($_CACHE['apps']) > 1) {
+            $return = uc_api_post('user', 'synlogout', array());
+        } else {
+            $return = '';
+        }
+    }
+    return $return;
 }

 function uc_user_edit($username, $oldpw, $newpw, $email, $ignoreoldpw = 0, $questionid = '', $answer = '') {
-	return call_user_func(UC_API_FUNC, 'user', 'edit', array('username'=>$username, 'oldpw'=>$oldpw, 'newpw'=>$newpw, 'email'=>$email, 'ignoreoldpw'=>$ignoreoldpw, 'questionid'=>$questionid, 'answer'=>$answer));
+    return call_user_func(UC_API_FUNC, 'user', 'edit', array('username'=>$username, 'oldpw'=>$oldpw, 'newpw'=>$newpw, 'email'=>$email, 'ignoreoldpw'=>$ignoreoldpw, 'questionid'=>$questionid, 'answer'=>$answer));
 }

 function uc_user_delete($uid) {
-	return call_user_func(UC_API_FUNC, 'user', 'delete', array('uid'=>$uid));
+    return call_user_func(UC_API_FUNC, 'user', 'delete', array('uid'=>$uid));
 }

 function uc_user_deleteavatar($uid) {
-	uc_api_post('user', 'deleteavatar', array('uid'=>$uid));
+    uc_api_post('user', 'deleteavatar', array('uid'=>$uid));
 }

 function uc_user_checkname($username) {
-	return call_user_func(UC_API_FUNC, 'user', 'check_username', array('username'=>$username));
+    return call_user_func(UC_API_FUNC, 'user', 'check_username', array('username'=>$username));
 }

 function uc_user_checkemail($email) {
-	return call_user_func(UC_API_FUNC, 'user', 'check_email', array('email'=>$email));
+    return call_user_func(UC_API_FUNC, 'user', 'check_email', array('email'=>$email));
 }

 function uc_user_addprotected($username, $admin='') {
-	return call_user_func(UC_API_FUNC, 'user', 'addprotected', array('username'=>$username, 'admin'=>$admin));
+    return call_user_func(UC_API_FUNC, 'user', 'addprotected', array('username'=>$username, 'admin'=>$admin));
 }

 function uc_user_deleteprotected($username) {
-	return call_user_func(UC_API_FUNC, 'user', 'deleteprotected', array('username'=>$username));
+    return call_user_func(UC_API_FUNC, 'user', 'deleteprotected', array('username'=>$username));
 }

 function uc_user_getprotected() {
-	$return = call_user_func(UC_API_FUNC, 'user', 'getprotected', array('1'=>1));
-	return UC_CONNECT == 'mysql' ? $return : uc_unserialize($return);
+    $return = call_user_func(UC_API_FUNC, 'user', 'getprotected', array('1'=>1));
+    return UC_CONNECT == 'mysql' ? $return : uc_unserialize($return);
 }

 function uc_get_user($username, $isuid=0) {
-	$return = call_user_func(UC_API_FUNC, 'user', 'get_user', array('username'=>$username, 'isuid'=>$isuid));
-	return UC_CONNECT == 'mysql' ? $return : uc_unserialize($return);
+    $return = call_user_func(UC_API_FUNC, 'user', 'get_user', array('username'=>$username, 'isuid'=>$isuid));
+    return UC_CONNECT == 'mysql' ? $return : uc_unserialize($return);
 }

 function uc_user_merge($oldusername, $newusername, $uid, $password, $email) {
-	return call_user_func(UC_API_FUNC, 'user', 'merge', array('oldusername'=>$oldusername, 'newusername'=>$newusername, 'uid'=>$uid, 'password'=>$password, 'email'=>$email));
+    return call_user_func(UC_API_FUNC, 'user', 'merge', array('oldusername'=>$oldusername, 'newusername'=>$newusername, 'uid'=>$uid, 'password'=>$password, 'email'=>$email));
 }

 function uc_user_merge_remove($username) {
-	return call_user_func(UC_API_FUNC, 'user', 'merge_remove', array('username'=>$username));
+    return call_user_func(UC_API_FUNC, 'user', 'merge_remove', array('username'=>$username));
 }

 function uc_user_getcredit($appid, $uid, $credit) {
-	return uc_api_post('user', 'getcredit', array('appid'=>$appid, 'uid'=>$uid, 'credit'=>$credit));
+    return uc_api_post('user', 'getcredit', array('appid'=>$appid, 'uid'=>$uid, 'credit'=>$credit));
 }

 function uc_pm_location($uid, $newpm = 0) {
-	$apiurl = uc_api_url('pm_client', 'ls', "uid=$uid", ($newpm ? '&folder=newbox' : ''));
-	@header("Expires: 0");
-	@header("Cache-Control: private, post-check=0, pre-check=0, max-age=0", FALSE);
-	@header("Pragma: no-cache");
-	@header("location: $apiurl");
+    $apiurl = uc_api_url('pm_client', 'ls', "uid=$uid", ($newpm ? '&folder=newbox' : ''));
+    @header("Expires: 0");
+    @header("Cache-Control: private, post-check=0, pre-check=0, max-age=0", FALSE);
+    @header("Pragma: no-cache");
+    @header("location: $apiurl");
 }

 function uc_pm_checknew($uid, $more = 0) {
-	$return = call_user_func(UC_API_FUNC, 'pm', 'check_newpm', array('uid'=>$uid, 'more'=>$more));
-	return (!$more || UC_CONNECT == 'mysql') ? $return : uc_unserialize($return);
+    $return = call_user_func(UC_API_FUNC, 'pm', 'check_newpm', array('uid'=>$uid, 'more'=>$more));
+    return (!$more || UC_CONNECT == 'mysql') ? $return : uc_unserialize($return);
 }

 function uc_pm_send($fromuid, $msgto, $subject, $message, $instantly = 1, $replypmid = 0, $isusername = 0, $type = 0) {
-	if($instantly) {
-		$replypmid = @is_numeric($replypmid) ? $replypmid : 0;
-		return call_user_func(UC_API_FUNC, 'pm', 'sendpm', array('fromuid'=>$fromuid, 'msgto'=>$msgto, 'subject'=>$subject, 'message'=>$message, 'replypmid'=>$replypmid, 'isusername'=>$isusername, 'type' => $type));
-	} else {
-		$fromuid = intval($fromuid);
-		$subject = rawurlencode($subject);
-		$msgto = rawurlencode($msgto);
-		$message = rawurlencode($message);
-		$replypmid = @is_numeric($replypmid) ? $replypmid : 0;
-		$replyadd = $replypmid ? "&pmid=$replypmid&do=reply" : '';
-		$apiurl = uc_api_url('pm_client', 'send', "uid=$fromuid", "&msgto=$msgto&subject=$subject&message=$message$replyadd");
-		@header("Expires: 0");
-		@header("Cache-Control: private, post-check=0, pre-check=0, max-age=0", FALSE);
-		@header("Pragma: no-cache");
-		@header("location: ".$apiurl);
-	}
+    if($instantly) {
+        $replypmid = @is_numeric($replypmid) ? $replypmid : 0;
+        return call_user_func(UC_API_FUNC, 'pm', 'sendpm', array('fromuid'=>$fromuid, 'msgto'=>$msgto, 'subject'=>$subject, 'message'=>$message, 'replypmid'=>$replypmid, 'isusername'=>$isusername, 'type' => $type));
+    } else {
+        $fromuid = intval($fromuid);
+        $subject = rawurlencode($subject);
+        $msgto = rawurlencode($msgto);
+        $message = rawurlencode($message);
+        $replypmid = @is_numeric($replypmid) ? $replypmid : 0;
+        $replyadd = $replypmid ? "&pmid=$replypmid&do=reply" : '';
+        $apiurl = uc_api_url('pm_client', 'send', "uid=$fromuid", "&msgto=$msgto&subject=$subject&message=$message$replyadd");
+        @header("Expires: 0");
+        @header("Cache-Control: private, post-check=0, pre-check=0, max-age=0", FALSE);
+        @header("Pragma: no-cache");
+        @header("location: ".$apiurl);
+    }
 }

 function uc_pm_delete($uid, $folder, $pmids) {
-	return call_user_func(UC_API_FUNC, 'pm', 'delete', array('uid'=>$uid, 'pmids'=>$pmids));
+    return call_user_func(UC_API_FUNC, 'pm', 'delete', array('uid'=>$uid, 'pmids'=>$pmids));
 }

 function uc_pm_deleteuser($uid, $touids) {
-	return call_user_func(UC_API_FUNC, 'pm', 'deleteuser', array('uid'=>$uid, 'touids'=>$touids));
+    return call_user_func(UC_API_FUNC, 'pm', 'deleteuser', array('uid'=>$uid, 'touids'=>$touids));
 }

 function uc_pm_deletechat($uid, $plids, $type = 0) {
-	return call_user_func(UC_API_FUNC, 'pm', 'deletechat', array('uid'=>$uid, 'plids'=>$plids, 'type'=>$type));
+    return call_user_func(UC_API_FUNC, 'pm', 'deletechat', array('uid'=>$uid, 'plids'=>$plids, 'type'=>$type));
 }

 function uc_pm_readstatus($uid, $uids, $plids = array(), $status = 0) {
-	return call_user_func(UC_API_FUNC, 'pm', 'readstatus', array('uid'=>$uid, 'uids'=>$uids, 'plids'=>$plids, 'status'=>$status));
+    return call_user_func(UC_API_FUNC, 'pm', 'readstatus', array('uid'=>$uid, 'uids'=>$uids, 'plids'=>$plids, 'status'=>$status));
 }

 function uc_pm_list($uid, $page = 1, $pagesize = 10, $folder = 'inbox', $filter = 'newpm', $msglen = 0) {
-	$uid = intval($uid);
-	$page = intval($page);
-	$pagesize = intval($pagesize);
-	$return = call_user_func(UC_API_FUNC, 'pm', 'ls', array('uid'=>$uid, 'page'=>$page, 'pagesize'=>$pagesize, 'filter'=>$filter, 'msglen'=>$msglen));
-	return UC_CONNECT == 'mysql' ? $return : uc_unserialize($return);
+    $uid = intval($uid);
+    $page = intval($page);
+    $pagesize = intval($pagesize);
+    $return = call_user_func(UC_API_FUNC, 'pm', 'ls', array('uid'=>$uid, 'page'=>$page, 'pagesize'=>$pagesize, 'filter'=>$filter, 'msglen'=>$msglen));
+    return UC_CONNECT == 'mysql' ? $return : uc_unserialize($return);
 }

 function uc_pm_ignore($uid) {
-	$uid = intval($uid);
-	return call_user_func(UC_API_FUNC, 'pm', 'ignore', array('uid'=>$uid));
+    $uid = intval($uid);
+    return call_user_func(UC_API_FUNC, 'pm', 'ignore', array('uid'=>$uid));
 }

 function uc_pm_view($uid, $pmid = 0, $touid = 0, $daterange = 1, $page = 0, $pagesize = 10, $type = 0, $isplid = 0) {
-	$uid = intval($uid);
-	$touid = intval($touid);
-	$page = intval($page);
-	$pagesize = intval($pagesize);
-	$pmid = @is_numeric($pmid) ? $pmid : 0;
-	$return = call_user_func(UC_API_FUNC, 'pm', 'view', array('uid'=>$uid, 'pmid'=>$pmid, 'touid'=>$touid, 'daterange'=>$daterange, 'page' => $page, 'pagesize' => $pagesize, 'type'=>$type, 'isplid'=>$isplid));
-	return UC_CONNECT == 'mysql' ? $return : uc_unserialize($return);
+    $uid = intval($uid);
+    $touid = intval($touid);
+    $page = intval($page);
+    $pagesize = intval($pagesize);
+    $pmid = @is_numeric($pmid) ? $pmid : 0;
+    $return = call_user_func(UC_API_FUNC, 'pm', 'view', array('uid'=>$uid, 'pmid'=>$pmid, 'touid'=>$touid, 'daterange'=>$daterange, 'page' => $page, 'pagesize' => $pagesize, 'type'=>$type, 'isplid'=>$isplid));
+    return UC_CONNECT == 'mysql' ? $return : uc_unserialize($return);
 }

 function uc_pm_view_num($uid, $touid, $isplid) {
-	$uid = intval($uid);
-	$touid = intval($touid);
-	$isplid = intval($isplid);
-	return call_user_func(UC_API_FUNC, 'pm', 'viewnum', array('uid' => $uid, 'touid' => $touid, 'isplid' => $isplid));
+    $uid = intval($uid);
+    $touid = intval($touid);
+    $isplid = intval($isplid);
+    return call_user_func(UC_API_FUNC, 'pm', 'viewnum', array('uid' => $uid, 'touid' => $touid, 'isplid' => $isplid));
 }

 function uc_pm_viewnode($uid, $type, $pmid) {
-	$uid = intval($uid);
-	$type = intval($type);
-	$pmid = @is_numeric($pmid) ? $pmid : 0;
-	$return = call_user_func(UC_API_FUNC, 'pm', 'viewnode', array('uid'=>$uid, 'type'=>$type, 'pmid'=>$pmid));
-	return UC_CONNECT == 'mysql' ? $return : uc_unserialize($return);
+    $uid = intval($uid);
+    $type = intval($type);
+    $pmid = @is_numeric($pmid) ? $pmid : 0;
+    $return = call_user_func(UC_API_FUNC, 'pm', 'viewnode', array('uid'=>$uid, 'type'=>$type, 'pmid'=>$pmid));
+    return UC_CONNECT == 'mysql' ? $return : uc_unserialize($return);
 }

 function uc_pm_chatpmmemberlist($uid, $plid = 0) {
-	$uid = intval($uid);
-	$plid = intval($plid);
-	$return = call_user_func(UC_API_FUNC, 'pm', 'chatpmmemberlist', array('uid'=>$uid, 'plid'=>$plid));
-	return UC_CONNECT == 'mysql' ? $return : uc_unserialize($return);
+    $uid = intval($uid);
+    $plid = intval($plid);
+    $return = call_user_func(UC_API_FUNC, 'pm', 'chatpmmemberlist', array('uid'=>$uid, 'plid'=>$plid));
+    return UC_CONNECT == 'mysql' ? $return : uc_unserialize($return);
 }

 function uc_pm_kickchatpm($plid, $uid, $touid) {
-	$uid = intval($uid);
-	$plid = intval($plid);
-	$touid = intval($touid);
-	return call_user_func(UC_API_FUNC, 'pm', 'kickchatpm', array('uid'=>$uid, 'plid'=>$plid, 'touid'=>$touid));
+    $uid = intval($uid);
+    $plid = intval($plid);
+    $touid = intval($touid);
+    return call_user_func(UC_API_FUNC, 'pm', 'kickchatpm', array('uid'=>$uid, 'plid'=>$plid, 'touid'=>$touid));
 }

 function uc_pm_appendchatpm($plid, $uid, $touid) {
-	$uid = intval($uid);
-	$plid = intval($plid);
-	$touid = intval($touid);
-	return call_user_func(UC_API_FUNC, 'pm', 'appendchatpm', array('uid'=>$uid, 'plid'=>$plid, 'touid'=>$touid));
+    $uid = intval($uid);
+    $plid = intval($plid);
+    $touid = intval($touid);
+    return call_user_func(UC_API_FUNC, 'pm', 'appendchatpm', array('uid'=>$uid, 'plid'=>$plid, 'touid'=>$touid));
 }

 function uc_pm_blackls_get($uid) {
-	$uid = intval($uid);
-	return call_user_func(UC_API_FUNC, 'pm', 'blackls_get', array('uid'=>$uid));
+    $uid = intval($uid);
+    return call_user_func(UC_API_FUNC, 'pm', 'blackls_get', array('uid'=>$uid));
 }

 function uc_pm_blackls_set($uid, $blackls) {
-	$uid = intval($uid);
-	return call_user_func(UC_API_FUNC, 'pm', 'blackls_set', array('uid'=>$uid, 'blackls'=>$blackls));
+    $uid = intval($uid);
+    return call_user_func(UC_API_FUNC, 'pm', 'blackls_set', array('uid'=>$uid, 'blackls'=>$blackls));
 }

 function uc_pm_blackls_add($uid, $username) {
-	$uid = intval($uid);
-	return call_user_func(UC_API_FUNC, 'pm', 'blackls_add', array('uid'=>$uid, 'username'=>$username));
+    $uid = intval($uid);
+    return call_user_func(UC_API_FUNC, 'pm', 'blackls_add', array('uid'=>$uid, 'username'=>$username));
 }

 function uc_pm_blackls_delete($uid, $username) {
-	$uid = intval($uid);
-	return call_user_func(UC_API_FUNC, 'pm', 'blackls_delete', array('uid'=>$uid, 'username'=>$username));
+    $uid = intval($uid);
+    return call_user_func(UC_API_FUNC, 'pm', 'blackls_delete', array('uid'=>$uid, 'username'=>$username));
 }

 function uc_domain_ls() {
-	$return = call_user_func(UC_API_FUNC, 'domain', 'ls', array('1'=>1));
-	return UC_CONNECT == 'mysql' ? $return : uc_unserialize($return);
+    $return = call_user_func(UC_API_FUNC, 'domain', 'ls', array('1'=>1));
+    return UC_CONNECT == 'mysql' ? $return : uc_unserialize($return);
 }

 function uc_credit_exchange_request($uid, $from, $to, $toappid, $amount) {
-	$uid = intval($uid);
-	$from = intval($from);
-	$toappid = intval($toappid);
-	$to = intval($to);
-	$amount = intval($amount);
-	return uc_api_post('credit', 'request', array('uid'=>$uid, 'from'=>$from, 'to'=>$to, 'toappid'=>$toappid, 'amount'=>$amount));
+    $uid = intval($uid);
+    $from = intval($from);
+    $toappid = intval($toappid);
+    $to = intval($to);
+    $amount = intval($amount);
+    return uc_api_post('credit', 'request', array('uid'=>$uid, 'from'=>$from, 'to'=>$to, 'toappid'=>$toappid, 'amount'=>$amount));
 }

 function uc_tag_get($tagname, $nums = 0) {
-	$return = call_user_func(UC_API_FUNC, 'tag', 'gettag', array('tagname'=>$tagname, 'nums'=>$nums));
-	return UC_CONNECT == 'mysql' ? $return : uc_unserialize($return);
+    $return = call_user_func(UC_API_FUNC, 'tag', 'gettag', array('tagname'=>$tagname, 'nums'=>$nums));
+    return UC_CONNECT == 'mysql' ? $return : uc_unserialize($return);
 }

 function uc_avatar($uid, $type = 'virtual', $returnhtml = 1) {
-	$uid = intval($uid);
-	$uc_input = uc_api_input("uid=$uid");
-	$uc_avatarflash = UC_API.'/images/camera.swf?inajax=1&appid='.UC_APPID.'&input='.$uc_input.'&agent='.md5($_SERVER['HTTP_USER_AGENT']).'&ucapi='.urlencode(str_replace('http://', '', UC_API)).'&avatartype='.$type.'&uploadSize=2048';
-	if($returnhtml) {
-		return '<object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=9,0,0,0" width="450" height="253" id="mycamera" align="middle">
-			<param name="allowScriptAccess" value="always" />
-			<param name="scale" value="exactfit" />
-			<param name="wmode" value="transparent" />
-			<param name="quality" value="high" />
-			<param name="bgcolor" value="#ffffff" />
-			<param name="movie" value="'.$uc_avatarflash.'" />
-			<param name="menu" value="false" />
-			<embed src="'.$uc_avatarflash.'" quality="high" bgcolor="#ffffff" width="450" height="253" name="mycamera" align="middle" allowScriptAccess="always" allowFullScreen="false" scale="exactfit"  wmode="transparent" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" />
-		</object>';
-	} else {
-		return array(
-			'width', '450',
-			'height', '253',
-			'scale', 'exactfit',
-			'src', $uc_avatarflash,
-			'id', 'mycamera',
-			'name', 'mycamera',
-			'quality','high',
-			'bgcolor','#ffffff',
-			'menu', 'false',
-			'swLiveConnect', 'true',
-			'allowScriptAccess', 'always'
-		);
-	}
+    $uid = intval($uid);
+    $uc_input = uc_api_input("uid=$uid");
+    $uc_avatarflash = UC_API.'/images/camera.swf?inajax=1&appid='.UC_APPID.'&input='.$uc_input.'&agent='.md5($_SERVER['HTTP_USER_AGENT']).'&ucapi='.urlencode(str_replace('http://', '', UC_API)).'&avatartype='.$type.'&uploadSize=2048';
+    if($returnhtml) {
+        return '<object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=9,0,0,0" width="450" height="253" id="mycamera" align="middle">
+            <param name="allowScriptAccess" value="always" />
+            <param name="scale" value="exactfit" />
+            <param name="wmode" value="transparent" />
+            <param name="quality" value="high" />
+            <param name="bgcolor" value="#ffffff" />
+            <param name="movie" value="'.$uc_avatarflash.'" />
+            <param name="menu" value="false" />
+            <embed src="'.$uc_avatarflash.'" quality="high" bgcolor="#ffffff" width="450" height="253" name="mycamera" align="middle" allowScriptAccess="always" allowFullScreen="false" scale="exactfit"  wmode="transparent" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" />
+        </object>';
+    } else {
+        return array(
+            'width', '450',
+            'height', '253',
+            'scale', 'exactfit',
+            'src', $uc_avatarflash,
+            'id', 'mycamera',
+            'name', 'mycamera',
+            'quality','high',
+            'bgcolor','#ffffff',
+            'menu', 'false',
+            'swLiveConnect', 'true',
+            'allowScriptAccess', 'always'
+        );
+    }
 }

 function uc_mail_queue($uids, $emails, $subject, $message, $frommail = '', $charset = 'gbk', $htmlon = FALSE, $level = 1) {
-	return call_user_func(UC_API_FUNC, 'mail', 'add', array('uids' => $uids, 'emails' => $emails, 'subject' => $subject, 'message' => $message, 'frommail' => $frommail, 'charset' => $charset, 'htmlon' => $htmlon, 'level' => $level));
+    return call_user_func(UC_API_FUNC, 'mail', 'add', array('uids' => $uids, 'emails' => $emails, 'subject' => $subject, 'message' => $message, 'frommail' => $frommail, 'charset' => $charset, 'htmlon' => $htmlon, 'level' => $level));
 }

 function uc_check_avatar($uid, $size = 'middle', $type = 'virtual') {
-	$url = UC_API."/avatar.php?uid=$uid&size=$size&type=$type&check_file_exists=1";
-	$res = uc_fopen2($url, 500000, '', '', TRUE, UC_IP, 20);
-	if($res == 1) {
-		return 1;
-	} else {
-		return 0;
-	}
+    $url = UC_API."/avatar.php?uid=$uid&size=$size&type=$type&check_file_exists=1";
+    $res = uc_fopen2($url, 500000, '', '', TRUE, UC_IP, 20);
+    if($res == 1) {
+        return 1;
+    } else {
+        return 0;
+    }
 }

 function uc_check_version() {
-	$return = uc_api_post('version', 'check', array());
-	$data = uc_unserialize($return);
-	return is_array($data) ? $data : $return;
+    $return = uc_api_post('version', 'check', array());
+    $data = uc_unserialize($return);
+    return is_array($data) ? $data : $return;
 }

 ?>
\ No newline at end of file
Index: uc_client/control/user.php
===================================================================
--- uc_client/control/user.php	(revision 3919)
+++ uc_client/control/user.php	(working copy)
@@ -1,10 +1,10 @@
 <?php

 /*
-	[UCenter] (C)2001-2099 Comsenz Inc.
-	This is NOT a freeware, use is subject to license terms
+    [UCenter] (C)2001-2099 Comsenz Inc.
+    This is NOT a freeware, use is subject to license terms

-	$Id: user.php 1082 2011-04-07 06:42:14Z svn_project_zhangjie $
+    $Id: user.php 1082 2011-04-07 06:42:14Z svn_project_zhangjie $
 */

 !defined('IN_UC') && exit('Access Denied');
@@ -19,244 +19,244 @@
 class usercontrol extends base {


-	function __construct() {
-		$this->usercontrol();
-	}
+    function __construct() {
+        $this->usercontrol();
+    }

-	function usercontrol() {
-		parent::__construct();
-		$this->load('user');
-		$this->app = $this->cache['apps'][UC_APPID];
-	}
+    function usercontrol() {
+        parent::__construct();
+        $this->load('user');
+        $this->app = $this->cache['apps'][UC_APPID];
+    }

-	// -1 δ
-	function onsynlogin() {
-		$this->init_input();
-		$uid = $this->input('uid');
-		if($this->app['synlogin']) {
-			if($this->user = $_ENV['user']->get_user_by_uid($uid)) {
-				$synstr = '';
-				foreach($this->cache['apps'] as $appid => $app) {
-					if($app['synlogin'] && $app['appid'] != $this->app['appid']) {
-						$synstr .= '<script type="text/javascript" src="'.$app['url'].'/api/uc.php?time='.$this->time.'&code='.urlencode($this->authcode('action=synlogin&username='.$this->user['username'].'&uid='.$this->user['uid'].'&password='.$this->user['password']."&time=".$this->time, 'ENCODE', $app['authkey'])).'"></script>';
-					}
-				}
-				return $synstr;
-			}
-		}
-		return '';
-	}
+    // -1 δ
+    function onsynlogin() {
+        $this->init_input();
+        $uid = $this->input('uid');
+        if($this->app['synlogin']) {
+            if($this->user = $_ENV['user']->get_user_by_uid($uid)) {
+                $synstr = '';
+                foreach($this->cache['apps'] as $appid => $app) {
+                    if($app['synlogin'] && $app['appid'] != $this->app['appid']) {
+                        $synstr .= '<script type="text/javascript" src="'.$app['url'].'/api/uc.php?time='.$this->time.'&code='.urlencode($this->authcode('action=synlogin&username='.$this->user['username'].'&uid='.$this->user['uid'].'&password='.$this->user['password']."&time=".$this->time, 'ENCODE', $app['authkey'])).'"></script>';
+                    }
+                }
+                return $synstr;
+            }
+        }
+        return '';
+    }

-	function onsynlogout() {
-		$this->init_input();
-		if($this->app['synlogin']) {
-			$synstr = '';
-			foreach($this->cache['apps'] as $appid => $app) {
-				if($app['synlogin'] && $app['appid'] != $this->app['appid']) {
-					$synstr .= '<script type="text/javascript" src="'.$app['url'].'/api/uc.php?time='.$this->time.'&code='.urlencode($this->authcode('action=synlogout&time='.$this->time, 'ENCODE', $app['authkey'])).'"></script>';
-				}
-			}
-			return $synstr;
-		}
-		return '';
-	}
+    function onsynlogout() {
+        $this->init_input();
+        if($this->app['synlogin']) {
+            $synstr = '';
+            foreach($this->cache['apps'] as $appid => $app) {
+                if($app['synlogin'] && $app['appid'] != $this->app['appid']) {
+                    $synstr .= '<script type="text/javascript" src="'.$app['url'].'/api/uc.php?time='.$this->time.'&code='.urlencode($this->authcode('action=synlogout&time='.$this->time, 'ENCODE', $app['authkey'])).'"></script>';
+                }
+            }
+            return $synstr;
+        }
+        return '';
+    }

-	function onregister() {
-		$this->init_input();
-		$username = $this->input('username');
-		$password =  $this->input('password');
-		$email = $this->input('email');
-		$questionid = $this->input('questionid');
-		$answer = $this->input('answer');
-		$regip = $this->input('regip');
+    function onregister() {
+        $this->init_input();
+        $username = $this->input('username');
+        $password =  $this->input('password');
+        $email = $this->input('email');
+        $questionid = $this->input('questionid');
+        $answer = $this->input('answer');
+        $regip = $this->input('regip');

-		if(($status = $this->_check_username($username)) < 0) {
-			return $status;
-		}
-		if(($status = $this->_check_email($email)) < 0) {
-			return $status;
-		}
-		$uid = $_ENV['user']->add_user($username, $password, $email, 0, $questionid, $answer, $regip);
-		return $uid;
-	}
+        if(($status = $this->_check_username($username)) < 0) {
+            return $status;
+        }
+        if(($status = $this->_check_email($email)) < 0) {
+            return $status;
+        }
+        $uid = $_ENV['user']->add_user($username, $password, $email, 0, $questionid, $answer, $regip);
+        return $uid;
+    }

-	function onedit() {
-		$this->init_input();
-		$username = $this->input('username');
-		$oldpw = $this->input('oldpw');
-		$newpw = $this->input('newpw');
-		$email = $this->input('email');
-		$ignoreoldpw = $this->input('ignoreoldpw');
-		$questionid = $this->input('questionid');
-		$answer = $this->input('answer');
+    function onedit() {
+        $this->init_input();
+        $username = $this->input('username');
+        $oldpw = $this->input('oldpw');
+        $newpw = $this->input('newpw');
+        $email = $this->input('email');
+        $ignoreoldpw = $this->input('ignoreoldpw');
+        $questionid = $this->input('questionid');
+        $answer = $this->input('answer');

-		if(!$ignoreoldpw && $email && ($status = $this->_check_email($email, $username)) < 0) {
-			return $status;
-		}
-		$status = $_ENV['user']->edit_user($username, $oldpw, $newpw, $email, $ignoreoldpw, $questionid, $answer);
+        if(!$ignoreoldpw && $email && ($status = $this->_check_email($email, $username)) < 0) {
+            return $status;
+        }
+        $status = $_ENV['user']->edit_user($username, $oldpw, $newpw, $email, $ignoreoldpw, $questionid, $answer);

-		if($newpw && $status > 0) {
-			$this->load('note');
-			$_ENV['note']->add('updatepw', 'username='.urlencode($username).'&password=');
-			$_ENV['note']->send();
-		}
-		return $status;
-	}
+        if($newpw && $status > 0) {
+            $this->load('note');
+            $_ENV['note']->add('updatepw', 'username='.urlencode($username).'&password=');
+            $_ENV['note']->send();
+        }
+        return $status;
+    }

-	function onlogin() {
-		$this->init_input();
-		$isuid = $this->input('isuid');
-		$username = $this->input('username');
-		$password = $this->input('password');
-		$checkques = $this->input('checkques');
-		$questionid = $this->input('questionid');
-		$answer = $this->input('answer');
-		if($isuid == 1) {
-			$user = $_ENV['user']->get_user_by_uid($username);
-		} elseif($isuid == 2) {
-			$user = $_ENV['user']->get_user_by_email($username);
-		} else {
-			$user = $_ENV['user']->get_user_by_username($username);
-		}
+    function onlogin() {
+        $this->init_input();
+        $isuid = $this->input('isuid');
+        $username = $this->input('username');
+        $password = $this->input('password');
+        $checkques = $this->input('checkques');
+        $questionid = $this->input('questionid');
+        $answer = $this->input('answer');
+        if($isuid == 1) {
+            $user = $_ENV['user']->get_user_by_uid($username);
+        } elseif($isuid == 2) {
+            $user = $_ENV['user']->get_user_by_email($username);
+        } else {
+            $user = $_ENV['user']->get_user_by_username($username);
+        }

-		$passwordmd5 = preg_match('/^\w{32}$/', $password) ? $password : md5($password);
-		if(empty($user)) {
-			$status = -1;
-		} elseif($user['password'] != md5($passwordmd5.$user['salt'])) {
-			$status = -2;
-		} elseif($checkques && $user['secques'] != '' && $user['secques'] != $_ENV['user']->quescrypt($questionid, $answer)) {
-			$status = -3;
-		} else {
-			$status = $user['uid'];
-		}
-		$merge = $status != -1 && !$isuid && $_ENV['user']->check_mergeuser($username) ? 1 : 0;
-		return array($status, $user['username'], $password, $user['email'], $merge);
-	}
+        $passwordmd5 = preg_match('/^\w{32}$/', $password) ? $password : md5($password);
+        if(empty($user)) {
+            $status = -1;
+        } elseif($user['password'] != md5($passwordmd5.$user['salt'])) {
+            $status = -2;
+        } elseif($checkques && $user['secques'] != '' && $user['secques'] != $_ENV['user']->quescrypt($questionid, $answer)) {
+            $status = -3;
+        } else {
+            $status = $user['uid'];
+        }
+        $merge = $status != -1 && !$isuid && $_ENV['user']->check_mergeuser($username) ? 1 : 0;
+        return array($status, $user['username'], $password, $user['email'], $merge);
+    }

-	function oncheck_email() {
-		$this->init_input();
-		$email = $this->input('email');
-		return $this->_check_email($email);
-	}
+    function oncheck_email() {
+        $this->init_input();
+        $email = $this->input('email');
+        return $this->_check_email($email);
+    }

-	function oncheck_username() {
-		$this->init_input();
-		$username = $this->input('username');
-		if(($status = $this->_check_username($username)) < 0) {
-			return $status;
-		} else {
-			return 1;
-		}
-	}
+    function oncheck_username() {
+        $this->init_input();
+        $username = $this->input('username');
+        if(($status = $this->_check_username($username)) < 0) {
+            return $status;
+        } else {
+            return 1;
+        }
+    }

-	function onget_user() {
-		$this->init_input();
-		$username = $this->input('username');
-		if(!$this->input('isuid')) {
-			$status = $_ENV['user']->get_user_by_username($username);
-		} else {
-			$status = $_ENV['user']->get_user_by_uid($username);
-		}
-		if($status) {
-			return array($status['uid'],$status['username'],$status['email']);
-		} else {
-			return 0;
-		}
-	}
+    function onget_user() {
+        $this->init_input();
+        $username = $this->input('username');
+        if(!$this->input('isuid')) {
+            $status = $_ENV['user']->get_user_by_username($username);
+        } else {
+            $status = $_ENV['user']->get_user_by_uid($username);
+        }
+        if($status) {
+            return array($status['uid'],$status['username'],$status['email']);
+        } else {
+            return 0;
+        }
+    }


-	function ongetprotected() {
-		$protectedmembers = $this->db->fetch_all("SELECT uid,username FROM ".UC_DBTABLEPRE."protectedmembers GROUP BY username");
-		return $protectedmembers;
-	}
+    function ongetprotected() {
+        $protectedmembers = $this->db->fetch_all("SELECT uid,username FROM ".UC_DBTABLEPRE."protectedmembers GROUP BY username");
+        return $protectedmembers;
+    }

-	function ondelete() {
-		$this->init_input();
-		$uid = $this->input('uid');
-		return $_ENV['user']->delete_user($uid);
-	}
+    function ondelete() {
+        $this->init_input();
+        $uid = $this->input('uid');
+        return $_ENV['user']->delete_user($uid);
+    }

-	function onaddprotected() {
-		$this->init_input();
-		$username = $this->input('username');
-		$admin = $this->input('admin');
-		$appid = $this->app['appid'];
-		$usernames = (array)$username;
-		foreach($usernames as $username) {
-			$user = $_ENV['user']->get_user_by_username($username);
-			$uid = $user['uid'];
-			$this->db->query("REPLACE INTO ".UC_DBTABLEPRE."protectedmembers SET uid='$uid', username='$username', appid='$appid', dateline='{$this->time}', admin='$admin'", 'SILENT');
-		}
-		return $this->db->errno() ? -1 : 1;
-	}
+    function onaddprotected() {
+        $this->init_input();
+        $username = $this->input('username');
+        $admin = $this->input('admin');
+        $appid = $this->app['appid'];
+        $usernames = (array)$username;
+        foreach($usernames as $username) {
+            $user = $_ENV['user']->get_user_by_username($username);
+            $uid = $user['uid'];
+            $this->db->query("REPLACE INTO ".UC_DBTABLEPRE."protectedmembers SET uid='$uid', username='$username', appid='$appid', dateline='{$this->time}', admin='$admin'", 'SILENT');
+        }
+        return $this->db->errno() ? -1 : 1;
+    }

-	function ondeleteprotected() {
-		$this->init_input();
-		$username = $this->input('username');
-		$appid = $this->app['appid'];
-		$usernames = (array)$username;
-		foreach($usernames as $username) {
-			$this->db->query("DELETE FROM ".UC_DBTABLEPRE."protectedmembers WHERE username='$username' AND appid='$appid'");
-		}
-		return $this->db->errno() ? -1 : 1;
-	}
+    function ondeleteprotected() {
+        $this->init_input();
+        $username = $this->input('username');
+        $appid = $this->app['appid'];
+        $usernames = (array)$username;
+        foreach($usernames as $username) {
+            $this->db->query("DELETE FROM ".UC_DBTABLEPRE."protectedmembers WHERE username='$username' AND appid='$appid'");
+        }
+        return $this->db->errno() ? -1 : 1;
+    }

-	function onmerge() {
-		$this->init_input();
-		$oldusername = $this->input('oldusername');
-		$newusername = $this->input('newusername');
-		$uid = $this->input('uid');
-		$password = $this->input('password');
-		$email = $this->input('email');
-		if(($status = $this->_check_username($newusername)) < 0) {
-			return $status;
-		}
-		$uid = $_ENV['user']->add_user($newusername, $password, $email, $uid);
-		$this->db->query("DELETE FROM ".UC_DBTABLEPRE."mergemembers WHERE appid='".$this->app['appid']."' AND username='$oldusername'");
-		return $uid;
-	}
+    function onmerge() {
+        $this->init_input();
+        $oldusername = $this->input('oldusername');
+        $newusername = $this->input('newusername');
+        $uid = $this->input('uid');
+        $password = $this->input('password');
+        $email = $this->input('email');
+        if(($status = $this->_check_username($newusername)) < 0) {
+            return $status;
+        }
+        $uid = $_ENV['user']->add_user($newusername, $password, $email, $uid);
+        $this->db->query("DELETE FROM ".UC_DBTABLEPRE."mergemembers WHERE appid='".$this->app['appid']."' AND username='$oldusername'");
+        return $uid;
+    }

-	function onmerge_remove() {
-		$this->init_input();
-		$username = $this->input('username');
-		$this->db->query("DELETE FROM ".UC_DBTABLEPRE."mergemembers WHERE appid='".$this->app['appid']."' AND username='$username'");
-		return NULL;
-	}
+    function onmerge_remove() {
+        $this->init_input();
+        $username = $this->input('username');
+        $this->db->query("DELETE FROM ".UC_DBTABLEPRE."mergemembers WHERE appid='".$this->app['appid']."' AND username='$username'");
+        return NULL;
+    }

-	function _check_username($username) {
-		$username = addslashes(trim(stripslashes($username)));
-		if(!$_ENV['user']->check_username($username)) {
-			return UC_USER_CHECK_USERNAME_FAILED;
-		} elseif(!$_ENV['user']->check_usernamecensor($username)) {
-			return UC_USER_USERNAME_BADWORD;
-		} elseif($_ENV['user']->check_usernameexists($username)) {
-			return UC_USER_USERNAME_EXISTS;
-		}
-		return 1;
-	}
+    function _check_username($username) {
+        $username = addslashes(trim(stripslashes($username)));
+        if(!$_ENV['user']->check_username($username)) {
+            return UC_USER_CHECK_USERNAME_FAILED;
+        } elseif(!$_ENV['user']->check_usernamecensor($username)) {
+            return UC_USER_USERNAME_BADWORD;
+        } elseif($_ENV['user']->check_usernameexists($username)) {
+            return UC_USER_USERNAME_EXISTS;
+        }
+        return 1;
+    }

-	function _check_email($email, $username = '') {
-		if(empty($this->settings)) {
-			$this->settings = $this->cache('settings');
-		}
-		if(!$_ENV['user']->check_emailformat($email)) {
-			return UC_USER_EMAIL_FORMAT_ILLEGAL;
-		} elseif(!$_ENV['user']->check_emailaccess($email)) {
-			return UC_USER_EMAIL_ACCESS_ILLEGAL;
-		} elseif(!$this->settings['doublee'] && $_ENV['user']->check_emailexists($email, $username)) {
-			return UC_USER_EMAIL_EXISTS;
-		} else {
-			return 1;
-		}
-	}
+    function _check_email($email, $username = '') {
+        if(empty($this->settings)) {
+            $this->settings = $this->cache('settings');
+        }
+        if(!$_ENV['user']->check_emailformat($email)) {
+            return UC_USER_EMAIL_FORMAT_ILLEGAL;
+        } elseif(!$_ENV['user']->check_emailaccess($email)) {
+            return UC_USER_EMAIL_ACCESS_ILLEGAL;
+        } elseif(!$this->settings['doublee'] && $_ENV['user']->check_emailexists($email, $username)) {
+            return UC_USER_EMAIL_EXISTS;
+        } else {
+            return 1;
+        }
+    }

-	function onuploadavatar() {
-	}
+    function onuploadavatar() {
+    }

-	function onrectavatar() {
-	}
-	function flashdata_decode($s) {
-	}
+    function onrectavatar() {
+    }
+    function flashdata_decode($s) {
+    }
 }

 ?>
\ No newline at end of file
Index: uc_client/lib/db.class.php
===================================================================
--- uc_client/lib/db.class.php	(revision 3919)
+++ uc_client/lib/db.class.php	(working copy)
@@ -1,172 +1,177 @@
 <?php

 /*
-	[UCenter] (C)2001-2099 Comsenz Inc.
-	This is NOT a freeware, use is subject to license terms
+    [UCenter] (C)2001-2099 Comsenz Inc.
+    This is NOT a freeware, use is subject to license terms

-	$Id: db.class.php 1059 2011-03-01 07:25:09Z monkey $
+    $Id: db.class.php 1059 2011-03-01 07:25:09Z monkey $
 */


 class ucclient_db {
-	var $querynum = 0;
-	var $link;
-	var $histories;
+    var $querynum = 0;
+    var $link;
+    var $histories;

-	var $dbhost;
-	var $dbuser;
-	var $dbpw;
-	var $dbcharset;
-	var $pconnect;
-	var $tablepre;
-	var $time;
+    var $dbhost;
+    var $dbuser;
+    var $dbpw;
+    var $dbcharset;
+    var $pconnect;
+    var $tablepre;
+    var $time;

-	var $goneaway = 5;
+    var $goneaway = 5;

-	function connect($dbhost, $dbuser, $dbpw, $dbname = '', $dbcharset = '', $pconnect = 0, $tablepre='', $time = 0) {
-		$this->dbhost = $dbhost;
-		$this->dbuser = $dbuser;
-		$this->dbpw = $dbpw;
-		$this->dbname = $dbname;
-		$this->dbcharset = $dbcharset;
-		$this->pconnect = $pconnect;
-		$this->tablepre = $tablepre;
-		$this->time = $time;
+    function connect($dbhost, $dbuser, $dbpw, $dbname = '', $dbcharset = '', $pconnect = 0, $tablepre='', $time = 0) {
+        $this->dbhost = $dbhost;
+        $this->dbuser = $dbuser;
+        $this->dbpw = $dbpw;
+        $this->dbname = $dbname;
+        $this->dbcharset = $dbcharset;
+        $this->pconnect = $pconnect;
+        $this->tablepre = $tablepre;
+        $this->time = $time;

-		if($pconnect) {
-			if(!$this->link = mysql_pconnect($dbhost, $dbuser, $dbpw)) {
-				$this->halt('Can not connect to MySQL server');
-			}
-		} else {
-			if(!$this->link = mysql_connect($dbhost, $dbuser, $dbpw)) {
-				$this->halt('Can not connect to MySQL server');
-			}
-		}
+        if($pconnect) {
+            if(!$this->link = mysqli_pconnect($dbhost, $dbuser, $dbpw)) {
+                $this->halt('Can not connect to MySQL server');
+            }
+        } else {
+            if(!$this->link = mysqli_connect($dbhost, $dbuser, $dbpw)) {
+                $this->halt('Can not connect to MySQL server');
+            }
+        }

-		if($this->version() > '4.1') {
-			if($dbcharset) {
-				mysql_query("SET character_set_connection=".$dbcharset.", character_set_results=".$dbcharset.", character_set_client=binary", $this->link);
-			}
+        if($this->version() > '4.1') {
+            if($dbcharset) {
+                mysqli_query($this->link, "SET character_set_connection=".$dbcharset.", character_set_results=".$dbcharset.", character_set_client=binary");
+            }

-			if($this->version() > '5.0.1') {
-				mysql_query("SET sql_mode=''", $this->link);
-			}
-		}
+            if($this->version() > '5.0.1') {
+                mysqli_query($this->link, "SET sql_mode=''");
+            }
+        }

-		if($dbname) {
-			mysql_select_db($dbname, $this->link);
-		}
+        if($dbname) {
+            mysqli_select_db($this->link, $dbname);
+        }

-	}
+    }

-	function fetch_array($query, $result_type = MYSQL_ASSOC) {
-		return mysql_fetch_array($query, $result_type);
-	}
+    function fetch_array($query, $result_type = MYSQLI_ASSOC) {
+        return mysqli_fetch_array($query, $result_type);
+    }

-	function result_first($sql) {
-		$query = $this->query($sql);
-		return $this->result($query, 0);
-	}
+    function result_first($sql) {
+        $query = $this->query($sql);
+        return $this->result($query, 0);
+    }

-	function fetch_first($sql) {
-		$query = $this->query($sql);
-		return $this->fetch_array($query);
-	}
+    function fetch_first($sql) {
+        $query = $this->query($sql);
+        return $this->fetch_array($query);
+    }

-	function fetch_all($sql, $id = '') {
-		$arr = array();
-		$query = $this->query($sql);
-		while($data = $this->fetch_array($query)) {
-			$id ? $arr[$data[$id]] = $data : $arr[] = $data;
-		}
-		return $arr;
-	}
+    function fetch_all($sql, $id = '') {
+        $arr = array();
+        $query = $this->query($sql);
+        while($data = $this->fetch_array($query)) {
+            $id ? $arr[$data[$id]] = $data : $arr[] = $data;
+        }
+        return $arr;
+    }

-	function cache_gc() {
-		$this->query("DELETE FROM {$this->tablepre}sqlcaches WHERE expiry<$this->time");
-	}
+    function cache_gc() {
+        $this->query("DELETE FROM {$this->tablepre}sqlcaches WHERE expiry<$this->time");
+    }

-	function query($sql, $type = '', $cachetime = FALSE) {
-		$func = $type == 'UNBUFFERED' && @function_exists('mysql_unbuffered_query') ? 'mysql_unbuffered_query' : 'mysql_query';
-		if(!($query = $func($sql, $this->link)) && $type != 'SILENT') {
-			$this->halt('MySQL Query Error', $sql);
-		}
-		$this->querynum++;
-		$this->histories[] = $sql;
-		return $query;
-	}
+    function query($sql, $type = '', $cachetime = FALSE) {
+        $func = $type == 'UNBUFFERED' && @function_exists('mysqli_unbuffered_query') ? 'mysqli_unbuffered_query' : 'mysqli_query';
+        if(!($query = $func($this->link, $sql)) && $type != 'SILENT') {
+            $this->halt('MySQL Query Error', $sql);
+        }
+        $this->querynum++;
+        $this->histories[] = $sql;
+        return $query;
+    }

-	function affected_rows() {
-		return mysql_affected_rows($this->link);
-	}
+    function affected_rows() {
+        return mysqli_affected_rows($this->link);
+    }

-	function error() {
-		return (($this->link) ? mysql_error($this->link) : mysql_error());
-	}
+    function error() {
+        return (($this->link) ? mysqli_error($this->link) : mysqli_error());
+    }

-	function errno() {
-		return intval(($this->link) ? mysql_errno($this->link) : mysql_errno());
-	}
+    function errno() {
+        return intval(($this->link) ? mysqli_errno($this->link) : mysqli_errno());
+    }

-	function result($query, $row) {
-		$query = @mysql_result($query, $row);
-		return $query;
-	}
+    function result($query, $row) {
+        for ($i = 0; $i <= $row; $i++) {
+            $query = mysqli_fetch_row($query);
+        }
+        if (count($query) == 1) {
+            $query = $query[0];
+        }
+        return $query;
+    }

-	function num_rows($query) {
-		$query = mysql_num_rows($query);
-		return $query;
-	}
+    function num_rows($query) {
+        $query = mysqli_num_rows($query);
+        return $query;
+    }

-	function num_fields($query) {
-		return mysql_num_fields($query);
-	}
+    function num_fields($query) {
+        return mysqli_num_fields($query);
+    }

-	function free_result($query) {
-		return mysql_free_result($query);
-	}
+    function free_result($query) {
+        return mysqli_free_result($query);
+    }

-	function insert_id() {
-		return ($id = mysql_insert_id($this->link)) >= 0 ? $id : $this->result($this->query("SELECT last_insert_id()"), 0);
-	}
+    function insert_id() {
+        return ($id = mysqli_insert_id($this->link)) >= 0 ? $id : $this->result($this->query("SELECT last_insert_id()"), 0);
+    }

-	function fetch_row($query) {
-		$query = mysql_fetch_row($query);
-		return $query;
-	}
+    function fetch_row($query) {
+        $query = mysqli_fetch_row($query);
+        return $query;
+    }

-	function fetch_fields($query) {
-		return mysql_fetch_field($query);
-	}
+    function fetch_fields($query) {
+        return mysqli_fetch_field($query);
+    }

-	function version() {
-		return mysql_get_server_info($this->link);
-	}
+    function version() {
+        return mysqli_get_server_info($this->link);
+    }

-	function close() {
-		return mysql_close($this->link);
-	}
+    function close() {
+        return mysqli_close($this->link);
+    }

-	function halt($message = '', $sql = '') {
-		$error = mysql_error();
-		$errorno = mysql_errno();
-		if($errorno == 2006 && $this->goneaway-- > 0) {
-			$this->connect($this->dbhost, $this->dbuser, $this->dbpw, $this->dbname, $this->dbcharset, $this->pconnect, $this->tablepre, $this->time);
-			$this->query($sql);
-		} else {
-			$s = '';
-			if($message) {
-				$s = "<b>UCenter info:</b> $message<br />";
-			}
-			if($sql) {
-				$s .= '<b>SQL:</b>'.htmlspecialchars($sql).'<br />';
-			}
-			$s .= '<b>Error:</b>'.$error.'<br />';
-			$s .= '<b>Errno:</b>'.$errorno.'<br />';
-			$s = str_replace(UC_DBTABLEPRE, '[Table]', $s);
-			exit($s);
-		}
-	}
+    function halt($message = '', $sql = '') {
+        $error = mysqli_error($this->link);
+        $errorno = mysqli_errno($this->link);
+        if($errorno == 2006 && $this->goneaway-- > 0) {
+            $this->connect($this->dbhost, $this->dbuser, $this->dbpw, $this->dbname, $this->dbcharset, $this->pconnect, $this->tablepre, $this->time);
+            $this->query($sql);
+        } else {
+            $s = '';
+            if($message) {
+                $s = "<b>UCenter info:</b> $message<br />";
+            }
+            if($sql) {
+                $s .= '<b>SQL:</b>'.htmlspecialchars($sql).'<br />';
+            }
+            $s .= '<b>Error:</b>'.$error.'<br />';
+            $s .= '<b>Errno:</b>'.$errorno.'<br />';
+            $s = str_replace(UC_DBTABLEPRE, '[Table]', $s);
+            exit($s);
+        }
+    }
 }

 ?>
\ No newline at end of file
Index: uc_client/model/base.php
===================================================================
--- uc_client/model/base.php	(revision 3919)
+++ uc_client/model/base.php	(working copy)
@@ -1,253 +1,253 @@
 <?php

 /*
-	[UCenter] (C)2001-2099 Comsenz Inc.
-	This is NOT a freeware, use is subject to license terms
+    [UCenter] (C)2001-2099 Comsenz Inc.
+    This is NOT a freeware, use is subject to license terms

-	$Id: base.php 1059 2011-03-01 07:25:09Z monkey $
+    $Id: base.php 1059 2011-03-01 07:25:09Z monkey $
 */

 !defined('IN_UC') && exit('Access Denied');

 if(!function_exists('getgpc')) {
-	function getgpc($k, $var='G') {
-		switch($var) {
-			case 'G': $var = &$_GET; break;
-			case 'P': $var = &$_POST; break;
-			case 'C': $var = &$_COOKIE; break;
-			case 'R': $var = &$_REQUEST; break;
-		}
-		return isset($var[$k]) ? $var[$k] : NULL;
-	}
+    function getgpc($k, $var='G') {
+        switch($var) {
+            case 'G': $var = &$_GET; break;
+            case 'P': $var = &$_POST; break;
+            case 'C': $var = &$_COOKIE; break;
+            case 'R': $var = &$_REQUEST; break;
+        }
+        return isset($var[$k]) ? $var[$k] : NULL;
+    }
 }

 class base {

-	var $time;
-	var $onlineip;
-	var $db;
-	var $key;
-	var $settings = array();
-	var $cache = array();
-	var $app = array();
-	var $user = array();
-	var $input = array();
-	function __construct() {
-		$this->base();
-	}
+    var $time;
+    var $onlineip;
+    var $db;
+    var $key;
+    var $settings = array();
+    var $cache = array();
+    var $app = array();
+    var $user = array();
+    var $input = array();
+    function __construct() {
+        $this->base();
+    }

-	function base() {
-		$this->init_var();
-		$this->init_db();
-		$this->init_cache();
-		$this->init_note();
-		$this->init_mail();
-	}
+    function base() {
+        $this->init_var();
+        $this->init_db();
+        $this->init_cache();
+        $this->init_note();
+        $this->init_mail();
+    }

-	function init_var() {
-		$this->time = time();
-		$cip = getenv('HTTP_CLIENT_IP');
-		$xip = getenv('HTTP_X_FORWARDED_FOR');
-		$rip = getenv('REMOTE_ADDR');
-		$srip = $_SERVER['REMOTE_ADDR'];
-		if($cip && strcasecmp($cip, 'unknown')) {
-			$this->onlineip = $cip;
-		} elseif($xip && strcasecmp($xip, 'unknown')) {
-			$this->onlineip = $xip;
-		} elseif($rip && strcasecmp($rip, 'unknown')) {
-			$this->onlineip = $rip;
-		} elseif($srip && strcasecmp($srip, 'unknown')) {
-			$this->onlineip = $srip;
-		}
-		preg_match("/[\d\.]{7,15}/", $this->onlineip, $match);
-		$this->onlineip = $match[0] ? $match[0] : 'unknown';
-		$this->app['appid'] = UC_APPID;
-	}
+    function init_var() {
+        $this->time = time();
+        $cip = getenv('HTTP_CLIENT_IP');
+        $xip = getenv('HTTP_X_FORWARDED_FOR');
+        $rip = getenv('REMOTE_ADDR');
+        $srip = $_SERVER['REMOTE_ADDR'];
+        if($cip && strcasecmp($cip, 'unknown')) {
+            $this->onlineip = $cip;
+        } elseif($xip && strcasecmp($xip, 'unknown')) {
+            $this->onlineip = $xip;
+        } elseif($rip && strcasecmp($rip, 'unknown')) {
+            $this->onlineip = $rip;
+        } elseif($srip && strcasecmp($srip, 'unknown')) {
+            $this->onlineip = $srip;
+        }
+        preg_match("/[\d\.]{7,15}/", $this->onlineip, $match);
+        $this->onlineip = isset($match[0]) ? $match[0] : 'unknown';
+        $this->app['appid'] = UC_APPID;
+    }

-	function init_input() {
+    function init_input() {

-	}
+    }

-	function init_db() {
-		require_once UC_ROOT.'lib/db.class.php';
-		$this->db = new ucclient_db();
-		$this->db->connect(UC_DBHOST, UC_DBUSER, UC_DBPW, '', UC_DBCHARSET, UC_DBCONNECT, UC_DBTABLEPRE);
-	}
+    function init_db() {
+        require_once UC_ROOT.'lib/db.class.php';
+        $this->db = new ucclient_db();
+        $this->db->connect(UC_DBHOST, UC_DBUSER, UC_DBPW, '', UC_DBCHARSET, UC_DBCONNECT, UC_DBTABLEPRE);
+    }

-	function load($model, $base = NULL) {
-		$base = $base ? $base : $this;
-		if(empty($_ENV[$model])) {
-			require_once UC_ROOT."./model/$model.php";
-			eval('$_ENV[$model] = new '.$model.'model($base);');
-		}
-		return $_ENV[$model];
-	}
+    function load($model, $base = NULL) {
+        $base = $base ? $base : $this;
+        if(empty($_ENV[$model])) {
+            require_once UC_ROOT."./model/$model.php";
+            eval('$_ENV[$model] = new '.$model.'model($base);');
+        }
+        return $_ENV[$model];
+    }

-	function date($time, $type = 3) {
-		if(!$this->settings) {
-			$this->settings = $this->cache('settings');
-		}
-		$format[] = $type & 2 ? (!empty($this->settings['dateformat']) ? $this->settings['dateformat'] : 'Y-n-j') : '';
-		$format[] = $type & 1 ? (!empty($this->settings['timeformat']) ? $this->settings['timeformat'] : 'H:i') : '';
-		return gmdate(implode(' ', $format), $time + $this->settings['timeoffset']);
-	}
+    function date($time, $type = 3) {
+        if(!$this->settings) {
+            $this->settings = $this->cache('settings');
+        }
+        $format[] = $type & 2 ? (!empty($this->settings['dateformat']) ? $this->settings['dateformat'] : 'Y-n-j') : '';
+        $format[] = $type & 1 ? (!empty($this->settings['timeformat']) ? $this->settings['timeformat'] : 'H:i') : '';
+        return gmdate(implode(' ', $format), $time + $this->settings['timeoffset']);
+    }

-	function page_get_start($page, $ppp, $totalnum) {
-		$totalpage = ceil($totalnum / $ppp);
-		$page =  max(1, min($totalpage,intval($page)));
-		return ($page - 1) * $ppp;
-	}
+    function page_get_start($page, $ppp, $totalnum) {
+        $totalpage = ceil($totalnum / $ppp);
+        $page =  max(1, min($totalpage,intval($page)));
+        return ($page - 1) * $ppp;
+    }

-	function implode($arr) {
-		return "'".implode("','", (array)$arr)."'";
-	}
+    function implode($arr) {
+        return "'".implode("','", (array)$arr)."'";
+    }

-	function &cache($cachefile) {
-		static $_CACHE = array();
-		if(!isset($_CACHE[$cachefile])) {
-			$cachepath = UC_DATADIR.'./cache/'.$cachefile.'.php';
-			if(!file_exists($cachepath)) {
-				$this->load('cache');
-				$_ENV['cache']->updatedata($cachefile);
-			} else {
-				include_once $cachepath;
-			}
-		}
-		return $_CACHE[$cachefile];
-	}
+    function &cache($cachefile) {
+        static $_CACHE = array();
+        if(!isset($_CACHE[$cachefile])) {
+            $cachepath = UC_DATADIR.'./cache/'.$cachefile.'.php';
+            if(!file_exists($cachepath)) {
+                $this->load('cache');
+                $_ENV['cache']->updatedata($cachefile);
+            } else {
+                include_once $cachepath;
+            }
+        }
+        return $_CACHE[$cachefile];
+    }

-	function get_setting($k = array(), $decode = FALSE) {
-		$return = array();
-		$sqladd = $k ? "WHERE k IN (".$this->implode($k).")" : '';
-		$settings = $this->db->fetch_all("SELECT * FROM ".UC_DBTABLEPRE."settings $sqladd");
-		if(is_array($settings)) {
-			foreach($settings as $arr) {
-				$return[$arr['k']] = $decode ? unserialize($arr['v']) : $arr['v'];
-			}
-		}
-		return $return;
-	}
+    function get_setting($k = array(), $decode = FALSE) {
+        $return = array();
+        $sqladd = $k ? "WHERE k IN (".$this->implode($k).")" : '';
+        $settings = $this->db->fetch_all("SELECT * FROM ".UC_DBTABLEPRE."settings $sqladd");
+        if(is_array($settings)) {
+            foreach($settings as $arr) {
+                $return[$arr['k']] = $decode ? unserialize($arr['v']) : $arr['v'];
+            }
+        }
+        return $return;
+    }

-	function init_cache() {
-		$this->settings = $this->cache('settings');
-		$this->cache['apps'] = $this->cache('apps');
+    function init_cache() {
+        $this->settings = $this->cache('settings');
+        $this->cache['apps'] = $this->cache('apps');

-		if(PHP_VERSION > '5.1') {
-			$timeoffset = intval($this->settings['timeoffset'] / 3600);
-			@date_default_timezone_set('Etc/GMT'.($timeoffset > 0 ? '-' : '+').(abs($timeoffset)));
-		}
-	}
+        if(PHP_VERSION > '5.1') {
+            $timeoffset = intval($this->settings['timeoffset'] / 3600);
+            @date_default_timezone_set('Etc/GMT'.($timeoffset > 0 ? '-' : '+').(abs($timeoffset)));
+        }
+    }

-	function cutstr($string, $length, $dot = ' ...') {
-		if(strlen($string) <= $length) {
-			return $string;
-		}
+    function cutstr($string, $length, $dot = ' ...') {
+        if(strlen($string) <= $length) {
+            return $string;
+        }

-		$string = str_replace(array('&amp;', '&quot;', '&lt;', '&gt;'), array('&', '"', '<', '>'), $string);
+        $string = str_replace(array('&amp;', '&quot;', '&lt;', '&gt;'), array('&', '"', '<', '>'), $string);

-		$strcut = '';
-		if(strtolower(UC_CHARSET) == 'utf-8') {
+        $strcut = '';
+        if(strtolower(UC_CHARSET) == 'utf-8') {

-			$n = $tn = $noc = 0;
-			while($n < strlen($string)) {
+            $n = $tn = $noc = 0;
+            while($n < strlen($string)) {

-				$t = ord($string[$n]);
-				if($t == 9 || $t == 10 || (32 <= $t && $t <= 126)) {
-					$tn = 1; $n++; $noc++;
-				} elseif(194 <= $t && $t <= 223) {
-					$tn = 2; $n += 2; $noc += 2;
-				} elseif(224 <= $t && $t < 239) {
-					$tn = 3; $n += 3; $noc += 2;
-				} elseif(240 <= $t && $t <= 247) {
-					$tn = 4; $n += 4; $noc += 2;
-				} elseif(248 <= $t && $t <= 251) {
-					$tn = 5; $n += 5; $noc += 2;
-				} elseif($t == 252 || $t == 253) {
-					$tn = 6; $n += 6; $noc += 2;
-				} else {
-					$n++;
-				}
+                $t = ord($string[$n]);
+                if($t == 9 || $t == 10 || (32 <= $t && $t <= 126)) {
+                    $tn = 1; $n++; $noc++;
+                } elseif(194 <= $t && $t <= 223) {
+                    $tn = 2; $n += 2; $noc += 2;
+                } elseif(224 <= $t && $t < 239) {
+                    $tn = 3; $n += 3; $noc += 2;
+                } elseif(240 <= $t && $t <= 247) {
+                    $tn = 4; $n += 4; $noc += 2;
+                } elseif(248 <= $t && $t <= 251) {
+                    $tn = 5; $n += 5; $noc += 2;
+                } elseif($t == 252 || $t == 253) {
+                    $tn = 6; $n += 6; $noc += 2;
+                } else {
+                    $n++;
+                }

-				if($noc >= $length) {
-					break;
-				}
+                if($noc >= $length) {
+                    break;
+                }

-			}
-			if($noc > $length) {
-				$n -= $tn;
-			}
+            }
+            if($noc > $length) {
+                $n -= $tn;
+            }

-			$strcut = substr($string, 0, $n);
+            $strcut = substr($string, 0, $n);

-		} else {
-			for($i = 0; $i < $length; $i++) {
-				$strcut .= ord($string[$i]) > 127 ? $string[$i].$string[++$i] : $string[$i];
-			}
-		}
+        } else {
+            for($i = 0; $i < $length; $i++) {
+                $strcut .= ord($string[$i]) > 127 ? $string[$i].$string[++$i] : $string[$i];
+            }
+        }

-		$strcut = str_replace(array('&', '"', '<', '>'), array('&amp;', '&quot;', '&lt;', '&gt;'), $strcut);
+        $strcut = str_replace(array('&', '"', '<', '>'), array('&amp;', '&quot;', '&lt;', '&gt;'), $strcut);

-		return $strcut.$dot;
-	}
+        return $strcut.$dot;
+    }

-	function init_note() {
-		if($this->note_exists()) {
-			$this->load('note');
-			$_ENV['note']->send();
-		}
-	}
+    function init_note() {
+        if($this->note_exists()) {
+            $this->load('note');
+            $_ENV['note']->send();
+        }
+    }

-	function note_exists() {
-		$noteexists = $this->db->fetch_first("SELECT value FROM ".UC_DBTABLEPRE."vars WHERE name='noteexists".UC_APPID."'");
-		if(empty($noteexists)) {
-			return FALSE;
-		} else {
-			return TRUE;
-		}
-	}
+    function note_exists() {
+        $noteexists = $this->db->fetch_first("SELECT value FROM ".UC_DBTABLEPRE."vars WHERE name='noteexists".UC_APPID."'");
+        if(empty($noteexists)) {
+            return FALSE;
+        } else {
+            return TRUE;
+        }
+    }

-	function init_mail() {
-		if($this->mail_exists() && !getgpc('inajax')) {
-			$this->load('mail');
-			$_ENV['mail']->send();
-		}
-	}
+    function init_mail() {
+        if($this->mail_exists() && !getgpc('inajax')) {
+            $this->load('mail');
+            $_ENV['mail']->send();
+        }
+    }

-	function authcode($string, $operation = 'DECODE', $key = '', $expiry = 0) {
-		return uc_authcode($string, $operation, $key, $expiry);
-	}
+    function authcode($string, $operation = 'DECODE', $key = '', $expiry = 0) {
+        return uc_authcode($string, $operation, $key, $expiry);
+    }
 /*
-	function serialize() {
+    function serialize() {

-	}
+    }
 */
-	function unserialize($s) {
-		return uc_unserialize($s);
-	}
+    function unserialize($s) {
+        return uc_unserialize($s);
+    }

-	function input($k) {
-		return isset($this->input[$k]) ? (is_array($this->input[$k]) ? $this->input[$k] : trim($this->input[$k])) : NULL;
-	}
+    function input($k) {
+        return isset($this->input[$k]) ? (is_array($this->input[$k]) ? $this->input[$k] : trim($this->input[$k])) : NULL;
+    }

-	function mail_exists() {
-		$mailexists = $this->db->fetch_first("SELECT value FROM ".UC_DBTABLEPRE."vars WHERE name='mailexists'");
-		if(empty($mailexists)) {
-			return FALSE;
-		} else {
-			return TRUE;
-		}
-	}
+    function mail_exists() {
+        $mailexists = $this->db->fetch_first("SELECT value FROM ".UC_DBTABLEPRE."vars WHERE name='mailexists'");
+        if(empty($mailexists)) {
+            return FALSE;
+        } else {
+            return TRUE;
+        }
+    }

-	function dstripslashes($string) {
-		if(is_array($string)) {
-			foreach($string as $key => $val) {
-				$string[$key] = $this->dstripslashes($val);
-			}
-		} else {
-			$string = stripslashes($string);
-		}
-		return $string;
-	}
+    function dstripslashes($string) {
+        if(is_array($string)) {
+            foreach($string as $key => $val) {
+                $string[$key] = $this->dstripslashes($val);
+            }
+        } else {
+            $string = stripslashes($string);
+        }
+        return $string;
+    }

 }

Index: uc_client/model/pm.php
===================================================================
--- uc_client/model/pm.php	(revision 3919)
+++ uc_client/model/pm.php	(working copy)
@@ -1,10 +1,10 @@
 <?php

 /*
-	[UCenter] (C)2001-2099 Comsenz Inc.
-	This is NOT a freeware, use is subject to license terms
+    [UCenter] (C)2001-2099 Comsenz Inc.
+    This is NOT a freeware, use is subject to license terms

-	$Id: pm.php 1059 2011-03-01 07:25:09Z monkey $
+    $Id: pm.php 1059 2011-03-01 07:25:09Z monkey $
 */

 !defined('IN_UC') && exit('Access Denied');
@@ -21,991 +21,991 @@

 class pmmodel {

-	var $db;
-	var $base;
-	function __construct(&$base) {
-		$this->pmmodel($base);
-	}
+    var $db;
+    var $base;
+    function __construct(&$base) {
+        $this->pmmodel($base);
+    }

-	function pmmodel(&$base) {
-		$this->base = $base;
-		$this->db = $base->db;
-	}
+    function pmmodel(&$base) {
+        $this->base = $base;
+        $this->db = $base->db;
+    }

-	function pmintval($pmid) {
-		return @is_numeric($pmid) ? $pmid : 0;
-	}
+    function pmintval($pmid) {
+        return @is_numeric($pmid) ? $pmid : 0;
+    }

-	function getpmbypmid($uid, $pmid) {
-		if(!$pmid) {
-			return array();
-		}
-		$arr = array();
-		$pm = $this->db->fetch_first("SELECT * FROM ".UC_DBTABLEPRE."pm_indexes i LEFT JOIN ".UC_DBTABLEPRE."pm_lists t ON t.plid=i.plid WHERE i.pmid='$pmid'");
-		if($this->isprivilege($pm['plid'], $uid)) {
-			$pms = $this->db->fetch_all("SELECT t.*, p.*, t.authorid as founderuid, t.dateline as founddateline FROM ".UC_DBTABLEPRE.$this->getposttablename($pm['plid'])." p LEFT JOIN ".UC_DBTABLEPRE."pm_lists t ON t.plid=p.plid WHERE p.pmid='$pm[pmid]'");
-			$arr = $this->getpostlist($pms);
-		}
-		return $arr;
-	}
+    function getpmbypmid($uid, $pmid) {
+        if(!$pmid) {
+            return array();
+        }
+        $arr = array();
+        $pm = $this->db->fetch_first("SELECT * FROM ".UC_DBTABLEPRE."pm_indexes i LEFT JOIN ".UC_DBTABLEPRE."pm_lists t ON t.plid=i.plid WHERE i.pmid='$pmid'");
+        if($this->isprivilege($pm['plid'], $uid)) {
+            $pms = $this->db->fetch_all("SELECT t.*, p.*, t.authorid as founderuid, t.dateline as founddateline FROM ".UC_DBTABLEPRE.$this->getposttablename($pm['plid'])." p LEFT JOIN ".UC_DBTABLEPRE."pm_lists t ON t.plid=p.plid WHERE p.pmid='$pm[pmid]'");
+            $arr = $this->getpostlist($pms);
+        }
+        return $arr;
+    }

-	function isprivilege($plid, $uid) {
-		if(!$plid || !$uid) {
-			return true;
-		}
-		$query = $this->db->query("SELECT * FROM ".UC_DBTABLEPRE."pm_members WHERE plid='$plid' AND uid='$uid'");
-		if($this->db->fetch_array($query)) {
-			return true;
-		} else {
-			return false;
-		}
-	}
+    function isprivilege($plid, $uid) {
+        if(!$plid || !$uid) {
+            return true;
+        }
+        $query = $this->db->query("SELECT * FROM ".UC_DBTABLEPRE."pm_members WHERE plid='$plid' AND uid='$uid'");
+        if($this->db->fetch_array($query)) {
+            return true;
+        } else {
+            return false;
+        }
+    }

-	function getpmbyplid($uid, $plid, $starttime, $endtime, $start, $ppp, $type = 0) {
-		if(!$type) {
-			$pm = $this->getprivatepmbyplid($uid, $plid, $starttime, $endtime, $start, $ppp);
-		} else {
-			$pm = $this->getchatpmbyplid($uid, $plid, $starttime, $endtime, $start, $ppp);
-		}
-		return $this->getpostlist($pm);
-	}
+    function getpmbyplid($uid, $plid, $starttime, $endtime, $start, $ppp, $type = 0) {
+        if(!$type) {
+            $pm = $this->getprivatepmbyplid($uid, $plid, $starttime, $endtime, $start, $ppp);
+        } else {
+            $pm = $this->getchatpmbyplid($uid, $plid, $starttime, $endtime, $start, $ppp);
+        }
+        return $this->getpostlist($pm);
+    }

-	function getpostlist($list) {
-		if(empty($list)) {
-			return array();
-		}
-		$authoridarr = $authorarr = array();
-		foreach($list as $key => $value) {
-			$authoridarr[$value['authorid']] = $value['authorid'];
-		}
-		if($authoridarr) {
-			$this->base->load('user');
-			$authorarr = $_ENV['user']->id2name($authoridarr);
-		}
-		foreach($list as $key => $value) {
-			if($value['pmtype'] == 1) {
-				$users = explode('_', $value['min_max']);
-				if($value['authorid'] == $users[0]) {
-					$value['touid'] = $users[1];
-				} else {
-					$value['touid'] = $users[0];
-				}
-			} else {
-				$value['touid'] = 0;
-			}
-			$value['author'] = $authorarr[$value['authorid']];
+    function getpostlist($list) {
+        if(empty($list)) {
+            return array();
+        }
+        $authoridarr = $authorarr = array();
+        foreach($list as $key => $value) {
+            $authoridarr[$value['authorid']] = $value['authorid'];
+        }
+        if($authoridarr) {
+            $this->base->load('user');
+            $authorarr = $_ENV['user']->id2name($authoridarr);
+        }
+        foreach($list as $key => $value) {
+            if($value['pmtype'] == 1) {
+                $users = explode('_', $value['min_max']);
+                if($value['authorid'] == $users[0]) {
+                    $value['touid'] = $users[1];
+                } else {
+                    $value['touid'] = $users[0];
+                }
+            } else {
+                $value['touid'] = 0;
+            }
+            $value['author'] = $authorarr[$value['authorid']];

-			$value['msgfromid'] = $value['authorid'];
-			$value['msgfrom'] = $value['author'];
-			$value['msgtoid'] = $value['touid'];
+            $value['msgfromid'] = $value['authorid'];
+            $value['msgfrom'] = $value['author'];
+            $value['msgtoid'] = $value['touid'];

-			unset($value['min_max']);
-			unset($value['delstatus']);
-			unset($value['lastmessage']);
-			$list[$key] = $value;
-		}
-		return $list;
-	}
+            unset($value['min_max']);
+            unset($value['delstatus']);
+            unset($value['lastmessage']);
+            $list[$key] = $value;
+        }
+        return $list;
+    }

-	function setpmstatus($uid, $touids, $plids, $status = 0) {
-		if(!$uid) {
-			return false;
-		}
-		if(!$status) {
-			$oldstatus = 1;
-			$newstatus = 0;
-		} else {
-			$oldstatus = 0;
-			$newstatus = 1;
-		}
-		if($touids) {
-			foreach($touids as $key => $value) {
-				if($uid == $value || !$value) {
-					return false;
-				}
-				$relastionship[] = $this->relationship($uid, $value);
-			}
-			$plid = $plidpostarr = array();
-			$query = $this->db->query("SELECT plid FROM ".UC_DBTABLEPRE."pm_lists WHERE min_max IN (".$this->base->implode($relationship).")");
-			while($thread = $this->db->fetch_array($query)) {
-				$plidarr[] = $thread['plid'];
-			}
-			if($plidarr) {
-				$this->db->query("UPDATE ".UC_DBTABLEPRE."pm_members SET isnew='$newstatus' WHERE plid IN (".$this->base->implode($plidarr).") AND uid='$uid' AND isnew='$oldstatus'");
-			}
-		}
-		if($plids) {
-			$this->db->query("UPDATE ".UC_DBTABLEPRE."pm_members SET isnew='$newstatus' WHERE plid IN (".$this->base->implode($plids).") AND uid='$uid' AND isnew='$oldstatus'");
-		}
-		return true;
-	}
+    function setpmstatus($uid, $touids, $plids, $status = 0) {
+        if(!$uid) {
+            return false;
+        }
+        if(!$status) {
+            $oldstatus = 1;
+            $newstatus = 0;
+        } else {
+            $oldstatus = 0;
+            $newstatus = 1;
+        }
+        if($touids) {
+            foreach($touids as $key => $value) {
+                if($uid == $value || !$value) {
+                    return false;
+                }
+                $relastionship[] = $this->relationship($uid, $value);
+            }
+            $plid = $plidpostarr = array();
+            $query = $this->db->query("SELECT plid FROM ".UC_DBTABLEPRE."pm_lists WHERE min_max IN (".$this->base->implode($relationship).")");
+            while($thread = $this->db->fetch_array($query)) {
+                $plidarr[] = $thread['plid'];
+            }
+            if($plidarr) {
+                $this->db->query("UPDATE ".UC_DBTABLEPRE."pm_members SET isnew='$newstatus' WHERE plid IN (".$this->base->implode($plidarr).") AND uid='$uid' AND isnew='$oldstatus'");
+            }
+        }
+        if($plids) {
+            $this->db->query("UPDATE ".UC_DBTABLEPRE."pm_members SET isnew='$newstatus' WHERE plid IN (".$this->base->implode($plids).") AND uid='$uid' AND isnew='$oldstatus'");
+        }
+        return true;
+    }

-	function set_ignore($uid) {
-		return $this->db->query("DELETE FROM ".UC_DBTABLEPRE."newpm WHERE uid='$uid'");
-	}
+    function set_ignore($uid) {
+        return $this->db->query("DELETE FROM ".UC_DBTABLEPRE."newpm WHERE uid='$uid'");
+    }

-	function isnewpm($uid) {
-		return $this->db->result_first("SELECT COUNT(*) FROM ".UC_DBTABLEPRE."newpm WHERE uid='$uid'");
-	}
+    function isnewpm($uid) {
+        return $this->db->result_first("SELECT COUNT(*) FROM ".UC_DBTABLEPRE."newpm WHERE uid='$uid'");
+    }

-	function lastpm($uid) {
-		$lastpm = $this->db->fetch_first("SELECT * FROM ".UC_DBTABLEPRE."pm_members m LEFT JOIN ".UC_DBTABLEPRE."pm_lists t ON m.plid=t.plid WHERE m.uid='$uid' ORDER BY m.lastdateline DESC LIMIT 1");
-		$lastmessage = unserialize($lastpm['lastmessage']);
-		if($lastmessage['lastauthorid']) {
-			$lastpm['lastauthorid'] = $lastmessage['lastauthorid'];
-			$lastpm['lastauthor'] = $lastmessage['lastauthor'];
-			$lastpm['lastsummary'] = $lastmessage['lastsummary'];
-		} else {
-			$lastpm['lastauthorid'] = $lastmessage['firstauthorid'];
-			$lastpm['lastauthor'] = $lastmessage['firstauthor'];
-			$lastpm['lastsummary'] = $lastmessage['firstsummary'];
-		}
-		return $lastpm;
-	}
+    function lastpm($uid) {
+        $lastpm = $this->db->fetch_first("SELECT * FROM ".UC_DBTABLEPRE."pm_members m LEFT JOIN ".UC_DBTABLEPRE."pm_lists t ON m.plid=t.plid WHERE m.uid='$uid' ORDER BY m.lastdateline DESC LIMIT 1");
+        $lastmessage = unserialize($lastpm['lastmessage']);
+        if($lastmessage['lastauthorid']) {
+            $lastpm['lastauthorid'] = $lastmessage['lastauthorid'];
+            $lastpm['lastauthor'] = $lastmessage['lastauthor'];
+            $lastpm['lastsummary'] = $lastmessage['lastsummary'];
+        } else {
+            $lastpm['lastauthorid'] = $lastmessage['firstauthorid'];
+            $lastpm['lastauthor'] = $lastmessage['firstauthor'];
+            $lastpm['lastsummary'] = $lastmessage['firstsummary'];
+        }
+        return $lastpm;
+    }

-	function getpmnum($uid, $type = 0, $isnew = 0) {
-		$newsql = '';
-		$newnum = 0;
+    function getpmnum($uid, $type = 0, $isnew = 0) {
+        $newsql = '';
+        $newnum = 0;

-		if($isnew) {
-			$newsql = 'AND m.isnew=1';
-		}
-		if(!$type) {
-			$newnum = $this->db->result_first("SELECT COUNT(*) FROM ".UC_DBTABLEPRE."pm_members m WHERE m.uid='$uid' $newsql");
-		} else {
-			$newnum = $this->db->result_first("SELECT COUNT(*) FROM ".UC_DBTABLEPRE."pm_members m LEFT JOIN ".UC_DBTABLEPRE."pm_lists t ON t.plid=m.plid WHERE m.uid='$uid' $newsql AND t.pmtype='$type'");
-		}
-		return $newnum;
-	}
+        if($isnew) {
+            $newsql = 'AND m.isnew=1';
+        }
+        if(!$type) {
+            $newnum = $this->db->result_first("SELECT COUNT(*) FROM ".UC_DBTABLEPRE."pm_members m WHERE m.uid='$uid' $newsql");
+        } else {
+            $newnum = $this->db->result_first("SELECT COUNT(*) FROM ".UC_DBTABLEPRE."pm_members m LEFT JOIN ".UC_DBTABLEPRE."pm_lists t ON t.plid=m.plid WHERE m.uid='$uid' $newsql AND t.pmtype='$type'");
+        }
+        return $newnum;
+    }

-	function getpmnumbyplid($uid, $plid) {
-		return $this->db->result_first("SELECT pmnum FROM ".UC_DBTABLEPRE."pm_members WHERE plid='$plid' AND uid='$uid'");
-	}
+    function getpmnumbyplid($uid, $plid) {
+        return $this->db->result_first("SELECT pmnum FROM ".UC_DBTABLEPRE."pm_members WHERE plid='$plid' AND uid='$uid'");
+    }

-	function sendpm($fromuid, $fromusername, $touids, $subject, $message, $type = 0) {
-		if(!$fromuid || !$fromusername || !$touids || !$message) {
-			return 0;
-		}
-		$touids = array_unique($touids);
-		$relationship = $existplid = $pm_member_insertsql = array();
-		$this->base->load('user');
-		$tmptouidarr = $touids;
-		$blackls = $this->get_blackls($fromuid, $touids);
+    function sendpm($fromuid, $fromusername, $touids, $subject, $message, $type = 0) {
+        if(!$fromuid || !$fromusername || !$touids || !$message) {
+            return 0;
+        }
+        $touids = array_unique($touids);
+        $relationship = $existplid = $pm_member_insertsql = array();
+        $this->base->load('user');
+        $tmptouidarr = $touids;
+        $blackls = $this->get_blackls($fromuid, $touids);

-		foreach($tmptouidarr as $key => $value) {
-			if($fromuid == $value || !$value) {
-				return PMSENDSELF_ERROR;
-			}
+        foreach($tmptouidarr as $key => $value) {
+            if($fromuid == $value || !$value) {
+                return PMSENDSELF_ERROR;
+            }

-			if(in_array('{ALL}', $blackls[$value])) {
-				unset($touids[$key]);
-				continue;
-			}
-			$blackls[$value] = $_ENV['user']->name2id($blackls[$value]);
-			if(!(isset($blackls[$value]) && !in_array($fromuid, $blackls[$value]))) {
-				unset($touids[$key]);
-			} else {
-				$relationship[$value] = $this->relationship($fromuid, $value);
-			}
-		}
-		if(empty($touids)) {
-			return PMSENDNONE_ERROR;
-		}
-		if($type == 1 && count($touids) < 2) {
-			return PMSENDCHATNUM_ERROR;
-		}
+            if(in_array('{ALL}', $blackls[$value])) {
+                unset($touids[$key]);
+                continue;
+            }
+            $blackls[$value] = $_ENV['user']->name2id($blackls[$value]);
+            if(!(isset($blackls[$value]) && !in_array($fromuid, $blackls[$value]))) {
+                unset($touids[$key]);
+            } else {
+                $relationship[$value] = $this->relationship($fromuid, $value);
+            }
+        }
+        if(empty($touids)) {
+            return PMSENDNONE_ERROR;
+        }
+        if($type == 1 && count($touids) < 2) {
+            return PMSENDCHATNUM_ERROR;
+        }

-		$_CACHE['badwords'] = $this->base->cache('badwords');
-		if($_CACHE['badwords']['findpattern']) {
-			$subject = @preg_replace($_CACHE['badwords']['findpattern'], $_CACHE['badwords']['replace'], $subject);
-			$message = @preg_replace($_CACHE['badwords']['findpattern'], $_CACHE['badwords']['replace'], $message);
-		}
-		if(!$subject) {
-			$subject = $this->removecode(trim($message), 80);
-		} else {
-			$subject = htmlspecialchars($subject);
-		}
-		$lastsummary = $this->removecode(trim($message), 150);
+        $_CACHE['badwords'] = $this->base->cache('badwords');
+        if($_CACHE['badwords']['findpattern']) {
+            $subject = @preg_replace($_CACHE['badwords']['findpattern'], $_CACHE['badwords']['replace'], $subject);
+            $message = @preg_replace($_CACHE['badwords']['findpattern'], $_CACHE['badwords']['replace'], $message);
+        }
+        if(!$subject) {
+            $subject = $this->removecode(trim($message), 80);
+        } else {
+            $subject = htmlspecialchars($subject);
+        }
+        $lastsummary = $this->removecode(trim($message), 150);

-		if(!$type) {
-			$query = $this->db->query("SELECT plid, min_max FROM ".UC_DBTABLEPRE."pm_lists WHERE min_max IN (".$this->base->implode($relationship).")");
-			while($thread = $this->db->fetch_array($query)) {
-				$existplid[$thread['min_max']] = $thread['plid'];
-			}
-			$lastmessage = array('lastauthorid' => $fromuid, 'lastauthor' => $fromusername, 'lastsummary' => $lastsummary);
-			$lastmessage = addslashes(serialize($lastmessage));
-			foreach($relationship as $key => $value) {
-				if(!isset($existplid[$value])) {
-					$this->db->query("INSERT INTO ".UC_DBTABLEPRE."pm_lists(authorid, pmtype, subject, members, min_max, dateline, lastmessage) VALUES('$fromuid', '1', '$subject', 2, '$value', '".$this->base->time."', '$lastmessage')");
-					$plid = $this->db->insert_id();
-					$this->db->query("INSERT INTO ".UC_DBTABLEPRE."pm_indexes(plid) VALUES('$plid')");
-					$pmid = $this->db->insert_id();
-					$this->db->query("INSERT INTO ".UC_DBTABLEPRE.$this->getposttablename($plid)."(pmid, plid, authorid, message, dateline, delstatus) VALUES('$pmid', '$plid', '$fromuid', '$message', '".$this->base->time."', 0)");
-					$this->db->query("INSERT INTO ".UC_DBTABLEPRE."pm_members(plid, uid, isnew, pmnum, lastupdate, lastdateline) VALUES('$plid', '$key', '1', '1', '0', '".$this->base->time."')");
-					$this->db->query("INSERT INTO ".UC_DBTABLEPRE."pm_members(plid, uid, isnew, pmnum, lastupdate, lastdateline) VALUES('$plid', '$fromuid', '0', '1', '".$this->base->time."', '".$this->base->time."')");
-				} else {
-					$plid = $existplid[$value];
-					$this->db->query("INSERT INTO ".UC_DBTABLEPRE."pm_indexes(plid) VALUES('$plid')");
-					$pmid = $this->db->insert_id();
-					$this->db->query("INSERT INTO ".UC_DBTABLEPRE.$this->getposttablename($plid)."(pmid, plid, authorid, message, dateline, delstatus) VALUES('$pmid', '$plid', '$fromuid', '$message', '".$this->base->time."', 0)");
-					$result = $this->db->query("INSERT INTO ".UC_DBTABLEPRE."pm_members(plid, uid, isnew, pmnum, lastupdate, lastdateline) VALUES('$plid', '$key', '1', '1', '0', '".$this->base->time."')", 'SILENT');
-					if(!$result) {
-						$this->db->query("UPDATE ".UC_DBTABLEPRE."pm_members SET isnew=1, pmnum=pmnum+1, lastdateline='".$this->base->time."' WHERE plid='$plid' AND uid='$key'");
-					}
-					$result = $this->db->query("INSERT INTO ".UC_DBTABLEPRE."pm_members(plid, uid, isnew, pmnum, lastupdate, lastdateline) VALUES('$plid', '$fromuid', '0', '1', '".$this->base->time."', '".$this->base->time."')", 'SILENT');
-					if(!$result) {
-						$this->db->query("UPDATE ".UC_DBTABLEPRE."pm_members SET isnew=0, pmnum=pmnum+1, lastupdate='".$this->base->time."', lastdateline='".$this->base->time."' WHERE plid='$plid' AND uid='$fromuid'");
-					}
-					$this->db->query("UPDATE ".UC_DBTABLEPRE."pm_lists SET lastmessage='$lastmessage' WHERE plid='$plid'");
-				}
-			}
-		} else {
-			$lastmessage = array('firstauthorid' => $fromuid, 'firstauthor' => $fromusername, 'firstsummary' => $lastsummary);
-			$lastmessage = addslashes(serialize($lastmessage));
-			$this->db->query("INSERT INTO ".UC_DBTABLEPRE."pm_lists(authorid, pmtype, subject, members, min_max, dateline, lastmessage) VALUES('$fromuid', '2', '$subject', '".(count($touids)+1)."', '', '".$this->base->time."', '$lastmessage')");
-			$plid = $this->db->insert_id();
-			$this->db->query("INSERT INTO ".UC_DBTABLEPRE."pm_indexes(plid) VALUES('$plid')");
-			$pmid = $this->db->insert_id();
-			$this->db->query("INSERT INTO ".UC_DBTABLEPRE.$this->getposttablename($plid)."(pmid, plid, authorid, message, dateline, delstatus) VALUES('$pmid', '$plid', '$fromuid', '$message', '".$this->base->time."', 0)");
-			$pm_member_insertsql[] = "('$plid', '$fromuid', '0', '1', '".$this->base->time."', '".$this->base->time."')";
-			foreach($touids as $key => $value) {
-				$pm_member_insertsql[] = "('$plid', '$value', '1', '1', '0', '".$this->base->time."')";
-			}
-			$this->db->query("INSERT INTO ".UC_DBTABLEPRE."pm_members(plid, uid, isnew, pmnum, lastupdate, lastdateline) VALUES ".implode(',', $pm_member_insertsql));
-		}
+        if(!$type) {
+            $query = $this->db->query("SELECT plid, min_max FROM ".UC_DBTABLEPRE."pm_lists WHERE min_max IN (".$this->base->implode($relationship).")");
+            while($thread = $this->db->fetch_array($query)) {
+                $existplid[$thread['min_max']] = $thread['plid'];
+            }
+            $lastmessage = array('lastauthorid' => $fromuid, 'lastauthor' => $fromusername, 'lastsummary' => $lastsummary);
+            $lastmessage = addslashes(serialize($lastmessage));
+            foreach($relationship as $key => $value) {
+                if(!isset($existplid[$value])) {
+                    $this->db->query("INSERT INTO ".UC_DBTABLEPRE."pm_lists(authorid, pmtype, subject, members, min_max, dateline, lastmessage) VALUES('$fromuid', '1', '$subject', 2, '$value', '".$this->base->time."', '$lastmessage')");
+                    $plid = $this->db->insert_id();
+                    $this->db->query("INSERT INTO ".UC_DBTABLEPRE."pm_indexes(plid) VALUES('$plid')");
+                    $pmid = $this->db->insert_id();
+                    $this->db->query("INSERT INTO ".UC_DBTABLEPRE.$this->getposttablename($plid)."(pmid, plid, authorid, message, dateline, delstatus) VALUES('$pmid', '$plid', '$fromuid', '$message', '".$this->base->time."', 0)");
+                    $this->db->query("INSERT INTO ".UC_DBTABLEPRE."pm_members(plid, uid, isnew, pmnum, lastupdate, lastdateline) VALUES('$plid', '$key', '1', '1', '0', '".$this->base->time."')");
+                    $this->db->query("INSERT INTO ".UC_DBTABLEPRE."pm_members(plid, uid, isnew, pmnum, lastupdate, lastdateline) VALUES('$plid', '$fromuid', '0', '1', '".$this->base->time."', '".$this->base->time."')");
+                } else {
+                    $plid = $existplid[$value];
+                    $this->db->query("INSERT INTO ".UC_DBTABLEPRE."pm_indexes(plid) VALUES('$plid')");
+                    $pmid = $this->db->insert_id();
+                    $this->db->query("INSERT INTO ".UC_DBTABLEPRE.$this->getposttablename($plid)."(pmid, plid, authorid, message, dateline, delstatus) VALUES('$pmid', '$plid', '$fromuid', '$message', '".$this->base->time."', 0)");
+                    $result = $this->db->query("INSERT INTO ".UC_DBTABLEPRE."pm_members(plid, uid, isnew, pmnum, lastupdate, lastdateline) VALUES('$plid', '$key', '1', '1', '0', '".$this->base->time."')", 'SILENT');
+                    if(!$result) {
+                        $this->db->query("UPDATE ".UC_DBTABLEPRE."pm_members SET isnew=1, pmnum=pmnum+1, lastdateline='".$this->base->time."' WHERE plid='$plid' AND uid='$key'");
+                    }
+                    $result = $this->db->query("INSERT INTO ".UC_DBTABLEPRE."pm_members(plid, uid, isnew, pmnum, lastupdate, lastdateline) VALUES('$plid', '$fromuid', '0', '1', '".$this->base->time."', '".$this->base->time."')", 'SILENT');
+                    if(!$result) {
+                        $this->db->query("UPDATE ".UC_DBTABLEPRE."pm_members SET isnew=0, pmnum=pmnum+1, lastupdate='".$this->base->time."', lastdateline='".$this->base->time."' WHERE plid='$plid' AND uid='$fromuid'");
+                    }
+                    $this->db->query("UPDATE ".UC_DBTABLEPRE."pm_lists SET lastmessage='$lastmessage' WHERE plid='$plid'");
+                }
+            }
+        } else {
+            $lastmessage = array('firstauthorid' => $fromuid, 'firstauthor' => $fromusername, 'firstsummary' => $lastsummary);
+            $lastmessage = addslashes(serialize($lastmessage));
+            $this->db->query("INSERT INTO ".UC_DBTABLEPRE."pm_lists(authorid, pmtype, subject, members, min_max, dateline, lastmessage) VALUES('$fromuid', '2', '$subject', '".(count($touids)+1)."', '', '".$this->base->time."', '$lastmessage')");
+            $plid = $this->db->insert_id();
+            $this->db->query("INSERT INTO ".UC_DBTABLEPRE."pm_indexes(plid) VALUES('$plid')");
+            $pmid = $this->db->insert_id();
+            $this->db->query("INSERT INTO ".UC_DBTABLEPRE.$this->getposttablename($plid)."(pmid, plid, authorid, message, dateline, delstatus) VALUES('$pmid', '$plid', '$fromuid', '$message', '".$this->base->time."', 0)");
+            $pm_member_insertsql[] = "('$plid', '$fromuid', '0', '1', '".$this->base->time."', '".$this->base->time."')";
+            foreach($touids as $key => $value) {
+                $pm_member_insertsql[] = "('$plid', '$value', '1', '1', '0', '".$this->base->time."')";
+            }
+            $this->db->query("INSERT INTO ".UC_DBTABLEPRE."pm_members(plid, uid, isnew, pmnum, lastupdate, lastdateline) VALUES ".implode(',', $pm_member_insertsql));
+        }

-		$newpm = array();
-		foreach($touids as $key => $value) {
-			$newpm[] = "('$value')";
-		}
-		$this->db->query("REPLACE INTO ".UC_DBTABLEPRE."newpm(uid) VALUES ".implode(',', $newpm));
-		return $pmid;
-	}
+        $newpm = array();
+        foreach($touids as $key => $value) {
+            $newpm[] = "('$value')";
+        }
+        $this->db->query("REPLACE INTO ".UC_DBTABLEPRE."newpm(uid) VALUES ".implode(',', $newpm));
+        return $pmid;
+    }

-	function replypm($plid, $fromuid, $fromusername, $message) {
-		if(!$plid || !$fromuid || !$fromusername || !$message) {
-			return 0;
-		}
+    function replypm($plid, $fromuid, $fromusername, $message) {
+        if(!$plid || !$fromuid || !$fromusername || !$message) {
+            return 0;
+        }

-		$threadpm = $this->db->fetch_first("SELECT * FROM ".UC_DBTABLEPRE."pm_lists WHERE plid='$plid'");
-		if(empty($threadpm)) {
-			return PMTHREADNONE_ERROR;
-		}
+        $threadpm = $this->db->fetch_first("SELECT * FROM ".UC_DBTABLEPRE."pm_lists WHERE plid='$plid'");
+        if(empty($threadpm)) {
+            return PMTHREADNONE_ERROR;
+        }

-		if($threadpm['pmtype'] == 1) {
-			$users = explode('_', $threadpm['min_max']);
-			if($users[0] == $fromuid) {
-				$touid = $users[1];
-			} elseif($users[1] == $fromuid) {
-				$touid = $users[0];
-			} else {
-				return PMPRIVILEGENONE_ERROR;
-			}
+        if($threadpm['pmtype'] == 1) {
+            $users = explode('_', $threadpm['min_max']);
+            if($users[0] == $fromuid) {
+                $touid = $users[1];
+            } elseif($users[1] == $fromuid) {
+                $touid = $users[0];
+            } else {
+                return PMPRIVILEGENONE_ERROR;
+            }

-			$blackls = $this->get_blackls($fromuid, $touid);
-			if(in_array('{ALL}', $blackls[$touid])) {
-				return PMINBALCKLIST_ERROR;
-			}
-			$this->base->load('user');
-			$blackls[$touid] = $_ENV['user']->name2id($blackls[$touid]);
-			if(!(isset($blackls[$touid]) && !in_array($fromuid, $blackls[$touid]))) {
-				return PMINBALCKLIST_ERROR;
-			}
-		}
+            $blackls = $this->get_blackls($fromuid, $touid);
+            if(in_array('{ALL}', $blackls[$touid])) {
+                return PMINBALCKLIST_ERROR;
+            }
+            $this->base->load('user');
+            $blackls[$touid] = $_ENV['user']->name2id($blackls[$touid]);
+            if(!(isset($blackls[$touid]) && !in_array($fromuid, $blackls[$touid]))) {
+                return PMINBALCKLIST_ERROR;
+            }
+        }

-		$memberuid = array();
-		$query = $this->db->query("SELECT * FROM ".UC_DBTABLEPRE."pm_members WHERE plid='$plid'");
-		while($member = $this->db->fetch_array($query)) {
-			$memberuid[$member['uid']] = "('$member[uid]')";
-		}
-		if(!isset($memberuid[$fromuid])) {
-			return PMPRIVILEGENONE_ERROR;
-		}
+        $memberuid = array();
+        $query = $this->db->query("SELECT * FROM ".UC_DBTABLEPRE."pm_members WHERE plid='$plid'");
+        while($member = $this->db->fetch_array($query)) {
+            $memberuid[$member['uid']] = "('$member[uid]')";
+        }
+        if(!isset($memberuid[$fromuid])) {
+            return PMPRIVILEGENONE_ERROR;
+        }

-		$_CACHE['badwords'] = $this->base->cache('badwords');
-		if($_CACHE['badwords']['findpattern']) {
-			$message = @preg_replace($_CACHE['badwords']['findpattern'], $_CACHE['badwords']['replace'], $message);
-		}
-		$lastsummary = $this->removecode(trim($message), 150);
+        $_CACHE['badwords'] = $this->base->cache('badwords');
+        if($_CACHE['badwords']['findpattern']) {
+            $message = @preg_replace($_CACHE['badwords']['findpattern'], $_CACHE['badwords']['replace'], $message);
+        }
+        $lastsummary = $this->removecode(trim($message), 150);

-		$this->db->query("INSERT INTO ".UC_DBTABLEPRE."pm_indexes(plid) VALUES('$plid')");
-		$pmid = $this->db->insert_id();
-		$this->db->query("INSERT INTO ".UC_DBTABLEPRE.$this->getposttablename($plid)."(pmid, plid, authorid, message, dateline, delstatus) VALUES('$pmid', '$plid', '$fromuid', '$message', '".$this->base->time."', 0)");
-		if($threadpm['pmtype'] == 1) {
-			$lastmessage = array('lastauthorid' => $fromuid, 'lastauthor' => $fromusername, 'lastsummary' => $lastsummary);
-			$lastmessage = addslashes(serialize($lastmessage));
-			$result = $this->db->query("INSERT INTO ".UC_DBTABLEPRE."pm_members(plid, uid, isnew, pmnum, lastupdate, lastdateline) VALUES('$plid', '$touid', '1', '1', '0', '".$this->base->time."')", 'SILENT');
-			if(!$result) {
-				$this->db->query("UPDATE ".UC_DBTABLEPRE."pm_members SET isnew=1, pmnum=pmnum+1, lastdateline='".$this->base->time."' WHERE plid='$plid' AND uid='$touid'");
-			}
-			$this->db->query("UPDATE ".UC_DBTABLEPRE."pm_members SET isnew=0, pmnum=pmnum+1, lastupdate='".$this->base->time."', lastdateline='".$this->base->time."' WHERE plid='$plid' AND uid='$fromuid'");
-		} else {
-			$lastmessage = unserialize($threadpm['lastmessage']);
-			$lastmessage = array('firstauthorid' => $lastmessage['firstauthorid'], 'firstauthor' => $lastmessage['firstauthor'], 'firstsummary' => $lastmessage['firstsummary'], 'lastauthorid' => $fromuid, 'lastauthor' => $fromusername, 'lastsummary' => $lastsummary);
-			$lastmessage = addslashes(serialize($lastmessage));
-			$this->db->query("UPDATE ".UC_DBTABLEPRE."pm_members SET isnew=1, pmnum=pmnum+1, lastdateline='".$this->base->time."' WHERE plid='$plid'");
-			$this->db->query("UPDATE ".UC_DBTABLEPRE."pm_members SET isnew=0, lastupdate='".$this->base->time."' WHERE plid='$plid' AND uid='$fromuid'");
-		}
-		$this->db->query("UPDATE ".UC_DBTABLEPRE."pm_lists SET lastmessage='$lastmessage' WHERE plid='$plid'");
+        $this->db->query("INSERT INTO ".UC_DBTABLEPRE."pm_indexes(plid) VALUES('$plid')");
+        $pmid = $this->db->insert_id();
+        $this->db->query("INSERT INTO ".UC_DBTABLEPRE.$this->getposttablename($plid)."(pmid, plid, authorid, message, dateline, delstatus) VALUES('$pmid', '$plid', '$fromuid', '$message', '".$this->base->time."', 0)");
+        if($threadpm['pmtype'] == 1) {
+            $lastmessage = array('lastauthorid' => $fromuid, 'lastauthor' => $fromusername, 'lastsummary' => $lastsummary);
+            $lastmessage = addslashes(serialize($lastmessage));
+            $result = $this->db->query("INSERT INTO ".UC_DBTABLEPRE."pm_members(plid, uid, isnew, pmnum, lastupdate, lastdateline) VALUES('$plid', '$touid', '1', '1', '0', '".$this->base->time."')", 'SILENT');
+            if(!$result) {
+                $this->db->query("UPDATE ".UC_DBTABLEPRE."pm_members SET isnew=1, pmnum=pmnum+1, lastdateline='".$this->base->time."' WHERE plid='$plid' AND uid='$touid'");
+            }
+            $this->db->query("UPDATE ".UC_DBTABLEPRE."pm_members SET isnew=0, pmnum=pmnum+1, lastupdate='".$this->base->time."', lastdateline='".$this->base->time."' WHERE plid='$plid' AND uid='$fromuid'");
+        } else {
+            $lastmessage = unserialize($threadpm['lastmessage']);
+            $lastmessage = array('firstauthorid' => $lastmessage['firstauthorid'], 'firstauthor' => $lastmessage['firstauthor'], 'firstsummary' => $lastmessage['firstsummary'], 'lastauthorid' => $fromuid, 'lastauthor' => $fromusername, 'lastsummary' => $lastsummary);
+            $lastmessage = addslashes(serialize($lastmessage));
+            $this->db->query("UPDATE ".UC_DBTABLEPRE."pm_members SET isnew=1, pmnum=pmnum+1, lastdateline='".$this->base->time."' WHERE plid='$plid'");
+            $this->db->query("UPDATE ".UC_DBTABLEPRE."pm_members SET isnew=0, lastupdate='".$this->base->time."' WHERE plid='$plid' AND uid='$fromuid'");
+        }
+        $this->db->query("UPDATE ".UC_DBTABLEPRE."pm_lists SET lastmessage='$lastmessage' WHERE plid='$plid'");

-		$this->db->query("REPLACE INTO ".UC_DBTABLEPRE."newpm(uid) VALUES ".implode(',', $memberuid)."");
+        $this->db->query("REPLACE INTO ".UC_DBTABLEPRE."newpm(uid) VALUES ".implode(',', $memberuid)."");

-		return $pmid;
-	}
+        return $pmid;
+    }

-	function appendchatpm($plid, $uid, $touid) {
-		if(!$plid || !$uid || !$touid) {
-			return 0;
-		}
-		$threadpm = $this->db->fetch_first("SELECT * FROM ".UC_DBTABLEPRE."pm_lists WHERE plid='$plid'");
-		if(empty($threadpm)) {
-			return PMTHREADNONE_ERROR;
-		}
-		if($threadpm['pmtype'] != 2) {
-			return PMCHATTYPE_ERROR;
-		}
-		if($threadpm['authorid'] != $uid) {
-			return PMPRIVILEGENONE_ERROR;
-		}
+    function appendchatpm($plid, $uid, $touid) {
+        if(!$plid || !$uid || !$touid) {
+            return 0;
+        }
+        $threadpm = $this->db->fetch_first("SELECT * FROM ".UC_DBTABLEPRE."pm_lists WHERE plid='$plid'");
+        if(empty($threadpm)) {
+            return PMTHREADNONE_ERROR;
+        }
+        if($threadpm['pmtype'] != 2) {
+            return PMCHATTYPE_ERROR;
+        }
+        if($threadpm['authorid'] != $uid) {
+            return PMPRIVILEGENONE_ERROR;
+        }

-		$blackls = $this->get_blackls($uid, $touid);
-		if(in_array('{ALL}', $blackls[$touid])) {
-			return PMINBALCKLIST_ERROR;
-		}
-		$this->base->load('user');
-		$blackls[$touid] = $_ENV['user']->name2id($blackls[$touid]);
-		if(!(isset($blackls[$touid]) && !in_array($uid, $blackls[$touid]))) {
-			return PMINBALCKLIST_ERROR;
-		}
+        $blackls = $this->get_blackls($uid, $touid);
+        if(in_array('{ALL}', $blackls[$touid])) {
+            return PMINBALCKLIST_ERROR;
+        }
+        $this->base->load('user');
+        $blackls[$touid] = $_ENV['user']->name2id($blackls[$touid]);
+        if(!(isset($blackls[$touid]) && !in_array($uid, $blackls[$touid]))) {
+            return PMINBALCKLIST_ERROR;
+        }

-		$pmnum = $this->db->result_first("SELECT COUNT(*) FROM ".UC_DBTABLEPRE.$this->getposttablename($plid)." WHERE plid='$plid'");
-		$this->db->query("INSERT INTO ".UC_DBTABLEPRE."pm_members(plid, uid, isnew, pmnum, lastupdate, lastdateline) VALUES('$plid', '$touid', '1', '$pmnum', '0', '0')", 'SILENT');
-		$num = $this->db->result_first("SELECT COUNT(*) FROM ".UC_DBTABLEPRE."pm_members WHERE plid='$plid'");
-		$this->db->query("UPDATE ".UC_DBTABLEPRE."pm_lists SET members='$num' WHERE plid='$plid'");
+        $pmnum = $this->db->result_first("SELECT COUNT(*) FROM ".UC_DBTABLEPRE.$this->getposttablename($plid)." WHERE plid='$plid'");
+        $this->db->query("INSERT INTO ".UC_DBTABLEPRE."pm_members(plid, uid, isnew, pmnum, lastupdate, lastdateline) VALUES('$plid', '$touid', '1', '$pmnum', '0', '0')", 'SILENT');
+        $num = $this->db->result_first("SELECT COUNT(*) FROM ".UC_DBTABLEPRE."pm_members WHERE plid='$plid'");
+        $this->db->query("UPDATE ".UC_DBTABLEPRE."pm_lists SET members='$num' WHERE plid='$plid'");

-		return 1;
-	}
+        return 1;
+    }

-	function kickchatpm($plid, $uid, $touid) {
-		if(!$uid || !$touid || !$plid || $uid == $touid) {
-			return 0;
-		}
-		$threadpm = $this->db->fetch_first("SELECT * FROM ".UC_DBTABLEPRE."pm_lists WHERE plid='$plid'");
-		if($threadpm['pmtype'] != 2) {
-			return PMCHATTYPE_ERROR;
-		}
-		if($threadpm['authorid'] != $uid) {
-			return PMPRIVILEGENONE_ERROR;
-		}
-		$this->db->query("DELETE FROM ".UC_DBTABLEPRE."pm_members WHERE plid='$plid' AND uid='$touid'");
-		$num = $this->db->result_first("SELECT COUNT(*) FROM ".UC_DBTABLEPRE."pm_members WHERE plid='$plid'");
-		$this->db->query("UPDATE ".UC_DBTABLEPRE."pm_lists SET members='$num' WHERE plid='$plid'");
-		return 1;
-	}
+    function kickchatpm($plid, $uid, $touid) {
+        if(!$uid || !$touid || !$plid || $uid == $touid) {
+            return 0;
+        }
+        $threadpm = $this->db->fetch_first("SELECT * FROM ".UC_DBTABLEPRE."pm_lists WHERE plid='$plid'");
+        if($threadpm['pmtype'] != 2) {
+            return PMCHATTYPE_ERROR;
+        }
+        if($threadpm['authorid'] != $uid) {
+            return PMPRIVILEGENONE_ERROR;
+        }
+        $this->db->query("DELETE FROM ".UC_DBTABLEPRE."pm_members WHERE plid='$plid' AND uid='$touid'");
+        $num = $this->db->result_first("SELECT COUNT(*) FROM ".UC_DBTABLEPRE."pm_members WHERE plid='$plid'");
+        $this->db->query("UPDATE ".UC_DBTABLEPRE."pm_lists SET members='$num' WHERE plid='$plid'");
+        return 1;
+    }

-	function quitchatpm($uid, $plids) {
-		if(!$uid || !$plids) {
-			return 0;
-		}
-		$list = array();
-		$query = $this->db->query("SELECT * FROM ".UC_DBTABLEPRE."pm_members m LEFT JOIN ".UC_DBTABLEPRE."pm_lists t ON m.plid=t.plid WHERE m.plid IN (".$this->base->implode($plids).") AND m.uid='$uid'");
-		while($threadpm = $this->db->fetch_array($query)) {
-			if($threadpm['pmtype'] != 2) {
-				return PMCHATTYPE_ERROR;
-			}
-			if($threadpm['authorid'] == $uid) {
-				return PMPRIVILEGENONE_ERROR;
-			}
-			$list[] = $threadpm['plid'];
-		}
+    function quitchatpm($uid, $plids) {
+        if(!$uid || !$plids) {
+            return 0;
+        }
+        $list = array();
+        $query = $this->db->query("SELECT * FROM ".UC_DBTABLEPRE."pm_members m LEFT JOIN ".UC_DBTABLEPRE."pm_lists t ON m.plid=t.plid WHERE m.plid IN (".$this->base->implode($plids).") AND m.uid='$uid'");
+        while($threadpm = $this->db->fetch_array($query)) {
+            if($threadpm['pmtype'] != 2) {
+                return PMCHATTYPE_ERROR;
+            }
+            if($threadpm['authorid'] == $uid) {
+                return PMPRIVILEGENONE_ERROR;
+            }
+            $list[] = $threadpm['plid'];
+        }

-		if($list) {
-			$this->db->query("DELETE FROM ".UC_DBTABLEPRE."pm_members WHERE plid IN (".$this->base->implode($list).") AND uid='$uid'");
-			$this->db->query("UPDATE ".UC_DBTABLEPRE."pm_lists SET members=members-1 WHERE plid IN (".$this->base->implode($list).")");
-		}
+        if($list) {
+            $this->db->query("DELETE FROM ".UC_DBTABLEPRE."pm_members WHERE plid IN (".$this->base->implode($list).") AND uid='$uid'");
+            $this->db->query("UPDATE ".UC_DBTABLEPRE."pm_lists SET members=members-1 WHERE plid IN (".$this->base->implode($list).")");
+        }

-		return 1;
-	}
+        return 1;
+    }

-	function deletepmbypmid($uid, $pmid) {
-		if(!$uid || !$pmid) {
-			return 0;
-		}
-		$index = $this->db->fetch_first("SELECT * FROM ".UC_DBTABLEPRE."pm_indexes i LEFT JOIN ".UC_DBTABLEPRE."pm_lists t ON i.plid=t.plid WHERE i.pmid='$pmid'");
-		if($index['pmtype'] != 1) {
-			return PMUIDTYPE_ERROR;
-		}
-		$users = explode('_', $index['min_max']);
-		if(!in_array($uid, $users)) {
-			return PMPRIVILEGENONE_ERROR;
-		}
-		if($index['authorid'] != $uid) {
-			$this->db->query("UPDATE ".UC_DBTABLEPRE.$this->getposttablename($index['plid'])." SET delstatus=2 WHERE pmid='$pmid' AND delstatus=0");
-			$updatenum = $this->db->affected_rows();
-			$this->db->query("DELETE FROM ".UC_DBTABLEPRE.$this->getposttablename($index['plid'])." WHERE pmid='$pmid' AND delstatus=1");
-			$deletenum = $this->db->affected_rows();
-		} else {
-			$this->db->query("UPDATE ".UC_DBTABLEPRE.$this->getposttablename($index['plid'])." SET delstatus=1 WHERE pmid='$pmid' AND delstatus=0");
-			$updatenum = $this->db->affected_rows();
-			$this->db->query("DELETE FROM ".UC_DBTABLEPRE.$this->getposttablename($index['plid'])." WHERE pmid='$pmid' AND delstatus=2");
-			$deletenum = $this->db->affected_rows();
-		}
+    function deletepmbypmid($uid, $pmid) {
+        if(!$uid || !$pmid) {
+            return 0;
+        }
+        $index = $this->db->fetch_first("SELECT * FROM ".UC_DBTABLEPRE."pm_indexes i LEFT JOIN ".UC_DBTABLEPRE."pm_lists t ON i.plid=t.plid WHERE i.pmid='$pmid'");
+        if($index['pmtype'] != 1) {
+            return PMUIDTYPE_ERROR;
+        }
+        $users = explode('_', $index['min_max']);
+        if(!in_array($uid, $users)) {
+            return PMPRIVILEGENONE_ERROR;
+        }
+        if($index['authorid'] != $uid) {
+            $this->db->query("UPDATE ".UC_DBTABLEPRE.$this->getposttablename($index['plid'])." SET delstatus=2 WHERE pmid='$pmid' AND delstatus=0");
+            $updatenum = $this->db->affected_rows();
+            $this->db->query("DELETE FROM ".UC_DBTABLEPRE.$this->getposttablename($index['plid'])." WHERE pmid='$pmid' AND delstatus=1");
+            $deletenum = $this->db->affected_rows();
+        } else {
+            $this->db->query("UPDATE ".UC_DBTABLEPRE.$this->getposttablename($index['plid'])." SET delstatus=1 WHERE pmid='$pmid' AND delstatus=0");
+            $updatenum = $this->db->affected_rows();
+            $this->db->query("DELETE FROM ".UC_DBTABLEPRE.$this->getposttablename($index['plid'])." WHERE pmid='$pmid' AND delstatus=2");
+            $deletenum = $this->db->affected_rows();
+        }

-		if(!$this->db->result_first("SELECT COUNT(*) FROM ".UC_DBTABLEPRE.$this->getposttablename($index['plid'])." WHERE plid='$index[plid]'")) {
-			$this->db->query("DELETE FROM ".UC_DBTABLEPRE."pm_lists WHERE plid='$index[plid]'");
-			$this->db->query("DELETE FROM ".UC_DBTABLEPRE."pm_members WHERE plid='$index[plid]'");
-			$this->db->query("DELETE FROM ".UC_DBTABLEPRE."pm_indexes WHERE plid='$index[plid]'");
-		} else {
-			$this->db->query("UPDATE ".UC_DBTABLEPRE."pm_members SET pmnum=pmnum-".($updatenum + $deletenum)." WHERE plid='".$index['plid']."' AND uid='$uid'");
-		}
-		return 1;
-	}
+        if(!$this->db->result_first("SELECT COUNT(*) FROM ".UC_DBTABLEPRE.$this->getposttablename($index['plid'])." WHERE plid='$index[plid]'")) {
+            $this->db->query("DELETE FROM ".UC_DBTABLEPRE."pm_lists WHERE plid='$index[plid]'");
+            $this->db->query("DELETE FROM ".UC_DBTABLEPRE."pm_members WHERE plid='$index[plid]'");
+            $this->db->query("DELETE FROM ".UC_DBTABLEPRE."pm_indexes WHERE plid='$index[plid]'");
+        } else {
+            $this->db->query("UPDATE ".UC_DBTABLEPRE."pm_members SET pmnum=pmnum-".($updatenum + $deletenum)." WHERE plid='".$index['plid']."' AND uid='$uid'");
+        }
+        return 1;
+    }

-	function deletepmbypmids($uid, $pmids) {
-		if($pmids) {
-			foreach($pmids as $key => $pmid) {
-				$this->deletepmbypmid($uid, $pmid);
-			}
-		}
-		return 1;
-	}
+    function deletepmbypmids($uid, $pmids) {
+        if($pmids) {
+            foreach($pmids as $key => $pmid) {
+                $this->deletepmbypmid($uid, $pmid);
+            }
+        }
+        return 1;
+    }

 /*
-	function deletepmbypmids($uid, $pmids) {
-		if(!$uid || !$pmids) {
-			return 0;
-		}
-		$pmplid = $delstatus1pm = $delstatus2pm = $pmplidpost = array();
-		$existplid = array();
-		$query = $this->db->query("SELECT * FROM ".UC_DBTABLEPRE."pm_indexes i LEFT JOIN ".UC_DBTABLEPRE."pm_lists t ON i.plid=t.plid WHERE i.pmid IN (".$this->base->implode($pmids).") AND t.pmtype=1");
-		while($index = $this->db->fetch_array($query)) {
-			$users = explode('_', $index['min_max']);
-			if(!in_array($uid, $users)) {
-				return PMPRIVILEGENONE_ERROR;
-			}
-			if($index['authorid'] == $uid) {
-				$delstatus1pm[$this->getposttablename($index['plid'])][] = $index['pmid'];
-			} else {
-				$delstatus2pm[$this->getposttablename($index['plid'])][] = $index['pmid'];
-			}
-			$pmplidpost[$this->getposttablename($index['plid'])][] = $index['plid'];
-			$pmplid[$index['plid']] = $index['plid'];
-		}
-		if(empty($pmplidpost)) {
-			return 0;
-		}
+    function deletepmbypmids($uid, $pmids) {
+        if(!$uid || !$pmids) {
+            return 0;
+        }
+        $pmplid = $delstatus1pm = $delstatus2pm = $pmplidpost = array();
+        $existplid = array();
+        $query = $this->db->query("SELECT * FROM ".UC_DBTABLEPRE."pm_indexes i LEFT JOIN ".UC_DBTABLEPRE."pm_lists t ON i.plid=t.plid WHERE i.pmid IN (".$this->base->implode($pmids).") AND t.pmtype=1");
+        while($index = $this->db->fetch_array($query)) {
+            $users = explode('_', $index['min_max']);
+            if(!in_array($uid, $users)) {
+                return PMPRIVILEGENONE_ERROR;
+            }
+            if($index['authorid'] == $uid) {
+                $delstatus1pm[$this->getposttablename($index['plid'])][] = $index['pmid'];
+            } else {
+                $delstatus2pm[$this->getposttablename($index['plid'])][] = $index['pmid'];
+            }
+            $pmplidpost[$this->getposttablename($index['plid'])][] = $index['plid'];
+            $pmplid[$index['plid']] = $index['plid'];
+        }
+        if(empty($pmplidpost)) {
+            return 0;
+        }

-		if($delstatus1pm) {
-			foreach($delstatus1pm as $key => $value) {
-				$this->db->query("UPDATE ".UC_DBTABLEPRE."$key SET delstatus=1 WHERE pmid IN (".$this->base->implode($value).") AND delstatus=0");
-				$this->db->query("DELETE FROM ".UC_DBTABLEPRE."$key WHERE pmid IN (".$this->base->implode($value).") AND delstatus=2");
-			}
-		}
+        if($delstatus1pm) {
+            foreach($delstatus1pm as $key => $value) {
+                $this->db->query("UPDATE ".UC_DBTABLEPRE."$key SET delstatus=1 WHERE pmid IN (".$this->base->implode($value).") AND delstatus=0");
+                $this->db->query("DELETE FROM ".UC_DBTABLEPRE."$key WHERE pmid IN (".$this->base->implode($value).") AND delstatus=2");
+            }
+        }

-		if($delstatus2pm) {
-			foreach($delstatus2pm as $key => $value) {
-				$this->db->query("UPDATE ".UC_DBTABLEPRE."$key SET delstatus=2 WHERE pmid IN (".$this->base->implode($value).") AND delstatus=0");
-				$this->db->query("DELETE FROM ".UC_DBTABLEPRE."$key WHERE pmid IN (".$this->base->implode($value).") AND delstatus=1");
-			}
-		}
+        if($delstatus2pm) {
+            foreach($delstatus2pm as $key => $value) {
+                $this->db->query("UPDATE ".UC_DBTABLEPRE."$key SET delstatus=2 WHERE pmid IN (".$this->base->implode($value).") AND delstatus=0");
+                $this->db->query("DELETE FROM ".UC_DBTABLEPRE."$key WHERE pmid IN (".$this->base->implode($value).") AND delstatus=1");
+            }
+        }

-		foreach($pmplidpost as $key => $value) {
-			$query = $this->db->query("SELECT DISTINCT plid FROM ".UC_DBTABLEPRE."$key WHERE plid IN (".$this->base->implode($value).")");
-			while($pmpostarr = $this->db->fetch_array($query)) {
-				$existplid[] = $pmpostarr['plid'];
-			}
-		}
-		$pmplid = array_diff($pmplid, $existplid);
-		if($pmplid) {
-			$this->db->query("DELETE FROM ".UC_DBTABLEPRE."pm_lists WHERE plid IN (".$this->base->implode($pmplid).")");
-			$this->db->query("DELETE FROM ".UC_DBTABLEPRE."pm_members WHERE plid IN (".$this->base->implode($pmplid).")");
-			$this->db->query("DELETE FROM ".UC_DBTABLEPRE."pm_indexes WHERE plid IN (".$this->base->implode($pmplid).")");
-		}
-		return 1;
-	}
+        foreach($pmplidpost as $key => $value) {
+            $query = $this->db->query("SELECT DISTINCT plid FROM ".UC_DBTABLEPRE."$key WHERE plid IN (".$this->base->implode($value).")");
+            while($pmpostarr = $this->db->fetch_array($query)) {
+                $existplid[] = $pmpostarr['plid'];
+            }
+        }
+        $pmplid = array_diff($pmplid, $existplid);
+        if($pmplid) {
+            $this->db->query("DELETE FROM ".UC_DBTABLEPRE."pm_lists WHERE plid IN (".$this->base->implode($pmplid).")");
+            $this->db->query("DELETE FROM ".UC_DBTABLEPRE."pm_members WHERE plid IN (".$this->base->implode($pmplid).")");
+            $this->db->query("DELETE FROM ".UC_DBTABLEPRE."pm_indexes WHERE plid IN (".$this->base->implode($pmplid).")");
+        }
+        return 1;
+    }
 */

-	function deletepmbyplid($uid, $plid, $isuser = 0) {
-		if(!$uid || !$plid) {
-			return 0;
-		}
+    function deletepmbyplid($uid, $plid, $isuser = 0) {
+        if(!$uid || !$plid) {
+            return 0;
+        }

-		if($isuser) {
-			$relationship = $this->relationship($uid, $plid);
-			$sql = "SELECT * FROM ".UC_DBTABLEPRE."pm_lists WHERE min_max='$relationship'";
-		} else {
-			$sql = "SELECT * FROM ".UC_DBTABLEPRE."pm_lists WHERE plid='$plid'";
-		}
+        if($isuser) {
+            $relationship = $this->relationship($uid, $plid);
+            $sql = "SELECT * FROM ".UC_DBTABLEPRE."pm_lists WHERE min_max='$relationship'";
+        } else {
+            $sql = "SELECT * FROM ".UC_DBTABLEPRE."pm_lists WHERE plid='$plid'";
+        }

-		$query = $this->db->query($sql);
-		if($list = $this->db->fetch_array($query)) {
-			if($list['pmtype'] == 1) {
-				$user = explode('_', $list['min_max']);
-				if(!in_array($uid, $user)) {
-					return PMPRIVILEGENONE_ERROR;
-				}
-			} else {
-				if($uid != $list['authorid']) {
-					return PMPRIVILEGENONE_ERROR;
-				}
-			}
-		} else {
-			return PMTHREADNONE_ERROR;
-		}
+        $query = $this->db->query($sql);
+        if($list = $this->db->fetch_array($query)) {
+            if($list['pmtype'] == 1) {
+                $user = explode('_', $list['min_max']);
+                if(!in_array($uid, $user)) {
+                    return PMPRIVILEGENONE_ERROR;
+                }
+            } else {
+                if($uid != $list['authorid']) {
+                    return PMPRIVILEGENONE_ERROR;
+                }
+            }
+        } else {
+            return PMTHREADNONE_ERROR;
+        }

-		if($list['pmtype'] == 1) {
-			if($uid == $list['authorid']) {
-				$this->db->query("DELETE FROM ".UC_DBTABLEPRE.$this->getposttablename($list['plid'])." WHERE plid='$list[plid]' AND delstatus=2");
-				$this->db->query("UPDATE ".UC_DBTABLEPRE.$this->getposttablename($list['plid'])." SET delstatus=1 WHERE plid='$list[plid]' AND delstatus=0");
-			} else {
-				$this->db->query("DELETE FROM ".UC_DBTABLEPRE.$this->getposttablename($list['plid'])." WHERE plid='$list[plid]' AND delstatus=1");
-				$this->db->query("UPDATE ".UC_DBTABLEPRE.$this->getposttablename($list['plid'])." SET delstatus=2 WHERE plid='$list[plid]' AND delstatus=0");
-			}
-			$count = $this->db->result_first("SELECT COUNT(*) FROM ".UC_DBTABLEPRE.$this->getposttablename($list['plid'])." WHERE plid='$list[plid]'");
-			if(!$count) {
-				$this->db->query("DELETE FROM ".UC_DBTABLEPRE."pm_lists WHERE plid='$list[plid]'");
-				$this->db->query("DELETE FROM ".UC_DBTABLEPRE."pm_members WHERE plid='$list[plid]'");
-				$this->db->query("DELETE FROM ".UC_DBTABLEPRE."pm_indexes WHERE plid='$list[plid]'");
-			} else {
-				$this->db->query("DELETE FROM ".UC_DBTABLEPRE."pm_members WHERE plid='$list[plid]' AND uid='$uid'");
-			}
-		} else {
-			$this->db->query("DELETE FROM ".UC_DBTABLEPRE.$this->getposttablename($list['plid'])." WHERE plid='$list[plid]'");
-			$this->db->query("DELETE FROM ".UC_DBTABLEPRE."pm_lists WHERE plid='$list[plid]'");
-			$this->db->query("DELETE FROM ".UC_DBTABLEPRE."pm_members WHERE plid='$list[plid]'");
-			$this->db->query("DELETE FROM ".UC_DBTABLEPRE."pm_indexes WHERE plid='$list[plid]'");
-		}
-		return 1;
-	}
+        if($list['pmtype'] == 1) {
+            if($uid == $list['authorid']) {
+                $this->db->query("DELETE FROM ".UC_DBTABLEPRE.$this->getposttablename($list['plid'])." WHERE plid='$list[plid]' AND delstatus=2");
+                $this->db->query("UPDATE ".UC_DBTABLEPRE.$this->getposttablename($list['plid'])." SET delstatus=1 WHERE plid='$list[plid]' AND delstatus=0");
+            } else {
+                $this->db->query("DELETE FROM ".UC_DBTABLEPRE.$this->getposttablename($list['plid'])." WHERE plid='$list[plid]' AND delstatus=1");
+                $this->db->query("UPDATE ".UC_DBTABLEPRE.$this->getposttablename($list['plid'])." SET delstatus=2 WHERE plid='$list[plid]' AND delstatus=0");
+            }
+            $count = $this->db->result_first("SELECT COUNT(*) FROM ".UC_DBTABLEPRE.$this->getposttablename($list['plid'])." WHERE plid='$list[plid]'");
+            if(!$count) {
+                $this->db->query("DELETE FROM ".UC_DBTABLEPRE."pm_lists WHERE plid='$list[plid]'");
+                $this->db->query("DELETE FROM ".UC_DBTABLEPRE."pm_members WHERE plid='$list[plid]'");
+                $this->db->query("DELETE FROM ".UC_DBTABLEPRE."pm_indexes WHERE plid='$list[plid]'");
+            } else {
+                $this->db->query("DELETE FROM ".UC_DBTABLEPRE."pm_members WHERE plid='$list[plid]' AND uid='$uid'");
+            }
+        } else {
+            $this->db->query("DELETE FROM ".UC_DBTABLEPRE.$this->getposttablename($list['plid'])." WHERE plid='$list[plid]'");
+            $this->db->query("DELETE FROM ".UC_DBTABLEPRE."pm_lists WHERE plid='$list[plid]'");
+            $this->db->query("DELETE FROM ".UC_DBTABLEPRE."pm_members WHERE plid='$list[plid]'");
+            $this->db->query("DELETE FROM ".UC_DBTABLEPRE."pm_indexes WHERE plid='$list[plid]'");
+        }
+        return 1;
+    }

-	function deletepmbyplids($uid, $plids, $isuser = 0) {
-		if($plids) {
-			foreach($plids as $key => $plid) {
-				$this->deletepmbyplid($uid, $plid, $isuser);
-			}
-		}
-		return 1;
-	}
+    function deletepmbyplids($uid, $plids, $isuser = 0) {
+        if($plids) {
+            foreach($plids as $key => $plid) {
+                $this->deletepmbyplid($uid, $plid, $isuser);
+            }
+        }
+        return 1;
+    }

 /*
-	function deletepmbyplid($uid, $plids, $isuser = 0) {
-		if(!$uid || !$plids) {
-			return 0;
-		}
+    function deletepmbyplid($uid, $plids, $isuser = 0) {
+        if(!$uid || !$plids) {
+            return 0;
+        }

-		$privatepm = $chatpm = array();
-		$privatepmauthorpost = $privatepmpost = $privatepmpostall = array();
-		$existplid = array();
-		if($isuser) {
-			$relationship = array();
-			foreach($plids as $key => $value) {
-				if($uid == $value || !$value) {
-					return PMDATA_ERROR;
-				}
-				$relationship[] = $this->relationship($uid, $value);
-			}
-			$sql = "SELECT * FROM ".UC_DBTABLEPRE."pm_lists WHERE min_max IN (".$this->base->implode($relationship).")";
-		} else {
-			$sql = "SELECT * FROM ".UC_DBTABLEPRE."pm_lists WHERE plid IN (".$this->base->implode($plids).")";
-		}
-		$query = $this->db->query($sql);
-		while($threadpm = $this->db->fetch_array($query)) {
-			if($threadpm['pmtype'] == 1) {
-				$users = explode('_', $threadpm['min_max']);
-				if($users[0] == $uid) {
-					$touid = $users[1];
-				} elseif($users[1] == $uid) {
-					$touid = $users[0];
-				} else {
-					continue;
-				}
+        $privatepm = $chatpm = array();
+        $privatepmauthorpost = $privatepmpost = $privatepmpostall = array();
+        $existplid = array();
+        if($isuser) {
+            $relationship = array();
+            foreach($plids as $key => $value) {
+                if($uid == $value || !$value) {
+                    return PMDATA_ERROR;
+                }
+                $relationship[] = $this->relationship($uid, $value);
+            }
+            $sql = "SELECT * FROM ".UC_DBTABLEPRE."pm_lists WHERE min_max IN (".$this->base->implode($relationship).")";
+        } else {
+            $sql = "SELECT * FROM ".UC_DBTABLEPRE."pm_lists WHERE plid IN (".$this->base->implode($plids).")";
+        }
+        $query = $this->db->query($sql);
+        while($threadpm = $this->db->fetch_array($query)) {
+            if($threadpm['pmtype'] == 1) {
+                $users = explode('_', $threadpm['min_max']);
+                if($users[0] == $uid) {
+                    $touid = $users[1];
+                } elseif($users[1] == $uid) {
+                    $touid = $users[0];
+                } else {
+                    continue;
+                }

-				if($threadpm['authorid'] == $uid) {
-					$privatepmauthorpost[$this->getposttablename($threadpm['plid'])][] = $threadpm['plid'];
-				} else {
-					$privatepmpost[$this->getposttablename($threadpm['plid'])][] = $threadpm['plid'];
-				}
-				$privatepmpostall[$this->getposttablename($threadpm['plid'])][] = $threadpm['plid'];
-				$privatepm[] = $threadpm['plid'];
-			} else {
-				if($uid != $threadpm['authorid']) {
-					continue;
-				}
-				$chatpm[] = $threadpm['plid'];
-				$chatpmpost[$this->getposttablename($threadpm['plid'])][] = $threadpm['plid'];
-			}
-		}
+                if($threadpm['authorid'] == $uid) {
+                    $privatepmauthorpost[$this->getposttablename($threadpm['plid'])][] = $threadpm['plid'];
+                } else {
+                    $privatepmpost[$this->getposttablename($threadpm['plid'])][] = $threadpm['plid'];
+                }
+                $privatepmpostall[$this->getposttablename($threadpm['plid'])][] = $threadpm['plid'];
+                $privatepm[] = $threadpm['plid'];
+            } else {
+                if($uid != $threadpm['authorid']) {
+                    continue;
+                }
+                $chatpm[] = $threadpm['plid'];
+                $chatpmpost[$this->getposttablename($threadpm['plid'])][] = $threadpm['plid'];
+            }
+        }

-		if($privatepmauthorpost) {
-			foreach($privatepmauthorpost as $key => $value) {
-				$this->db->query("UPDATE ".UC_DBTABLEPRE."$key SET delstatus=1 WHERE plid IN (".$this->base->implode($value).") AND delstatus=0");
-				$this->db->query("DELETE FROM ".UC_DBTABLEPRE."$key WHERE plid IN (".$this->base->implode($value).") AND delstatus=2");
-			}
-		}
+        if($privatepmauthorpost) {
+            foreach($privatepmauthorpost as $key => $value) {
+                $this->db->query("UPDATE ".UC_DBTABLEPRE."$key SET delstatus=1 WHERE plid IN (".$this->base->implode($value).") AND delstatus=0");
+                $this->db->query("DELETE FROM ".UC_DBTABLEPRE."$key WHERE plid IN (".$this->base->implode($value).") AND delstatus=2");
+            }
+        }

-		if($privatepmpost) {
-			foreach($privatepmpost as $key => $value) {
-				$this->db->query("UPDATE ".UC_DBTABLEPRE."$key SET delstatus=2 WHERE plid IN (".$this->base->implode($value).") AND delstatus=0");
-				$this->db->query("DELETE FROM ".UC_DBTABLEPRE."$key WHERE plid IN (".$this->base->implode($value).") AND delstatus=1");
-			}
-		}
-		if($privatepmpostall) {
-			foreach($privatepmpostall as $key => $value) {
-				$query = $this->db->query("SELECT DISTINCT plid FROM ".UC_DBTABLEPRE."$key WHERE plid IN (".$this->base->implode($value).")");
-				while($postpm = $this->db->fetch_array($query)) {
-					$existplid[] = $postpm['plid'];
-				}
-			}
-			$this->db->query("DELETE FROM ".UC_DBTABLEPRE."pm_members WHERE plid IN (".$this->base->implode($privatepm).") AND uid='$uid'");
-			$privatepm = array_diff($privatepm, $existplid);
-			if(!empty($privatepm)) {
-				$this->db->query("DELETE FROM ".UC_DBTABLEPRE."pm_lists WHERE plid IN (".$this->base->implode($privatepm).")");
-				$this->db->query("DELETE FROM ".UC_DBTABLEPRE."pm_members WHERE plid IN (".$this->base->implode($privatepm).")");
-				$this->db->query("DELETE FROM ".UC_DBTABLEPRE."pm_indexes WHERE plid IN (".$this->base->implode($privatepm).")");
-			}
-		}
-		if($chatpmpost) {
-			foreach($chatpmpost as $key => $value) {
-				$this->db->query("DELETE FROM ".UC_DBTABLEPRE."$key WHERE plid IN (".$this->base->implode($value).")");
-			}
-			$this->db->query("DELETE FROM ".UC_DBTABLEPRE."pm_lists WHERE plid IN (".$this->base->implode($chatpm).")");
-			$this->db->query("DELETE FROM ".UC_DBTABLEPRE."pm_members WHERE plid IN (".$this->base->implode($chatpm).")");
-			$this->db->query("DELETE FROM ".UC_DBTABLEPRE."pm_indexes WHERE plid IN (".$this->base->implode($chatpm).")");
-		}
-		return 1;
-	}
+        if($privatepmpost) {
+            foreach($privatepmpost as $key => $value) {
+                $this->db->query("UPDATE ".UC_DBTABLEPRE."$key SET delstatus=2 WHERE plid IN (".$this->base->implode($value).") AND delstatus=0");
+                $this->db->query("DELETE FROM ".UC_DBTABLEPRE."$key WHERE plid IN (".$this->base->implode($value).") AND delstatus=1");
+            }
+        }
+        if($privatepmpostall) {
+            foreach($privatepmpostall as $key => $value) {
+                $query = $this->db->query("SELECT DISTINCT plid FROM ".UC_DBTABLEPRE."$key WHERE plid IN (".$this->base->implode($value).")");
+                while($postpm = $this->db->fetch_array($query)) {
+                    $existplid[] = $postpm['plid'];
+                }
+            }
+            $this->db->query("DELETE FROM ".UC_DBTABLEPRE."pm_members WHERE plid IN (".$this->base->implode($privatepm).") AND uid='$uid'");
+            $privatepm = array_diff($privatepm, $existplid);
+            if(!empty($privatepm)) {
+                $this->db->query("DELETE FROM ".UC_DBTABLEPRE."pm_lists WHERE plid IN (".$this->base->implode($privatepm).")");
+                $this->db->query("DELETE FROM ".UC_DBTABLEPRE."pm_members WHERE plid IN (".$this->base->implode($privatepm).")");
+                $this->db->query("DELETE FROM ".UC_DBTABLEPRE."pm_indexes WHERE plid IN (".$this->base->implode($privatepm).")");
+            }
+        }
+        if($chatpmpost) {
+            foreach($chatpmpost as $key => $value) {
+                $this->db->query("DELETE FROM ".UC_DBTABLEPRE."$key WHERE plid IN (".$this->base->implode($value).")");
+            }
+            $this->db->query("DELETE FROM ".UC_DBTABLEPRE."pm_lists WHERE plid IN (".$this->base->implode($chatpm).")");
+            $this->db->query("DELETE FROM ".UC_DBTABLEPRE."pm_members WHERE plid IN (".$this->base->implode($chatpm).")");
+            $this->db->query("DELETE FROM ".UC_DBTABLEPRE."pm_indexes WHERE plid IN (".$this->base->implode($chatpm).")");
+        }
+        return 1;
+    }
 */

-	function getprivatepmbyplid($uid, $plid, $starttime = 0, $endtime = 0, $start = 0, $ppp = 0) {
-		if(!$uid || !$plid) {
-			return 0;
-		}
-		if(!$this->isprivilege($plid, $uid)) {
-			return 0;
-		}
-		$thread = $this->db->fetch_first("SELECT * FROM ".UC_DBTABLEPRE."pm_lists WHERE plid='$plid'");
-		if($thread['pmtype'] != 1) {
-			return 0;
-		}
-		$pms = $addsql = array();
-		$addsql[] = "p.plid='$plid'";
-		if($thread['authorid'] == $uid) {
-			$addsql[] = 'p.delstatus IN (0,2)';
-		} else {
-			$addsql[] = 'p.delstatus IN (0,1)';
-		}
-		if($starttime) {
-			$addsql[]= "p.dateline>'$starttime'";
-		}
-		if($endtime) {
-			$addsql[] = "p.dateline<'$endtime'";
-		}
-		if($addsql) {
-			$addsql = implode(' AND ', $addsql);
-		} else {
-			$addsql = '';
-		}
-		if($ppp) {
-			$limitsql = 'LIMIT '.intval($start).', '.intval($ppp);
-		} else {
-			$limitsql = '';
-		}
-		$pms = $this->db->fetch_all("SELECT t.*, p.*, t.authorid as founderuid, t.dateline as founddateline FROM ".UC_DBTABLEPRE.$this->getposttablename($plid)." p LEFT JOIN ".UC_DBTABLEPRE."pm_lists t ON p.plid=t.plid WHERE $addsql ORDER BY p.dateline DESC $limitsql");
-		$this->db->query("UPDATE ".UC_DBTABLEPRE."pm_members SET isnew=0 WHERE plid='$plid' AND uid='$uid' AND isnew=1");
-		return array_reverse($pms);
-	}
+    function getprivatepmbyplid($uid, $plid, $starttime = 0, $endtime = 0, $start = 0, $ppp = 0) {
+        if(!$uid || !$plid) {
+            return 0;
+        }
+        if(!$this->isprivilege($plid, $uid)) {
+            return 0;
+        }
+        $thread = $this->db->fetch_first("SELECT * FROM ".UC_DBTABLEPRE."pm_lists WHERE plid='$plid'");
+        if($thread['pmtype'] != 1) {
+            return 0;
+        }
+        $pms = $addsql = array();
+        $addsql[] = "p.plid='$plid'";
+        if($thread['authorid'] == $uid) {
+            $addsql[] = 'p.delstatus IN (0,2)';
+        } else {
+            $addsql[] = 'p.delstatus IN (0,1)';
+        }
+        if($starttime) {
+            $addsql[]= "p.dateline>'$starttime'";
+        }
+        if($endtime) {
+            $addsql[] = "p.dateline<'$endtime'";
+        }
+        if($addsql) {
+            $addsql = implode(' AND ', $addsql);
+        } else {
+            $addsql = '';
+        }
+        if($ppp) {
+            $limitsql = 'LIMIT '.intval($start).', '.intval($ppp);
+        } else {
+            $limitsql = '';
+        }
+        $pms = $this->db->fetch_all("SELECT t.*, p.*, t.authorid as founderuid, t.dateline as founddateline FROM ".UC_DBTABLEPRE.$this->getposttablename($plid)." p LEFT JOIN ".UC_DBTABLEPRE."pm_lists t ON p.plid=t.plid WHERE $addsql ORDER BY p.dateline DESC $limitsql");
+        $this->db->query("UPDATE ".UC_DBTABLEPRE."pm_members SET isnew=0 WHERE plid='$plid' AND uid='$uid' AND isnew=1");
+        return array_reverse($pms);
+    }

-	function getchatpmbyplid($uid, $plid, $starttime = 0, $endtime = 0, $start = 0, $ppp = 0) {
-		if(!$uid || !$plid) {
-			return 0;
-		}
-		if(!$this->isprivilege($plid, $uid)) {
-			return 0;
-		}
-		$pms = $addsql = array();
-		$addsql[] = "p.plid='$plid'";
-		if($starttime) {
-			$addsql[]= "p.dateline>'$starttime'";
-		}
-		if($endtime) {
-			$addsql[] = "p.dateline<'$endtime'";
-		}
-		if($addsql) {
-			$addsql = implode(' AND ', $addsql);
-		} else {
-			$addsql = '';
-		}
-		if($ppp) {
-			$limitsql = 'LIMIT '.intval($start).', '.intval($ppp);
-		} else {
-			$limitsql = '';
-		}
-		$query = $this->db->query("SELECT t.*, p.*, t.authorid as founderuid, t.dateline as founddateline FROM ".UC_DBTABLEPRE.$this->getposttablename($plid)." p LEFT JOIN ".UC_DBTABLEPRE."pm_lists t ON p.plid=t.plid WHERE $addsql ORDER BY p.dateline DESC $limitsql");
-		while($pm = $this->db->fetch_array($query)) {
-			if($pm['pmtype'] != 2) {
-				return 0;
-			}
-			$pms[] = $pm;
-		}
-		$this->db->query("UPDATE ".UC_DBTABLEPRE."pm_members SET isnew=0 WHERE plid='$plid' AND uid='$uid' AND isnew=1");
-		return array_reverse($pms);
-	}
+    function getchatpmbyplid($uid, $plid, $starttime = 0, $endtime = 0, $start = 0, $ppp = 0) {
+        if(!$uid || !$plid) {
+            return 0;
+        }
+        if(!$this->isprivilege($plid, $uid)) {
+            return 0;
+        }
+        $pms = $addsql = array();
+        $addsql[] = "p.plid='$plid'";
+        if($starttime) {
+            $addsql[]= "p.dateline>'$starttime'";
+        }
+        if($endtime) {
+            $addsql[] = "p.dateline<'$endtime'";
+        }
+        if($addsql) {
+            $addsql = implode(' AND ', $addsql);
+        } else {
+            $addsql = '';
+        }
+        if($ppp) {
+            $limitsql = 'LIMIT '.intval($start).', '.intval($ppp);
+        } else {
+            $limitsql = '';
+        }
+        $query = $this->db->query("SELECT t.*, p.*, t.authorid as founderuid, t.dateline as founddateline FROM ".UC_DBTABLEPRE.$this->getposttablename($plid)." p LEFT JOIN ".UC_DBTABLEPRE."pm_lists t ON p.plid=t.plid WHERE $addsql ORDER BY p.dateline DESC $limitsql");
+        while($pm = $this->db->fetch_array($query)) {
+            if($pm['pmtype'] != 2) {
+                return 0;
+            }
+            $pms[] = $pm;
+        }
+        $this->db->query("UPDATE ".UC_DBTABLEPRE."pm_members SET isnew=0 WHERE plid='$plid' AND uid='$uid' AND isnew=1");
+        return array_reverse($pms);
+    }

-	function getpmlist($uid, $filter, $start, $ppp = 10) {
-		if(!$uid) {
-			return 0;
-		}
-		$members = $touidarr = $tousernamearr = array();
+    function getpmlist($uid, $filter, $start, $ppp = 10) {
+        if(!$uid) {
+            return 0;
+        }
+        $members = $touidarr = $tousernamearr = array();

-		if($filter == 'newpm') {
-			$addsql = 'm.isnew=1 AND ';
-		/*Ӱ
-		} elseif($filter == 'privatepm') {
-			$addsql = 't.pmtype=1 AND ';
-		} elseif($filter == 'chatpm') {
-			$addsql = 't.pmtype=2 AND ';
-		*/
-		} else {
-			$addsql = '';
-		}
-		$query = $this->db->query("SELECT * FROM ".UC_DBTABLEPRE."pm_members m LEFT JOIN ".UC_DBTABLEPRE."pm_lists t ON t.plid=m.plid WHERE $addsql m.uid='$uid' ORDER BY m.lastdateline DESC LIMIT $start, $ppp");
-		while($member = $this->db->fetch_array($query)) {
-			if($member['pmtype'] == 1) {
-				$users = explode('_', $member['min_max']);
-				$member['touid'] = $users[0] == $uid ? $users[1] : $users[0];
-			} else {
-				$member['touid'] = 0;
-			}
-			$touidarr[$member['touid']] = $member['touid'];
-			$members[] = $member;
-		}
+        if($filter == 'newpm') {
+            $addsql = 'm.isnew=1 AND ';
+        /*Ӱ
+        } elseif($filter == 'privatepm') {
+            $addsql = 't.pmtype=1 AND ';
+        } elseif($filter == 'chatpm') {
+            $addsql = 't.pmtype=2 AND ';
+        */
+        } else {
+            $addsql = '';
+        }
+        $query = $this->db->query("SELECT * FROM ".UC_DBTABLEPRE."pm_members m LEFT JOIN ".UC_DBTABLEPRE."pm_lists t ON t.plid=m.plid WHERE $addsql m.uid='$uid' ORDER BY m.lastdateline DESC LIMIT $start, $ppp");
+        while($member = $this->db->fetch_array($query)) {
+            if($member['pmtype'] == 1) {
+                $users = explode('_', $member['min_max']);
+                $member['touid'] = $users[0] == $uid ? $users[1] : $users[0];
+            } else {
+                $member['touid'] = 0;
+            }
+            $touidarr[$member['touid']] = $member['touid'];
+            $members[] = $member;
+        }

-		$this->db->query("DELETE FROM ".UC_DBTABLEPRE."newpm WHERE uid='$uid'");
+        $this->db->query("DELETE FROM ".UC_DBTABLEPRE."newpm WHERE uid='$uid'");

-		$array = array();
-		if($members) {
-			$today = $this->base->time - $this->base->time % 86400;
-			$this->base->load('user');
-			$tousernamearr = $_ENV['user']->id2name($touidarr);
-			foreach($members as $key => $data) {
+        $array = array();
+        if($members) {
+            $today = $this->base->time - $this->base->time % 86400;
+            $this->base->load('user');
+            $tousernamearr = $_ENV['user']->id2name($touidarr);
+            foreach($members as $key => $data) {

-				$daterange = 5;
-				$data['founddateline'] = $data['dateline'];
-				$data['dateline'] = $data['lastdateline'];
-				$data['pmid'] = $data['plid'];
-				$lastmessage = unserialize($data['lastmessage']);
-				if($lastmessage['firstauthorid']) {
-					$data['firstauthorid'] = $lastmessage['firstauthorid'];
-					$data['firstauthor'] = $lastmessage['firstauthor'];
-					$data['firstsummary'] = $lastmessage['firstsummary'];
-				}
-				if($lastmessage['lastauthorid']) {
-					$data['lastauthorid'] = $lastmessage['lastauthorid'];
-					$data['lastauthor'] = $lastmessage['lastauthor'];
-					$data['lastsummary'] = $lastmessage['lastsummary'];
-				}
-				$data['msgfromid'] = $lastmessage['lastauthorid'];
-				$data['msgfrom'] = $lastmessage['lastauthor'];
-				$data['message'] = $lastmessage['lastsummary'];
+                $daterange = 5;
+                $data['founddateline'] = $data['dateline'];
+                $data['dateline'] = $data['lastdateline'];
+                $data['pmid'] = $data['plid'];
+                $lastmessage = unserialize($data['lastmessage']);
+                if(@$lastmessage['firstauthorid']) {
+                    $data['firstauthorid'] = $lastmessage['firstauthorid'];
+                    $data['firstauthor'] = $lastmessage['firstauthor'];
+                    $data['firstsummary'] = $lastmessage['firstsummary'];
+                }
+                if($lastmessage['lastauthorid']) {
+                    $data['lastauthorid'] = $lastmessage['lastauthorid'];
+                    $data['lastauthor'] = $lastmessage['lastauthor'];
+                    $data['lastsummary'] = $lastmessage['lastsummary'];
+                }
+                $data['msgfromid'] = $lastmessage['lastauthorid'];
+                $data['msgfrom'] = $lastmessage['lastauthor'];
+                $data['message'] = $lastmessage['lastsummary'];

-				$data['new'] = $data['isnew'];
+                $data['new'] = $data['isnew'];

-				$data['msgtoid'] = $data['touid'];
-				if($data['lastdateline'] >= $today) {
-					$daterange = 1;
-				} elseif($data['lastdateline'] >= $today - 86400) {
-					$daterange = 2;
-				} elseif($data['lastdateline'] >= $today - 172800) {
-					$daterange = 3;
-				} elseif($data['lastdateline'] >= $today - 604800) {
-					$daterange = 4;
-				}
-				$data['daterange'] = $daterange;
+                $data['msgtoid'] = $data['touid'];
+                if($data['lastdateline'] >= $today) {
+                    $daterange = 1;
+                } elseif($data['lastdateline'] >= $today - 86400) {
+                    $daterange = 2;
+                } elseif($data['lastdateline'] >= $today - 172800) {
+                    $daterange = 3;
+                } elseif($data['lastdateline'] >= $today - 604800) {
+                    $daterange = 4;
+                }
+                $data['daterange'] = $daterange;

-				$data['tousername'] = $tousernamearr[$data['touid']];
-				unset($data['min_max']);
-				$array[] = $data;
-			}
-		}
-		return $array;
-	}
+                $data['tousername'] = $tousernamearr[$data['touid']];
+                unset($data['min_max']);
+                $array[] = $data;
+            }
+        }
+        return $array;
+    }

-	function getplidbypmid($pmid) {
-		if(!$pmid) {
-			return false;
-		}
-		return $this->db->result_first("SELECT plid FROM ".UC_DBTABLEPRE."pm_indexes WHERE pmid='$pmid'");
-	}
+    function getplidbypmid($pmid) {
+        if(!$pmid) {
+            return false;
+        }
+        return $this->db->result_first("SELECT plid FROM ".UC_DBTABLEPRE."pm_indexes WHERE pmid='$pmid'");
+    }

-	function getplidbytouid($uid, $touid) {
-		if(!$uid || !$touid) {
-			return 0;
-		}
-		return $this->db->result_first("SELECT plid FROM ".UC_DBTABLEPRE."pm_lists WHERE min_max='".$this->relationship($uid, $touid)."'");
-	}
+    function getplidbytouid($uid, $touid) {
+        if(!$uid || !$touid) {
+            return 0;
+        }
+        return $this->db->result_first("SELECT plid FROM ".UC_DBTABLEPRE."pm_lists WHERE min_max='".$this->relationship($uid, $touid)."'");
+    }

-	function getuidbyplid($plid) {
-		if(!$plid) {
-			return array();
-		}
-		$uidarr = array();
-		$query = $this->db->query("SELECT uid FROM ".UC_DBTABLEPRE."pm_members WHERE plid='$plid'");
-		while($uid = $this->db->fetch_array($query)) {
-			$uidarr[$uid['uid']] = $uid['uid'];
-		}
-		return $uidarr;
-	}
+    function getuidbyplid($plid) {
+        if(!$plid) {
+            return array();
+        }
+        $uidarr = array();
+        $query = $this->db->query("SELECT uid FROM ".UC_DBTABLEPRE."pm_members WHERE plid='$plid'");
+        while($uid = $this->db->fetch_array($query)) {
+            $uidarr[$uid['uid']] = $uid['uid'];
+        }
+        return $uidarr;
+    }

-	function chatpmmemberlist($uid, $plid) {
-		if(!$uid || !$plid) {
-			return 0;
-		}
-		$uidarr = $this->getuidbyplid($plid);
-		if(empty($uidarr)) {
-			return 0;
-		}
-		if(!isset($uidarr[$uid])) {
-			return 0;
-		}
-		$authorid = $this->db->result_first("SELECT authorid FROM ".UC_DBTABLEPRE."pm_lists WHERE plid='$plid'");
-		return array('author' => $authorid, 'member' => $uidarr);
-	}
+    function chatpmmemberlist($uid, $plid) {
+        if(!$uid || !$plid) {
+            return 0;
+        }
+        $uidarr = $this->getuidbyplid($plid);
+        if(empty($uidarr)) {
+            return 0;
+        }
+        if(!isset($uidarr[$uid])) {
+            return 0;
+        }
+        $authorid = $this->db->result_first("SELECT authorid FROM ".UC_DBTABLEPRE."pm_lists WHERE plid='$plid'");
+        return array('author' => $authorid, 'member' => $uidarr);
+    }

-	function relationship($fromuid, $touid) {
-		if($fromuid < $touid) {
-			return $fromuid.'_'.$touid;
-		} elseif($fromuid > $touid) {
-			return $touid.'_'.$fromuid;
-		} else {
-			return '';
-		}
-	}
+    function relationship($fromuid, $touid) {
+        if($fromuid < $touid) {
+            return $fromuid.'_'.$touid;
+        } elseif($fromuid > $touid) {
+            return $touid.'_'.$fromuid;
+        } else {
+            return '';
+        }
+    }

-	function getposttablename($plid) {
-		$id = substr((string)$plid, -1, 1);
-		return 'pm_messages_'.$id;
-	}
+    function getposttablename($plid) {
+        $id = substr((string)$plid, -1, 1);
+        return 'pm_messages_'.$id;
+    }

-	function get_blackls($uid, $uids = array()) {
-		if(!$uids) {
-			$blackls = $this->db->result_first("SELECT blacklist FROM ".UC_DBTABLEPRE."memberfields WHERE uid='$uid'");
-		} else {
-			$uids = $this->base->implode($uids);
-			$blackls = array();
-			$query = $this->db->query("SELECT uid, blacklist FROM ".UC_DBTABLEPRE."memberfields WHERE uid IN ($uids)");
-			while($data = $this->db->fetch_array($query)) {
-				$blackls[$data['uid']] = explode(',', $data['blacklist']);
-			}
-		}
-		return $blackls;
-	}
+    function get_blackls($uid, $uids = array()) {
+        if(!$uids) {
+            $blackls = $this->db->result_first("SELECT blacklist FROM ".UC_DBTABLEPRE."memberfields WHERE uid='$uid'");
+        } else {
+            $uids = $this->base->implode($uids);
+            $blackls = array();
+            $query = $this->db->query("SELECT uid, blacklist FROM ".UC_DBTABLEPRE."memberfields WHERE uid IN ($uids)");
+            while($data = $this->db->fetch_array($query)) {
+                $blackls[$data['uid']] = explode(',', $data['blacklist']);
+            }
+        }
+        return $blackls;
+    }

-	function set_blackls($uid, $blackls) {
-		$this->db->query("UPDATE ".UC_DBTABLEPRE."memberfields SET blacklist='$blackls' WHERE uid='$uid'");
-		return $this->db->affected_rows();
-	}
+    function set_blackls($uid, $blackls) {
+        $this->db->query("UPDATE ".UC_DBTABLEPRE."memberfields SET blacklist='$blackls' WHERE uid='$uid'");
+        return $this->db->affected_rows();
+    }

-	function update_blackls($uid, $username, $action = 1) {
-		$username = !is_array($username) ? array($username) : $username;
-		if($action == 1) {
-			if(!in_array('{ALL}', $username)) {
-				$usernames = $this->base->implode($username);
-				$query = $this->db->query("SELECT username FROM ".UC_DBTABLEPRE."members WHERE username IN ($usernames)");
-				$usernames = array();
-				while($data = $this->db->fetch_array($query)) {
-					$usernames[addslashes($data['username'])] = addslashes($data['username']);
-				}
-				if(!$usernames) {
-					return 0;
-				}
-				$blackls = addslashes($this->db->result_first("SELECT blacklist FROM ".UC_DBTABLEPRE."memberfields WHERE uid='$uid'"));
-				if($blackls) {
-					$list = explode(',', $blackls);
-					foreach($list as $k => $v) {
-						if(in_array($v, $usernames)) {
-							unset($usernames[$v]);
-						}
-					}
-				}
-				if(!$usernames) {
-					return 1;
-				}
-				$listnew = implode(',', $usernames);
-				$blackls .= $blackls !== '' ? ','.$listnew : $listnew;
-			} else {
-				$blackls = addslashes($this->db->result_first("SELECT blacklist FROM ".UC_DBTABLEPRE."memberfields WHERE uid='$uid'"));
-				$blackls .= ',{ALL}';
-			}
-		} else {
-			$blackls = addslashes($this->db->result_first("SELECT blacklist FROM ".UC_DBTABLEPRE."memberfields WHERE uid='$uid'"));
-			$list = $blackls = explode(',', $blackls);
-			foreach($list as $k => $v) {
-				if(in_array($v, $username)) {
-					unset($blackls[$k]);
-				}
-			}
-			$blackls = implode(',', $blackls);
-		}
-		$this->db->query("UPDATE ".UC_DBTABLEPRE."memberfields SET blacklist='$blackls' WHERE uid='$uid'");
-		return 1;
-	}
+    function update_blackls($uid, $username, $action = 1) {
+        $username = !is_array($username) ? array($username) : $username;
+        if($action == 1) {
+            if(!in_array('{ALL}', $username)) {
+                $usernames = $this->base->implode($username);
+                $query = $this->db->query("SELECT username FROM ".UC_DBTABLEPRE."members WHERE username IN ($usernames)");
+                $usernames = array();
+                while($data = $this->db->fetch_array($query)) {
+                    $usernames[addslashes($data['username'])] = addslashes($data['username']);
+                }
+                if(!$usernames) {
+                    return 0;
+                }
+                $blackls = addslashes($this->db->result_first("SELECT blacklist FROM ".UC_DBTABLEPRE."memberfields WHERE uid='$uid'"));
+                if($blackls) {
+                    $list = explode(',', $blackls);
+                    foreach($list as $k => $v) {
+                        if(in_array($v, $usernames)) {
+                            unset($usernames[$v]);
+                        }
+                    }
+                }
+                if(!$usernames) {
+                    return 1;
+                }
+                $listnew = implode(',', $usernames);
+                $blackls .= $blackls !== '' ? ','.$listnew : $listnew;
+            } else {
+                $blackls = addslashes($this->db->result_first("SELECT blacklist FROM ".UC_DBTABLEPRE."memberfields WHERE uid='$uid'"));
+                $blackls .= ',{ALL}';
+            }
+        } else {
+            $blackls = addslashes($this->db->result_first("SELECT blacklist FROM ".UC_DBTABLEPRE."memberfields WHERE uid='$uid'"));
+            $list = $blackls = explode(',', $blackls);
+            foreach($list as $k => $v) {
+                if(in_array($v, $username)) {
+                    unset($blackls[$k]);
+                }
+            }
+            $blackls = implode(',', $blackls);
+        }
+        $this->db->query("UPDATE ".UC_DBTABLEPRE."memberfields SET blacklist='$blackls' WHERE uid='$uid'");
+        return 1;
+    }

-	function removecode($str, $length) {
-		static $uccode = null;
-		if($uccode === null) {
-			require_once UC_ROOT.'lib/uccode.class.php';
-			$uccode = new uccode();
-		}
-		$str = $uccode->complie($str);
-		return trim($this->base->cutstr(strip_tags($str), $length));
-	}
+    function removecode($str, $length) {
+        static $uccode = null;
+        if($uccode === null) {
+            require_once UC_ROOT.'lib/uccode.class.php';
+            $uccode = new uccode();
+        }
+        $str = $uccode->complie($str);
+        return trim($this->base->cutstr(strip_tags($str), $length));
+    }

-	function ispminterval($uid, $interval = 0) {
-		if(!$uid) {
-			return 0;
-		}
-		$interval = intval($interval);
-		if(!$interval) {
-			return 1;
-		}
-		$lastupdate = $this->db->result_first("SELECT lastupdate FROM ".UC_DBTABLEPRE."pm_members WHERE uid='$uid' ORDER BY lastupdate DESC LIMIT 1");
-		if(($this->base->time - $lastupdate) > $interval) {
-			return 1;
-		} else {
-			return 0;
-		}
-	}
+    function ispminterval($uid, $interval = 0) {
+        if(!$uid) {
+            return 0;
+        }
+        $interval = intval($interval);
+        if(!$interval) {
+            return 1;
+        }
+        $lastupdate = $this->db->result_first("SELECT lastupdate FROM ".UC_DBTABLEPRE."pm_members WHERE uid='$uid' ORDER BY lastupdate DESC LIMIT 1");
+        if(($this->base->time - $lastupdate) > $interval) {
+            return 1;
+        } else {
+            return 0;
+        }
+    }

-	function isprivatepmthreadlimit($uid, $maxnum = 0) {
-		if(!$uid) {
-			return 0;
-		}
-		$maxnum = intval($maxnum);
-		if(!$maxnum) {
-			return 1;
-		}
-		$num = $this->db->result_first("SELECT COUNT(*) FROM ".UC_DBTABLEPRE."pm_members m LEFT JOIN ".UC_DBTABLEPRE."pm_lists t ON m.plid=t.plid WHERE uid='$uid' AND lastupdate>'".($this->base->time-86400)."' AND t.pmtype=1");
-		if($maxnum - $num < 0) {
-			return 0;
-		} else {
-			return 1;
-		}
-	}
+    function isprivatepmthreadlimit($uid, $maxnum = 0) {
+        if(!$uid) {
+            return 0;
+        }
+        $maxnum = intval($maxnum);
+        if(!$maxnum) {
+            return 1;
+        }
+        $num = $this->db->result_first("SELECT COUNT(*) FROM ".UC_DBTABLEPRE."pm_members m LEFT JOIN ".UC_DBTABLEPRE."pm_lists t ON m.plid=t.plid WHERE uid='$uid' AND lastupdate>'".($this->base->time-86400)."' AND t.pmtype=1");
+        if($maxnum - $num < 0) {
+            return 0;
+        } else {
+            return 1;
+        }
+    }

-	function ischatpmthreadlimit($uid, $maxnum = 0) {
-		if(!$uid) {
-			return 0;
-		}
-		$maxnum = intval($maxnum);
-		if(!$maxnum) {
-			return 1;
-		}
-		$num = $this->db->result_first("SELECT COUNT(*) FROM ".UC_DBTABLEPRE."pm_lists WHERE authorid='$uid' AND dateline>'".($this->base->time-86400)."'");
-		if($maxnum - $num < 0) {
-			return 0;
-		} else {
-			return 1;
-		}
-	}
+    function ischatpmthreadlimit($uid, $maxnum = 0) {
+        if(!$uid) {
+            return 0;
+        }
+        $maxnum = intval($maxnum);
+        if(!$maxnum) {
+            return 1;
+        }
+        $num = $this->db->result_first("SELECT COUNT(*) FROM ".UC_DBTABLEPRE."pm_lists WHERE authorid='$uid' AND dateline>'".($this->base->time-86400)."'");
+        if($maxnum - $num < 0) {
+            return 0;
+        } else {
+            return 1;
+        }
+    }
 }
 ?>
